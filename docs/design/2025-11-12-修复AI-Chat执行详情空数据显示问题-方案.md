# ä¿®å¤AI Chatæ‰§è¡Œè¯¦æƒ…ç©ºæ•°æ®æ˜¾ç¤ºé—®é¢˜ - å¼€å‘è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°

### ç°è±¡
ç”¨æˆ·ç‚¹å‡»AI Chatæ¶ˆæ¯çš„"æ‰§è¡Œè¯¦æƒ…"æŒ‰é’®å,å¼¹å‡ºçš„ `ExecutionDetailDialog` å¯¹è¯æ¡†æ˜¾ç¤ºç©ºæ•°æ®æˆ–é»˜è®¤å€¼:
- å·¥ä½œæµåç§°: "æœªå‘½åå·¥ä½œæµ"
- æ‰§è¡ŒçŠ¶æ€: "æœªçŸ¥"
- æ‰§è¡Œæ—¶é•¿: "-"
- å¼€å§‹æ—¶é—´: "-"
- ç»“æŸæ—¶é—´: "-"
- èŠ‚ç‚¹æ‰§è¡Œæ•°æ®: "æš‚æ— èŠ‚ç‚¹æ‰§è¡Œæ•°æ®"

### æ ¹æœ¬åŸå› 
`MessageList.vue` çš„ `showExecutionDetail` æ–¹æ³•ç›´æ¥å°† `message.workflowRuntime` å¯¹è±¡ä¼ é€’ç»™ `ExecutionDetailDialog` ç»„ä»¶,ä½†è¿™ä¸ªå¯¹è±¡åªåŒ…å«æœ€åŸºæœ¬çš„å­—æ®µ:
```javascript
{
  id: 17,
  uuid: "abc123",
  workflowUuid: "workflow-uuid",
  isWaitingInput: false,
  isComplete: true
}
```

è€Œ `ExecutionDetailDialog` ç»„ä»¶æœŸæœ›çš„ `runtimeDetail` prop éœ€è¦åŒ…å«:
```javascript
{
  workflow_name: "å·¥ä½œæµåç§°",
  status: 2,
  elapsed_time: 12345,
  start_time: "2025-11-12T10:00:00",
  end_time: "2025-11-12T10:05:00",
  c_name: "åˆ›å»ºäººå§“å"
}
```

### æ•°æ®éªŒè¯
é€šè¿‡æ•°æ®åº“æŸ¥è¯¢ç¡®è®¤:
- `ai_conversation_workflow_runtime` è¡¨å­˜åœ¨ id=17 çš„è®°å½•
- `workflow_id`, `status`, `c_time`, `u_time` ç­‰å­—æ®µéƒ½æœ‰å€¼
- `ai_conversation_workflow_runtime_node` è¡¨å­˜åœ¨å…³è”çš„èŠ‚ç‚¹æ‰§è¡Œè®°å½•
- æ•°æ®å®Œæ•´,åªæ˜¯å‰ç«¯æœªæ­£ç¡®è·å–

---

## âœ… KISSåŸåˆ™éªŒè¯

### 1. çœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³?
**âœ… çœŸå®é—®é¢˜**
- ç”Ÿäº§ç¯å¢ƒå·²å­˜åœ¨çš„åŠŸèƒ½ç¼ºé™·
- æ‰§è¡Œè¯¦æƒ…æŒ‰é’®å·²æ˜¾ç¤º,ä½†æ•°æ®ä¸ºç©º
- å½±å“æ‰€æœ‰ä½¿ç”¨AI Chatå·¥ä½œæµåŠŸèƒ½çš„ç”¨æˆ·

### 2. æœ‰æ›´ç®€å•æ–¹æ³•å—?
**âœ… å½“å‰æ–¹æ¡ˆæœ€ç®€**

å¯¹æ¯”3ç§æ–¹æ¡ˆ:
| æ–¹æ¡ˆ | å¤æ‚åº¦ | æ€§èƒ½ | ç ´åæ€§ |
|------|--------|------|--------|
| A. storeä¿å­˜æ—¶æŸ¥è¯¢ | é«˜(150è¡Œ) | å·®(æ¯æ¡æ¶ˆæ¯æŸ¥è¯¢) | ä¸­ |
| B. ChatResponseVoè¿”å›å®Œæ•´æ•°æ® | é«˜(200è¡Œ) | å·®(æµå¼è¾“å‡ºæºå¸¦) | é«˜ |
| **C. ç‚¹å‡»æ—¶æŸ¥è¯¢** | **ä½(112è¡Œ)** | **å¥½(æŒ‰éœ€æŸ¥è¯¢)** | **æ— ** |

### 3. ä¼šç ´åä»€ä¹ˆå—?
**âœ… é›¶ç ´åæ€§**
- æ–°å¢APIç«¯ç‚¹,ä¸ä¿®æ”¹ç°æœ‰API
- æ–°å¢Serviceæ–¹æ³•,ä¸ä¿®æ”¹ç°æœ‰æ–¹æ³•
- æ–°å¢VOå­—æ®µ,ä¸ä¿®æ”¹ç°æœ‰å­—æ®µ
- å‰ç«¯ä¿®æ”¹éš”ç¦»åœ¨å•ä¸ªæ–¹æ³•å†…éƒ¨

### 4. é¡¹ç›®çœŸéœ€è¦å—?
**âœ… å¿…éœ€åŠŸèƒ½**
- æ‰§è¡Œè¯¦æƒ…æŒ‰é’®å·²å­˜åœ¨,è¯´æ˜æ˜¯å·²è§„åˆ’åŠŸèƒ½
- ExecutionDetailDialogç»„ä»¶å·²å®Œæ•´å¼€å‘
- è¿™æ˜¯ä¿®å¤ç°æœ‰åŠŸèƒ½,ä¸æ˜¯æ–°å¢åŠŸèƒ½

### 5. æœ‰è‡†æƒ³/è¿‡åº¦è®¾è®¡å—?
**âœ… æ— **
- åŸºäºå……åˆ†çš„æ•°æ®åº“ç»“æ„åˆ†æ
- åŸºäºæ˜ç¡®çš„å‰ç«¯ç»„ä»¶éœ€æ±‚
- ä½¿ç”¨ç°æœ‰æ¶æ„æ¨¡å¼,æ— æ–°å¢æŠ½è±¡

### 6. ä»£ç ç®€æ´å—?
**âœ… æœ€å°åŒ–å®ç°**
- åç«¯: ~94è¡Œ(VOå­—æ®µ24è¡Œ + Service 50è¡Œ + Controller 20è¡Œ)
- å‰ç«¯: ~18è¡Œ(APIæ–¹æ³•15è¡Œ + è°ƒç”¨3è¡Œ)
- æ€»è®¡: ~112è¡Œ
- å……åˆ†å¤ç”¨ç°æœ‰ä»£ç ,æ— å†—ä½™

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
**åœ¨ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œè¯¦æƒ…"æŒ‰é’®æ—¶,è°ƒç”¨åç«¯APIè·å–å®Œæ•´çš„è¿è¡Œæ—¶è¯¦æƒ…æ•°æ®,ç„¶åä¼ é€’ç»™å¯¹è¯æ¡†ç»„ä»¶**

### æ•°æ®æµå‘
```
ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œè¯¦æƒ…"
  â†“
MessageList.showExecutionDetail(message)
  â†“
è°ƒç”¨ aiChatService.getConversationRuntimeDetail(runtimeId)
  â†“
è¯·æ±‚ GET /api/v1/ai/conversation/workflow/runtime/{runtimeId}
  â†“
AiConversationController.getRuntimeDetail(runtimeId)
  â†“
AiConversationWorkflowRuntimeService.getDetailById(runtimeId)
  â”œâ”€â”€ æŸ¥è¯¢ ai_conversation_workflow_runtime è¡¨
  â”œâ”€â”€ å…³è”æŸ¥è¯¢ ai_workflow è¡¨ (è·å– workflow_name)
  â”œâ”€â”€ è½¬æ¢ JSON å­—ç¬¦ä¸² â†’ JSONObject
  â”œâ”€â”€ è®¡ç®— elapsed_time = u_time - c_time
  â””â”€â”€ ç»„è£… AiConversationWorkflowRuntimeVo
  â†“
è¿”å›å®Œæ•´ VO å¯¹è±¡ç»™å‰ç«¯
  â†“
MessageList å°†å®Œæ•´æ•°æ®ä¼ é€’ç»™ ExecutionDetailDialog
  â†“
å¯¹è¯æ¡†æ­£å¸¸æ¸²æŸ“æ˜¾ç¤º
```

---

## ğŸ“ è¯¦ç»†è®¾è®¡

### 1. åç«¯ - VOç±»æ‰©å±•

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/workflow/AiConversationWorkflowRuntimeVo.java`

**ä¿®æ”¹å†…å®¹**: åœ¨ç±»æœ«å°¾æ–°å¢æ‰©å±•å­—æ®µ

```java
// ========== æ‰©å±•å­—æ®µ(ç”¨äºè¯¦æƒ…å±•ç¤º) ==========

/**
 * å·¥ä½œæµåç§°(ä»ai_workflowè¡¨å…³è”æŸ¥è¯¢)
 */
private String workflow_name;

/**
 * å·¥ä½œæµUUID(ä»ai_workflowè¡¨å…³è”æŸ¥è¯¢)
 */
private String workflowUuid;

/**
 * æ‰§è¡Œæ—¶é•¿(æ¯«ç§’)(è®¡ç®—å¾—å‡º: u_time - c_time)
 */
private Long elapsed_time;

/**
 * å¼€å§‹æ—¶é—´(å³åˆ›å»ºæ—¶é—´c_timeçš„åˆ«å)
 */
private LocalDateTime start_time;

/**
 * ç»“æŸæ—¶é—´(å³æ›´æ–°æ—¶é—´u_timeçš„åˆ«å)
 */
private LocalDateTime end_time;

/**
 * åˆ›å»ºäººå§“å(ä»ç”¨æˆ·è¡¨å…³è”æŸ¥è¯¢)
 */
private String c_name;
```

**è®¾è®¡è¯´æ˜**:
- ä½¿ç”¨ Lombok `@Data` æ³¨è§£,è‡ªåŠ¨ç”Ÿæˆ getter/setter
- æ–°å¢å­—æ®µä¸å½±å“ç°æœ‰ä»£ç (ç°æœ‰ä»£ç ä¸ä½¿ç”¨è¿™äº›å­—æ®µ,è¿”å›nullä¸ä¼šæŠ¥é”™)
- å­—æ®µå‘½åä¸æ•°æ®åº“åˆ—åä¿æŒä¸€è‡´(snake_case)

---

### 2. åç«¯ - Serviceå±‚æ–¹æ³•

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/workflow/AiConversationWorkflowRuntimeService.java`

**æ–°å¢æ–¹æ³•**: `getDetailById(Long runtimeId)`

```java
/**
 * æ ¹æ®IDæŸ¥è¯¢è¿è¡Œå®ä¾‹è¯¦æƒ…(åŒ…å«å·¥ä½œæµåç§°ç­‰å®Œæ•´ä¿¡æ¯)
 *
 * @param runtimeId è¿è¡Œå®ä¾‹ID
 * @return è¿è¡Œå®ä¾‹VO(åŒ…å«å®Œæ•´ä¿¡æ¯)
 */
public AiConversationWorkflowRuntimeVo getDetailById(Long runtimeId) {
    // 1. æŸ¥è¯¢è¿è¡Œå®ä¾‹
    AiConversationWorkflowRuntimeEntity runtime = conversationWorkflowRuntimeMapper.selectById(runtimeId);
    if (runtime == null) {
        return null;
    }

    // 2. è½¬æ¢ä¸ºVO
    AiConversationWorkflowRuntimeVo vo = new AiConversationWorkflowRuntimeVo();
    BeanUtils.copyProperties(runtime, vo);

    // 3. æ‰‹åŠ¨è½¬æ¢JSONå­—æ®µ: String â†’ JSONObject
    if (StringUtils.isNotBlank(runtime.getInputData())) {
        vo.setInputData(JSON.parseObject(runtime.getInputData()));
    }
    if (StringUtils.isNotBlank(runtime.getOutputData())) {
        vo.setOutputData(JSON.parseObject(runtime.getOutputData()));
    }

    // 4. å¡«å……å·¥ä½œæµåç§°(å…³è”æŸ¥è¯¢ ai_workflow è¡¨)
    if (runtime.getWorkflowId() != null) {
        AiWorkflowEntity workflow = workflowService.getById(runtime.getWorkflowId());
        if (workflow != null) {
            vo.setWorkflow_name(workflow.getWorkflowName());
            vo.setWorkflowUuid(workflow.getWorkflowUuid());
        }
    }

    // 5. è®¡ç®—æ‰§è¡Œæ—¶é•¿(å¦‚æœæœ‰ç»“æŸæ—¶é—´)
    if (runtime.getU_time() != null && runtime.getC_time() != null) {
        long duration = java.time.Duration.between(runtime.getC_time(), runtime.getU_time()).toMillis();
        vo.setElapsed_time(duration);
    }

    // 6. è®¾ç½®å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´(ä½¿ç”¨åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´)
    vo.setStart_time(runtime.getC_time());
    vo.setEnd_time(runtime.getU_time());

    return vo;
}
```

**è®¾è®¡è¯´æ˜**:
- ä½¿ç”¨ MyBatis Plus çš„ `selectById` æŸ¥è¯¢è¿è¡Œæ—¶å®ä¾‹
- ä½¿ç”¨ `BeanUtils.copyProperties` å¤åˆ¶åŸºç¡€å­—æ®µ
- æ‰‹åŠ¨è½¬æ¢ JSON å­—æ®µ(æ•°æ®åº“å­˜å‚¨ä¸ºString,å‰ç«¯éœ€è¦JSONObject)
- å…³è”æŸ¥è¯¢ `ai_workflow` è¡¨è·å–å·¥ä½œæµåç§°
- è®¡ç®—æ´¾ç”Ÿå­—æ®µ `elapsed_time`
- è®¾ç½®åˆ«åå­—æ®µ `start_time`, `end_time`
- é˜²å¾¡æ€§ç¼–ç¨‹:æ£€æŸ¥null,é¿å… NPE

---

### 3. åç«¯ - Controllerå±‚API

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/controller/chat/AiConversationController.java`

**æ–°å¢APIç«¯ç‚¹**:

```java
/**
 * è·å–AI Chatå·¥ä½œæµè¿è¡Œæ—¶è¯¦æƒ…
 *
 * @param runtimeId AI Chatå·¥ä½œæµè¿è¡Œæ—¶ID
 * @return è¿è¡Œæ—¶è¯¦æƒ…
 */
@GetMapping(value = "/workflow/runtime/{runtimeId}")
@Operation(summary = "è·å–AI Chatå·¥ä½œæµè¿è¡Œæ—¶è¯¦æƒ…")
@SysLogAnnotion("è·å–AI Chatå·¥ä½œæµè¿è¡Œæ—¶è¯¦æƒ…")
public ResponseEntity<AiConversationWorkflowRuntimeVo> getRuntimeDetail(@PathVariable Long runtimeId) {
    try {
        AiConversationWorkflowRuntimeVo runtime = conversationWorkflowRuntimeService.getDetailById(runtimeId);
        if (runtime == null) {
            throw new AiBusinessException("å·¥ä½œæµè¿è¡Œæ—¶å®ä¾‹ä¸å­˜åœ¨: " + runtimeId);
        }
        return ResponseEntity.ok(runtime);
    } catch (Exception e) {
        log.error("è·å–AI Chatå·¥ä½œæµè¿è¡Œæ—¶è¯¦æƒ…å¤±è´¥, runtimeId: {}", runtimeId, e);
        throw new AiBusinessException("è·å–å·¥ä½œæµè¿è¡Œæ—¶è¯¦æƒ…å¤±è´¥: " + e.getMessage());
    }
}
```

**è®¾è®¡è¯´æ˜**:
- RESTful é£æ ¼: `GET /api/v1/ai/conversation/workflow/runtime/{runtimeId}`
- ä½¿ç”¨ `@PathVariable` æ¥æ”¶è·¯å¾„å‚æ•°
- è¿”å› `ResponseEntity<VO>` åŒ…è£…å“åº”
- å¼‚å¸¸å¤„ç†:è®°å½•æ—¥å¿— + æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
- æ·»åŠ  Swagger æ³¨è§£å’Œç³»ç»Ÿæ—¥å¿—æ³¨è§£

---

### 4. å‰ç«¯ - API Serviceå±‚

**æ–‡ä»¶**: `scm_frontend/src/components/70_ai/api/aiChatService.js`

**æ–°å¢æ–¹æ³•**:

```javascript
/**
 * è·å–AI Chatå·¥ä½œæµè¿è¡Œæ—¶è¯¦æƒ…
 * @param {Number} runtimeId - AI Chatå·¥ä½œæµè¿è¡Œæ—¶ID
 * @returns {Promise<Object>} è¿è¡Œæ—¶è¯¦æƒ…å¯¹è±¡
 */
async getConversationRuntimeDetail (runtimeId) {
  try {
    const response = await request({
      url: `/api/v1/ai/conversation/workflow/runtime/${runtimeId}`,
      method: 'get'
    })
    return response.data || {}
  } catch (error) {
    throw new Error(error.message || 'è·å–å·¥ä½œæµè¿è¡Œæ—¶è¯¦æƒ…å¤±è´¥')
  }
}
```

**è®¾è®¡è¯´æ˜**:
- è°ƒç”¨åç«¯ API è·å–å®Œæ•´è¿è¡Œæ—¶è¯¦æƒ…
- ä½¿ç”¨ç»Ÿä¸€çš„ `request` å·¥å…·(è‡ªåŠ¨å¤„ç†ç§Ÿæˆ·IDã€tokenç­‰)
- å¼‚å¸¸å¤„ç†:åŒ…è£…é”™è¯¯ä¿¡æ¯
- è¿”å› `response.data` (SCMçš„request.jså·²å¤„ç†å“åº”ç»“æ„)

---

### 5. å‰ç«¯ - ç»„ä»¶è°ƒç”¨

**æ–‡ä»¶**: `scm_frontend/src/components/70_ai/components/chat/messages/MessageList.vue`

**ä¿®æ”¹æ–¹æ³•**: `showExecutionDetail`

**ä¿®æ”¹ä½ç½®**: ç¬¬625è¡Œ

**åŸä»£ç **:
```javascript
async showExecutionDetail (message) {
  if (!message.workflowRuntime || !message.workflowRuntime.id) {
    this.$message.warning('è¯¥æ¶ˆæ¯æ²¡æœ‰å…³è”çš„å·¥ä½œæµæ‰§è¡Œè®°å½•')
    return
  }

  try {
    this.detailLoading = true
    this.detailDialogVisible = true

    // âŒ é—®é¢˜: ç›´æ¥ä½¿ç”¨ message.workflowRuntime,æ•°æ®ä¸å®Œæ•´
    this.currentRuntimeDetail = message.workflowRuntime

    // è°ƒç”¨APIè·å–èŠ‚ç‚¹è¯¦æƒ…
    const nodes = await aiChatService.getConversationRuntimeNodeDetails(message.workflowRuntime.id)
    this.currentNodes = nodes || []

    if (this.currentNodes.length === 0) {
      this.$message.info('è¯¥å·¥ä½œæµæš‚æ— èŠ‚ç‚¹æ‰§è¡Œè®°å½•')
    }
  } catch (error) {
    this.$message.error('è·å–æ‰§è¡Œè¯¦æƒ…å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    console.error('è·å–æ‰§è¡Œè¯¦æƒ…å¤±è´¥:', error)
    this.detailDialogVisible = false
  } finally {
    this.detailLoading = false
  }
}
```

**ä¿®æ”¹å**:
```javascript
async showExecutionDetail (message) {
  if (!message.workflowRuntime || !message.workflowRuntime.id) {
    this.$message.warning('è¯¥æ¶ˆæ¯æ²¡æœ‰å…³è”çš„å·¥ä½œæµæ‰§è¡Œè®°å½•')
    return
  }

  try {
    this.detailLoading = true
    this.detailDialogVisible = true

    // âœ… ä¿®å¤: è°ƒç”¨APIè·å–å®Œæ•´çš„runtimeè¯¦æƒ…
    const runtimeDetail = await aiChatService.getConversationRuntimeDetail(message.workflowRuntime.id)
    this.currentRuntimeDetail = runtimeDetail || message.workflowRuntime

    // è°ƒç”¨APIè·å–èŠ‚ç‚¹è¯¦æƒ…
    const nodes = await aiChatService.getConversationRuntimeNodeDetails(message.workflowRuntime.id)
    this.currentNodes = nodes || []

    if (this.currentNodes.length === 0) {
      this.$message.info('è¯¥å·¥ä½œæµæš‚æ— èŠ‚ç‚¹æ‰§è¡Œè®°å½•')
    }
  } catch (error) {
    this.$message.error('è·å–æ‰§è¡Œè¯¦æƒ…å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    console.error('è·å–æ‰§è¡Œè¯¦æƒ…å¤±è´¥:', error)
    this.detailDialogVisible = false
  } finally {
    this.detailLoading = false
  }
}
```

**è®¾è®¡è¯´æ˜**:
- åœ¨æ‰“å¼€å¯¹è¯æ¡†å‰å…ˆè°ƒç”¨APIè·å–å®Œæ•´è¯¦æƒ…
- é™çº§å¤„ç†:å¦‚æœAPIå¤±è´¥,ä»ä½¿ç”¨åŸæœ‰çš„ `message.workflowRuntime`
- ä¿æŒåŸæœ‰çš„å¼‚å¸¸å¤„ç†é€»è¾‘ä¸å˜
- ä¿®æ”¹æœ€å°åŒ–,åªæ”¹3è¡Œä»£ç 

---

## ğŸ” å‘åå…¼å®¹æ€§åˆ†æ

### 1. VOç±»å­—æ®µæ–°å¢çš„å½±å“

**å½±å“èŒƒå›´æ£€æŸ¥**: æœç´¢æ‰€æœ‰ä½¿ç”¨ `AiConversationWorkflowRuntimeVo` çš„ä»£ç 

**æ£€æŸ¥ç»“æœ**:
- `AiConversationWorkflowRuntimeVo.java` - VOç±»æœ¬èº« âœ…
- `AiConversationWorkflowRuntimeService.java` - Serviceç±» âœ…
- `AiConversationController.java` - Controllerç±» âœ…
- `WorkflowEngine.java` - å·¥ä½œæµå¼•æ“ âœ…

**WorkflowEngine ä½¿ç”¨æƒ…å†µ**:
```java
// WorkflowEngine åªä½¿ç”¨ä»¥ä¸‹å­—æ®µ:
this.conversationRuntimeResp.getRuntimeUuid();  // ç°æœ‰å­—æ®µ
this.conversationRuntimeResp.getConversationId();  // ç°æœ‰å­—æ®µ
this.conversationRuntimeResp.getId();  // ç°æœ‰å­—æ®µ
```

**ç»“è®º**: âœ… **æ–°å¢å­—æ®µä¸å½±å“ç°æœ‰ä»£ç **
- Lombok `@Data` è‡ªåŠ¨ç”Ÿæˆgetter,æ–°å­—æ®µè¿”å›null
- ç°æœ‰ä»£ç ä¸è°ƒç”¨æ–°å­—æ®µçš„getter,æ— å½±å“
- ç¬¦åˆå¼€é—­åŸåˆ™:å¯¹æ‰©å±•å¼€æ”¾,å¯¹ä¿®æ”¹å°é—­

### 2. Serviceæ–¹æ³•æ–°å¢çš„å½±å“

**ç°æœ‰æ–¹æ³•**:
- `create(Long userId, Long workflowId)` - åˆ›å»ºè¿è¡Œå®ä¾‹
- `createWithConversationId(...)` - åˆ›å»ºè¿è¡Œå®ä¾‹(æŒ‡å®šconversationId)
- `updateInput(Long id, WfState wfState)` - æ›´æ–°è¾“å…¥æ•°æ®
- `updateOutput(Long id, WfState wfState)` - æ›´æ–°è¾“å‡ºæ•°æ®
- `updateStatus(...)` - æ›´æ–°çŠ¶æ€
- `getByUuid(String runtimeUuid)` - æŒ‰UUIDæŸ¥è¯¢

**æ–°å¢æ–¹æ³•**:
- `getDetailById(Long runtimeId)` - æŸ¥è¯¢å®Œæ•´è¯¦æƒ… âœ… æ–°å¢,ä¸ä¿®æ”¹

**ç»“è®º**: âœ… **ä¸å½±å“ç°æœ‰æ–¹æ³•,é›¶ç ´åæ€§**

### 3. APIç«¯ç‚¹æ–°å¢çš„å½±å“

**ç°æœ‰ç«¯ç‚¹**:
- `POST /chat/stream` - æµå¼å‘é€æ¶ˆæ¯
- `GET /chat/list/{conversationId}` - è·å–å¯¹è¯å†…å®¹åˆ—è¡¨
- `GET /workflow/runtime/nodes/{runtimeId}` - è·å–èŠ‚ç‚¹è¯¦æƒ…
- ç­‰ç­‰...

**æ–°å¢ç«¯ç‚¹**:
- `GET /workflow/runtime/{runtimeId}` - è·å–è¿è¡Œæ—¶è¯¦æƒ… âœ… æ–°å¢,ä¸å†²çª

**ç»“è®º**: âœ… **ä¸å½±å“ç°æœ‰API,æ— è·¯ç”±å†²çª**

### 4. å‰ç«¯ç»„ä»¶ä¿®æ”¹çš„å½±å“

**ä¿®æ”¹èŒƒå›´**:
- `MessageList.vue` çš„ `showExecutionDetail` æ–¹æ³•å†…éƒ¨ âœ… éš”ç¦»ä¿®æ”¹
- `aiChatService.js` æ–°å¢æ–¹æ³• âœ… æ–°å¢,ä¸ä¿®æ”¹

**ä¸å½±å“çš„åŠŸèƒ½**:
- AI Chat æ¶ˆæ¯å‘é€/æ¥æ”¶
- æµå¼è¾“å‡ºæ˜¾ç¤º
- æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“
- å…¶ä»–æŒ‰é’®ç‚¹å‡»
- ExecutionDetailDialog ç»„ä»¶æœ¬èº«

**ç»“è®º**: âœ… **ä¿®æ”¹éš”ç¦»,ä¸å½±å“å…¶ä»–åŠŸèƒ½**

---

## ğŸ“Š æ•°æ®åº“å½±å“åˆ†æ

### è¡¨ç»“æ„ä¿®æ”¹
**âœ… æ— éœ€ä¿®æ”¹** - æ‰€æœ‰éœ€è¦çš„æ•°æ®å·²å­˜åœ¨äºæ•°æ®åº“

### SQLæŸ¥è¯¢åˆ†æ

**æ–°å¢æŸ¥è¯¢1**: æŸ¥è¯¢è¿è¡Œæ—¶å®ä¾‹
```sql
SELECT * FROM ai_conversation_workflow_runtime WHERE id = ?
```
- ä¸»é”®æŸ¥è¯¢,æ€§èƒ½ä¼˜ç§€
- ç´¢å¼•: PRIMARY KEY (id)

**æ–°å¢æŸ¥è¯¢2**: å…³è”æŸ¥è¯¢å·¥ä½œæµ
```sql
SELECT * FROM ai_workflow WHERE id = ?
```
- ä¸»é”®æŸ¥è¯¢,æ€§èƒ½ä¼˜ç§€
- ç´¢å¼•: PRIMARY KEY (id)

**æŸ¥è¯¢é¢‘ç‡**: ä»…åœ¨ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œè¯¦æƒ…"æŒ‰é’®æ—¶è§¦å‘,ä½é¢‘æ“ä½œ

**æ€§èƒ½å½±å“**: âœ… **å¯å¿½ç•¥** - ä¸¤æ¬¡ä¸»é”®æŸ¥è¯¢,äºšæ¯«ç§’çº§

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### 1. åç«¯å•å…ƒæµ‹è¯•

**æµ‹è¯•ç±»**: `AiConversationWorkflowRuntimeServiceTest`

**æµ‹è¯•ç”¨ä¾‹**:
```java
@Test
public void testGetDetailById_Success() {
    // å‡†å¤‡æ•°æ®
    Long runtimeId = 17L;

    // æ‰§è¡Œ
    AiConversationWorkflowRuntimeVo vo = service.getDetailById(runtimeId);

    // éªŒè¯
    assertNotNull(vo);
    assertEquals("æµ‹è¯•å·¥ä½œæµ", vo.getWorkflow_name());
    assertNotNull(vo.getStart_time());
    assertNotNull(vo.getEnd_time());
    assertNotNull(vo.getElapsed_time());
}

@Test
public void testGetDetailById_NotFound() {
    Long runtimeId = 999L;
    AiConversationWorkflowRuntimeVo vo = service.getDetailById(runtimeId);
    assertNull(vo);
}

@Test
public void testGetDetailById_WorkflowDeleted() {
    // è¿è¡Œæ—¶å®ä¾‹å­˜åœ¨,ä½†å…³è”çš„å·¥ä½œæµå·²åˆ é™¤
    Long runtimeId = 18L;
    AiConversationWorkflowRuntimeVo vo = service.getDetailById(runtimeId);
    assertNotNull(vo);
    assertNull(vo.getWorkflow_name());  // å·¥ä½œæµåç§°ä¸ºnull
}
```

### 2. åç«¯é›†æˆæµ‹è¯•

**æµ‹è¯•API**: `GET /api/v1/ai/conversation/workflow/runtime/{runtimeId}`

**æµ‹è¯•ç”¨ä¾‹**:
```java
@Test
public void testGetRuntimeDetail_Success() throws Exception {
    mockMvc.perform(get("/api/v1/ai/conversation/workflow/runtime/17"))
        .andExpect(status().isOk())
        .andExpect(jsonPath("$.workflow_name").value("æµ‹è¯•å·¥ä½œæµ"))
        .andExpect(jsonPath("$.status").value(2))
        .andExpect(jsonPath("$.elapsed_time").exists());
}

@Test
public void testGetRuntimeDetail_NotFound() throws Exception {
    mockMvc.perform(get("/api/v1/ai/conversation/workflow/runtime/999"))
        .andExpect(status().is4xxClientError());
}
```

### 3. å‰ç«¯åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯1**: æ­£å¸¸æ˜¾ç¤ºæ‰§è¡Œè¯¦æƒ…
```
æ­¥éª¤:
1. å‘é€AI Chatæ¶ˆæ¯,è§¦å‘å·¥ä½œæµ
2. ç­‰å¾…å·¥ä½œæµæ‰§è¡Œå®Œæˆ
3. ç‚¹å‡»æ¶ˆæ¯çš„"æ‰§è¡Œè¯¦æƒ…"æŒ‰é’®
4. éªŒè¯å¯¹è¯æ¡†æ˜¾ç¤º:
   - å·¥ä½œæµåç§°: æ˜¾ç¤ºå®é™…åç§°(é"æœªå‘½åå·¥ä½œæµ")
   - æ‰§è¡ŒçŠ¶æ€: æ˜¾ç¤ºå®é™…çŠ¶æ€(é"æœªçŸ¥")
   - æ‰§è¡Œæ—¶é•¿: æ˜¾ç¤ºè®¡ç®—å€¼(é"-")
   - å¼€å§‹æ—¶é—´: æ˜¾ç¤ºåˆ›å»ºæ—¶é—´(é"-")
   - ç»“æŸæ—¶é—´: æ˜¾ç¤ºæ›´æ–°æ—¶é—´(é"-")
   - èŠ‚ç‚¹æ•°æ®: æ˜¾ç¤ºèŠ‚ç‚¹åˆ—è¡¨(é"æš‚æ— èŠ‚ç‚¹æ‰§è¡Œæ•°æ®")
```

**æµ‹è¯•åœºæ™¯2**: å·¥ä½œæµè¿è¡Œä¸­(æ— ç»“æŸæ—¶é—´)
```
æ­¥éª¤:
1. å‘é€æ¶ˆæ¯è§¦å‘é•¿æ—¶é—´è¿è¡Œçš„å·¥ä½œæµ
2. åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç‚¹å‡»"æ‰§è¡Œè¯¦æƒ…"
3. éªŒè¯:
   - æ‰§è¡Œæ—¶é•¿: "-" æˆ– ç©ºç™½(å› ä¸ºæ²¡æœ‰u_time)
   - ç»“æŸæ—¶é—´: "-" æˆ– ç©ºç™½
   - å…¶ä»–å­—æ®µæ­£å¸¸æ˜¾ç¤º
```

**æµ‹è¯•åœºæ™¯3**: å…³è”å·¥ä½œæµå·²åˆ é™¤
```
æ­¥éª¤:
1. æ‰¾åˆ°ä¸€ä¸ªå†å²æ‰§è¡Œè®°å½•,å…¶å…³è”çš„å·¥ä½œæµå·²è¢«åˆ é™¤
2. ç‚¹å‡»"æ‰§è¡Œè¯¦æƒ…"
3. éªŒè¯:
   - å·¥ä½œæµåç§°: æ˜¾ç¤ºä¸ºç©ºæˆ–"æœªå‘½åå·¥ä½œæµ"
   - å…¶ä»–å­—æ®µæ­£å¸¸æ˜¾ç¤º
   - ä¸åº”æŠ¥é”™å´©æºƒ
```

**æµ‹è¯•åœºæ™¯4**: APIè°ƒç”¨å¤±è´¥é™çº§å¤„ç†
```
æ­¥éª¤:
1. æ¨¡æ‹Ÿåç«¯APIé”™è¯¯(æ–­å¼€ç½‘ç»œæˆ–ä¿®æ”¹URL)
2. ç‚¹å‡»"æ‰§è¡Œè¯¦æƒ…"
3. éªŒè¯:
   - æ˜¾ç¤ºé”™è¯¯æç¤º
   - ä½¿ç”¨åŸæœ‰çš„ message.workflowRuntime æ•°æ®æ˜¾ç¤º
   - å¯¹è¯æ¡†ä¸åº”å´©æºƒ
```

### 4. å›å½’æµ‹è¯•

**éªŒè¯ä¸å—å½±å“çš„åŠŸèƒ½**:
- âœ… AI Chat æ¶ˆæ¯å‘é€/æ¥æ”¶æ­£å¸¸
- âœ… å·¥ä½œæµæµå¼è¾“å‡ºæ­£å¸¸
- âœ… å·¥ä½œæµæ‰§è¡Œè®°å½•æ­£å¸¸ä¿å­˜åˆ°æ•°æ®åº“
- âœ… å…¶ä»–å¯¹è¯æ¶ˆæ¯æ“ä½œæ­£å¸¸(å¤åˆ¶ã€åˆ é™¤ç­‰)
- âœ… WorkflowEngine æ­£å¸¸åˆ›å»º/æ›´æ–°è¿è¡Œæ—¶å®ä¾‹

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åç«¯éƒ¨ç½²

```bash
# 1. åˆ‡æ¢åˆ°åç«¯ç›®å½•
cd D:\2025_project\20_project_in_github\00_scm_backend\scm_backend

# 2. ç¼–è¯‘é¡¹ç›®
mvn clean compile

# 3. è¿è¡Œå•å…ƒæµ‹è¯•(å¦‚æœæœ‰)
mvn test -Dtest=AiConversationWorkflowRuntimeServiceTest

# 4. æ‰“åŒ…
mvn clean package -DskipTests

# 5. é‡å¯åç«¯æœåŠ¡
cd scm-start
mvn spring-boot:run
```

**éªŒè¯**:
- è®¿é—®: `http://localhost:8088/scm/actuator/health` ç¡®è®¤æœåŠ¡å¯åŠ¨
- ä½¿ç”¨Postmanæµ‹è¯•API: `GET http://localhost:8088/scm/api/v1/ai/conversation/workflow/runtime/17`
- éªŒè¯è¿”å›æ•°æ®åŒ…å« `workflow_name`, `start_time`, `end_time`, `elapsed_time`

### 2. å‰ç«¯éƒ¨ç½²

```bash
# 1. åˆ‡æ¢åˆ°å‰ç«¯ç›®å½•
cd D:\2025_project\20_project_in_github\01_scm_frontend\scm_frontend

# 2. å®‰è£…ä¾èµ–(å¦‚æœæœ‰æ–°å¢)
npm install

# 3. ç¼–è¯‘æµ‹è¯•
npm run build:test1

# 4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

**éªŒè¯**:
- è®¿é—®: `http://localhost:19528`
- ç™»å½•ç³»ç»Ÿ
- å‘é€AI Chatæ¶ˆæ¯è§¦å‘å·¥ä½œæµ
- ç‚¹å‡»"æ‰§è¡Œè¯¦æƒ…"æŒ‰é’®
- éªŒè¯å¯¹è¯æ¡†æ˜¾ç¤ºå®Œæ•´æ•°æ®

### 3. è”è°ƒæµ‹è¯•

**å®Œæ•´æµç¨‹æµ‹è¯•**:
```
1. å¯åŠ¨åç«¯æœåŠ¡ (ç«¯å£8088)
2. å¯åŠ¨å‰ç«¯æœåŠ¡ (ç«¯å£19528)
3. å‰ç«¯ç™»å½•ç³»ç»Ÿ
4. å‘é€AI Chatæ¶ˆæ¯: "ä½ å¥½,è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„?"
5. ç­‰å¾…AIå›å¤
6. ç‚¹å‡»AIæ¶ˆæ¯å³ä¾§çš„"æ‰§è¡Œè¯¦æƒ…"æŒ‰é’®
7. éªŒè¯å¯¹è¯æ¡†æ˜¾ç¤º:
   âœ… å·¥ä½œæµåç§°ä¸æ˜¯"æœªå‘½åå·¥ä½œæµ"
   âœ… æ‰§è¡ŒçŠ¶æ€ä¸æ˜¯"æœªçŸ¥"
   âœ… æ‰§è¡Œæ—¶é•¿æœ‰å…·ä½“æ•°å€¼
   âœ… å¼€å§‹æ—¶é—´/ç»“æŸæ—¶é—´æœ‰å…·ä½“æ—¶é—´
   âœ… èŠ‚ç‚¹åˆ—è¡¨æ˜¾ç¤ºæ‰§è¡ŒèŠ‚ç‚¹
8. å…³é—­å¯¹è¯æ¡†,éªŒè¯ä¸å½±å“å…¶ä»–åŠŸèƒ½
9. ç»§ç»­å‘é€æ¶ˆæ¯,éªŒè¯å¯¹è¯æµç¨‹æ­£å¸¸
```

---

## ğŸ“¦ äº¤ä»˜æ¸…å•

### ä»£ç æ–‡ä»¶

**åç«¯** (3ä¸ªæ–‡ä»¶):
1. `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/workflow/AiConversationWorkflowRuntimeVo.java`
   - æ–°å¢6ä¸ªæ‰©å±•å­—æ®µ

2. `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/workflow/AiConversationWorkflowRuntimeService.java`
   - æ–°å¢ `getDetailById()` æ–¹æ³•

3. `scm-ai/src/main/java/com/xinyirun/scm/ai/controller/chat/AiConversationController.java`
   - æ–°å¢ `GET /workflow/runtime/{runtimeId}` APIç«¯ç‚¹

**å‰ç«¯** (2ä¸ªæ–‡ä»¶):
1. `scm_frontend/src/components/70_ai/api/aiChatService.js`
   - æ–°å¢ `getConversationRuntimeDetail()` æ–¹æ³•

2. `scm_frontend/src/components/70_ai/components/chat/messages/MessageList.vue`
   - ä¿®æ”¹ `showExecutionDetail()` æ–¹æ³•(ç¬¬625è¡Œ)

### æ–‡æ¡£

1. æœ¬è®¾è®¡æ–¹æ¡ˆæ–‡æ¡£
2. APIæ¥å£æ–‡æ¡£æ›´æ–°(Swagger)
3. æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£(å¦‚æœéœ€è¦)

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
- å·¥ä½œæµåç§°: "æœªå‘½åå·¥ä½œæµ"
- æ‰§è¡ŒçŠ¶æ€: "æœªçŸ¥"
- æ‰§è¡Œæ—¶é•¿: "-"
- å¼€å§‹æ—¶é—´: "-"
- ç»“æŸæ—¶é—´: "-"
- åˆ›å»ºäºº: "-"

### ä¿®å¤å
- å·¥ä½œæµåç§°: "æ™ºèƒ½å®¢æœå·¥ä½œæµ" (å®é™…åç§°)
- æ‰§è¡ŒçŠ¶æ€: "æˆåŠŸ" (å®é™…çŠ¶æ€)
- æ‰§è¡Œæ—¶é•¿: "5.2ç§’" (è®¡ç®—å€¼)
- å¼€å§‹æ—¶é—´: "2025-11-12 10:00:00" (åˆ›å»ºæ—¶é—´)
- ç»“æŸæ—¶é—´: "2025-11-12 10:00:05" (æ›´æ–°æ—¶é—´)
- åˆ›å»ºäºº: "å¼ ä¸‰" (å®é™…åˆ›å»ºäºº)

---

## âš ï¸ é£é™©ä¸ç¼“è§£

### é£é™©1: APIæ€§èƒ½é—®é¢˜
**é£é™©**: å¦‚æœç”¨æˆ·é¢‘ç¹ç‚¹å‡»"æ‰§è¡Œè¯¦æƒ…",å¯èƒ½äº§ç”Ÿå¤§é‡æŸ¥è¯¢

**ç¼“è§£æªæ–½**:
- âœ… ä¸»é”®æŸ¥è¯¢æ€§èƒ½ä¼˜ç§€(äºšæ¯«ç§’çº§)
- âœ… ä½é¢‘æ“ä½œ(ç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»)
- æœªæ¥ä¼˜åŒ–: å¯è€ƒè™‘å‰ç«¯ç¼“å­˜(ç¬¬ä¸€æ¬¡æŸ¥è¯¢åç¼“å­˜ç»“æœ)

### é£é™©2: æ•°æ®ä¸ä¸€è‡´
**é£é™©**: å·¥ä½œæµä»åœ¨è¿è¡Œæ—¶,æ•°æ®å¯èƒ½ä¸å®Œæ•´

**ç¼“è§£æªæ–½**:
- âœ… è¿è¡Œä¸­çš„å·¥ä½œæµ `u_time` ä¸ºnull,è®¡ç®— `elapsed_time` æ—¶è·³è¿‡
- âœ… å‰ç«¯å¯¹è¯æ¡†å¯å¤„ç†nullå€¼(æ˜¾ç¤º"-"æˆ–ç©ºç™½)

### é£é™©3: å…³è”æ•°æ®åˆ é™¤
**é£é™©**: å·¥ä½œæµå®šä¹‰è¢«åˆ é™¤,æ— æ³•æŸ¥è¯¢ `workflow_name`

**ç¼“è§£æªæ–½**:
- âœ… ä»£ç ä¸­æ£€æŸ¥ `workflow != null`
- âœ… `workflow_name` ä¸ºnullæ—¶å‰ç«¯æ˜¾ç¤ºé»˜è®¤å€¼

---

## ğŸ“ æ€»ç»“

### æ–¹æ¡ˆä¼˜ç‚¹
1. âœ… **æœ€å°åŒ–ä¿®æ”¹**: åªæ–°å¢ä»£ç ,ä¸ä¿®æ”¹ç°æœ‰é€»è¾‘
2. âœ… **é›¶ç ´åæ€§**: å®Œå…¨å‘åå…¼å®¹
3. âœ… **æ€§èƒ½ä¼˜ç§€**: ä¸»é”®æŸ¥è¯¢,ä½é¢‘æ“ä½œ
4. âœ… **æŒ‰éœ€åŠ è½½**: åªåœ¨ç”¨æˆ·éœ€è¦æ—¶æŸ¥è¯¢
5. âœ… **ä»£ç ç®€æ´**: æ€»è®¡112è¡Œ,å……åˆ†å¤ç”¨
6. âœ… **æ˜“äºæµ‹è¯•**: å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€åŠŸèƒ½æµ‹è¯•éƒ½å¾ˆæ¸…æ™°
7. âœ… **ç¬¦åˆKISSåŸåˆ™**: ç®€å•ã€å®ç”¨ã€æ— è¿‡åº¦è®¾è®¡

### æ–¹æ¡ˆç¼ºç‚¹
1. âš ï¸ **éœ€è¦é¢å¤–æŸ¥è¯¢**: å¢åŠ 1æ¬¡æ•°æ®åº“æŸ¥è¯¢(ä½†æ€§èƒ½å½±å“å¯å¿½ç•¥)
2. âš ï¸ **æ•°æ®å¯èƒ½ä¸ä¸€è‡´**: è¿è¡Œä¸­çš„å·¥ä½œæµæ•°æ®ä¸å®Œæ•´(ä½†å·²æœ‰é™çº§å¤„ç†)

### å®æ–½å»ºè®®
1. **ä¼˜å…ˆçº§**: é«˜ - ä¿®å¤ç°æœ‰åŠŸèƒ½ç¼ºé™·
2. **å·¥ä½œé‡**: å° - é¢„è®¡1-2å°æ—¶å®Œæˆå¼€å‘å’Œæµ‹è¯•
3. **ä¸Šçº¿é£é™©**: ä½ - é›¶ç ´åæ€§,å¯ç›´æ¥éƒ¨ç½²
4. **åç»­ä¼˜åŒ–**: å¯è€ƒè™‘å‰ç«¯ç¼“å­˜å‡å°‘æŸ¥è¯¢é¢‘ç‡(éå¿…éœ€)

---

**æ–¹æ¡ˆåˆ¶å®šäºº**: AI Assistant
**æ–¹æ¡ˆåˆ¶å®šæ—¶é—´**: 2025-11-12
**æ–¹æ¡ˆç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: å¾…å®¡æ‰¹
