# MCP Server 测试指南

## 一、测试环境准备

### 1.1 应用启动
```bash
cd D:\2025_project\20_project_in_github\00_scm_backend\scm_backend\scm-start
mvn spring-boot:run
```

**验证启动成功**：
- 日志中应该看到: `Started ScmApplication`
- 默认端口: `8088`
- MCP端点: `http://localhost:8088/scm/mcp`

### 1.2 配置信息
根据 `application.yml` 配置：
```yaml
spring:
  ai:
    mcp:
      server:
        transport: sse                    # 使用SSE传输
        sse:
          path: /mcp                      # MCP端点路径
        capabilities:
          tools:
            enabled: true                 # 工具调用能力
```

## 二、测试方法

### 方法1: 使用 MCP Inspector (推荐)

**MCP Inspector** 是 Anthropic 提供的官方测试工具。

**安装**：
```bash
npm install -g @modelcontextprotocol/inspector
```

**连接测试**：
```bash
# 方式1: 直接连接HTTP端点
mcp-inspector http://localhost:8088/scm/mcp

# 方式2: 使用SSE连接
mcp-inspector sse://localhost:8088/scm/mcp
```

**测试步骤**：
1. Inspector会显示可用的工具列表
2. 选择一个工具(如 `query_bins`)
3. 填写参数(如 `tenantId: "P00000025"`)
4. 执行并查看结果

---

### 方法2: 使用 Claude Desktop 配置

**配置文件位置**：
- Windows: `%APPDATA%\Claude\claude_desktop_config.json`
- macOS: `~/Library/Application Support/Claude/claude_desktop_config.json`

**配置内容**：
```json
{
  "mcpServers": {
    "scm-warehouse": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-http",
        "http://localhost:8088/scm/mcp"
      ]
    }
  }
}
```

**使用方法**：
1. 重启Claude Desktop
2. 在对话中输入: "查询所有库位"
3. Claude会自动调用 `query_bins` 工具

---

### 方法3: 直接HTTP请求测试

#### 3.1 查询可用工具列表
```bash
curl -X POST http://localhost:8088/scm/mcp/tools/list \
  -H "Content-Type: application/json" \
  -d '{}'
```

**预期响应**：
```json
{
  "tools": [
    {
      "name": "query_bins",
      "description": "查询库位信息...",
      "inputSchema": { ... }
    },
    {
      "name": "query_locations",
      "description": "查询库区信息...",
      "inputSchema": { ... }
    },
    ...
  ]
}
```

#### 3.2 调用具体工具
```bash
# 示例: 调用 query_bins 工具
curl -X POST http://localhost:8088/scm/mcp/tools/call \
  -H "Content-Type: application/json" \
  -d '{
    "name": "query_bins",
    "arguments": {
      "tenantId": "P00000025",
      "locationId": 1
    }
  }'
```

**预期响应**：
```json
{
  "content": [
    {
      "type": "text",
      "text": "{\"success\": true, \"data\": [...], \"toolName\": \"query_bins\"}"
    }
  ]
}
```

---

### 方法4: 使用 Postman 测试集合

**导入以下请求集合**：

**请求1: 列出所有工具**
```
POST http://localhost:8088/scm/mcp/tools/list
Content-Type: application/json

{}
```

**请求2: 查询库位**
```
POST http://localhost:8088/scm/mcp/tools/call
Content-Type: application/json

{
  "name": "query_bins",
  "arguments": {
    "tenantId": "P00000025",
    "locationId": 1,
    "status": "ENABLED"
  }
}
```

**请求3: 查询库区**
```
POST http://localhost:8088/scm/mcp/tools/call
Content-Type: application/json

{
  "name": "query_locations",
  "arguments": {
    "tenantId": "P00000025",
    "warehouseId": 1
  }
}
```

**请求4: 查询仓库**
```
POST http://localhost:8088/scm/mcp/tools/call
Content-Type: application/json

{
  "name": "query_warehouses",
  "arguments": {
    "tenantId": "P00000025",
    "status": "ENABLED"
  }
}
```

---

## 三、完整测试用例

### 3.1 库位管理工具测试

#### TC001: 查询所有库位
```json
{
  "tool": "query_bins",
  "input": {
    "tenantId": "P00000025"
  },
  "expected": {
    "success": true,
    "data": [...]
  }
}
```

#### TC002: 按库区查询库位
```json
{
  "tool": "query_bins",
  "input": {
    "tenantId": "P00000025",
    "locationId": 1
  },
  "expected": {
    "success": true,
    "data": [...]
  }
}
```

#### TC003: 按编码查找库位
```json
{
  "tool": "find_bin_by_code",
  "input": {
    "tenantId": "P00000025",
    "code": "A01-01-01"
  },
  "expected": {
    "success": true,
    "data": {...}
  }
}
```

### 3.2 库区管理工具测试

#### TC004: 查询所有库区
```json
{
  "tool": "query_locations",
  "input": {
    "tenantId": "P00000025"
  },
  "expected": {
    "success": true,
    "data": [...]
  }
}
```

#### TC005: 按仓库查询库区
```json
{
  "tool": "query_locations_by_warehouse",
  "input": {
    "tenantId": "P00000025",
    "warehouseId": 1
  },
  "expected": {
    "success": true,
    "data": [...]
  }
}
```

### 3.3 仓库管理工具测试

#### TC006: 查询所有仓库
```json
{
  "tool": "query_warehouses",
  "input": {
    "tenantId": "P00000025"
  },
  "expected": {
    "success": true,
    "data": [...]
  }
}
```

#### TC007: 查询仓库详情
```json
{
  "tool": "get_warehouse_detail",
  "input": {
    "tenantId": "P00000025",
    "warehouseId": 1
  },
  "expected": {
    "success": true,
    "data": {...}
  }
}
```

---

## 四、常见问题排查

### 4.1 应用启动失败
**检查**：
- MySQL是否运行 (127.0.0.1:3306)
- Redis是否运行 (127.0.0.1:6379)
- 端口8088是否被占用

### 4.2 MCP端点404
**检查**：
- 访问 `http://localhost:8088/scm/actuator/health` 确认应用正常
- 确认 `spring.ai.mcp.server.sse.path=/mcp` 配置正确
- 查看日志是否有MCP Server初始化错误

### 4.3 工具调用失败
**检查**：
- 租户ID是否正确 (需要在数据库中存在)
- 参数是否符合工具定义的要求
- 查看应用日志中的异常信息

### 4.4 权限问题
**检查**：
- Spring Security配置是否放行了 `/mcp` 路径
- JWT token是否有效(如果需要认证)

---

## 五、性能测试

### 5.1 并发测试
```bash
# 使用Apache Bench测试并发性能
ab -n 1000 -c 10 -p query.json -T application/json http://localhost:8088/scm/mcp/tools/call
```

### 5.2 响应时间监控
- 正常查询: < 100ms
- 复杂查询: < 500ms
- 大数据量: < 1000ms

---

## 六、集成测试脚本

### 6.1 Python测试脚本
```python
import requests
import json

BASE_URL = "http://localhost:8088/scm/mcp"

def test_list_tools():
    response = requests.post(f"{BASE_URL}/tools/list", json={})
    print("Available tools:", json.dumps(response.json(), indent=2))
    return response.json()

def test_query_bins(tenant_id, location_id=None):
    payload = {
        "name": "query_bins",
        "arguments": {
            "tenantId": tenant_id
        }
    }
    if location_id:
        payload["arguments"]["locationId"] = location_id

    response = requests.post(f"{BASE_URL}/tools/call", json=payload)
    print("Query bins result:", json.dumps(response.json(), indent=2))
    return response.json()

if __name__ == "__main__":
    # 测试1: 列出所有工具
    tools = test_list_tools()

    # 测试2: 查询库位
    bins = test_query_bins("P00000025", location_id=1)
```

### 6.2 Node.js测试脚本
```javascript
const axios = require('axios');

const BASE_URL = 'http://localhost:8088/scm/mcp';

async function testListTools() {
  const response = await axios.post(`${BASE_URL}/tools/list`, {});
  console.log('Available tools:', JSON.stringify(response.data, null, 2));
  return response.data;
}

async function testQueryBins(tenantId, locationId) {
  const payload = {
    name: 'query_bins',
    arguments: { tenantId, locationId }
  };
  const response = await axios.post(`${BASE_URL}/tools/call`, payload);
  console.log('Query bins result:', JSON.stringify(response.data, null, 2));
  return response.data;
}

(async () => {
  await testListTools();
  await testQueryBins('P00000025', 1);
})();
```

---

## 七、测试检查清单

- [ ] 应用成功启动，无错误日志
- [ ] MCP端点可访问 (`/scm/mcp`)
- [ ] 工具列表返回18个工具
- [ ] 每个工具都有正确的描述和参数定义
- [ ] 实际调用工具返回预期结果
- [ ] 错误处理正确(如租户不存在、参数错误等)
- [ ] 响应格式统一(JSON with success/data/message)
- [ ] 性能满足要求(响应时间<500ms)
- [ ] 日志记录完整(入参、出参、异常)
- [ ] 安全性验证(权限控制、参数校验)

---

## 八、下一步改进

根据QA审查结果，建议：

### P0优先级
1. **验证向后兼容性**: 确认现有AI Chat功能不受影响
2. **明确真实需求**: 确认是否有真实的MCP客户端使用场景

### P1优先级
1. **统一响应格式**: 成功/失败返回结构一致
2. **抽取模板方法**: 消除900行重复代码
3. **简化配置**: 删除未使用的capability配置

---

**文档版本**: v1.0
**创建日期**: 2025-11-13
**作者**: SCM开发团队
