# 修复AI-Chat工作流执行详情数据传递问题

**日期**: 2025-11-11
**状态**: 已完成
**类型**: Bug修复

## 问题描述

用户在AI Chat界面点击"执行详情"按钮时，显示错误消息："该消息没有关联的工作流执行记录"，即使数据库中确实存在相关的工作流运行时记录。

### 问题现象

1. 数据库表有数据：
   - `ai_conversation_content` - 对话内容记录 ✅
   - `ai_conversation_workflow_runtime` - 工作流运行时记录 ✅
   - `ai_conversation_workflow_runtime_node` - 节点执行记录 ✅

2. 前端表现：
   - "执行详情"按钮可见
   - 点击按钮后提示"该消息没有关联的工作流执行记录"
   - 弹窗不显示

### 根本原因

**数据流断裂**：WorkflowEngine在发送done事件时，只传递了工作流输出内容（outputStr字符串），没有包含runtime元数据（runtime_id、runtime_uuid、workflow_uuid）。

**问题链路**：
```
WorkflowEngine.java (line 323)
  └─ streamHandler.sendComplete(outputStr) ❌ 只传字符串
      └─ WorkflowStarter.java
          └─ callback.onComplete(data)
              └─ AiConversationController.convertWorkflowEventToResponse()
                  └─ 尝试从event.data提取runtime信息 ❌ 数据不存在
                      └─ 前端onComplete收到chatResponse
                          └─ chatResponse.runtimeId = null ❌
                              └─ message.workflowRuntime = null ❌
                                  └─ 按钮显示但点击报错 ❌
```

## 解决方案

### 核心思路

修改done事件的data格式，从单纯的输出字符串改为包含runtime元数据的JSON对象。

**修改前**：
```json
{
  "event": "done",
  "data": "{\"key\":\"工作流输出内容\"}"
}
```

**修改后**：
```json
{
  "event": "done",
  "data": "{\"content\":\"{\\\"key\\\":\\\"工作流输出内容\\\"}\",\"runtime_id\":123,\"runtime_uuid\":\"uuid-string\",\"workflow_uuid\":\"wf-uuid\"}"
}
```

### 修改文件清单

#### 后端修改

**1. WorkflowEngine.java** (关键修改)

**位置**: `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WorkflowEngine.java`
**行号**: 318-341

**修改前**：
```java
if (StringUtils.isBlank(outputStr)) {
    outputStr = "{}";
}

// 发送完成事件
streamHandler.sendComplete(outputStr);
```

**修改后**：
```java
if (StringUtils.isBlank(outputStr)) {
    outputStr = "{}";
}

// 构建包含runtime元数据的完成事件数据
JSONObject completeData = new JSONObject();
completeData.put("content", outputStr);

// 添加runtime信息（用于前端查询执行详情）
if (this.wfRuntimeResp != null) {
    // Workflow独立测试场景
    completeData.put("runtime_id", this.wfRuntimeResp.getId());
    completeData.put("runtime_uuid", this.wfRuntimeResp.getRuntimeUuid());
    completeData.put("workflow_uuid", this.workflow.getWorkflowUuid());
} else if (this.conversationRuntimeResp != null) {
    // AI Chat场景
    completeData.put("runtime_id", this.conversationRuntimeResp.getId());
    completeData.put("runtime_uuid", this.conversationRuntimeResp.getRuntimeUuid());
    completeData.put("workflow_uuid", this.workflow.getWorkflowUuid());
}
// 子工作流不需要添加runtime信息（复用父runtime，但前端不需要显示子工作流的执行详情按钮）

// 发送完成事件
streamHandler.sendComplete(completeData.toJSONString());
```

**2. AiConversationController.java**

**位置**: `scm-ai/src/main/java/com/xinyirun/scm/ai/controller/chat/AiConversationController.java`
**行号**: 484-518

**修改内容**：
- 从done事件的JSON数据中提取`content`字段
- 更新ChatResponseVo中的content（因为现在data是JSON对象，不再是纯字符串）
- 提取并设置runtime元数据（runtime_id、runtime_uuid、workflow_uuid）

**关键代码**：
```java
// 提取content字段（新格式：done事件的data是JSON对象，包含content和runtime信息）
String content = dataJson.getString("content");
if (content != null) {
    // 更新response中的content
    response.getResults().get(0).getOutput().setContent(content);
}

// 提取runtime信息
String runtimeUuid = dataJson.getString("runtime_uuid");
Long runtimeId = dataJson.getLong("runtime_id");
String workflowUuid = dataJson.getString("workflow_uuid");
```

#### 前端修改

**3. MessageList.vue**

**位置**: `scm_frontend/src/components/70_ai/components/chat/messages/MessageList.vue`
**行号**: 247-255

**修改内容**：恢复按钮的条件显示逻辑（之前为了测试暂时移除了v-if）

**修改后**：
```vue
<el-button
  v-if="message.workflowRuntime && message.workflowRuntime.id"
  type="text"
  size="mini"
  icon="el-icon-document"
  class="bubble-action-btn"
  title="执行详情"
  @click="showExecutionDetail(message)"
/>
```

**说明**：只有当消息对象包含workflowRuntime且有id时，才显示"执行详情"按钮。

### 数据流向（修复后）

```
1. WorkflowEngine执行完成
   └─ 构建completeData JSON对象
       ├─ content: 工作流输出
       ├─ runtime_id: 运行时主键
       ├─ runtime_uuid: 运行时UUID
       └─ workflow_uuid: 工作流UUID

2. streamHandler.sendComplete(completeData.toJSONString())
   └─ WorkflowStarter发送done事件

3. 前端SSE接收done事件
   └─ aiChatService.js解析ChatResponse
       └─ onComplete(content, chatResponse) ✅ chatResponse包含runtime信息

4. Vuex store处理onComplete
   └─ 从chatResponse提取runtime信息 ✅
       └─ 构建workflowRuntime对象
           └─ 保存到message.workflowRuntime ✅

5. 用户点击"执行详情"按钮
   └─ showExecutionDetail(message) ✅
       └─ message.workflowRuntime.id存在 ✅
           └─ 调用API获取节点详情 ✅
               └─ 弹窗显示执行详情 ✅
```

## 测试验证

### 前置条件

1. 清空测试数据（可选）：
```sql
TRUNCATE TABLE ai_conversation_content;
TRUNCATE TABLE ai_conversation_workflow_runtime;
TRUNCATE TABLE ai_conversation_workflow_runtime_node;
```

2. 重启后端服务：
```bash
cd scm-start
mvn spring-boot:run
```

3. 清除浏览器缓存并刷新前端

### 测试步骤

1. **发送测试消息**
   - 在AI Chat界面输入一条消息（例如："请帮我分析一下库存情况"）
   - 等待AI回复完成

2. **验证按钮显示**
   - AI回复消息下方的操作按钮区域应该显示"执行详情"按钮（文档图标）
   - 如果按钮不显示，说明workflowRuntime数据未正确传递

3. **点击执行详情按钮**
   - 点击"执行详情"按钮
   - 应该打开执行详情弹窗，显示：
     - 工作流基本信息（名称、状态、执行时长、开始/结束时间）
     - 节点执行详情列表（时间线展示）
     - 每个节点的输入数据、输出数据、状态

4. **验证数据库记录**
```sql
-- 查询运行时记录
SELECT id, runtime_uuid, workflow_uuid, status, start_time, end_time
FROM ai_conversation_workflow_runtime
ORDER BY c_time DESC LIMIT 1;

-- 查询节点执行记录
SELECT id, node_title, status, input_data, output_data, c_time
FROM ai_conversation_workflow_runtime_node
WHERE wf_runtime_id = (
  SELECT id FROM ai_conversation_workflow_runtime
  ORDER BY c_time DESC LIMIT 1
)
ORDER BY c_time;
```

### 预期结果

✅ **正确结果**：
- AI回复消息下方显示"执行详情"按钮
- 点击按钮打开弹窗，显示完整的工作流执行信息
- 节点详情按时间线展示，包含输入/输出数据

❌ **错误结果**（已修复）：
- 点击按钮后提示"该消息没有关联的工作流执行记录"
- 弹窗不显示

## 影响范围

### 受益功能

1. ✅ **AI Chat执行详情查看**：用户可以正常查看工作流执行过程
2. ✅ **问题排查**：开发人员和运维人员可以通过执行详情快速定位问题
3. ✅ **用户体验**：完整的功能闭环，提升用户信任度

### 无影响功能

- ✅ 工作流正常执行流程不受影响
- ✅ AI Chat基础对话功能不受影响
- ✅ 流式输出不受影响
- ✅ 其他SSE事件不受影响

### 兼容性说明

**向后兼容**：
- 修改只影响done事件的data格式
- 前端已经适配新格式（提取content字段）
- 如果旧格式的done事件到达，try-catch会优雅降级，不会崩溃

**数据库兼容**：
- 无需修改数据库表结构
- 现有数据无需迁移

## 技术细节

### JSON对象构建

```java
// WorkflowEngine.java - 构建完成事件数据
JSONObject completeData = new JSONObject();
completeData.put("content", outputStr);  // 工作流输出内容（JSON字符串）
completeData.put("runtime_id", runtimeId);  // Long类型主键
completeData.put("runtime_uuid", runtimeUuid);  // String类型UUID
completeData.put("workflow_uuid", workflowUuid);  // String类型工作流UUID
```

### 前端数据提取

```javascript
// chat.js - Vuex Store处理onComplete回调
const runtimeId = chatResponse.runtimeId || chatResponse.runtimeUuid
if (runtimeId) {
  workflowRuntime = {
    id: runtimeId,  // 优先使用runtimeId（数字ID），用于API查询
    uuid: chatResponse.runtimeUuid,  // UUID用于工作流恢复
    workflowUuid: chatResponse.workflowUuid,  // 工作流UUID
    isWaitingInput: chatResponse.isWaitingInput,
    isComplete: chatResponse.isComplete
  }
}
```

### API查询

```javascript
// MessageList.vue - 查询执行详情
async showExecutionDetail (message) {
  if (!message.workflowRuntime || !message.workflowRuntime.id) {
    this.$message.warning('该消息没有关联的工作流执行记录')
    return
  }

  // 使用runtime_id（数字主键）查询
  const nodes = await aiChatService.getConversationRuntimeNodeDetails(
    message.workflowRuntime.id
  )
  // ...
}
```

## 总结

### 问题本质

done事件数据格式不完整，只包含工作流输出内容，缺少runtime元数据。

### 解决方案

在WorkflowEngine发送done事件时，将data从字符串改为JSON对象，同时包含content和runtime信息。

### 修改影响

- ✅ 最小化修改：只涉及3个文件
- ✅ 向后兼容：优雅降级，不会破坏现有功能
- ✅ 完整闭环：从数据生成→传输→存储→查询→展示，全链路打通

### 验证方法

1. 后端编译通过 ✅
2. 前端构建通过 ✅
3. 功能测试通过 ⏳（需要用户测试确认）

---

**修复完成时间**: 2025-11-11 23:31
**编译状态**: ✅ BUILD SUCCESS
**待测试**: 需要重启后端服务并清除浏览器缓存后测试
