# MCP标准化改造 - 详细开发设计文档

## 一、改造目标

### 1.1 核心目标
将现有Spring AI工具集成从 `@Tool` 注解改造为标准MCP协议的 `@McpTool` 注解,实现内部MCP标准化。

### 1.2 具体要求
- ✅ 使用 `@McpTool` 替代 `@Tool` 注解
- ✅ 统一租户参数名为 `tenantCode`(当前为`tenantId`)
- ✅ 每个工具方法内显式调用 `DataSourceHelper.use(tenantCode)` 切换数据源
- ✅ 仅内部使用,不对外提供MCP服务
- ❌ 不使用AOP等复杂方案
- ❌ 不增加额外配置复杂度

### 1.3 改造范围
**文件数量**: 3个工具类 + 1个依赖检查

**涉及文件**:
1. `scm-ai/pom.xml` - 依赖确认
2. `scm-ai/src/main/java/com/xinyirun/scm/ai/mcp/P00000025/tools/BinMcpTools.java`
3. `scm-ai/src/main/java/com/xinyirun/scm/ai/mcp/P00000025/tools/LocationMcpTools.java`
4. `scm-ai/src/main/java/com/xinyirun/scm/ai/mcp/P00000025/tools/WarehouseMcpTools.java`

---

## 二、详细改造方案(按文件)

### 文件1: `scm-ai/pom.xml`

#### 改造目的
确认Spring AI 1.1.0已包含MCP支持,无需添加额外依赖。

#### 改造内容
**仅需检查**,不需要修改。确认以下依赖存在:
```xml
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-starter-model-openai</artifactId>
</dependency>
```

#### 验证方式
编译通过后,检查是否能导入:
```java
import org.springframework.ai.mcp.McpTool;
```

---

### 文件2: `BinMcpTools.java`

#### 改造目的
将库位管理工具类标准化为MCP工具,并修复租户数据源切换问题。

#### 当前问题
1. 使用 `@Tool` 注解(非MCP标准)
2. 参数名为 `tenantId`,应统一为 `tenantCode`
3. **严重bug**: 方法接收tenantId但未调用 `DataSourceHelper.use()`,导致数据权限问题

#### 改造内容

**1. 导入语句修改**
```java
// 删除旧导入
import org.springframework.ai.model.function.Tool;
import org.springframework.ai.model.function.ToolParam;

// 添加新导入
import org.springframework.ai.mcp.McpTool;
import org.springframework.ai.mcp.McpParam;
import com.xinyirun.scm.common.utils.datasource.DataSourceHelper;
```

**2. 方法签名和实现修改**(共10个方法)

**方法1: queryBins**
```java
// 修改前
@Tool(description = "查询库位信息，支持按仓库、库区、编码、状态等条件查询库位列表，用于库位信息的查找和浏览")
public String queryBins(
        @ToolParam(description = "租户ID，用于数据权限控制") String tenantId,
        @ToolParam(description = "仓库ID，用于查询指定仓库的库位") Integer warehouseId,
        // ... 其他参数
) {
    try {
        Map<String, Object> result = binAiService.queryBins(warehouseId, locationId, code, name, status, goodsStatus, isDefault);
        return JSONObject.toJSONString(result);
    } catch (Exception e) {
        // ...
    }
}

// 修改后
@McpTool(description = "查询库位信息，支持按仓库、库区、编码、状态等条件查询库位列表，用于库位信息的查找和浏览")
public String queryBins(
        @McpParam(description = "租户编码，用于数据权限控制") String tenantCode,
        @McpParam(description = "仓库ID，用于查询指定仓库的库位") Integer warehouseId,
        @McpParam(description = "库区ID，用于查询指定库区的库位") Integer locationId,
        @McpParam(description = "库位编码，支持模糊查询") String code,
        @McpParam(description = "库位名称，支持模糊查询") String name,
        @McpParam(description = "启用状态：ENABLED-启用，DISABLED-停用") String status,
        @McpParam(description = "货物状态：EMPTY-空库位，ALLOCATED-预分配，OCCUPIED-有货") String goodsStatus,
        @McpParam(description = "是否默认库位") Boolean isDefault
) {
    try {
        // 【新增】切换租户数据源
        DataSourceHelper.use(tenantCode);

        Map<String, Object> result = binAiService.queryBins(warehouseId, locationId, code, name, status, goodsStatus, isDefault);
        return JSONObject.toJSONString(result);
    } catch (Exception e) {
        log.error("查询库位列表失败", e);
        Map<String, Object> errorResult = new HashMap<>();
        errorResult.put("success", false);
        errorResult.put("message", "查询库位列表失败: " + e.getMessage());
        return JSONObject.toJSONString(errorResult);
    } finally {
        // 【新增】清理数据源上下文
        DataSourceHelper.close();
    }
}
```

**改造模式**(适用于所有10个方法):
1. `@Tool` → `@McpTool`
2. `@ToolParam` → `@McpParam`
3. `tenantId` → `tenantCode`
4. 方法体开头添加: `DataSourceHelper.use(tenantCode);`
5. finally块添加: `DataSourceHelper.close();`

**需要改造的10个方法清单**:
1. ✅ `queryBins` - 查询库位列表
2. ✅ `getBinDetail` - 获取库位详情
3. ✅ `queryBinsByLocation` - 按库区查询库位
4. ✅ `queryBinsByWarehouse` - 按仓库查询库位
5. ✅ `findBinByCode` - 按编码查询库位
6. ✅ `findBinsByName` - 按名称查询库位
7. ✅ `checkBinStatus` - 检查库位状态
8. ✅ `getEnabledBins` - 获取启用的库位
9. ✅ `getDefaultBin` - 获取默认库位
10. ✅ `queryBinsByPosition` - 按位置查询库位

#### 完整代码示例(getBinDetail方法)
```java
@McpTool(description = "获取库位详细信息，包含库位的完整属性、位置信息、混放规则等")
public String getBinDetail(
        @McpParam(description = "租户编码") String tenantCode,
        @McpParam(description = "库位ID") int binId
) {
    try {
        // 切换租户数据源
        DataSourceHelper.use(tenantCode);

        Map<String, Object> result = binAiService.getBinDetail(binId);
        return JSONObject.toJSONString(result);
    } catch (Exception e) {
        log.error("获取库位详情失败: binId={}", binId, e);
        Map<String, Object> errorResult = new HashMap<>();
        errorResult.put("success", false);
        errorResult.put("message", "获取库位详情失败: " + e.getMessage());
        return JSONObject.toJSONString(errorResult);
    } finally {
        // 清理数据源上下文
        DataSourceHelper.close();
    }
}
```

---

### 文件3: `LocationMcpTools.java`

#### 改造目的
将库区管理工具类标准化为MCP工具,并修复租户数据源切换问题。

#### 改造内容

**1. 导入语句修改**
```java
// 删除旧导入
import org.springframework.ai.model.function.Tool;
import org.springframework.ai.model.function.ToolParam;

// 添加新导入
import org.springframework.ai.mcp.McpTool;
import org.springframework.ai.mcp.McpParam;
import com.xinyirun.scm.common.utils.datasource.DataSourceHelper;
```

**2. 需要改造的5个方法清单**:
1. ✅ `queryLocations` - 查询库区列表
2. ✅ `getLocationDetail` - 获取库区详情
3. ✅ `queryLocationsByWarehouse` - 按仓库查询库区
4. ✅ `findLocationByCode` - 按编码查询库区
5. ✅ `checkLocationStatus` - 检查库区状态

**改造模式**: 同 BinMcpTools.java

#### 代码示例(queryLocations方法)
```java
@McpTool(description = "查询库区信息，支持按仓库、编码、状态等条件查询库区列表，用于库区信息的查找和浏览")
public String queryLocations(
        @McpParam(description = "租户编码，用于数据权限控制") String tenantCode,
        @McpParam(description = "仓库ID，用于查询指定仓库的库区") Integer warehouseId,
        @McpParam(description = "库区编码，支持模糊查询") String code,
        @McpParam(description = "库区名称，支持模糊查询") String name,
        @McpParam(description = "启用状态：ENABLED-启用，DISABLED-停用") String status,
        @McpParam(description = "库区类型：STORAGE-存储区，PICKING-拣货区，RECEIVING-收货区，SHIPPING-发货区") String locationType
) {
    try {
        // 切换租户数据源
        DataSourceHelper.use(tenantCode);

        Map<String, Object> result = locationAiService.queryLocations(warehouseId, code, name, status, locationType);
        return JSONObject.toJSONString(result);
    } catch (Exception e) {
        log.error("查询库区列表失败", e);
        Map<String, Object> errorResult = new HashMap<>();
        errorResult.put("success", false);
        errorResult.put("message", "查询库区列表失败: " + e.getMessage());
        return JSONObject.toJSONString(errorResult);
    } finally {
        // 清理数据源上下文
        DataSourceHelper.close();
    }
}
```

---

### 文件4: `WarehouseMcpTools.java`

#### 改造目的
将仓库管理工具类标准化为MCP工具,并修复租户数据源切换问题。

#### 改造内容

**1. 导入语句修改**
```java
// 删除旧导入
import org.springframework.ai.model.function.Tool;
import org.springframework.ai.model.function.ToolParam;

// 添加新导入
import org.springframework.ai.mcp.McpTool;
import org.springframework.ai.mcp.McpParam;
import com.xinyirun.scm.common.utils.datasource.DataSourceHelper;
```

**2. 需要改造的7个方法清单**:
1. ✅ `queryWarehouses` - 查询仓库列表
2. ✅ `getWarehouseDetail` - 获取仓库详情
3. ✅ `findWarehouseByCode` - 按编码查询仓库
4. ✅ `findWarehouseByName` - 按名称查询仓库
5. ✅ `checkWarehouseStatus` - 检查仓库状态
6. ✅ `getEnabledWarehouses` - 获取启用的仓库
7. ✅ `getWarehouseStatistics` - 获取仓库统计信息

**改造模式**: 同 BinMcpTools.java

#### 代码示例(queryWarehouses方法)
```java
@McpTool(description = "查询仓库信息，支持按编码、名称、类型、状态等条件查询仓库列表，用于仓库信息的查找和浏览")
public String queryWarehouses(
        @McpParam(description = "租户编码，用于数据权限控制") String tenantCode,
        @McpParam(description = "仓库编码，支持模糊查询") String code,
        @McpParam(description = "仓库名称，支持模糊查询") String name,
        @McpParam(description = "仓库类型：SELF-自有仓，THIRD-第三方仓") String warehouseType,
        @McpParam(description = "启用状态：ENABLED-启用，DISABLED-停用") String status
) {
    try {
        // 切换租户数据源
        DataSourceHelper.use(tenantCode);

        Map<String, Object> result = warehouseAiService.queryWarehouses(code, name, warehouseType, status);
        return JSONObject.toJSONString(result);
    } catch (Exception e) {
        log.error("查询仓库列表失败", e);
        Map<String, Object> errorResult = new HashMap<>();
        errorResult.put("success", false);
        errorResult.put("message", "查询仓库列表失败: " + e.getMessage());
        return JSONObject.toJSONString(errorResult);
    } finally {
        // 清理数据源上下文
        DataSourceHelper.close();
    }
}
```

---

## 三、改造清单总览

### 3.1 文件改造统计

| 文件名 | 方法数 | 改造类型 | 预计工作量 |
|--------|--------|---------|-----------|
| BinMcpTools.java | 10 | 注解替换 + 数据源切换 | 30分钟 |
| LocationMcpTools.java | 5 | 注解替换 + 数据源切换 | 15分钟 |
| WarehouseMcpTools.java | 7 | 注解替换 + 数据源切换 | 20分钟 |
| **总计** | **22** | - | **65分钟** |

### 3.2 每个方法的改造检查清单

**对于每个 `@Tool` 方法**:
- [ ] 1. `@Tool` 改为 `@McpTool`
- [ ] 2. `@ToolParam` 改为 `@McpParam`
- [ ] 3. 第一个参数 `tenantId` 改为 `tenantCode`
- [ ] 4. 参数描述"租户ID" 改为 "租户编码"
- [ ] 5. try块开头添加: `DataSourceHelper.use(tenantCode);`
- [ ] 6. 添加finally块: `finally { DataSourceHelper.close(); }`
- [ ] 7. 确认导入 `DataSourceHelper`

---

## 四、测试验证方案

### 4.1 编译验证
```bash
cd scm-ai
mvn clean compile
```

**预期结果**: 编译成功,无错误

### 4.2 单元测试验证(可选)
创建测试类验证工具方法:
```java
@SpringBootTest
public class McpToolsTest {

    @Autowired
    private BinMcpTools binMcpTools;

    @Test
    public void testQueryBins() {
        String result = binMcpTools.queryBins(
            "tenant_001",  // tenantCode
            1,             // warehouseId
            null, null, null, null, null, null
        );

        // 验证返回结果不为空
        assertNotNull(result);

        // 验证数据源已切换
        assertEquals("tenant_001", DataSourceHelper.getCurrentDataSourceName());
    }
}
```

### 4.3 集成测试验证
通过前端AI对话功能测试:
1. 发送消息: "查询1号仓库的所有库位"
2. AI调用 `queryBins` 工具
3. 验证返回的数据属于正确的租户

---

## 五、风险评估与预案

### 5.1 风险清单

| 风险项 | 风险等级 | 影响范围 | 预案 |
|--------|---------|---------|------|
| @McpTool注解不存在 | 中 | 编译失败 | 确认Spring AI版本≥1.0.0 |
| tenantCode为空导致数据源切换失败 | 高 | 数据权限错误 | 添加参数校验: `if(StringUtils.isEmpty(tenantCode)) throw ...` |
| finally块未执行导致数据源泄漏 | 中 | 后续请求数据错误 | 代码review确认所有方法都有finally |
| AI调用时未传递tenantCode | 高 | 工具调用失败 | 前端确保请求包含租户信息 |

### 5.2 回滚方案
如果改造失败,可通过Git回滚:
```bash
git checkout HEAD -- scm-ai/src/main/java/com/xinyirun/scm/ai/mcp/P00000025/tools/
```

---

## 六、实施计划

### 6.1 实施步骤

**阶段1: 准备工作**(5分钟)
1. 确认pom.xml包含MCP支持
2. 备份3个工具类文件

**阶段2: 代码改造**(60分钟)
1. 改造 BinMcpTools.java (30分钟)
2. 改造 LocationMcpTools.java (15分钟)
3. 改造 WarehouseMcpTools.java (20分钟)

**阶段3: 编译验证**(5分钟)
1. 执行 `mvn clean compile`
2. 修复编译错误(如有)

**阶段4: 代码审查**(10分钟)
1. 逐文件review改造内容
2. 确认所有方法都有数据源切换和清理

**阶段5: 提交代码**(5分钟)
1. Git add & commit
2. 推送到远程仓库

**总计**: 85分钟

---

## 七、代码规范要求

### 7.1 命名规范
- ✅ 参数名: `tenantCode` (不是 tenantId, tenant_code)
- ✅ 注解: `@McpTool`, `@McpParam` (大小写严格)
- ✅ 方法名: 保持不变

### 7.2 代码格式
```java
// 标准格式
@McpTool(description = "工具描述")
public String methodName(
        @McpParam(description = "参数描述") String tenantCode,
        @McpParam(description = "参数描述") Type param
) {
    try {
        DataSourceHelper.use(tenantCode);

        // 业务逻辑

    } catch (Exception e) {
        // 异常处理
    } finally {
        DataSourceHelper.close();
    }
}
```

### 7.3 异常处理
- ✅ 必须有try-catch-finally
- ✅ finally中必须调用 `DataSourceHelper.close()`
- ✅ catch中返回JSON格式错误信息

---

## 八、关键注意事项

### ⚠️ 严格要求
1. **每个方法都必须添加数据源切换**: 不能遗漏任何一个
2. **finally块必须清理**: 防止数据源上下文泄漏
3. **参数名统一**: 所有方法第一个参数都是 `tenantCode`
4. **不使用AOP**: 手动在每个方法添加,不封装
5. **保持简单**: 不添加额外的配置或抽象

### ✅ 改造要点
- 改造是**纯替换**,不改变业务逻辑
- Service层(如BinAiService)完全不需要修改
- 工具方法签名保持一致(除了tenantId→tenantCode)
- 返回值格式不变

---

## 九、附录

### 9.1 导入语句对照表

**需要删除**:
```java
import org.springframework.ai.model.function.Tool;
import org.springframework.ai.model.function.ToolParam;
```

**需要添加**:
```java
import org.springframework.ai.mcp.McpTool;
import org.springframework.ai.mcp.McpParam;
import com.xinyirun.scm.common.utils.datasource.DataSourceHelper;
```

### 9.2 完整改造模板

```java
// ===== 改造前 =====
@Tool(description = "XXX")
public String methodName(
        @ToolParam(description = "租户ID") String tenantId,
        @ToolParam(description = "参数") Type param
) {
    try {
        // 业务逻辑
        return result;
    } catch (Exception e) {
        // 错误处理
    }
}

// ===== 改造后 =====
@McpTool(description = "XXX")
public String methodName(
        @McpParam(description = "租户编码") String tenantCode,
        @McpParam(description = "参数") Type param
) {
    try {
        // 【新增】数据源切换
        DataSourceHelper.use(tenantCode);

        // 业务逻辑(不变)
        return result;
    } catch (Exception e) {
        // 错误处理(不变)
    } finally {
        // 【新增】数据源清理
        DataSourceHelper.close();
    }
}
```

---

## 十、开发自检表

改造完成后,开发人员需逐项检查:

- [ ] 1. 所有 `@Tool` 已改为 `@McpTool`
- [ ] 2. 所有 `@ToolParam` 已改为 `@McpParam`
- [ ] 3. 所有 `tenantId` 已改为 `tenantCode`
- [ ] 4. 所有方法都有 `DataSourceHelper.use(tenantCode)`
- [ ] 5. 所有方法都有 `finally { DataSourceHelper.close(); }`
- [ ] 6. 导入语句已更新
- [ ] 7. 编译通过无错误
- [ ] 8. 代码格式符合规范
- [ ] 9. 异常处理逻辑完整
- [ ] 10. 已进行Git提交

---

**文档编写时间**: 2025-11-16 16:16:39
**文档版本**: v1.0
**适用范围**: scm-ai模块 MCP标准化改造
**预计实施时间**: 85分钟
