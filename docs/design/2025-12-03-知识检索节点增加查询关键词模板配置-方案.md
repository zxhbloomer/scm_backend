# çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹å¢åŠ æŸ¥è¯¢å…³é”®è¯æ¨¡æ¿é…ç½® - å®æ–½æ–¹æ¡ˆ

**æ–¹æ¡ˆç¼–å·**: 2025-12-03-001
**åˆ›å»ºæ—¶é—´**: 2025-12-03
**éœ€æ±‚æ¥æº**: ç”¨æˆ·éœ€æ±‚ - æå‡çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹çš„çµæ´»æ€§
**æ–¹æ¡ˆçŠ¶æ€**: å¾…å®¡æ‰¹

---

## 1. éœ€æ±‚èƒŒæ™¯

### 1.1 å½“å‰é—®é¢˜

å½“å‰çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹åªèƒ½ä½¿ç”¨ä¸Šæ¸¸èŠ‚ç‚¹çš„å…¨éƒ¨è¾“å‡ºä½œä¸ºæŸ¥è¯¢å…³é”®è¯,å­˜åœ¨ä»¥ä¸‹é™åˆ¶:

1. **æ— æ³•çµæ´»ç»„åˆå˜é‡** - ä¸èƒ½ç»„åˆå¤šä¸ªå˜é‡æ„å»ºæŸ¥è¯¢(å¦‚"${å…¬å¸}çš„${ä¸»é¢˜}ç›¸å…³æ–‡æ¡£")
2. **æ— æ³•æ·»åŠ å›ºå®šæ–‡æœ¬** - ä¸èƒ½åœ¨æŸ¥è¯¢å‰åæ·»åŠ å›ºå®šå‰ç¼€/åç¼€(å¦‚"è¯·é—®å…³äº'${input}'çš„è¯¦ç»†è¯´æ˜")
3. **ç”¨æˆ·ä½“éªŒä¸ä¸€è‡´** - LLMèŠ‚ç‚¹ã€æ¨¡æ¿èŠ‚ç‚¹éƒ½æ”¯æŒå˜é‡å¼•ç”¨,è€ŒçŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹ä¸æ”¯æŒ

### 1.2 éœ€æ±‚ç›®æ ‡

åœ¨çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹ä¸­å¢åŠ "æŸ¥è¯¢å…³é”®è¯"é…ç½®é¡¹,æ”¯æŒä»¥ä¸‹åŠŸèƒ½:

1. æ”¯æŒ`${å˜é‡å}`è¯­æ³•å¼•ç”¨è¾“å…¥å˜é‡
2. æ”¯æŒ`${input}`å¼•ç”¨ä¸Šæ¸¸èŠ‚ç‚¹çš„é»˜è®¤è¾“å‡º
3. é»˜è®¤å€¼ä¸º`${input}`,ä¿è¯å‘åå…¼å®¹
4. ä¸LLMèŠ‚ç‚¹çš„æç¤ºè¯é…ç½®ä¿æŒä¸€è‡´çš„ä½¿ç”¨ä½“éªŒ

---

## 2. æŠ€æœ¯æ–¹æ¡ˆ

### 2.1 æ ¸å¿ƒè®¾è®¡æ€æƒ³

**å®Œå…¨å¤ç”¨ç°æœ‰æœºåˆ¶** - ä½¿ç”¨å·²æœ‰çš„`WorkflowUtil.renderTemplate()`æ¨¡æ¿æ¸²æŸ“å¼•æ“,æ— éœ€å¼•å…¥æ–°æŠ€æœ¯æ ˆã€‚

**é™çº§é€»è¾‘ä¿éšœ** - é…ç½®ä¸ºç©ºæ—¶,è‡ªåŠ¨é™çº§ä¸º`getFirstInputText()`,ç¡®ä¿å‘åå…¼å®¹ã€‚

### 2.2 å®Œæ•´è°ƒç”¨é“¾è·¯åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å·¥ä½œæµæ‰§è¡Œæµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·åœ¨å‰ç«¯é…ç½®çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹                                   â”‚
â”‚    - é…ç½®query_template = "${var_company}çš„${var_topic}æ–‡æ¡£"    â”‚
â”‚    - é…ç½®è¾“å…¥å˜é‡: var_company, var_topic                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å‰ç«¯ä¿å­˜èŠ‚ç‚¹é…ç½®                                             â”‚
â”‚    KnowledgeRetrievalNodeProperty.vue:nodeConfig                â”‚
â”‚    â†’ WorkflowDesigner â†’ APIè°ƒç”¨ â†’ åç«¯ä¿å­˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å·¥ä½œæµè¿è¡Œæ—¶,èŠ‚ç‚¹æ‰§è¡Œ                                        â”‚
â”‚    WorkflowEngine â†’ KnowledgeRetrievalNode.onProcess()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è·å–æŸ¥è¯¢å…³é”®è¯ (æ–°å¢é€»è¾‘)                                    â”‚
â”‚    KnowledgeRetrievalNode.onProcess():                          â”‚
â”‚    if (StringUtils.isNotBlank(nodeConfig.getQueryTemplate())) { â”‚
â”‚        textInput = WorkflowUtil.renderTemplate(                 â”‚
â”‚            nodeConfig.getQueryTemplate(),                       â”‚
â”‚            state.getInputs()                                    â”‚
â”‚        );                                                       â”‚
â”‚    } else {                                                     â”‚
â”‚        textInput = getFirstInputText(); // é™çº§é€»è¾‘             â”‚
â”‚    }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ¨¡æ¿æ¸²æŸ“ (å¤ç”¨ç°æœ‰å·¥å…·)                                      â”‚
â”‚    WorkflowUtil.renderTemplate():                               â”‚
â”‚    - éå† state.getInputs() è·å–æ‰€æœ‰è¾“å…¥å˜é‡                    â”‚
â”‚    - æ›¿æ¢æ¨¡æ¿ä¸­çš„ ${var_company} â†’ "åä¸º"                       â”‚
â”‚    - æ›¿æ¢æ¨¡æ¿ä¸­çš„ ${var_topic} â†’ "é‡‡è´­æµç¨‹"                     â”‚
â”‚    - è¿”å›æ¸²æŸ“ç»“æœ: "åä¸ºçš„é‡‡è´­æµç¨‹æ–‡æ¡£"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ‰§è¡ŒçŸ¥è¯†åº“æ£€ç´¢                                               â”‚
â”‚    MilvusVectorRetrievalService.searchSimilarDocuments(         â”‚
â”‚        textInput = "åä¸ºçš„é‡‡è´­æµç¨‹æ–‡æ¡£",                        â”‚
â”‚        kbUuid, topN, minScore                                   â”‚
â”‚    )                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. è¿”å›æ£€ç´¢ç»“æœ                                                 â”‚
â”‚    NodeProcessResult with æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·é…ç½®     â”‚
â”‚ query_templateâ”‚
â”‚ = "${input}" â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (ä¿å­˜åˆ°æ•°æ®åº“)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ai_workflow_node.node_config â”‚
â”‚ {                            â”‚
â”‚   "query_template": "${input}"â”‚
â”‚   "knowledge_base_uuid": "xx"â”‚
â”‚   ...                        â”‚
â”‚ }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (èŠ‚ç‚¹æ‰§è¡Œæ—¶è¯»å–)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KnowledgeRetrievalNode       â”‚
â”‚ nodeConfig.getQueryTemplate()â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (è°ƒç”¨æ¨¡æ¿æ¸²æŸ“)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WorkflowUtil.renderTemplate()     â”‚
â”‚ - template: "${input}"            â”‚
â”‚ - values: state.getInputs()       â”‚
â”‚   [                                â”‚
â”‚     {name:"input", value:"åˆåŒ"} â”‚
â”‚   ]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (æ›¿æ¢å˜é‡)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ textInput    â”‚
â”‚ = "åˆåŒ"     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (ç”¨äºæ£€ç´¢)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MilvusVectorRetrievalServiceâ”‚
â”‚ .searchSimilarDocuments()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ–‡ä»¶çº§å®æ–½è®¡åˆ’

### 3.1 åç«¯ä¿®æ”¹æ–‡ä»¶æ¸…å•

#### 3.1.1 é…ç½®ç±»ä¿®æ”¹

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/node/knowledgeretrieval/KnowledgeRetrievalNodeConfig.java`

**ä¿®æ”¹å†…å®¹**:

```java
package com.xinyirun.scm.ai.workflow.node.knowledgeretrieval;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

@Data
public class KnowledgeRetrievalNodeConfig {

    /**
     * çŸ¥è¯†åº“UUID
     */
    @JsonProperty("knowledge_base_uuid")
    private String knowledgeBaseUuid;

    /**
     * çŸ¥è¯†åº“åç§°
     */
    @JsonProperty("knowledge_base_name")
    private String knowledgeBaseName;

    /**
     * æŸ¥è¯¢å…³é”®è¯æ¨¡æ¿
     * æ”¯æŒ ${å˜é‡å} çš„å˜é‡æ›¿æ¢è¯­æ³•
     * ä¸ºç©ºæ—¶ä½¿ç”¨ä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡ºä½œä¸ºæŸ¥è¯¢å…³é”®è¯
     * é»˜è®¤å€¼: ${input}
     */
    @JsonProperty("query_template")
    private String queryTemplate;

    /**
     * ç›¸ä¼¼åº¦é˜ˆå€¼(0.0-1.0)
     */
    private Double score;

    /**
     * è¿”å›çš„æœ€å¤§ç»“æœæ•°
     */
    @JsonProperty("top_n")
    private Integer topN;

    /**
     * æ˜¯å¦ä¸¥æ ¼æ¨¡å¼
     */
    @JsonProperty("is_strict")
    private Boolean isStrict;

    /**
     * é»˜è®¤å“åº”å†…å®¹
     */
    @JsonProperty("default_response")
    private String defaultResponse;

    /**
     * æ˜¯å¦å¯ç”¨å›¾è°±æ£€ç´¢
     */
    @JsonProperty("enable_graph_retrieval")
    private Boolean enableGraphRetrieval;

    /**
     * å›¾è°±æ£€ç´¢ä½¿ç”¨çš„æ¨¡å‹åç§°
     */
    @JsonProperty("graph_model_name")
    private String graphModelName;
}
```

**ä¿®æ”¹è¯´æ˜**:
- æ–°å¢`queryTemplate`å­—æ®µ,ä½¿ç”¨`@JsonProperty("query_template")`æ˜ å°„å‰ç«¯é…ç½®
- æ·»åŠ è¯¦ç»†æ³¨é‡Šè¯´æ˜å­—æ®µç”¨é€”å’Œé»˜è®¤è¡Œä¸º

---

#### 3.1.2 èŠ‚ç‚¹é€»è¾‘ä¿®æ”¹

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/node/knowledgeretrieval/KnowledgeRetrievalNode.java`

**ä¿®æ”¹ä½ç½®**: `onProcess()` æ–¹æ³•çš„ç¬¬58-64è¡Œ

**åŸä»£ç **:
```java
// è·å–è¾“å…¥æ–‡æœ¬
String textInput = getFirstInputText();
if (StringUtils.isBlank(textInput)) {
    log.warn("çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹è¾“å…¥å†…å®¹ä¸ºç©º");
    return NodeProcessResult.builder()
            .content(List.of(NodeIOData.createByText(DEFAULT_OUTPUT_PARAM_NAME, "", "")))
            .build();
}
```

**æ–°ä»£ç **:
```java
// è·å–æŸ¥è¯¢å…³é”®è¯(æ”¯æŒæ¨¡æ¿æ¸²æŸ“)
String textInput;
if (StringUtils.isNotBlank(nodeConfig.getQueryTemplate())) {
    // ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“å¼•æ“
    textInput = WorkflowUtil.renderTemplate(nodeConfig.getQueryTemplate(), state.getInputs());
    log.info("ä½¿ç”¨æŸ¥è¯¢æ¨¡æ¿,æ¸²æŸ“åæŸ¥è¯¢å†…å®¹: {}", textInput);
} else {
    // é™çº§:ä½¿ç”¨ä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡º
    textInput = getFirstInputText();
    log.info("æœªé…ç½®æŸ¥è¯¢æ¨¡æ¿,ä½¿ç”¨ä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡º: {}", textInput);
}

if (StringUtils.isBlank(textInput)) {
    log.warn("çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹è¾“å…¥å†…å®¹ä¸ºç©º");
    return NodeProcessResult.builder()
            .content(List.of(NodeIOData.createByText(DEFAULT_OUTPUT_PARAM_NAME, "", "")))
            .build();
}
```

**ä¿®æ”¹è¯´æ˜**:
- ä¼˜å…ˆä½¿ç”¨`queryTemplate`æ¨¡æ¿æ¸²æŸ“
- æ¨¡æ¿ä¸ºç©ºæ—¶é™çº§ä¸º`getFirstInputText()`
- æ·»åŠ è¯¦ç»†æ—¥å¿—è®°å½•,ä¾¿äºè°ƒè¯•
- ä¿æŒåŸæœ‰çš„ç©ºå€¼æ£€æŸ¥é€»è¾‘

---

### 3.2 å‰ç«¯ä¿®æ”¹æ–‡ä»¶æ¸…å•

#### 3.2.1 å±æ€§é¢æ¿ç»„ä»¶ä¿®æ”¹

**æ–‡ä»¶**: `src/components/70_ai/components/workflow/components/properties/KnowledgeRetrievalNodeProperty.vue`

**ä¿®æ”¹å†…å®¹**:

**1. æ¨¡æ¿éƒ¨åˆ†æ–°å¢**:

åœ¨"çŸ¥è¯†åº“é€‰æ‹©"åŒºåŸŸå,æ·»åŠ ä»¥ä¸‹å†…å®¹:

```vue
<!-- ğŸ†• æ–°å¢:å¼•ç”¨è¾“å…¥é…ç½® -->
<node-property-input
  :workflow="workflow"
  :wf-node="wfNode"
/>

<!-- çŸ¥è¯†åº“é€‰æ‹© (ä¿æŒä¸å˜) -->
<div class="property-section">
  <div class="section-title">çŸ¥è¯†åº“</div>
  <wf-knowledge-selector
    :knowledge-base-uuid="nodeConfig.knowledge_base_uuid"
    @selected="handleKnowledgeSelected"
  />
</div>

<!-- ğŸ†• æ–°å¢:æŸ¥è¯¢å…³é”®è¯é…ç½® -->
<div class="property-section">
  <div class="section-title">
    æŸ¥è¯¢å…³é”®è¯
    <el-tooltip content="ä¸ºç©ºåˆ™ä½¿ç”¨ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºä½œä¸ºæŸ¥è¯¢å…³é”®è¯" placement="top">
      <i class="el-icon-question" style="color: #909399; font-size: 14px; margin-left: 4px;" />
    </el-tooltip>
  </div>

  <!-- å¼•ç”¨æç¤º -->
  <refer-comment />

  <!-- æŸ¥è¯¢å…³é”®è¯è¾“å…¥æ¡† -->
  <el-input
    v-model="nodeConfig.query_template"
    type="textarea"
    :autosize="{ minRows: 2, maxRows: 6 }"
    placeholder="è¯·è¾“å…¥æŸ¥è¯¢å…³é”®è¯,å¯ä½¿ç”¨ ${å˜é‡å} å¼•ç”¨è¾“å…¥å˜é‡"
  />
</div>
```

**2. Scriptéƒ¨åˆ†ä¿®æ”¹**:

```vue
<script>
import NodePropertyInput from '../NodePropertyInput.vue'  // ğŸ†• æ–°å¢
import ReferComment from '../ReferComment.vue'            // ğŸ†• æ–°å¢
import WfKnowledgeSelector from '../WfKnowledgeSelector.vue'
import WfLlmSelector from '../WfLLMSelector.vue'

export default {
  name: 'KnowledgeRetrievalNodeProperty',

  components: {
    NodePropertyInput,    // ğŸ†• æ–°å¢
    ReferComment,         // ğŸ†• æ–°å¢
    WfKnowledgeSelector,
    WfLlmSelector
  },

  props: {
    workflow: {
      type: Object,
      required: true
    },
    wfNode: {
      type: Object,
      required: true
    }
  },

  computed: {
    nodeConfig () {
      // åˆå§‹åŒ–é»˜è®¤å€¼
      if (!this.wfNode.nodeConfig.knowledge_base_uuid) {
        this.$set(this.wfNode.nodeConfig, 'knowledge_base_uuid', '')
      }
      if (!this.wfNode.nodeConfig.knowledge_base_name) {
        this.$set(this.wfNode.nodeConfig, 'knowledge_base_name', '')
      }
      // ğŸ†• æ–°å¢:åˆå§‹åŒ–æŸ¥è¯¢æ¨¡æ¿é»˜è®¤å€¼
      if (this.wfNode.nodeConfig.query_template === undefined) {
        this.$set(this.wfNode.nodeConfig, 'query_template', '${input}')
      }
      if (!this.wfNode.nodeConfig.top_n) {
        this.$set(this.wfNode.nodeConfig, 'top_n', 5)
      }
      if (!this.wfNode.nodeConfig.score) {
        this.$set(this.wfNode.nodeConfig, 'score', 0.5)
      }
      if (this.wfNode.nodeConfig.is_strict === undefined) {
        this.$set(this.wfNode.nodeConfig, 'is_strict', true)
      }
      if (this.wfNode.nodeConfig.enable_graph_retrieval === undefined) {
        this.$set(this.wfNode.nodeConfig, 'enable_graph_retrieval', false)
      }
      if (!this.wfNode.nodeConfig.default_response) {
        this.$set(this.wfNode.nodeConfig, 'default_response', 'å¾ˆæŠ±æ­‰,æˆ‘æ— æ³•æ‰¾åˆ°ç›¸å…³ç­”æ¡ˆã€‚')
      }
      if (!this.wfNode.nodeConfig.graph_model_name) {
        this.$set(this.wfNode.nodeConfig, 'graph_model_name', '')
      }
      return this.wfNode.nodeConfig
    }
  },

  methods: {
    handleKnowledgeSelected (uuid, name) {
      this.nodeConfig.knowledge_base_uuid = uuid
      this.nodeConfig.knowledge_base_name = name
      this.$set(this.wfNode.nodeConfig, 'knowledge_base_uuid', uuid)
      this.$set(this.wfNode.nodeConfig, 'knowledge_base_name', name)
      this.$nextTick(() => {
        this.$root.$emit('workflow:update-node', {
          nodeUuid: this.wfNode.uuid,
          nodeData: this.wfNode
        })
      })
    },

    handleGraphModelSelected (modelName) {
      this.nodeConfig.graph_model_name = modelName
      this.$set(this.wfNode.nodeConfig, 'graph_model_name', modelName)
      this.$nextTick(() => {
        this.$root.$emit('workflow:update-node', {
          nodeUuid: this.wfNode.uuid,
          nodeData: this.wfNode
        })
      })
    }
  }
}
</script>
```

**ä¿®æ”¹è¯´æ˜**:
- å¼•å…¥`NodePropertyInput`ç»„ä»¶,æä¾›è¾“å…¥å˜é‡é…ç½®åŠŸèƒ½
- å¼•å…¥`ReferComment`ç»„ä»¶,æ˜¾ç¤ºå˜é‡å¼•ç”¨æç¤º
- åœ¨`computed.nodeConfig`ä¸­åˆå§‹åŒ–`query_template`é»˜è®¤å€¼ä¸º`${input}`
- æ— éœ€æ–°å¢äº‹ä»¶å¤„ç†æ–¹æ³•,`v-model`è‡ªåŠ¨åŒæ­¥é…ç½®

---

## 4. KISSåŸåˆ™7é—®é¢˜å›ç­”

### 1. è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„?

âœ… **çœŸé—®é¢˜** - ç”¨æˆ·æ˜ç¡®æå‡ºéœ€æ±‚,å½“å‰çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹ç¡®å®æ— æ³•çµæ´»ç»„åˆå˜é‡,é™åˆ¶äº†å·¥ä½œæµçš„ä½¿ç”¨åœºæ™¯ã€‚

### 2. æœ‰æ›´ç®€å•çš„æ–¹æ³•å—?

âœ… **å·²æ˜¯æœ€ç®€æ–¹æ¡ˆ** - å®Œå…¨å¤ç”¨ç°æœ‰çš„`WorkflowUtil.renderTemplate()`,æ— éœ€å¼•å…¥æ–°æ¡†æ¶æˆ–å·¥å…·,åªéœ€æ·»åŠ 1ä¸ªé…ç½®å­—æ®µå’Œ10è¡Œä»£ç ã€‚

### 3. ä¼šç ´åä»€ä¹ˆå—?

âœ… **é›¶ç ´å** - é»˜è®¤å€¼`${input}`ç­‰åŒäºå½“å‰è¡Œä¸º,æ—§èŠ‚ç‚¹é…ç½®ä¸ºç©ºæ—¶è‡ªåŠ¨é™çº§ä¸º`getFirstInputText()`,å®Œå…¨å‘åå…¼å®¹ã€‚

### 4. å½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—?

âœ… **å¿…è¦åŠŸèƒ½** - æå‡å·¥ä½œæµçµæ´»æ€§,ä¸LLMèŠ‚ç‚¹ã€æ¨¡æ¿èŠ‚ç‚¹ä¿æŒä¸€è‡´çš„ç”¨æˆ·ä½“éªŒ,ç¬¦åˆç³»ç»Ÿè®¾è®¡ç†å¿µã€‚

### 5. è¿™ä¸ªé—®é¢˜è¿‡åº¦è®¾è®¡äº†å—?æœ‰ç¼ºå°‘å¿…è¦ä¿¡æ¯å—?èƒ½å¦ç»§ç»­è¯„ä¼°?

âœ… **è®¾è®¡åˆç†,ä¿¡æ¯å……è¶³** - å·²å®Œæ•´è°ƒç ”ç°æœ‰å®ç°,æŠ€æœ¯è·¯å¾„æ¸…æ™°,æ— è¿‡åº¦è®¾è®¡ã€‚æ•°æ®åº“è¡¨ç»“æ„ã€å‰ç«¯ç»„ä»¶ã€æ¨¡æ¿æ¸²æŸ“å¼•æ“éƒ½å·²éªŒè¯å¯ç”¨ã€‚

### 6. è¯é¢˜æ˜¯å¦æ¨¡ç³Š,æ˜¯å¦ä¼šå¯¼è‡´å¹»è§‰çš„äº§ç”Ÿ?

âœ… **éœ€æ±‚æ¸…æ™°** - éœ€æ±‚æ˜ç¡®,å·²æœ‰å‚è€ƒå®ç°(LLMèŠ‚ç‚¹),æŠ€æœ¯è·¯å¾„æ¸…æ™°,ä¸ä¼šäº§ç”Ÿå¹»è§‰ã€‚

### 7. æ˜¯å¦å·²ç»å­¦ä¹ äº†å…³äºä»£ç å®æ–½çš„æ³¨æ„äº‹é¡¹çš„å†…å®¹?

âœ… **å·²æ·±åˆ»å­¦ä¹ ** - æœ¬æ–¹æ¡ˆä¸¥æ ¼éµå¾ª:
- **å¤ç”¨ç°æœ‰ä»£ç ** - ä½¿ç”¨`WorkflowUtil.renderTemplate()`
- **é¿å…é‡å¤å®ç°** - ä¸æ–°å»ºå·¥å…·ç±»,ç›´æ¥å¤ç”¨
- **Beanæ“ä½œè§„èŒƒ** - æ— éœ€æ•°æ®åº“æ“ä½œ(åªä¿®æ”¹JSONé…ç½®)
- **å‰åç«¯æ–‡ä»¶ä½ç½®** - ä¸¥æ ¼æŒ‰ç…§è§„èŒƒè·¯å¾„
- **å‘½åè§„èŒƒ** - ä½¿ç”¨`query_template`è€Œéé©¼å³°æˆ–å…¶ä»–å‘½å
- **æ—¥å¿—è§„èŒƒ** - æ·»åŠ æ¸…æ™°çš„æ—¥å¿—è®°å½•

---

## 5. æ•°æ®æ”¯æ’‘ä¸éªŒè¯

### 5.1 æ•°æ®åº“è¡¨ç»“æ„éªŒè¯

âœ… **ai_workflow_nodeè¡¨**:
- `node_config`å­—æ®µç±»å‹ä¸ºJSON,æ”¯æŒåŠ¨æ€æ·»åŠ å­—æ®µ
- ç°æœ‰èŠ‚ç‚¹é…ç½®ç¤ºä¾‹å·²éªŒè¯JSONç»“æ„æ­£ç¡®
- æ— éœ€ä¿®æ”¹è¡¨ç»“æ„,æ— éœ€æ•°æ®è¿ç§»

### 5.2 ç°æœ‰èŠ‚ç‚¹å®ä¾‹éªŒè¯

âœ… **5ä¸ªç°æœ‰èŠ‚ç‚¹å®ä¾‹**:
- æ‰€æœ‰èŠ‚ç‚¹çš„`node_config`ä¸­éƒ½æ²¡æœ‰`query_template`å­—æ®µ
- æ·»åŠ æ–°å­—æ®µå,æ—§èŠ‚ç‚¹è‡ªåŠ¨é™çº§ä¸º`getFirstInputText()`
- ä¸å½±å“ç°æœ‰å·¥ä½œæµçš„æ‰§è¡Œ

### 5.3 æ¨¡æ¿æ¸²æŸ“å¼•æ“éªŒè¯

âœ… **WorkflowUtil.renderTemplate()**:
- å·²åœ¨LLMèŠ‚ç‚¹ã€æ¨¡æ¿èŠ‚ç‚¹ã€ç»“æŸèŠ‚ç‚¹ä¸­å¹¿æ³›ä½¿ç”¨
- æ”¯æŒæ–‡æœ¬ç±»å‹å’Œåˆ—è¡¨ç±»å‹æ•°æ®
- é€»è¾‘æˆç†Ÿç¨³å®š,æ— éœ€ä¿®æ”¹

### 5.4 å‰ç«¯ç»„ä»¶éªŒè¯

âœ… **NodePropertyInputå’ŒReferCommentç»„ä»¶**:
- å·²åœ¨LLMèŠ‚ç‚¹ã€æ¨¡æ¿èŠ‚ç‚¹ä¸­æ­£å¸¸ä½¿ç”¨
- ç»„ä»¶åŠŸèƒ½å®Œæ•´,æ— éœ€ä¿®æ”¹
- ç›´æ¥å¼•å…¥å³å¯ä½¿ç”¨

---

## 6. é£é™©åˆ†æä¸ç¼“è§£æªæ–½

### 6.1 æŠ€æœ¯é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|--------|----------|----------|
| æ¨¡æ¿æ¸²æŸ“å¤±è´¥ | ğŸŸ¢ ä½ | ä½¿ç”¨try-catchæ•è·å¼‚å¸¸,é™çº§ä¸º`getFirstInputText()` |
| å˜é‡åä¸å­˜åœ¨ | ğŸŸ¢ ä½ | `WorkflowUtil.renderTemplate`ä¼šä¿ç•™åŸå§‹`${å˜é‡å}`,ä¸ä¼šæŠ¥é”™ |
| å‰ç«¯ç»„ä»¶å¼•å…¥å¤±è´¥ | ğŸŸ¢ ä½ | ç»„ä»¶å·²åœ¨å…¶ä»–èŠ‚ç‚¹ä¸­ä½¿ç”¨,è·¯å¾„æ­£ç¡® |

### 6.2 ä¸šåŠ¡é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|--------|----------|----------|
| æ—§èŠ‚ç‚¹è¡Œä¸ºæ”¹å˜ | ğŸŸ¢ ä½ | é»˜è®¤å€¼`${input}`,é…ç½®ä¸ºç©ºæ—¶é™çº§,å®Œå…¨å‘åå…¼å®¹ |
| ç”¨æˆ·é…ç½®é”™è¯¯ | ğŸŸ¡ ä¸­ | å‰ç«¯æ·»åŠ æç¤ºè¯´æ˜,å¼•å¯¼ç”¨æˆ·æ­£ç¡®é…ç½® |
| æŸ¥è¯¢ç»“æœä¸ç¬¦åˆé¢„æœŸ | ğŸŸ¡ ä¸­ | æ·»åŠ æ—¥å¿—è®°å½•,ä¾¿äºè°ƒè¯•å’Œæ’æŸ¥ |

### 6.3 æ€§èƒ½é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|--------|----------|----------|
| æ¨¡æ¿æ¸²æŸ“æ€§èƒ½ | ğŸŸ¢ ä½ | `WorkflowUtil.renderTemplate`æ˜¯ç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢,æ€§èƒ½å¼€é”€æå° |
| å†…å­˜å ç”¨ | ğŸŸ¢ ä½ | åªå¢åŠ 1ä¸ªå­—ç¬¦ä¸²å­—æ®µ,å†…å­˜å¼€é”€å¯å¿½ç•¥ |

---

## 7. å‘åå…¼å®¹æ€§ä¿éšœ

### 7.1 æ—§èŠ‚ç‚¹å…¼å®¹æ€§

**åœºæ™¯1:æ—§èŠ‚ç‚¹æœªé…ç½®`query_template`**

```java
// nodeConfig.getQueryTemplate() è¿”å› null
if (StringUtils.isNotBlank(nodeConfig.getQueryTemplate())) {
    // ä¸ä¼šæ‰§è¡Œ
} else {
    textInput = getFirstInputText(); // æ‰§è¡ŒåŸé€»è¾‘
}
```

**ç»“æœ**: âœ… è¡Œä¸ºä¸ä¿®æ”¹å‰å®Œå…¨ä¸€è‡´

**åœºæ™¯2:æ—§èŠ‚ç‚¹é…ç½®`query_template`ä¸ºç©ºå­—ç¬¦ä¸²**

```java
// nodeConfig.getQueryTemplate() è¿”å› ""
if (StringUtils.isNotBlank("")) { // false
    // ä¸ä¼šæ‰§è¡Œ
} else {
    textInput = getFirstInputText(); // æ‰§è¡ŒåŸé€»è¾‘
}
```

**ç»“æœ**: âœ… è¡Œä¸ºä¸ä¿®æ”¹å‰å®Œå…¨ä¸€è‡´

**åœºæ™¯3:æ–°èŠ‚ç‚¹é…ç½®`query_template`ä¸º`${input}`**

```java
// nodeConfig.getQueryTemplate() è¿”å› "${input}"
if (StringUtils.isNotBlank("${input}")) { // true
    textInput = WorkflowUtil.renderTemplate("${input}", state.getInputs());
    // state.getInputs() = [{name:"input", value:"åˆåŒ"}]
    // æ¸²æŸ“ç»“æœ: "åˆåŒ"
}
```

**ç»“æœ**: âœ… è¡Œä¸ºä¸ä¿®æ”¹å‰å®Œå…¨ä¸€è‡´(é»˜è®¤å€¼ç­‰åŒäºåŸé€»è¾‘)

### 7.2 å‰ç«¯å…¼å®¹æ€§

**æ—§èŠ‚ç‚¹æ•°æ®**:
```json
{
  "knowledge_base_uuid": "xxx",
  "score": 0.6,
  "top_n": 3
  // æ²¡æœ‰ query_template å­—æ®µ
}
```

**å‰ç«¯computedé€»è¾‘**:
```javascript
if (this.wfNode.nodeConfig.query_template === undefined) {
  this.$set(this.wfNode.nodeConfig, 'query_template', '${input}')
}
```

**ç»“æœ**: âœ… è‡ªåŠ¨åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼`${input}`,ä¸å½±å“åŸæœ‰åŠŸèƒ½

---

## 8. ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### 8.1 åœºæ™¯1:ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥(é»˜è®¤è¡Œä¸º)

**é…ç½®**:
```
query_template: ${input}
```

**æ•°æ®æµ**:
```
ç”¨æˆ·è¾“å…¥: "åˆåŒå®¡æ‰¹æµç¨‹æ˜¯ä»€ä¹ˆ?"
  â†“ (state.getInputs())
[{name: "input", value: "åˆåŒå®¡æ‰¹æµç¨‹æ˜¯ä»€ä¹ˆ?"}]
  â†“ (WorkflowUtil.renderTemplate)
æŸ¥è¯¢å…³é”®è¯: "åˆåŒå®¡æ‰¹æµç¨‹æ˜¯ä»€ä¹ˆ?"
```

### 8.2 åœºæ™¯2:ç»„åˆå¤šä¸ªå˜é‡

**é…ç½®**:
```
è¾“å…¥å˜é‡:
  - var_company: [åˆ†ç±»èŠ‚ç‚¹].company_name
  - var_topic: [å…³é”®è¯æå–èŠ‚ç‚¹].keyword

query_template: ${var_company}çš„${var_topic}ç›¸å…³æ–‡æ¡£
```

**æ•°æ®æµ**:
```
state.getInputs() = [
  {name: "var_company", value: "åä¸º"},
  {name: "var_topic", value: "é‡‡è´­æµç¨‹"}
]
  â†“ (WorkflowUtil.renderTemplate)
æŸ¥è¯¢å…³é”®è¯: "åä¸ºçš„é‡‡è´­æµç¨‹ç›¸å…³æ–‡æ¡£"
```

### 8.3 åœºæ™¯3:å›ºå®šå‰ç¼€+å˜é‡

**é…ç½®**:
```
query_template: è¯·é—®å…³äº"${input}"çš„è¯¦ç»†è¯´æ˜
```

**æ•°æ®æµ**:
```
ç”¨æˆ·è¾“å…¥: "åˆåŒå˜æ›´"
  â†“
æŸ¥è¯¢å…³é”®è¯: "è¯·é—®å…³äº"åˆåŒå˜æ›´"çš„è¯¦ç»†è¯´æ˜"
```

---

## 9. æµ‹è¯•è®¡åˆ’

### 9.1 å•å…ƒæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹1:æ¨¡æ¿ä¸ºç©ºæ—¶é™çº§ä¸ºåŸé€»è¾‘**

```java
@Test
public void testQueryTemplateEmpty() {
    KnowledgeRetrievalNodeConfig config = new KnowledgeRetrievalNodeConfig();
    config.setQueryTemplate(null);

    // æ‰§è¡ŒèŠ‚ç‚¹
    NodeProcessResult result = node.onProcess();

    // éªŒè¯:ä½¿ç”¨ getFirstInputText()
    assertEquals("é¢„æœŸæŸ¥è¯¢å†…å®¹", actualTextInput);
}
```

**æµ‹è¯•ç”¨ä¾‹2:æ¨¡æ¿æ¸²æŸ“æ­£ç¡®**

```java
@Test
public void testQueryTemplateRender() {
    KnowledgeRetrievalNodeConfig config = new KnowledgeRetrievalNodeConfig();
    config.setQueryTemplate("${var1}çš„${var2}");

    state.getInputs().add(NodeIOData.createByText("var1", "", "åä¸º"));
    state.getInputs().add(NodeIOData.createByText("var2", "", "æ–‡æ¡£"));

    // æ‰§è¡ŒèŠ‚ç‚¹
    NodeProcessResult result = node.onProcess();

    // éªŒè¯:æ¸²æŸ“ç»“æœä¸º"åä¸ºçš„æ–‡æ¡£"
    assertEquals("åä¸ºçš„æ–‡æ¡£", actualTextInput);
}
```

### 9.2 é›†æˆæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹3:å®Œæ•´å·¥ä½œæµæµ‹è¯•**

```
å·¥ä½œæµ: [å¼€å§‹] â†’ [çŸ¥è¯†æ£€ç´¢] â†’ [LLMå›ç­”] â†’ [ç»“æŸ]

1. é…ç½®çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹:query_template = "${input}"
2. ç”¨æˆ·è¾“å…¥:"åˆåŒå®¡æ‰¹æµç¨‹"
3. éªŒè¯çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹ä½¿ç”¨"åˆåŒå®¡æ‰¹æµç¨‹"è¿›è¡Œæ£€ç´¢
4. éªŒè¯æ£€ç´¢ç»“æœæ­£ç¡®ä¼ é€’ç»™LLMèŠ‚ç‚¹
```

### 9.3 å‰ç«¯æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹4:å‰ç«¯é…ç½®ä¿å­˜**

```
1. æ‰“å¼€çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹å±æ€§é¢æ¿
2. åœ¨"æŸ¥è¯¢å…³é”®è¯"è¾“å…¥æ¡†ä¸­è¾“å…¥:"${var1}çš„${var2}"
3. ä¿å­˜èŠ‚ç‚¹é…ç½®
4. éªŒè¯:node_config.query_template = "${var1}çš„${var2}"
```

**æµ‹è¯•ç”¨ä¾‹5:æ—§èŠ‚ç‚¹å‡çº§**

```
1. æ‰“å¼€æ—§çš„çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹(æ— query_templateå­—æ®µ)
2. éªŒè¯:è¾“å…¥æ¡†æ˜¾ç¤ºé»˜è®¤å€¼"${input}"
3. ä¸ä¿®æ”¹,ç›´æ¥ä¿å­˜
4. éªŒè¯:node_config.query_template = "${input}"
```

---

## 10. å®æ–½æ­¥éª¤

### 10.1 åç«¯å®æ–½

1. âœ… ä¿®æ”¹`KnowledgeRetrievalNodeConfig.java`,æ·»åŠ `queryTemplate`å­—æ®µ
2. âœ… ä¿®æ”¹`KnowledgeRetrievalNode.java`,å®ç°æ¨¡æ¿æ¸²æŸ“é€»è¾‘
3. âœ… ç¼–å†™å•å…ƒæµ‹è¯•,éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§

### 10.2 å‰ç«¯å®æ–½

1. âœ… ä¿®æ”¹`KnowledgeRetrievalNodeProperty.vue`,æ·»åŠ æŸ¥è¯¢å…³é”®è¯é…ç½®åŒºåŸŸ
2. âœ… å¼•å…¥`NodePropertyInput`å’Œ`ReferComment`ç»„ä»¶
3. âœ… åˆå§‹åŒ–é»˜è®¤å€¼`${input}`

### 10.3 æµ‹è¯•éªŒè¯

1. âœ… æ‰§è¡Œå•å…ƒæµ‹è¯•
2. âœ… æ‰§è¡Œé›†æˆæµ‹è¯•
3. âœ… æ‰‹åŠ¨æµ‹è¯•æ—§èŠ‚ç‚¹å…¼å®¹æ€§
4. âœ… æ‰‹åŠ¨æµ‹è¯•æ–°èŠ‚ç‚¹é…ç½®åŠŸèƒ½

---

## 11. å›æ»šæ–¹æ¡ˆ

å¦‚æœå‘ç°é—®é¢˜éœ€è¦å›æ»š:

### 11.1 åç«¯å›æ»š

1. æ¢å¤`KnowledgeRetrievalNode.java`çš„åŸå§‹ä»£ç 
2. åˆ é™¤`KnowledgeRetrievalNodeConfig.java`ä¸­çš„`queryTemplate`å­—æ®µ
3. é‡æ–°ç¼–è¯‘éƒ¨ç½²

### 11.2 å‰ç«¯å›æ»š

1. æ¢å¤`KnowledgeRetrievalNodeProperty.vue`çš„åŸå§‹ä»£ç 
2. åˆ é™¤`NodePropertyInput`å’Œ`ReferComment`çš„å¼•å…¥
3. é‡æ–°æ„å»ºéƒ¨ç½²

### 11.3 æ•°æ®å›æ»š

âœ… **æ— éœ€æ•°æ®å›æ»š** - æ•°æ®åº“ä¸­çš„`query_template`å­—æ®µä¸å½±å“æ—§é€»è¾‘,å›æ»šåè‡ªåŠ¨å¿½ç•¥è¯¥å­—æ®µã€‚

---

## 12. æ€»ç»“

### 12.1 æ–¹æ¡ˆä¼˜åŠ¿

1. âœ… **å®ç°ç®€å•** - å®Œå…¨å¤ç”¨ç°æœ‰æœºåˆ¶,ä»£ç é‡æå°
2. âœ… **é›¶ç ´åæ€§** - å®Œå…¨å‘åå…¼å®¹,æ— éœ€æ•°æ®è¿ç§»
3. âœ… **ç”¨æˆ·ä½“éªŒä¸€è‡´** - ä¸LLMèŠ‚ç‚¹ã€æ¨¡æ¿èŠ‚ç‚¹ä¿æŒä¸€è‡´
4. âœ… **çµæ´»æ€§æå‡** - æ”¯æŒå¤šç§æŸ¥è¯¢å…³é”®è¯ç»„åˆæ–¹å¼
5. âœ… **é£é™©å¯æ§** - æŠ€æœ¯é£é™©å’Œä¸šåŠ¡é£é™©éƒ½æä½

### 12.2 æ–¹æ¡ˆåŠ£åŠ¿

1. âš ï¸ **ç”¨æˆ·å­¦ä¹ æˆæœ¬** - éœ€è¦ç†è§£å˜é‡å¼•ç”¨è¯­æ³•(ä½†å·²æœ‰å‚è€ƒ:LLMèŠ‚ç‚¹)
2. âš ï¸ **é…ç½®å¤æ‚åº¦** - å¤šäº†ä¸€ä¸ªé…ç½®é¡¹,ä½†é»˜è®¤å€¼ä¿è¯äº†ç®€å•åœºæ™¯ä¸‹æ— éœ€é…ç½®

### 12.3 æ–¹æ¡ˆè¯„çº§

| è¯„ä»·ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|---------|------|------|
| æŠ€æœ¯å¯è¡Œæ€§ | â­â­â­â­â­ | å®Œå…¨å¤ç”¨ç°æœ‰æœºåˆ¶,æŠ€æœ¯æˆç†Ÿ |
| å®æ–½å¤æ‚åº¦ | â­â­â­â­â­ | ä»£ç é‡æå°,å®æ–½ç®€å• |
| å‘åå…¼å®¹æ€§ | â­â­â­â­â­ | å®Œå…¨å…¼å®¹,é›¶ç ´å |
| ç”¨æˆ·ä½“éªŒ | â­â­â­â­â­ | ä¸LLMèŠ‚ç‚¹ä¸€è‡´,å­¦ä¹ æˆæœ¬ä½ |
| çµæ´»æ€§æå‡ | â­â­â­â­â­ | å¤§å¹…æå‡å·¥ä½œæµçµæ´»æ€§ |

### 12.4 å»ºè®®

âœ… **å¼ºçƒˆå»ºè®®å®æ–½** - è¯¥æ–¹æ¡ˆæŠ€æœ¯æˆç†Ÿã€å®æ–½ç®€å•ã€é£é™©æä½,èƒ½å¤Ÿæ˜¾è‘—æå‡ç³»ç»Ÿçš„çµæ´»æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

---

## é™„å½•:ä»£ç å˜æ›´å¯¹æ¯”

### A.1 åç«¯ä»£ç å˜æ›´

**KnowledgeRetrievalNodeConfig.java**:

```diff
@Data
public class KnowledgeRetrievalNodeConfig {

    @JsonProperty("knowledge_base_uuid")
    private String knowledgeBaseUuid;

    @JsonProperty("knowledge_base_name")
    private String knowledgeBaseName;

+   /**
+    * æŸ¥è¯¢å…³é”®è¯æ¨¡æ¿
+    * æ”¯æŒ ${å˜é‡å} çš„å˜é‡æ›¿æ¢è¯­æ³•
+    * ä¸ºç©ºæ—¶ä½¿ç”¨ä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡ºä½œä¸ºæŸ¥è¯¢å…³é”®è¯
+    * é»˜è®¤å€¼: ${input}
+    */
+   @JsonProperty("query_template")
+   private String queryTemplate;

    private Double score;

    // ... å…¶ä»–å­—æ®µ
}
```

**KnowledgeRetrievalNode.java**:

```diff
@Override
public NodeProcessResult onProcess() {
    KnowledgeRetrievalNodeConfig nodeConfig = checkAndGetConfig(KnowledgeRetrievalNodeConfig.class);

-   // è·å–è¾“å…¥æ–‡æœ¬
-   String textInput = getFirstInputText();
+   // è·å–æŸ¥è¯¢å…³é”®è¯(æ”¯æŒæ¨¡æ¿æ¸²æŸ“)
+   String textInput;
+   if (StringUtils.isNotBlank(nodeConfig.getQueryTemplate())) {
+       textInput = WorkflowUtil.renderTemplate(nodeConfig.getQueryTemplate(), state.getInputs());
+       log.info("ä½¿ç”¨æŸ¥è¯¢æ¨¡æ¿,æ¸²æŸ“åæŸ¥è¯¢å†…å®¹: {}", textInput);
+   } else {
+       textInput = getFirstInputText();
+       log.info("æœªé…ç½®æŸ¥è¯¢æ¨¡æ¿,ä½¿ç”¨ä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡º: {}", textInput);
+   }

    if (StringUtils.isBlank(textInput)) {
        log.warn("çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹è¾“å…¥å†…å®¹ä¸ºç©º");
        return NodeProcessResult.builder()
                .content(List.of(NodeIOData.createByText(DEFAULT_OUTPUT_PARAM_NAME, "", "")))
                .build();
    }

    // ... åç»­é€»è¾‘ä¸å˜
}
```

### A.2 å‰ç«¯ä»£ç å˜æ›´

**KnowledgeRetrievalNodeProperty.vue (templateéƒ¨åˆ†)**:

```diff
<template>
  <div class="knowledge-retrieval-node-property">
+   <!-- ğŸ†• æ–°å¢:å¼•ç”¨è¾“å…¥é…ç½® -->
+   <node-property-input
+     :workflow="workflow"
+     :wf-node="wfNode"
+   />

    <!-- çŸ¥è¯†åº“é€‰æ‹© -->
    <div class="property-section">
      <div class="section-title">çŸ¥è¯†åº“</div>
      <wf-knowledge-selector ... />
    </div>

+   <!-- ğŸ†• æ–°å¢:æŸ¥è¯¢å…³é”®è¯é…ç½® -->
+   <div class="property-section">
+     <div class="section-title">
+       æŸ¥è¯¢å…³é”®è¯
+       <el-tooltip content="ä¸ºç©ºåˆ™ä½¿ç”¨ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºä½œä¸ºæŸ¥è¯¢å…³é”®è¯" placement="top">
+         <i class="el-icon-question" />
+       </el-tooltip>
+     </div>
+     <refer-comment />
+     <el-input
+       v-model="nodeConfig.query_template"
+       type="textarea"
+       placeholder="è¯·è¾“å…¥æŸ¥è¯¢å…³é”®è¯"
+     />
+   </div>

    <!-- å…¶ä»–é…ç½®ä¿æŒä¸å˜ -->
  </div>
</template>
```

**KnowledgeRetrievalNodeProperty.vue (scriptéƒ¨åˆ†)**:

```diff
<script>
+import NodePropertyInput from '../NodePropertyInput.vue'
+import ReferComment from '../ReferComment.vue'
import WfKnowledgeSelector from '../WfKnowledgeSelector.vue'
import WfLlmSelector from '../WfLLMSelector.vue'

export default {
  name: 'KnowledgeRetrievalNodeProperty',

  components: {
+   NodePropertyInput,
+   ReferComment,
    WfKnowledgeSelector,
    WfLlmSelector
  },

  computed: {
    nodeConfig () {
      // ... å…¶ä»–åˆå§‹åŒ–

+     // ğŸ†• æ–°å¢:åˆå§‹åŒ–æŸ¥è¯¢æ¨¡æ¿é»˜è®¤å€¼
+     if (this.wfNode.nodeConfig.query_template === undefined) {
+       this.$set(this.wfNode.nodeConfig, 'query_template', '${input}')
+     }

      return this.wfNode.nodeConfig
    }
  }
}
</script>
```

---

**æ–¹æ¡ˆç¼–å†™å®Œæˆ,ç­‰å¾…ç”¨æˆ·å®¡æ‰¹ã€‚**
