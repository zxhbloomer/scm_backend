# Workflowå¤šè½®å¯¹è¯è®°å¿†ä¿®å¤æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-08
**ä½œè€…**: SCM-AIå›¢é˜Ÿ
**çŠ¶æ€**: å¾…å®¡æ‰¹

---

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

### ç›®æ ‡

ä¿®å¤Workflowå¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½ï¼Œä½¿Workflowèƒ½å¤Ÿæ­£ç¡®è¯»å–è‡ªå·±ä¿å­˜çš„å¯¹è¯å†å²ã€‚

### èƒŒæ™¯

**å½“å‰é—®é¢˜**ï¼š
- âœ… **ä¿å­˜é€»è¾‘æ­£å¸¸**ï¼šWorkflowå·²é€šè¿‡ `AiWorkflowConversationContentService` å°†å¯¹è¯è®°å½•ä¿å­˜åˆ° `ai_workflow_conversation_content` è¡¨
- âŒ **æŸ¥è¯¢é€»è¾‘é”™è¯¯**ï¼š`ScmMessageChatMemory.get()` åªä» `ai_conversation_content` è¡¨ï¼ˆChaté¢†åŸŸï¼‰æŸ¥è¯¢å†å²è®°å½•
- âŒ **åŠŸèƒ½å¤±æ•ˆ**ï¼šWorkflowæ‰§è¡Œå¤šè½®å¯¹è¯æ—¶ï¼Œæ— æ³•è¯»å–ä¹‹å‰çš„å¯¹è¯å†å²ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡è®°å¿†å¤±æ•ˆ

**é—®é¢˜å½±å“**ï¼š
- Workflowçš„é—®ç­”èŠ‚ç‚¹æ— æ³•è¿›è¡Œå¤šè½®å¯¹è¯
- ç”¨æˆ·æ¯æ¬¡æé—®æ—¶ï¼ŒAIæ— æ³•è®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹
- å½±å“Workflowçš„æ™ºèƒ½å¯¹è¯èƒ½åŠ›

---

## ğŸ¯ KISSåŸåˆ™éªŒè¯

### é—®é¢˜1ï¼šè¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ

âœ… **çœŸé—®é¢˜**
- Workflowçš„å¤šè½®å¯¹è¯åŠŸèƒ½å½“å‰å®Œå…¨å¤±æ•ˆ
- æ‰€æœ‰ä½¿ç”¨Workflowé—®ç­”èŠ‚ç‚¹çš„ç”¨æˆ·éƒ½ä¼šé‡åˆ°æ­¤é—®é¢˜
- è¿™æ˜¯åŠŸèƒ½æ€§ç¼ºé™·ï¼Œä¸æ˜¯æ€§èƒ½ä¼˜åŒ–æˆ–ç†è®ºé—®é¢˜

### é—®é¢˜2ï¼šæœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ

âœ… **å½“å‰æ–¹æ¡ˆå·²æ˜¯æœ€ç®€**
- åªéœ€1ä¸ªifåˆ¤æ–­åŒºåˆ†Chatå’ŒWorkflow
- åˆ©ç”¨ç°æœ‰çš„conversationIdæ ¼å¼å·®å¼‚ï¼ˆ2æ®µ vs 3æ®µï¼‰
- æ— éœ€ä¿®æ”¹æ•°æ®ç»“æ„æˆ–å¼•å…¥æ–°çš„é…ç½®
- ä»£ç ä¿®æ”¹ç‚¹æœ€å°‘ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰

### é—®é¢˜3ï¼šä¼šç ´åä»€ä¹ˆå—ï¼Ÿ

âœ… **ä¸ä¼šç ´åç°æœ‰åŠŸèƒ½**
- ChatåŠŸèƒ½å®Œå…¨ä¸å—å½±å“ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰
- Workflowä¿å­˜é€»è¾‘ä¸å˜ï¼ˆå·²æ­£å¸¸å·¥ä½œï¼‰
- åªä¿®æ”¹æŸ¥è¯¢é€»è¾‘ï¼Œä¸ä¿®æ”¹æ¥å£ç­¾å
- å‘åå…¼å®¹ï¼Œæ— éœ€æ•°æ®è¿ç§»

### é—®é¢˜4ï¼šå½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—ï¼Ÿ

âœ… **å¿…éœ€**
- å¤šè½®å¯¹è¯æ˜¯Workflowçš„æ ¸å¿ƒåŠŸèƒ½
- é¢†åŸŸéš”ç¦»æ¶æ„å·²å»ºç«‹ï¼Œå¿…é¡»å®Œæ•´å®ç°
- å½“å‰æ˜¯åŠŸèƒ½ç¼ºå¤±ï¼Œä¸æ˜¯å¢å¼º

---

## ğŸ“Š é—®é¢˜åˆ†æ

### è°ƒç”¨é“¾è·¯åˆ†æ

**å½“å‰è°ƒç”¨é“¾è·¯**ï¼ˆæœ‰é—®é¢˜ï¼‰ï¼š
```
Workflowæ‰§è¡Œå¤šè½®å¯¹è¯
  â†“
WorkflowUtil.streamingInvokeLLM()
  â†“
AiChatBaseService.chatWithMemoryStream(chatOption)
  â†“
MessageChatMemoryAdvisor
  â†“
ScmMessageChatMemory.get(conversationId)
  â†“
AiConversationService.getConversationHistory(conversationId, limit)  â† é—®é¢˜ç‚¹ï¼šåªæŸ¥Chatè¡¨
  â†“
ExtAiConversationContentMapper.selectLastByConversationIdByLimit()
  â†“
æŸ¥è¯¢ ai_conversation_content è¡¨  â† Chaté¢†åŸŸçš„è¡¨ï¼ŒæŸ¥ä¸åˆ°Workflowçš„æ•°æ®ï¼
```

**ä¿®å¤åçš„è°ƒç”¨é“¾è·¯**ï¼š
```
ScmMessageChatMemory.get(conversationId)
  â†“
åˆ¤æ–­conversationIdæ ¼å¼ï¼ˆé€šè¿‡"::"åˆ†éš”ç¬¦æ•°é‡ï¼‰
  â”œâ”€ 2æ®µ â†’ Chaté¢†åŸŸ
  â”‚   â””â”€ AiConversationService.getConversationHistory()
  â”‚       â””â”€ æŸ¥è¯¢ ai_conversation_content è¡¨
  â”‚
  â””â”€ 3æ®µ â†’ Workflowé¢†åŸŸ
      â””â”€ AiWorkflowConversationContentService.getConversationHistory()  â† æ–°å¢
          â””â”€ æŸ¥è¯¢ ai_workflow_conversation_content è¡¨
```

### conversationIdæ ¼å¼å·®å¼‚

| é¢†åŸŸ | conversationIdæ ¼å¼ | ç¤ºä¾‹ | æ®µæ•° |
|-----|------------------|------|-----|
| **Chat** | `tenantCode::conversationUUID` | `scm_tenant_001::uuid-1234` | **2æ®µ** |
| **Workflow** | `tenantCode::workflowUuid::userId` | `scm_tenant_001::wf-uuid::user-456` | **3æ®µ** |

**åˆ¤æ–­é€»è¾‘**ï¼š
```java
String[] parts = conversationId.split("::");
if (parts.length == 3) {
    // Workflowé¢†åŸŸï¼ˆ3æ®µï¼‰
} else {
    // Chaté¢†åŸŸï¼ˆ2æ®µï¼‰
}
```

---

## ğŸ—ï¸ æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å»ºæ–‡ä»¶ï¼ˆ0ä¸ªï¼‰

æ— éœ€æ–°å»ºæ–‡ä»¶ã€‚

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

#### 1. AiWorkflowConversationContentMapper.javaï¼ˆæ–°å¢æ–¹æ³•ï¼‰
**è·¯å¾„**ï¼š`scm-ai\src\main\java\com\xinyirun\scm\ai\core\mapper\workflow\AiWorkflowConversationContentMapper.java`

**ä¿®æ”¹å†…å®¹**ï¼šæ–°å¢æŸ¥è¯¢å¯¹è¯å†å²çš„SQLæ–¹æ³•
```java
/**
 * æ ¹æ®ä¼šè¯IDæŸ¥è¯¢æœ€åNæ¡è®°å½•ï¼ˆç”¨äºChatMemoryï¼‰
 *
 * æ³¨æ„ï¼šæ­¤SQLä¸Chatçš„æŸ¥è¯¢é€»è¾‘ä¸€è‡´
 * LIMIT 1, #{limit} è¡¨ç¤ºè·³è¿‡ç¬¬1æ¡ï¼ˆæœ€æ–°çš„ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œå–ä¹‹å‰çš„limitæ¡å†å²è®°å½•
 */
@Select("""
    SELECT
        id,
        message_id AS messageId,
        conversation_id AS conversationId,
        type,
        content,
        model_source_id AS modelSourceId,
        provider_name AS providerName,
        base_name AS baseName,
        c_time AS cTime,
        u_time AS uTime,
        c_id AS cId,
        u_id AS uId,
        dbversion
    FROM ai_workflow_conversation_content
    WHERE conversation_id = #{conversationId}
    ORDER BY c_time DESC
    LIMIT 1, #{limit}
    """)
List<AiWorkflowConversationContentVo> selectLastByConversationIdByLimit(
    @Param("conversationId") String conversationId,
    @Param("limit") int limit);
```

#### 2. AiWorkflowConversationContentService.javaï¼ˆæ–°å¢æ–¹æ³•ï¼‰
**è·¯å¾„**ï¼š`scm-ai\src\main\java\com\xinyirun\scm\ai\core\service\workflow\AiWorkflowConversationContentService.java`

**ä¿®æ”¹å†…å®¹**ï¼šæ–°å¢æŸ¥è¯¢å¯¹è¯å†å²çš„Serviceæ–¹æ³•
```java
/**
 * è·å–å¯¹è¯å†å²è®°å½•ï¼ˆç”¨äºChatMemoryï¼‰
 *
 * @param conversationId å¯¹è¯IDï¼ˆæ ¼å¼ï¼štenantCode::workflowUuid::userIdï¼‰
 * @param limit é™åˆ¶æ¡æ•°
 * @return å¯¹è¯å†…å®¹åˆ—è¡¨
 */
public List<AiWorkflowConversationContentVo> getConversationHistory(String conversationId, int limit) {
    try {
        List<AiWorkflowConversationContentVo> history =
            workflowConversationContentMapper.selectLastByConversationIdByLimit(conversationId, limit);

        log.debug("æŸ¥è¯¢å·¥ä½œæµå¯¹è¯å†å², conversationId: {}, limit: {}, ç»“æœæ•°é‡: {}",
                 conversationId, limit, history != null ? history.size() : 0);

        return history;
    } catch (Exception e) {
        log.error("æŸ¥è¯¢å·¥ä½œæµå¯¹è¯å†å²å¤±è´¥, conversationId: {}", conversationId, e);
        return Collections.emptyList(); // è¿”å›ç©ºåˆ—è¡¨ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å½±å“å¯¹è¯æµç¨‹
    }
}
```

#### 3. ScmMessageChatMemory.javaï¼ˆä¿®æ”¹æŸ¥è¯¢é€»è¾‘ï¼‰
**è·¯å¾„**ï¼š`scm-ai\src\main\java\com\xinyirun\scm\ai\config\memory\ScmMessageChatMemory.java`

**ä¿®æ”¹å†…å®¹**ï¼š
1. æ–°å¢ä¾èµ–æ³¨å…¥ `AiWorkflowConversationContentService`
2. ä¿®æ”¹ `get()` æ–¹æ³•ï¼Œå¢åŠ é¢†åŸŸåˆ¤æ–­é€»è¾‘

**ä¿®æ”¹å‰**ï¼š
```java
@Resource
@Lazy
private AiConversationService aiConversationService;

@Override
public List<Message> get(String conversationId) {
    try {
        String tenantId = parseTenantId(conversationId);
        DataSourceHelper.use(tenantId);

        // åªæŸ¥è¯¢Chatè¡¨
        List<AiConversationContentVo> contents = aiConversationService.getConversationHistory(
            conversationId, DEFAULT_MAX_MESSAGES);

        Collections.reverse(contents);
        return convertToMessages(contents);
    } finally {
        DataSourceHelper.close();
    }
}
```

**ä¿®æ”¹å**ï¼š
```java
@Resource
@Lazy
private AiConversationService aiConversationService;

@Resource
@Lazy
private AiWorkflowConversationContentService workflowConversationContentService;

@Override
public List<Message> get(String conversationId) {
    try {
        log.debug("èŠå¤©çš„conversationId {}", conversationId);

        // ä»conversationIdè§£æç§Ÿæˆ·ID
        String tenantId = parseTenantId(conversationId);
        DataSourceHelper.use(tenantId);

        // åˆ¤æ–­conversationIdæ ¼å¼ï¼ŒåŒºåˆ†Chatå’ŒWorkflowé¢†åŸŸ
        String[] parts = conversationId.split(TENANT_SEPARATOR);
        List<Message> messages;

        if (parts.length == 3) {
            // Workflowé¢†åŸŸï¼štenantCode::workflowUuid::userIdï¼ˆ3æ®µï¼‰
            log.debug("æ£€æµ‹åˆ°Workflowå¯¹è¯ï¼ŒæŸ¥è¯¢ai_workflow_conversation_contentè¡¨");
            List<AiWorkflowConversationContentVo> workflowContents =
                workflowConversationContentService.getConversationHistory(conversationId, DEFAULT_MAX_MESSAGES);
            Collections.reverse(workflowContents);
            messages = convertWorkflowContentsToMessages(workflowContents);
        } else {
            // Chaté¢†åŸŸï¼štenantCode::conversationUUIDï¼ˆ2æ®µï¼Œé»˜è®¤æƒ…å†µï¼‰
            log.debug("æ£€æµ‹åˆ°Chatå¯¹è¯ï¼ŒæŸ¥è¯¢ai_conversation_contentè¡¨");
            List<AiConversationContentVo> chatContents =
                aiConversationService.getConversationHistory(conversationId, DEFAULT_MAX_MESSAGES);
            Collections.reverse(chatContents);
            messages = convertChatContentsToMessages(chatContents);
        }

        return messages;
    } finally {
        DataSourceHelper.close();
    }
}

/**
 * å°†Chatçš„å¯¹è¯å†…å®¹è½¬æ¢ä¸ºSpring AI Messageå¯¹è±¡
 */
private List<Message> convertChatContentsToMessages(List<AiConversationContentVo> contents) {
    return contents.stream()
            .map(conversationContent -> {
                MessageType type = MessageType.fromValue(conversationContent.getType());
                String content = conversationContent.getContent();
                Message message = switch (type) {
                    case USER -> new UserMessage(content);
                    case ASSISTANT -> new AssistantMessage(content);
                    case SYSTEM -> new SystemMessage(content);
                    case TOOL -> new ToolResponseMessage(List.of());
                };
                return message;
            }).collect(Collectors.toList());
}

/**
 * å°†Workflowçš„å¯¹è¯å†…å®¹è½¬æ¢ä¸ºSpring AI Messageå¯¹è±¡
 */
private List<Message> convertWorkflowContentsToMessages(List<AiWorkflowConversationContentVo> contents) {
    return contents.stream()
            .map(conversationContent -> {
                MessageType type = MessageType.fromValue(conversationContent.getType());
                String content = conversationContent.getContent();
                Message message = switch (type) {
                    case USER -> new UserMessage(content);
                    case ASSISTANT -> new AssistantMessage(content);
                    case SYSTEM -> new SystemMessage(content);
                    case TOOL -> new ToolResponseMessage(List.of());
                };
                return message;
            }).collect(Collectors.toList());
}
```

---

## ğŸ”„ è°ƒç”¨é“¾è·¯å˜æ›´

### ä¿®æ”¹å‰ï¼ˆé—®é¢˜çŠ¶æ€ï¼‰

```
Workflowå¤šè½®å¯¹è¯
  â†“
chatWithMemoryStream()
  â†“
ScmMessageChatMemory.get(conversationId="scm_tenant_001::wf-uuid::user-456")
  â†“
AiConversationService.getConversationHistory()  â† å›ºå®šæŸ¥è¯¢Chatè¡¨
  â†“
æŸ¥è¯¢ ai_conversation_content WHERE conversation_id = "scm_tenant_001::wf-uuid::user-456"
  â†“
ç»“æœï¼šæŸ¥ä¸åˆ°æ•°æ®ï¼ˆå› ä¸ºWorkflowä¿å­˜åœ¨å¦ä¸€ä¸ªè¡¨ï¼‰
  â†“
AIæ— æ³•è¯»å–å†å²å¯¹è¯ï¼Œå¤šè½®è®°å¿†å¤±æ•ˆ âŒ
```

### ä¿®æ”¹åï¼ˆæ­£å¸¸çŠ¶æ€ï¼‰

```
Workflowå¤šè½®å¯¹è¯
  â†“
chatWithMemoryStream()
  â†“
ScmMessageChatMemory.get(conversationId="scm_tenant_001::wf-uuid::user-456")
  â†“
åˆ¤æ–­conversationId.split("::").length == 3  â† æ–°å¢åˆ¤æ–­é€»è¾‘
  â†“
æ˜¯3æ®µ â†’ Workflowé¢†åŸŸ
  â†“
AiWorkflowConversationContentService.getConversationHistory()  â† æ–°å¢æ–¹æ³•
  â†“
æŸ¥è¯¢ ai_workflow_conversation_content WHERE conversation_id = "scm_tenant_001::wf-uuid::user-456"
  â†“
ç»“æœï¼šæˆåŠŸæŸ¥è¯¢åˆ°å†å²å¯¹è¯
  â†“
AIè¯»å–å†å²ä¸Šä¸‹æ–‡ï¼Œå¤šè½®è®°å¿†æ­£å¸¸ âœ…
```

---

## âš ï¸ é£é™©è¯„ä¼°ä¸ç¼“è§£æªæ–½

### é£é™©1ï¼šconversationIdæ ¼å¼åˆ¤æ–­é”™è¯¯

**é£é™©æè¿°**ï¼šå¦‚æœåˆ¤æ–­é€»è¾‘é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´ChatæŸ¥è¯¢Workflowè¡¨ï¼Œæˆ–WorkflowæŸ¥è¯¢Chatè¡¨

**å½±å“ç¨‹åº¦**ï¼šğŸ”´ é«˜

**ç¼“è§£æªæ–½**ï¼š
- ä½¿ç”¨ä¸¥æ ¼çš„å­—ç¬¦ä¸²splitåˆ¤æ–­ï¼ˆ`parts.length == 3`ï¼‰
- æ·»åŠ æ—¥å¿—è®°å½•åˆ¤æ–­ç»“æœ
- å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰æ ¼å¼ç»„åˆ
- ä»£ç Reviewé‡ç‚¹æ£€æŸ¥åˆ¤æ–­é€»è¾‘

### é£é™©2ï¼šVOç±»å‹ä¸å…¼å®¹

**é£é™©æè¿°**ï¼šChatå’ŒWorkflowçš„VOç±»å¯èƒ½ä¸å®Œå…¨å…¼å®¹ï¼Œå¯¼è‡´ç±»å‹è½¬æ¢é”™è¯¯

**å½±å“ç¨‹åº¦**ï¼šğŸŸ¡ ä¸­

**ç¼“è§£æªæ–½**ï¼š
- ä¸¤ä¸ªVOç±»éƒ½åŒ…å«typeå’Œcontentå­—æ®µï¼ˆå·²éªŒè¯ï¼‰
- è½¬æ¢é€»è¾‘å®Œå…¨ç›¸åŒ
- å•å…ƒæµ‹è¯•éªŒè¯ä¸¤ç§VOçš„è½¬æ¢
- å¦‚æœ‰å·®å¼‚ï¼Œåˆ›å»ºç‹¬ç«‹çš„è½¬æ¢æ–¹æ³•

### é£é™©3ï¼šç§Ÿæˆ·è§£æé€»è¾‘å¤±æ•ˆ

**é£é™©æè¿°**ï¼šWorkflowçš„conversationIdæœ‰3æ®µï¼Œ`parseTenantId()` æ–¹æ³•æŒ‰`::`åˆ†éš”å–ç¬¬1æ®µï¼Œä»ç„¶æœ‰æ•ˆ

**å½±å“ç¨‹åº¦**ï¼šğŸŸ¢ ä½

**ç¼“è§£æªæ–½**ï¼š
- å·²éªŒè¯ `parseTenantId()` æ–¹æ³•ä»ç„¶æ­£ç¡®ï¼ˆå–ç¬¬1æ®µï¼‰
- Workflowæ ¼å¼ï¼š`tenantCode::workflowUuid::userId` â†’ å–tenantCodeï¼ˆæ­£ç¡®ï¼‰
- æ— éœ€ä¿®æ”¹ç§Ÿæˆ·è§£æé€»è¾‘

### é£é™©4ï¼šæ€§èƒ½å½±å“

**é£é™©æè¿°**ï¼šå¢åŠ ifåˆ¤æ–­å’Œsplitæ“ä½œï¼Œå¯èƒ½å½±å“æ€§èƒ½

**å½±å“ç¨‹åº¦**ï¼šğŸŸ¢ ä½

**ç¼“è§£æªæ–½**ï¼š
- åªæ˜¯ç®€å•çš„å­—ç¬¦ä¸²splitå’Œé•¿åº¦åˆ¤æ–­ï¼Œæ€§èƒ½å½±å“æå°ï¼ˆçº³ç§’çº§ï¼‰
- æ¯æ¬¡å¯¹è¯åªæ‰§è¡Œä¸€æ¬¡åˆ¤æ–­
- æŸ¥è¯¢SQLé€»è¾‘ä¸å˜ï¼Œæ— æ€§èƒ½æŸå¤±

---

## âœ… æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

**æµ‹è¯•1ï¼šconversationIdæ ¼å¼åˆ¤æ–­**
```java
@Test
void testConversationIdFormat() {
    // Chatæ ¼å¼ï¼ˆ2æ®µï¼‰
    String chatId = "scm_tenant_001::conv-uuid-123";
    String[] parts1 = chatId.split("::");
    assertEquals(2, parts1.length);

    // Workflowæ ¼å¼ï¼ˆ3æ®µï¼‰
    String workflowId = "scm_tenant_001::wf-uuid::user-456";
    String[] parts2 = workflowId.split("::");
    assertEquals(3, parts2.length);
}
```

**æµ‹è¯•2ï¼šWorkflowæŸ¥è¯¢å†å²**
```java
@Test
void testWorkflowGetConversationHistory() {
    String conversationId = "scm_tenant_001::wf-uuid-123::user-456";
    List<AiWorkflowConversationContentVo> history =
        workflowConversationContentService.getConversationHistory(conversationId, 10);
    assertNotNull(history);
}
```

**æµ‹è¯•3ï¼šChatæŸ¥è¯¢å†å²ï¼ˆå›å½’æµ‹è¯•ï¼‰**
```java
@Test
void testChatGetConversationHistory() {
    String conversationId = "scm_tenant_001::conv-uuid-123";
    List<AiConversationContentVo> history =
        aiConversationService.getConversationHistory(conversationId, 10);
    assertNotNull(history);
}
```

### é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯1ï¼šWorkflowå¤šè½®å¯¹è¯**
1. ç”¨æˆ·ç¬¬1æ¬¡æé—®ï¼š"ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
2. AIå›å¤ï¼š"ä»Šå¤©æ˜¯æ™´å¤©ï¼Œæ¸©åº¦25åº¦ã€‚"
3. ä¿å­˜åˆ° `ai_workflow_conversation_content` è¡¨
4. ç”¨æˆ·ç¬¬2æ¬¡æé—®ï¼š"é‚£æ˜å¤©å‘¢ï¼Ÿ"
5. AIè¯»å–å†å²å¯¹è¯ï¼ˆéªŒè¯èƒ½è¯»å–åˆ°æ­¥éª¤1-2çš„å†…å®¹ï¼‰
6. AIå›å¤ï¼š"æ ¹æ®å¤©æ°”é¢„æŠ¥ï¼Œæ˜å¤©ä¹Ÿæ˜¯æ™´å¤©ã€‚"

**éªŒè¯ç‚¹**ï¼š
- conversationIdæ ¼å¼æ­£ç¡®ï¼ˆ3æ®µï¼‰
- æŸ¥è¯¢å†å²æˆåŠŸï¼ˆåŒ…å«æ­¥éª¤1-2çš„å¯¹è¯ï¼‰
- AIå›å¤åŒ…å«ä¸Šä¸‹æ–‡ï¼ˆçŸ¥é“ä¹‹å‰é—®è¿‡ä»Šå¤©å¤©æ°”ï¼‰

**æµ‹è¯•åœºæ™¯2ï¼šChatå¤šè½®å¯¹è¯ï¼ˆå›å½’æµ‹è¯•ï¼‰**
1. ç”¨æˆ·æé—®ï¼š"ä½ å¥½"
2. AIå›å¤ï¼š"ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
3. ä¿å­˜åˆ° `ai_conversation_content` è¡¨
4. ç”¨æˆ·æé—®ï¼š"åˆšæ‰æˆ‘è¯´äº†ä»€ä¹ˆï¼Ÿ"
5. AIè¯»å–å†å²å¯¹è¯
6. AIå›å¤ï¼š"ä½ è¯´'ä½ å¥½'ã€‚"

**éªŒè¯ç‚¹**ï¼š
- conversationIdæ ¼å¼æ­£ç¡®ï¼ˆ2æ®µï¼‰
- æŸ¥è¯¢Chatè¡¨æˆåŠŸ
- ChatåŠŸèƒ½ä¸å—å½±å“

---

## ğŸ“… å®æ–½è®¡åˆ’

### ç¬¬1å¤©ï¼šå¼€å‘é˜¶æ®µï¼ˆé¢„è®¡2å°æ—¶ï¼‰
- âœ… æ–¹æ¡ˆå®¡æ‰¹
- ä¿®æ”¹ AiWorkflowConversationContentMapperï¼ˆæ–°å¢SQLæ–¹æ³•ï¼‰
- ä¿®æ”¹ AiWorkflowConversationContentServiceï¼ˆæ–°å¢æŸ¥è¯¢æ–¹æ³•ï¼‰
- ä¿®æ”¹ ScmMessageChatMemoryï¼ˆæ–°å¢é¢†åŸŸåˆ¤æ–­é€»è¾‘ï¼‰
- ç¼–å†™å•å…ƒæµ‹è¯•

### ç¬¬2å¤©ï¼šæµ‹è¯•é˜¶æ®µï¼ˆé¢„è®¡1å°æ—¶ï¼‰
- æ‰§è¡Œå•å…ƒæµ‹è¯•
- æ‰§è¡Œé›†æˆæµ‹è¯•ï¼ˆWorkflowå¤šè½®å¯¹è¯ï¼‰
- æ‰§è¡Œå›å½’æµ‹è¯•ï¼ˆChatå¤šè½®å¯¹è¯ï¼‰

### ç¬¬3å¤©ï¼šä¸Šçº¿é˜¶æ®µï¼ˆé¢„è®¡0.5å°æ—¶ï¼‰
- ä»£ç Review
- åˆå¹¶åˆ°ä¸»åˆ†æ”¯
- éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒéªŒè¯
- éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

## ğŸ“Š å½±å“èŒƒå›´

### å˜æ›´æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰
- `AiWorkflowConversationContentMapper.java`ï¼ˆæ–°å¢SQLæ–¹æ³•ï¼‰
- `AiWorkflowConversationContentService.java`ï¼ˆæ–°å¢æŸ¥è¯¢æ–¹æ³•ï¼‰
- `ScmMessageChatMemory.java`ï¼ˆä¿®æ”¹æŸ¥è¯¢é€»è¾‘ï¼‰

### ä¸å—å½±å“
- âœ… ChatåŠŸèƒ½å®Œå…¨ä¸å—å½±å“
- âœ… Workflowä¿å­˜é€»è¾‘ä¸å˜
- âœ… å…¶ä»–WorkflowåŠŸèƒ½ä¸å—å½±å“
- âœ… æ•°æ®åº“è¡¨ç»“æ„ä¸å˜

### éœ€è¦éªŒè¯
- âœ… Workflowå¤šè½®å¯¹è¯åŠŸèƒ½
- âœ… Chatå¤šè½®å¯¹è¯åŠŸèƒ½ï¼ˆå›å½’æµ‹è¯•ï¼‰

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

1. âœ… Workflowå¤šè½®å¯¹è¯èƒ½æ­£ç¡®è¯»å–å†å²è®°å½•
2. âœ… å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
3. âœ… é›†æˆæµ‹è¯•ï¼šWorkflowå¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡è®°å¿†æ­£å¸¸
4. âœ… å›å½’æµ‹è¯•ï¼šChatå¤šè½®å¯¹è¯ä¸å—å½±å“
5. âœ… ä»£ç Reviewé€šè¿‡
6. âœ… æ—¥å¿—è®°å½•æ¸…æ™°ï¼ˆè®°å½•åˆ¤æ–­ç»“æœï¼‰

---

**æ–¹æ¡ˆç¼–å†™å®Œæˆï¼Œç­‰å¾…å®¡æ‰¹ã€‚**
