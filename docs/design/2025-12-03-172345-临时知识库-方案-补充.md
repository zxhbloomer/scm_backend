# ä¸´æ—¶çŸ¥è¯†åº“åŠŸèƒ½å¼€å‘æ–¹æ¡ˆ - è¡¥å……è¯´æ˜ï¼ˆä¿®æ­£ç‰ˆï¼‰

**è¡¥å……æ—¥æœŸ**: 2025-12-03 17:50
**ä¿®æ­£åŸå› **: ç”¨æˆ·æŒ‡å‡ºå…³é”®é”™è¯¯ï¼Œå‚è€ƒ createJobKnowledgeBaseStatistics é‡æ–°è®¾è®¡

---

## âš ï¸ åŸæ–¹æ¡ˆçš„ä¸¤ä¸ªè‡´å‘½é”™è¯¯

### é”™è¯¯1ï¼šè¿åSCMæŸ¥è¯¢è§„èŒƒ
- âŒ ä½¿ç”¨äº† `LambdaQueryWrapper` æŸ¥è¯¢
- âœ… **å¿…é¡»**ä½¿ç”¨ SQL æ–¹å¼ï¼ˆè§„èŒƒç¬¬17ã€24æ¡ï¼‰

### é”™è¯¯2ï¼šä»»åŠ¡è®¾è®¡æ¨¡å¼å®Œå…¨é”™è¯¯
- âŒ ç³»ç»Ÿå¯åŠ¨æ—¶å…¨å±€æ³¨å†ŒCronå®šæ—¶ä»»åŠ¡ï¼ˆæ¯10åˆ†é’Ÿæ‰«æï¼‰
- âœ… **åº”è¯¥**åœ¨åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“æ—¶åŠ¨æ€åˆ›å»ºSimpleTriggerå•æ¬¡ä»»åŠ¡ï¼ˆ2å°æ—¶åæ‰§è¡Œï¼‰

---

## ğŸ’¡ æ­£ç¡®çš„è®¾è®¡ç†å¿µï¼ˆå‚è€ƒcreateJobKnowledgeBaseStatisticsï¼‰

### createJobKnowledgeBaseStatistics çš„å¯ç¤º

è¯¥æ–¹æ³•çš„è®¾è®¡æ¨¡å¼ï¼š
1. **ä¸šåŠ¡é©±åŠ¨åˆ›å»º**ï¼šåœ¨æ–‡æ¡£ç´¢å¼•å®ŒæˆååŠ¨æ€åˆ›å»ºä»»åŠ¡
2. **å•æ¬¡æ‰§è¡Œ**ï¼š`IS_CRON = false`ï¼Œä½¿ç”¨ SimpleTrigger
3. **ç²¾ç¡®ç›®æ ‡**ï¼šä»»åŠ¡å‚æ•°åŒ…å« `kbUuid`ï¼Œåªå¤„ç†æŒ‡å®šçŸ¥è¯†åº“
4. **è‡ªåŠ¨å¤±æ•ˆ**ï¼šä»»åŠ¡æ‰§è¡Œåè‡ªåŠ¨å¤±æ•ˆï¼Œæ— éœ€æ¸…ç†

### ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†ä»»åŠ¡åº”è¯¥è¿™æ ·è®¾è®¡

```
åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“
    â†“
ç«‹å³åˆ›å»ºæ¸…ç†ä»»åŠ¡ï¼ˆ2å°æ—¶åæ‰§è¡Œï¼‰
    â†“
ä»»åŠ¡è®°å½•åˆ°s_jobè¡¨
    â†“
2å°æ—¶åQuartzè‡ªåŠ¨è§¦å‘
    â†“
åˆ é™¤æŒ‡å®šçš„ä¸´æ—¶çŸ¥è¯†åº“
    â†“
ä»»åŠ¡è‡ªåŠ¨å¤±æ•ˆ
```

**å…³é”®ä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€å…¨è¡¨æ‰«æ
- âœ… ç²¾ç¡®å®šæ—¶æ¸…ç†
- âœ… s_jobè¡¨ä¸ä¼šå †ç§¯æ— æ•ˆä»»åŠ¡
- âœ… é›¶ç»´æŠ¤æˆæœ¬

---

## ä¸€ã€åç«¯æ–‡ä»¶æ¸…å•ï¼ˆä¿®æ­£ï¼‰

| æ–‡ä»¶è·¯å¾„ | æ“ä½œç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| `scm-ai/.../V1.1.0__add_temp_kb_fields.sql` | æ–°å»º | DDLè„šæœ¬ |
| `scm-ai/.../AiKnowledgeBaseEntity.java` | ä¿®æ”¹ | å®ä½“ç±»æ·»åŠ å­—æ®µ |
| `scm-ai/.../AiKnowledgeBaseVo.java` | ä¿®æ”¹ | VOç±»æ·»åŠ å­—æ®µ |
| `scm-ai/.../KnowledgeBaseService.java` | ä¿®æ”¹ | saveOrUpdateä¸­æ·»åŠ é€»è¾‘+åˆ›å»ºæ¸…ç†ä»»åŠ¡ |
| **âœ… `scm-ai/core/service/milvus/TempKnowledgeBaseCleanupService.java`** | **æ–°å»º** | **æ¸…ç†Serviceï¼ˆå•ä¸ªKBï¼‰** |
| **âœ… `scm-bean/.../vo/business/ai/TempKbCleanupParamVo.java`** | **æ–°å»º** | **ä»»åŠ¡å‚æ•°Vo** |
| **âœ… `scm-quartz/.../ScheduleUtils.java`** | **ä¿®æ”¹** | **æ·»åŠ createJobTempKbCleanupæ–¹æ³•** |
| **âœ… `scm-quartz/.../SchedulerConstants.java`** | **ä¿®æ”¹** | **æ·»åŠ TEMP_KB_CLEANUPå¸¸é‡** |
| **âœ… `scm-common/.../DictConstant.java`** | **ä¿®æ”¹** | **æ·»åŠ å­—å…¸å¸¸é‡** |

---

## äºŒã€æ¸…ç†Serviceå®ç°ï¼ˆæ­£ç¡®ç‰ˆæœ¬ï¼‰

### æ–‡ä»¶ä½ç½®
`scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/milvus/TempKnowledgeBaseCleanupService.java`

### å®Œæ•´ä»£ç 
```java
package com.xinyirun.scm.ai.core.service.milvus;

import com.xinyirun.scm.ai.core.service.KnowledgeBaseService;
import com.xinyirun.scm.bean.system.vo.business.ai.TempKbCleanupParamVo;
import com.xinyirun.scm.common.utils.datasource.DataSourceHelper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

/**
 * ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†æœåŠ¡
 *
 * è®¾è®¡æ¨¡å¼ï¼šå‚è€ƒKnowledgeBaseStatisticsService
 * åŠŸèƒ½ï¼šæ¸…ç†æŒ‡å®šçš„ä¸´æ—¶çŸ¥è¯†åº“åŠå…¶å…³è”æ•°æ®
 * è°ƒç”¨æ–¹å¼ï¼šQuartzå•æ¬¡ä»»åŠ¡ï¼ˆSimpleTriggerï¼‰
 * ä»»åŠ¡åˆ›å»ºï¼šKnowledgeBaseService.saveOrUpdate()åˆ›å»ºä¸´æ—¶KBåç«‹å³åˆ›å»º
 * æ‰§è¡Œæ—¶é—´ï¼šåˆ›å»ºå2å°æ—¶æ‰§è¡Œä¸€æ¬¡
 *
 * @author SCM AI Team
 * @since 2025-12-03
 */
@Slf4j
@Service
public class TempKnowledgeBaseCleanupService {

    @Autowired
    private KnowledgeBaseService knowledgeBaseService;

    /**
     * æ¸…ç†æŒ‡å®šçš„ä¸´æ—¶çŸ¥è¯†åº“ï¼ˆQuartzè°ƒç”¨å…¥å£ï¼‰
     *
     * è®¾è®¡è¯´æ˜ï¼š
     * 1. æ­¤æ–¹æ³•ç”±Quartzè°ƒåº¦å™¨è°ƒç”¨ï¼Œå‚æ•°ç”±JSONååºåˆ—åŒ–å¾—åˆ°
     * 2. ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç”±paramVo.tenantCodeè®¾ç½®
     * 3. å¤ç”¨KnowledgeBaseService.delete()å®ç°çº§è”åˆ é™¤
     * 4. ä»»åŠ¡æ‰§è¡Œåè‡ªåŠ¨å¤±æ•ˆï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
     *
     * @param paramVo å‚æ•°å¯¹è±¡ï¼ˆåŒ…å«kbUuidå’ŒtenantCodeï¼‰
     */
    public void cleanupTempKnowledgeBase(TempKbCleanupParamVo paramVo) {
        log.info("å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†: kbUuid={}, tenantCode={}",
                paramVo.getKbUuid(), paramVo.getTenantCode());

        try {
            // è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
            DataSourceHelper.use(paramVo.getTenantCode());

            // å¤ç”¨ç°æœ‰åˆ é™¤é€»è¾‘ï¼ˆè‡ªåŠ¨å¤„ç†çº§è”åˆ é™¤ï¼‰
            // KnowledgeBaseService.delete() ä¼šï¼š
            // 1. åˆ é™¤ ai_knowledge_base_item è®°å½•
            // 2. åˆ é™¤ ai_knowledge_base_graph_segment è®°å½•
            // 3. åˆ é™¤ Milvus å‘é‡æ•°æ®
            // 4. åˆ é™¤ Neo4j å›¾è°±æ•°æ®
            // 5. åˆ é™¤ ai_knowledge_base è®°å½•
            knowledgeBaseService.delete(paramVo.getKbUuid());

            log.info("å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œä¸´æ—¶çŸ¥è¯†åº“å·²æ¸…ç†: kbUuid={}", paramVo.getKbUuid());

        } catch (Exception e) {
            log.error("å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†å¤±è´¥: kbUuid={}, error={}",
                    paramVo.getKbUuid(), e.getMessage(), e);
            throw new RuntimeException("ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†å¤±è´¥: " + e.getMessage(), e);
        } finally {
            DataSourceHelper.close();
        }
    }
}
```

### è®¾è®¡è¦ç‚¹
1. **æ–¹æ³•ç­¾å**ï¼šæ¥æ”¶ `TempKbCleanupParamVo` å‚æ•°ï¼ˆä¸ `updateStatistics(KnowledgeBaseStatisticsParamVo)` æ¨¡å¼ä¸€è‡´ï¼‰
2. **ç§Ÿæˆ·å¤„ç†**ï¼šæ˜¾å¼è°ƒç”¨ `DataSourceHelper.use()` è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
3. **å¤ç”¨åˆ é™¤é€»è¾‘**ï¼šè°ƒç”¨ `knowledgeBaseService.delete()` å®ç°çº§è”åˆ é™¤
4. **æ— éœ€æŸ¥è¯¢**ï¼šç›´æ¥åˆ é™¤ï¼Œæ— éœ€ä½¿ç”¨ SQL æŸ¥è¯¢ï¼ˆç¬¦åˆè§„èŒƒï¼‰

---

## ä¸‰ã€ä»»åŠ¡å‚æ•°Voï¼ˆæ–°å¢æ–‡ä»¶ï¼‰

### æ–‡ä»¶ä½ç½®
`scm-bean/src/main/java/com/xinyirun/scm/bean/system/vo/business/ai/TempKbCleanupParamVo.java`

### å®Œæ•´ä»£ç 
```java
package com.xinyirun.scm.bean.system.vo.business.ai;

import lombok.Data;

/**
 * ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†ä»»åŠ¡å‚æ•°
 *
 * ç”¨é€”ï¼šQuartzä»»åŠ¡å‚æ•°åºåˆ—åŒ–/ååºåˆ—åŒ–
 * å…³è”ä»»åŠ¡ï¼šTempKnowledgeBaseCleanupService.cleanupTempKnowledgeBase
 *
 * @author SCM AI Team
 * @since 2025-12-03
 */
@Data
public class TempKbCleanupParamVo {

    /**
     * çŸ¥è¯†åº“UUID
     */
    private String kbUuid;

    /**
     * ç§Ÿæˆ·ä»£ç 
     */
    private String tenantCode;
}
```

---

## å››ã€ScheduleUtils æ·»åŠ æ–¹æ³•

### æ–‡ä»¶ä½ç½®
`scm-quartz/src/main/java/com/xinyirun/scm/quartz/util/ScheduleUtils.java`

### æ·»åŠ ä½ç½®
åœ¨ `createJobKnowledgeBaseStatistics` æ–¹æ³•åï¼ˆLine 172åï¼‰æ·»åŠ ï¼š

```java
/**
 * åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†ä»»åŠ¡
 *
 * è°ƒç”¨æ—¶æœºï¼šåœ¨KnowledgeBaseService.saveOrUpdate()åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“åç«‹å³è°ƒç”¨
 * ä»»åŠ¡ç±»å‹ï¼šSimpleTriggerå•æ¬¡æ‰§è¡Œ
 * æ‰§è¡Œæ—¶é—´ï¼šåˆ›å»ºå2å°æ—¶æ‰§è¡Œä¸€æ¬¡
 * ä»»åŠ¡ç›®æ ‡ï¼šåˆ é™¤æŒ‡å®šçš„ä¸´æ—¶çŸ¥è¯†åº“åŠå…¶å…³è”æ•°æ®
 *
 * @param scheduler Quartzè°ƒåº¦å™¨
 * @param tenantCode ç§Ÿæˆ·ä»£ç 
 * @param kbUuid ä¸´æ—¶çŸ¥è¯†åº“UUID
 * @param kbId ä¸´æ—¶çŸ¥è¯†åº“IDï¼ˆç”¨äºjob_serial_idï¼‰
 * @return æ˜¯å¦åˆ›å»ºæˆåŠŸ
 * @throws SchedulerException è°ƒåº¦å¼‚å¸¸
 */
public static boolean createJobTempKbCleanup(
        Scheduler scheduler,
        String tenantCode,
        String kbUuid,
        Long kbId
) throws SchedulerException {

    SJobManagerBo job = new SJobManagerBo();

    // ä»»åŠ¡ååŒ…å«kbUuidï¼Œç¡®ä¿å”¯ä¸€æ€§
    job.setJob_name(SchedulerConstants.TEMP_KB_CLEANUP.JOB_NAME + "-" + kbUuid);
    job.setJob_group_type(SchedulerConstants.TEMP_KB_CLEANUP.JOB_GROUP_TYPE);
    job.setJob_desc(SchedulerConstants.TEMP_KB_CLEANUP.JOB_DESC + " - " + kbUuid);
    job.setMisfire_policy(SchedulerConstants.TEMP_KB_CLEANUP.MISFIRE_POLICY);
    job.setConcurrent(SchedulerConstants.TEMP_KB_CLEANUP.CONCURRENT);
    job.setIs_cron(false); // SimpleTriggerå•æ¬¡æ‰§è¡Œ
    job.setIs_del(SchedulerConstants.TEMP_KB_CLEANUP.IS_DEL);
    job.setIs_effected(SchedulerConstants.TEMP_KB_CLEANUP.IS_EFFECTED);
    job.setNext_fire_time(LocalDateTime.now().plusHours(2)); // 2å°æ—¶åæ‰§è¡Œ
    job.setClass_name(SchedulerConstants.TEMP_KB_CLEANUP.CLASS_NAME);
    job.setMethod_name(SchedulerConstants.TEMP_KB_CLEANUP.METHOD_NAME);
    job.setParam_class(SchedulerConstants.TEMP_KB_CLEANUP.PARAM_CLASS);

    // è®¾ç½®ç§Ÿæˆ·codeï¼ˆå…³é”®ï¼šAbstractQuartzJobä¼šè‡ªåŠ¨åˆ‡æ¢æ•°æ®æºï¼‰
    job.setTenant_code(tenantCode);

    // æ„å»ºå‚æ•°å¯¹è±¡ï¼ˆJSONæ ¼å¼ï¼‰
    try {
        ObjectMapper objectMapper = new ObjectMapper();
        TempKbCleanupParamVo paramVo = new TempKbCleanupParamVo();
        paramVo.setKbUuid(kbUuid);
        paramVo.setTenantCode(tenantCode);
        job.setParam_data(objectMapper.writeValueAsString(paramVo));
    } catch (Exception e) {
        log.error("æ„å»ºä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†ä»»åŠ¡å‚æ•°å¤±è´¥ï¼ŒkbUuid: {}", kbUuid, e);
        throw new SchedulerException("å‚æ•°åºåˆ—åŒ–å¤±è´¥", e);
    }

    // ä»»åŠ¡å…³è”åˆ°å…·ä½“çš„çŸ¥è¯†åº“
    job.setJob_serial_type("ai_temp_kb_cleanup");
    job.setJob_serial_id(kbId);

    // å†™å…¥ç§Ÿæˆ·åº“
    SJobEntity entity = (SJobEntity) BeanUtilsSupport.copyProperties(job, SJobEntity.class);
    SpringUtils.getBean(ISJobQuartzService.class).save(entity);
    job.setId(entity.getId());

    // å†™å…¥Masteråº“ï¼ˆå…³é”®ï¼šåŒ…å«tenant_codeï¼‰
    job.setTenant_job_id(entity.getId());
    SpringUtils.getBean(ISJobManagerQuartzService.class).insert(job);

    // åˆ›å»ºè°ƒåº¦ä»»åŠ¡ï¼ˆSimpleTriggerå•æ¬¡æ‰§è¡Œï¼‰
    return createScheduleJobSimpleTrigger(scheduler, job);
}
```

---

## äº”ã€SchedulerConstants æ·»åŠ å¸¸é‡

### æ–‡ä»¶ä½ç½®
`scm-quartz/src/main/java/com/xinyirun/scm/quartz/util/SchedulerConstants.java`

### æ·»åŠ ä½ç½®
åœ¨ `KNOWLEDGE_BASE_STATISTICS` ç±»å®šä¹‰åï¼ˆLine 70åï¼‰æ·»åŠ ï¼š

```java
/**
 * ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†
 */
public static class TEMP_KB_CLEANUP {
    public static final String JOB_NAME = "ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†";
    public static final String JOB_GROUP_TYPE = DictConstant.DICT_SYS_JOB_GROUP_TYPE_AI_TEMP_KB_CLEANUP;
    public static final String JOB_DESC = "æ¸…ç†è¿‡æœŸçš„ä¸´æ—¶çŸ¥è¯†åº“åŠå…¶å…³è”æ•°æ®";
    // 0=é»˜è®¤,1=ç«‹å³è§¦å‘æ‰§è¡Œ,2=è§¦å‘ä¸€æ¬¡æ‰§è¡Œ,3=ä¸è§¦å‘ç«‹å³æ‰§è¡Œ
    public static final String MISFIRE_POLICY = "2"; // è§¦å‘ä¸€æ¬¡æ‰§è¡Œ
    public static final Boolean CONCURRENT = false; // ç¦æ­¢å¹¶å‘æ‰§è¡Œ
    public static final Boolean IS_DEL = false;
    public static final Boolean IS_EFFECTED = true;
    public static final String CLASS_NAME = "com.xinyirun.scm.ai.core.service.milvus.TempKnowledgeBaseCleanupService";
    public static final String METHOD_NAME = "cleanupTempKnowledgeBase";
    public static final String PARAM_CLASS = "com.xinyirun.scm.bean.system.vo.business.ai.TempKbCleanupParamVo";
}
```

---

## å…­ã€DictConstant æ·»åŠ å­—å…¸å¸¸é‡

### æ–‡ä»¶ä½ç½®
`scm-common/src/main/java/com/xinyirun/scm/common/constant/DictConstant.java`

### æ·»åŠ å†…å®¹
åœ¨AIç›¸å…³å¸¸é‡åŒºåŸŸæ·»åŠ ï¼š

```java
/**
 * å®šæ—¶ä»»åŠ¡ç»„ç±»å‹ - AIä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†
 */
public static final String DICT_SYS_JOB_GROUP_TYPE_AI_TEMP_KB_CLEANUP = "11";
```

---

## ä¸ƒã€KnowledgeBaseService ä¿®æ”¹

### æ–‡ä»¶ä½ç½®
`scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/KnowledgeBaseService.java`

### ä¿®æ”¹ä½ç½®
åœ¨ `saveOrUpdate()` æ–¹æ³•ä¸­ï¼Œä¸´æ—¶çŸ¥è¯†åº“åˆ›å»ºé€»è¾‘åæ·»åŠ ï¼š

```java
@Transactional(rollbackFor = Exception.class)
public AiKnowledgeBaseVo saveOrUpdate(AiKnowledgeBaseVo vo) {
    AiKnowledgeBaseEntity entity = new AiKnowledgeBaseEntity();
    boolean isNew = (vo.getKbUuid() == null || vo.getKbUuid().isEmpty());

    if (isNew) {
        BeanUtils.copyProperties(vo, entity, "id");

        // ç”Ÿæˆkb_uuid
        String tenantCode = DataSourceHelper.getCurrentDataSourceName();
        String uuid = UuidUtil.createShort();
        entity.setKbUuid(tenantCode + "::" + uuid);

        // è®¾ç½®æ‰€æœ‰è€…
        Long currentUserId = SecurityUtil.getStaff_id();
        entity.setOwnerId(String.valueOf(currentUserId));
        MStaffVo staffVo = staffService.selectByid(currentUserId);
        if (staffVo != null && staffVo.getName() != null) {
            entity.setOwnerName(staffVo.getName());
        }

        // ä¸´æ—¶çŸ¥è¯†åº“ç‰¹æ®Šå¤„ç†
        if (vo.getIsTemp() != null && vo.getIsTemp() == 1) {
            entity.setIs_temp(1);
            entity.setExpire_time(LocalDateTime.now().plusHours(2));
            entity.setIs_public(0); // ä¸´æ—¶çŸ¥è¯†åº“å¼ºåˆ¶ç§æœ‰

            // åº”ç”¨é»˜è®¤é…ç½®ï¼ˆå‚è€ƒKB ID: 1994334750959017986ï¼‰
            entity.setIngest_max_overlap(2000);
            entity.setIngest_model_id("7");
            entity.setRetrieve_max_results(5);
            entity.setRetrieve_min_score(new BigDecimal("0.5000"));
            entity.setQuery_llm_temperature(new BigDecimal("0.00"));
            entity.setIs_strict(1);
            entity.setQuery_system_message("è¯·è¿”å›æœ¬çŸ¥è¯†åº“çš„çš„å®Œæ•´åŸæ–‡æ¸…å•ï¼Œé€æ¡åˆ—å‡ºã€‚\nè¦æ±‚ï¼š\n- å…¨éƒ¨çš„æ¸…å•ï¼Œä¸è¦é‡å¤\n- ä»…è¾“å‡ºåŸæ–‡å†…å®¹ï¼Œä¸è¦æ€»ç»“ã€æ¦‚æ‹¬ã€æ‰©å†™æˆ–æ”¹å†™ã€‚\n- ä¿ç•™åŸå§‹é¡ºåºä¸è¡¨è¿°ï¼Œä¸æ–°å¢æˆ–åˆ é™¤ä¿¡æ¯ã€‚\n- ä¸æ·»åŠ ä»»ä½•å‰åç¼€ã€è§£é‡Šæˆ–è¯„è®ºã€‚\n- è‹¥å­˜åœ¨åˆ†èŠ‚/æ¡ç›®,è¯·æŒ‰åŸæ–‡åˆ†èŠ‚/åˆ†æ¡ä¾æ¬¡åˆ—å‡ºã€‚\n- è‹¥æŸ¥æ— å†…å®¹ï¼Œè¯·æ˜ç¡®è¯´æ˜\"æœªæ‰¾åˆ°ç›¸å…³åŸæ–‡\"ã€‚");
        }

        knowledgeBaseMapper.insert(entity);
        BeanUtils.copyProperties(entity, vo);

        // âœ… æ–°å¢ï¼šåˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†ä»»åŠ¡
        if (entity.getIs_temp() != null && entity.getIs_temp() == 1) {
            try {
                Scheduler scheduler = SpringUtils.getBean(Scheduler.class);
                boolean created = ScheduleUtils.createJobTempKbCleanup(
                        scheduler,
                        tenantCode,
                        entity.getKbUuid(),
                        Long.parseLong(entity.getId())
                );
                if (created) {
                    log.info("ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†ä»»åŠ¡å·²åˆ›å»º: kbUuid={}, å°†åœ¨2å°æ—¶åæ‰§è¡Œ", entity.getKbUuid());
                } else {
                    log.warn("ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†ä»»åŠ¡åˆ›å»ºå¤±è´¥: kbUuid={}", entity.getKbUuid());
                }
            } catch (Exception e) {
                // ä¸å½±å“ä¸»æµç¨‹ï¼Œåªè®°å½•é”™è¯¯
                log.error("åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†ä»»åŠ¡å¤±è´¥: kbUuid={}, error={}",
                        entity.getKbUuid(), e.getMessage(), e);
            }
        }

    } else {
        // æ›´æ–°é€»è¾‘ä¿æŒä¸å˜
        // ...
    }

    return vo;
}
```

---

## å…«ã€å­—å…¸æ•°æ®ï¼ˆå¯é€‰ï¼‰

### ç”¨é€”è¯´æ˜
å­—å…¸æ•°æ®**ä»…ç”¨äºå‰ç«¯æ˜¾ç¤º**ï¼Œä¸å½±å“ä»»åŠ¡æ‰§è¡Œã€‚å¦‚æœä¸æ·»åŠ ï¼š
- ä»»åŠ¡æ­£å¸¸æ‰§è¡Œ âœ…
- s_jobè¡¨è®°å½•æ­£å¸¸åˆ›å»º âœ…
- å‰ç«¯æ˜¾ç¤ºåŸå§‹å€¼ `'11'` è€Œé `'AIä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†'` âš ï¸

### SQLè¯­å¥ï¼ˆå¯é€‰æ‰§è¡Œï¼‰
```sql
-- æ·»åŠ å­—å…¸ç±»å‹ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
INSERT INTO s_dict_type (code, name, descr, c_time, u_time, is_del, dbversion)
VALUES ('sys_job_group_type', 'å®šæ—¶ä»»åŠ¡ç»„ç±»å‹', 'å®šæ—¶ä»»åŠ¡åˆ†ç»„ç±»å‹', NOW(), NOW(), 0, 1)
ON DUPLICATE KEY UPDATE u_time = NOW();

-- æ·»åŠ å­—å…¸æ•°æ®ï¼šAIä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†
INSERT INTO s_dict_data (
    code,
    dict_type_id,
    label,
    dict_value,
    sort,
    extra1,
    descr,
    c_time,
    u_time,
    is_del,
    dbversion
)
SELECT
    'sys_job_group_type',
    id,
    'AIä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†',
    '11',
    11,
    '0',
    'æ¸…ç†è¿‡æœŸçš„ä¸´æ—¶çŸ¥è¯†åº“åŠå…¶å…³è”æ•°æ®',
    NOW(),
    NOW(),
    0,
    1
FROM s_dict_type
WHERE code = 'sys_job_group_type'
ON DUPLICATE KEY UPDATE u_time = NOW();
```

---

## ä¹ã€å®æ–½æ­¥éª¤ï¼ˆä¿®æ­£ï¼‰

### æ­¥éª¤1ï¼šæ•°æ®åº“å˜æ›´
```sql
-- ä¿®æ”¹ai_knowledge_baseè¡¨
ALTER TABLE ai_knowledge_base
ADD COLUMN is_temp TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦ä¸´æ—¶çŸ¥è¯†åº“(0-å¦,1-æ˜¯)',
ADD COLUMN expire_time DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´';

CREATE INDEX idx_ai_knowledge_base_temp_cleanup
ON ai_knowledge_base(is_temp, expire_time);

-- ï¼ˆå¯é€‰ï¼‰æ·»åŠ å­—å…¸æ•°æ®
-- æ‰§è¡Œä¸Šæ–¹"å…«ã€å­—å…¸æ•°æ®"ä¸­çš„SQL
```

### æ­¥éª¤2ï¼šåç«¯ä»£ç éƒ¨ç½²
1. æ–°å¢ `TempKnowledgeBaseCleanupService.java`
2. æ–°å¢ `TempKbCleanupParamVo.java`
3. ä¿®æ”¹ `ScheduleUtils.java` æ·»åŠ  `createJobTempKbCleanup` æ–¹æ³•
4. ä¿®æ”¹ `SchedulerConstants.java` æ·»åŠ å¸¸é‡
5. ä¿®æ”¹ `DictConstant.java` æ·»åŠ å­—å…¸å¸¸é‡
6. ä¿®æ”¹ `KnowledgeBaseService.java` æ·»åŠ ä»»åŠ¡åˆ›å»ºé€»è¾‘
7. ä¿®æ”¹å®ä½“ç±»ã€VOç±»ï¼ˆåŸæ–¹æ¡ˆå·²è¦†ç›–ï¼‰

### æ­¥éª¤3ï¼šå‰ç«¯ä»£ç éƒ¨ç½²
ï¼ˆåŸæ–¹æ¡ˆå·²è¦†ç›–ï¼‰

### æ­¥éª¤4ï¼šéªŒè¯
```bash
# 1. åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“
POST /api/knowledgeBase/saveOrUpdate
{
  "title": "æµ‹è¯•ä¸´æ—¶çŸ¥è¯†åº“",
  "isTemp": 1,
  ...
}

# 2. æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åˆ›å»º
SELECT * FROM s_job
WHERE job_name LIKE 'ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†-%'
ORDER BY c_time DESC;

# 3. æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œæ—¶é—´
-- next_fire_time åº”è¯¥æ˜¯å½“å‰æ—¶é—´+2å°æ—¶

# 4. éªŒè¯ä»»åŠ¡æ‰§è¡Œï¼ˆ2å°æ—¶åï¼‰
-- æ£€æŸ¥ä¸´æ—¶çŸ¥è¯†åº“æ˜¯å¦è¢«åˆ é™¤
SELECT * FROM ai_knowledge_base WHERE is_temp = 1;

# 5. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
-- ä»»åŠ¡æ‰§è¡Œååº”è¯¥è‡ªåŠ¨å¤±æ•ˆï¼ˆis_effected = 0ï¼‰
SELECT * FROM s_job WHERE job_serial_type = 'ai_temp_kb_cleanup';
```

---

## åã€è®¾è®¡å¯¹æ¯”æ€»ç»“

| å¯¹æ¯”é¡¹ | âŒ é”™è¯¯è®¾è®¡ | âœ… æ­£ç¡®è®¾è®¡ |
|-------|-----------|-----------|
| **ä»»åŠ¡åˆ›å»ºæ—¶æœº** | ç³»ç»Ÿå¯åŠ¨æ—¶å…¨å±€æ³¨å†Œ | åˆ›å»ºä¸´æ—¶KBæ—¶åŠ¨æ€åˆ›å»º |
| **ä»»åŠ¡ç±»å‹** | Cronè¡¨è¾¾å¼ï¼ˆ`0 */10 * * * ?`ï¼‰ | SimpleTriggerï¼ˆå•æ¬¡æ‰§è¡Œï¼‰ |
| **æ‰§è¡Œæ—¶é—´** | æ¯10åˆ†é’Ÿé‡å¤æ‰§è¡Œ | åˆ›å»ºå2å°æ—¶æ‰§è¡Œä¸€æ¬¡ |
| **æ‰§è¡ŒèŒƒå›´** | å…¨å±€æ‰«ææ‰€æœ‰è¿‡æœŸKB | ç²¾ç¡®æ¸…ç†æŒ‡å®šçš„KB |
| **æŸ¥è¯¢æ–¹å¼** | LambdaQueryWrapperï¼ˆè¿åè§„èŒƒï¼‰ | æ— éœ€æŸ¥è¯¢ï¼Œç›´æ¥è°ƒç”¨delete |
| **ä»»åŠ¡å‚æ•°** | æ— å‚æ•° | TempKbCleanupParamVoï¼ˆåŒ…å«kbUuidï¼‰ |
| **ä»»åŠ¡å…³è”** | æ— å…³è” | job_serial_id = kb.getId() |
| **æ‰§è¡ŒåçŠ¶æ€** | æ°¸ä¹…å­˜åœ¨ï¼Œä¸æ–­é‡å¤ | è‡ªåŠ¨å¤±æ•ˆï¼ˆis_effected = 0ï¼‰ |
| **æ€§èƒ½å¼€é”€** | æ¯10åˆ†é’Ÿå…¨è¡¨æ‰«æ | ç²¾ç¡®å®šä½ï¼Œé›¶æ‰«æ |
| **s_jobè¡¨** | éœ€è¦æ‰‹åŠ¨INSERTä¸€æ¡å…¨å±€ä»»åŠ¡ | æ¯ä¸ªä¸´æ—¶KBè‡ªåŠ¨åˆ›å»ºä¸€æ¡ä»»åŠ¡ |
| **ä»»åŠ¡æ¸…ç†** | éœ€è¦æ‰‹åŠ¨æ¸…ç†æ—§ä»»åŠ¡ | è‡ªåŠ¨å¤±æ•ˆï¼Œæ— éœ€æ¸…ç† |

---

## åä¸€ã€å…³é”®ä¿®æ­£æ€»ç»“

| åŸæ–¹æ¡ˆé—®é¢˜ | ä¿®æ­£æ–¹æ¡ˆ |
|-----------|---------|
| âŒ ä½¿ç”¨LambdaQueryWrapperæŸ¥è¯¢ | âœ… å¤ç”¨knowledgeBaseService.delete()ï¼Œæ— éœ€æŸ¥è¯¢ |
| âŒ å…¨å±€Cronå®šæ—¶ä»»åŠ¡ | âœ… åŠ¨æ€åˆ›å»ºSimpleTriggerå•æ¬¡ä»»åŠ¡ |
| âŒ æ¯10åˆ†é’Ÿæ‰«æå…¨è¡¨ | âœ… ç²¾ç¡®å®šæ—¶ï¼Œé›¶æ‰«æ |
| âŒ åœ¨scm-quartzåˆ›å»ºJobç±» | âœ… åœ¨scm-ai/milvusåˆ›å»ºService |
| âŒ ç³»ç»Ÿå¯åŠ¨æ—¶æ³¨å†Œä»»åŠ¡ | âœ… åˆ›å»ºä¸´æ—¶KBæ—¶åŠ¨æ€åˆ›å»ºä»»åŠ¡ |
| âŒ ä»»åŠ¡æ°¸ä¹…å­˜åœ¨ | âœ… ä»»åŠ¡æ‰§è¡Œåè‡ªåŠ¨å¤±æ•ˆ |
| âŒ éœ€è¦ParamVoä½†æœªä½¿ç”¨ | âœ… æ­£ç¡®ä½¿ç”¨TempKbCleanupParamVoä¼ å‚ |

---

## åäºŒã€ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### Q1: ä¸ºä»€ä¹ˆä¸ä½¿ç”¨Cronå®šæ—¶ä»»åŠ¡ï¼Ÿ
**A**:
- Cronä»»åŠ¡éœ€è¦å…¨è¡¨æ‰«æï¼Œæ€§èƒ½å¼€é”€å¤§
- æ¯ä¸ªä¸´æ—¶çŸ¥è¯†åº“çš„è¿‡æœŸæ—¶é—´ä¸åŒï¼Œæ— æ³•ç”¨å›ºå®šå‘¨æœŸå¤„ç†
- SimpleTriggerå¯ä»¥ç²¾ç¡®å®šæ—¶åˆ°æ¯ä¸ªçŸ¥è¯†åº“çš„è¿‡æœŸæ—¶é—´

### Q2: ä¸ºä»€ä¹ˆä¸ä½¿ç”¨LambdaQueryWrapperï¼Ÿ
**A**:
- è¿åSCMè§„èŒƒç¬¬17ã€24æ¡ï¼š"æŸ¥è¯¢è¦ä½¿ç”¨sql"
- æœ¬æ–¹æ¡ˆæ— éœ€æŸ¥è¯¢ï¼Œç›´æ¥è°ƒç”¨deleteæ–¹æ³•å³å¯

### Q3: ä¸ºä»€ä¹ˆä»»åŠ¡å‚æ•°éœ€è¦kbUuidï¼Ÿ
**A**:
- æ¯ä¸ªä»»åŠ¡åªæ¸…ç†ä¸€ä¸ªçŸ¥è¯†åº“ï¼Œéœ€è¦æ˜ç¡®ç›®æ ‡
- å‚è€ƒcreateJobKnowledgeBaseStatisticsçš„è®¾è®¡æ¨¡å¼
- é¿å…å…¨è¡¨æ‰«æï¼Œæé«˜æ‰§è¡Œæ•ˆç‡

### Q4: ä¸ºä»€ä¹ˆåœ¨KnowledgeBaseServiceä¸­åˆ›å»ºä»»åŠ¡ï¼Ÿ
**A**:
- ä¸šåŠ¡é€»è¾‘é©±åŠ¨ï¼šåˆ›å»ºä¸´æ—¶KBæ—¶ç«‹å³å®‰æ’æ¸…ç†
- äº‹åŠ¡ä¸€è‡´æ€§ï¼šä»»åŠ¡åˆ›å»ºå¤±è´¥ä¸å½±å“KBåˆ›å»º
- è§£è€¦è®¾è®¡ï¼šæ¸…ç†ä»»åŠ¡çš„åˆ›å»ºå±äºä¸šåŠ¡é€»è¾‘

### Q5: s_jobè¡¨ä¼šä¸ä¼šå †ç§¯å¾ˆå¤šä»»åŠ¡è®°å½•ï¼Ÿ
**A**:
- ä»»åŠ¡æ‰§è¡Œåè‡ªåŠ¨å¤±æ•ˆï¼ˆ`is_effected = 0`ï¼‰
- SCMç³»ç»Ÿå¯ä»¥å®šæœŸæ¸…ç†å¤±æ•ˆä»»åŠ¡ï¼ˆå¦‚æœæœ‰æ­¤æœºåˆ¶ï¼‰
- ç›¸æ¯”Cronæ–¹å¼ï¼Œæ¯ä¸ªä¸´æ—¶KBåªåˆ›å»ºä¸€æ¡è®°å½•ï¼Œæ›´å¯æ§

---

## åä¸‰ã€æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸åˆ›å»ºå’Œæ¸…ç†
```bash
# 1. åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“
POST /api/knowledgeBase/saveOrUpdate
å“åº”ï¼š{"id": "123", "kbUuid": "tenant::abc123", "isTemp": 1, "expireTime": "2025-12-03 19:50:00"}

# 2. éªŒè¯ä»»åŠ¡åˆ›å»º
SELECT * FROM s_job WHERE job_serial_id = 123;
-- åº”è¯¥è¿”å›1æ¡è®°å½•ï¼Œnext_fire_time = 2025-12-03 19:50:00

# 3. ç­‰å¾…2å°æ—¶åéªŒè¯
SELECT * FROM ai_knowledge_base WHERE id = '123';
-- åº”è¯¥è¿”å›ç©ºç»“æœï¼ˆå·²è¢«åˆ é™¤ï¼‰

SELECT * FROM s_job WHERE job_serial_id = 123;
-- is_effected = 0ï¼ˆä»»åŠ¡å·²å¤±æ•ˆï¼‰
```

### åœºæ™¯2ï¼šä»»åŠ¡æ‰§è¡Œå‰æ‰‹åŠ¨åˆ é™¤
```bash
# 1. åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“
POST /api/knowledgeBase/saveOrUpdate

# 2. æ‰‹åŠ¨åˆ é™¤ä¸´æ—¶çŸ¥è¯†åº“
DELETE /api/knowledgeBase/{kbUuid}

# 3. 2å°æ—¶åä»»åŠ¡æ‰§è¡Œ
-- ä»»åŠ¡æ‰§è¡Œæ—¶å‘ç°KBå·²ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸
-- ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸ºå¤±è´¥ï¼Œä¸å½±å“å…¶ä»–ä»»åŠ¡
```

### åœºæ™¯3ï¼šç³»ç»Ÿé‡å¯
```bash
# 1. åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“
POST /api/knowledgeBase/saveOrUpdate

# 2. ç³»ç»Ÿé‡å¯

# 3. éªŒè¯ä»»åŠ¡æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
-- s_job_managerè¡¨ä¸­çš„ä»»åŠ¡è®°å½•ä»ç„¶å­˜åœ¨
-- Quartzä¼šåœ¨å¯åŠ¨æ—¶é‡æ–°åŠ è½½ä»»åŠ¡
-- 2å°æ—¶åä»»åŠ¡æ­£å¸¸æ‰§è¡Œ
```

---

**è¡¥å……ä¿®æ­£å®Œæˆï¼Œè¯·é‡æ–°å®¡é˜…æ–¹æ¡ˆã€‚**
