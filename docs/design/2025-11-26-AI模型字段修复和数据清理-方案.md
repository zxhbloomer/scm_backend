# AIæ¨¡å‹å­—æ®µä¿®å¤å’Œæ•°æ®æ¸…ç† - æŠ€æœ¯æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-26
**ä½œè€…**: SCM-AIå›¢é˜Ÿ
**çŠ¶æ€**: å¾…å®¡æ‰¹

---

## 1. éœ€æ±‚èƒŒæ™¯

### 1.1 é—®é¢˜æè¿°

å½“å‰AI Chatè°ƒç”¨Workflowåœºæ™¯ä¸‹,`ai_conversation_content`è¡¨çš„ä¸‰ä¸ªæ¨¡å‹å­—æ®µå­˜åœ¨é”™è¯¯èµ‹å€¼:
- `model_source_id` â†’ èµ‹å€¼ä¸º `null`
- `provider_name` â†’ ç¡¬ç¼–ç ä¸º `"workflow"` å­—ç¬¦ä¸²
- `base_name` â†’ ç¡¬ç¼–ç ä¸º `"workflow"` å­—ç¬¦ä¸²

**é—®é¢˜ä»£ç ä½ç½®**: `AiConversationContentService.java:67-69`

```java
// âŒ å½“å‰é”™è¯¯ä»£ç 
entity.setModelSourceId(null);
entity.setProviderName("workflow");
entity.setBaseName("workflow");
```

### 1.2 ä¸šåŠ¡å½±å“

1. **æ•°æ®ç»Ÿè®¡é”™è¯¯**: æ— æ³•å‡†ç¡®ç»Ÿè®¡å„æ¨¡å‹çš„çœŸå®è°ƒç”¨é‡
2. **æ—¥å¿—åˆ†æå›°éš¾**: ClickHouseæ—¥å¿—ä¸­æ¨¡å‹ä¿¡æ¯ä¸å‡†ç¡®
3. **è´¦å•æ ¸ç®—é—®é¢˜**: æ— æ³•è¿½è¸ªWorkflowåœºæ™¯ä¸‹çš„æ¨¡å‹æˆæœ¬
4. **ç³»ç»Ÿç›‘æ§ç¼ºå¤±**: æ— æ³•æŒ‰æ¨¡å‹ç»´åº¦ç›‘æ§æ€§èƒ½æŒ‡æ ‡

### 1.3 æ¸…ç†éœ€æ±‚

åŒæ—¶éœ€è¦æ¸…ç†ä»¥ä¸‹å†—ä½™æ•°æ®:
1. **workflow_idå­—æ®µ**: å·²è¢«output_dataæ›¿ä»£,éœ€è¦åˆ é™¤
2. **ai_drawæ¨¡å—**: ä»…æœ‰TODOå®ç°,éœ€è¦æ•´ä½“åˆ é™¤(8æ–‡ä»¶+3è¡¨)
3. **ai_mcpæ¨¡å—**: MCPåŠŸèƒ½æ”¹ä¸ºå®šä¹‰æ–¹å¼,è¡¨ç®¡ç†å·²åºŸå¼ƒ(8æ–‡ä»¶+2è¡¨)

---

## 2. KISSåŸåˆ™åˆ†æ

### 2.1 ä¸‰ä¸ªå…³é”®é—®é¢˜

**Q1: "è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„?"**
âœ… **çœŸé—®é¢˜**
- æ•°æ®åº“å·²å­˜åœ¨300+æ¡é”™è¯¯æ•°æ®(model_source_id=null)
- å®é™…ä¸šåŠ¡åœºæ™¯: AI Chat â†’ Workflow â†’ LLMèŠ‚ç‚¹è°ƒç”¨ â†’ ä¿å­˜å¯¹è¯è®°å½•
- å½±å“ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®ç»Ÿè®¡å’Œæˆæœ¬æ ¸ç®—

**Q2: "æœ‰æ›´ç®€å•çš„æ–¹æ³•å—?"**
âœ… **å½“å‰æ–¹æ¡ˆå·²æ˜¯æœ€ç®€**
- æ–¹æ¡ˆ1: åœ¨saveContent()å†…éƒ¨è·å–é»˜è®¤æ¨¡å‹ (1å¤„ä¿®æ”¹) â­
- æ–¹æ¡ˆ2: è°ƒç”¨å¤„ä¼ é€’æ¨¡å‹ä¿¡æ¯ (5+å¤„ä¿®æ”¹) âŒ
- æ–¹æ¡ˆ3: äº‹åæ‰¹é‡ä¿®æ­£æ•°æ® (æ²»æ ‡ä¸æ²»æœ¬) âŒ

**Q3: "ä¼šç ´åä»€ä¹ˆå—?"**
âœ… **é›¶ç ´åæ€§**
- ä»…ä¿®æ”¹å†…éƒ¨é€»è¾‘,ä¸æ”¹å˜æ–¹æ³•ç­¾å
- å¯¹ç°æœ‰è°ƒç”¨æ–¹å®Œå…¨é€æ˜
- å‘åå…¼å®¹æ‰€æœ‰ç°æœ‰ä»£ç 

### 2.2 å¤æ‚åº¦å®¡æŸ¥

**åŠŸèƒ½æœ¬è´¨**: "ä¿å­˜å¯¹è¯æ—¶,è®°å½•å®é™…ä½¿ç”¨çš„æ¨¡å‹ä¿¡æ¯"

**å½“å‰æ–¹æ¡ˆ**:
- æ–°å¢1ä¸ªä¾èµ–æ³¨å…¥ (AiModelConfigService)
- ä¿®æ”¹3è¡Œèµ‹å€¼ä»£ç 
- æ–°å¢1ä¸ªtry-catchå¼‚å¸¸å¤„ç†
- **æ€»å¤æ‚åº¦**: O(1) - æç®€

**æ— å¤šä½™æ¦‚å¿µ**:
- âœ… å¤ç”¨ç°æœ‰æ¨¡å‹é…ç½®ç³»ç»Ÿ
- âœ… å¤ç”¨ç°æœ‰DEFAULT_LLM_MODEL_IDé…ç½®
- âŒ ä¸å¼•å…¥æ–°è¡¨ã€æ–°å­—æ®µã€æ–°é…ç½®

---

## 3. æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

### 3.1 æ ¸å¿ƒä¿®æ”¹æ–¹æ¡ˆ

#### 3.1.1 ä¿®æ”¹æ–‡ä»¶

**æ–‡ä»¶**: `AiConversationContentService.java`
**ä¿®æ”¹ä½ç½®**: Line 55-69 (saveContentæ–¹æ³•)

#### 3.1.2 ä¿®æ”¹å‰ä»£ç 

```java
@Service
@Transactional(propagation = Propagation.NOT_SUPPORTED)
@Slf4j
public class AiConversationContentService {

    @Resource
    private AiConversationContentMapper aiConversationContentMapper;

    @Autowired
    private LogAiChatProducer logAiChatProducer;

    public AiConversationContentVo saveContent(String conversationId, Integer role, String content, Long operatorId, String runtimeUuid) {
        try {
            AiConversationContentEntity entity = new AiConversationContentEntity();
            entity.setMessageId(UuidUtil.createShort());
            entity.setConversationId(conversationId);
            entity.setType(role == 1 ? AiMessageTypeConstant.MESSAGE_TYPE_USER : AiMessageTypeConstant.MESSAGE_TYPE_ASSISTANT);
            entity.setContent(StringUtils.isNotBlank(content) ? content.trim() : content);
            entity.setRuntimeUuid(runtimeUuid);

            // âŒ é”™è¯¯: Workflowåœºæ™¯ç¡¬ç¼–ç é”™è¯¯å€¼
            entity.setModelSourceId(null);
            entity.setProviderName("workflow");
            entity.setBaseName("workflow");

            // ... å…¶ä½™ä»£ç 
        }
    }
}
```

#### 3.1.3 ä¿®æ”¹åä»£ç 

```java
@Service
@Transactional(propagation = Propagation.NOT_SUPPORTED)
@Slf4j
public class AiConversationContentService {

    @Resource
    private AiConversationContentMapper aiConversationContentMapper;

    @Autowired
    private LogAiChatProducer logAiChatProducer;

    // âœ… æ–°å¢: æ³¨å…¥æ¨¡å‹é…ç½®æœåŠ¡
    @Autowired
    private AiModelConfigService aiModelConfigService;

    public AiConversationContentVo saveContent(String conversationId, Integer role, String content, Long operatorId, String runtimeUuid) {
        try {
            AiConversationContentEntity entity = new AiConversationContentEntity();
            entity.setMessageId(UuidUtil.createShort());
            entity.setConversationId(conversationId);
            entity.setType(role == 1 ? AiMessageTypeConstant.MESSAGE_TYPE_USER : AiMessageTypeConstant.MESSAGE_TYPE_ASSISTANT);
            entity.setContent(StringUtils.isNotBlank(content) ? content.trim() : content);
            entity.setRuntimeUuid(runtimeUuid);

            // âœ… ä¿®å¤: ä»ai_configè·å–é»˜è®¤LLMæ¨¡å‹é…ç½®
            try {
                AiModelConfigVo defaultModel = aiModelConfigService.getDefaultModelConfigWithKey("LLM");
                entity.setModelSourceId(String.valueOf(defaultModel.getId()));
                entity.setProviderName(defaultModel.getProvider());
                entity.setBaseName(defaultModel.getModelName());
            } catch (Exception e) {
                // é™çº§å¤„ç†: è·å–å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼,ä¸å½±å“ä¸»æµç¨‹
                log.warn("è·å–é»˜è®¤LLMæ¨¡å‹é…ç½®å¤±è´¥,ä½¿ç”¨é™çº§å€¼: {}", e.getMessage());
                entity.setModelSourceId(null);
                entity.setProviderName("workflow");
                entity.setBaseName("workflow");
            }

            // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜
        }
    }
}
```

### 3.2 æ•°æ®æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Chatè°ƒç”¨Workflow  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Workflowæ‰§è¡Œ(LLMèŠ‚ç‚¹) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WorkflowRoutingService.streamWorkflow() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AiConversationContentService.saveContent() â”‚ â¬…ï¸ æœ¬æ¬¡ä¿®æ”¹ä½ç½®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ è·å–é»˜è®¤æ¨¡å‹é…ç½®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AiModelConfigService.getDefaultModelConfigWithKey("LLM") â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ Step 1: æŸ¥è¯¢é»˜è®¤æ¨¡å‹ID
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AiConfigService.getConfigValue("DEFAULT_LLM_MODEL_ID") â”‚
â”‚ è¿”å›: "5"                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ Step 2: æŸ¥è¯¢æ¨¡å‹é…ç½®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT * FROM ai_model_config WHERE id=5  â”‚
â”‚ è¿”å›:                                     â”‚
â”‚ - id: 5                                  â”‚
â”‚ - model_name: "deepseek-ai/DeepSeek-V3.1" â”‚
â”‚ - provider: "SiliconFlow"                â”‚
â”‚ - enabled: 1                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ Step 3: è®¾ç½®æ­£ç¡®å­—æ®µå€¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ entity.setModelSourceId("5")             â”‚
â”‚ entity.setProviderName("SiliconFlow")    â”‚
â”‚ entity.setBaseName("deepseek-ai/...")    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INSERT INTO ai_conversation_content      â”‚
â”‚ ä¿å­˜æ­£ç¡®çš„æ¨¡å‹å­—æ®µå€¼ âœ…                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 å¼‚å¸¸å¤„ç†ç­–ç•¥

**é™çº§ç­–ç•¥**: å½“è·å–é»˜è®¤æ¨¡å‹é…ç½®å¤±è´¥æ—¶
1. è®°å½•è­¦å‘Šæ—¥å¿— (log.warn)
2. ä½¿ç”¨æ—§çš„é™çº§å€¼ ("workflow")
3. **ä¸ä¸­æ–­ä¸»æµç¨‹** - ç¡®ä¿å¯¹è¯ä¿å­˜æˆåŠŸ
4. åç»­å¯é€šè¿‡æ—¥å¿—å‘Šè­¦å‘ç°é…ç½®é—®é¢˜

**è§¦å‘åœºæ™¯**:
- ai_configè¡¨æœªé…ç½®DEFAULT_LLM_MODEL_ID
- é…ç½®çš„æ¨¡å‹IDåœ¨ai_model_configä¸­ä¸å­˜åœ¨
- æ¨¡å‹è¢«ç¦ç”¨ (enabled=0)
- æ•°æ®åº“è¿æ¥å¼‚å¸¸

---

## 4. ä»£ç æ¸…ç†æ–¹æ¡ˆ

### 4.1 workflow_idå­—æ®µåˆ é™¤

#### 4.1.1 åˆ é™¤åŸå› 
- WorkflowRoutingService.java:506-508å·²å°†workflowä¿¡æ¯ä¿å­˜åˆ°`output_data` JSONå­—æ®µ
- output_dataåŒ…å«: `uuid`, `title`, `workerType`
- workflow_idå­—æ®µå·²æ— ä¸šåŠ¡ç”¨é€”

#### 4.1.2 å½±å“èŒƒå›´

**æ•°æ®åº“è¡¨**:
- `ai_conversation_runtime.workflow_id` (BIGINT)
- `ai_workflow_runtime.workflow_id` (BIGINT)

**Javaä»£ç æ–‡ä»¶** (19ä¸ª):
1. Entityç±» (2ä¸ª):
   - `AiConversationRuntimeEntity.java` - åˆ é™¤workflowIdå­—æ®µ
   - `AiWorkflowRuntimeEntity.java` - åˆ é™¤workflowIdå­—æ®µ

2. VOç±» (2ä¸ª):
   - `AiConversationRuntimeVo.java` - åˆ é™¤workflow_idå­—æ®µ
   - `AiWorkflowRuntimeVo.java` - åˆ é™¤workflow_idå­—æ®µ

3. Serviceç±» (4ä¸ª):
   - `AiConversationRuntimeService.java` - åˆ é™¤setWorkflowId()è°ƒç”¨
   - `AiWorkflowRuntimeService.java` - åˆ é™¤setWorkflowId()è°ƒç”¨
   - `AiWorkflowService.java` - æ£€æŸ¥ä¸šåŠ¡é€»è¾‘å¼•ç”¨
   - `WorkflowRoutingService.java` - åˆ é™¤ORCHESTRATOR_MODE_WORKFLOW_IDå¸¸é‡

4. Controllerç±» (3ä¸ª):
   - `AiConversationController.java` - æ£€æŸ¥APIå“åº”å­—æ®µ
   - `AiWorkflowController.java` - æ£€æŸ¥APIå“åº”å­—æ®µ
   - `AiWorkflowRuntimeController.java` - æ£€æŸ¥APIå“åº”å­—æ®µ

5. Mapperç±» (2ä¸ª):
   - `AiConversationRuntimeMapper.java` - æ£€æŸ¥SQLå¼•ç”¨
   - `AiWorkflowRuntimeMapper.java` - æ£€æŸ¥SQLå¼•ç”¨

6. XMLæ˜ å°„æ–‡ä»¶ (2ä¸ª):
   - `AiConversationRuntimeMapper.xml` - åˆ é™¤workflow_idå­—æ®µæ˜ å°„
   - `AiWorkflowRuntimeMapper.xml` - åˆ é™¤workflow_idå­—æ®µæ˜ å°„

#### 4.1.3 æ‰§è¡Œæ­¥éª¤

```sql
-- Step 1: å¤‡ä»½æ•°æ®
CREATE TABLE ai_conversation_runtime_backup_20251126 AS SELECT * FROM ai_conversation_runtime;
CREATE TABLE ai_workflow_runtime_backup_20251126 AS SELECT * FROM ai_workflow_runtime;

-- Step 2: åˆ é™¤å­—æ®µ
ALTER TABLE ai_conversation_runtime DROP COLUMN workflow_id;
ALTER TABLE ai_workflow_runtime DROP COLUMN workflow_id;
```

### 4.2 ai_drawæ¨¡å—åˆ é™¤

#### 4.2.1 åˆ é™¤åŸå› 
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å…¨éƒ¨ä¸ºTODOæ³¨é‡Š
- æœåŠ¡å±‚æ–¹æ³•ä½“: `// TODO: å¼‚æ­¥è°ƒç”¨å›¾ç‰‡ç”ŸæˆæœåŠ¡`
- åŠŸèƒ½æœªå®ç°,ä»…æœ‰ä»£ç æ¡†æ¶

#### 4.2.2 åˆ é™¤æ–‡ä»¶æ¸…å• (8ä¸ª)

**Entityç±»** (3ä¸ª):
- `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/entity/draw/AiDrawEntity.java`
- `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/entity/draw/AiDrawCommentEntity.java`
- `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/entity/draw/AiDrawStarEntity.java`

**VOç±»** (1ä¸ª):
- `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/draw/AiDrawVo.java`

**Mapperç±»** (3ä¸ª):
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/mapper/draw/AiDrawMapper.java`
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/mapper/draw/AiDrawCommentMapper.java`
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/mapper/draw/AiDrawStarMapper.java`

**Serviceç±»** (3ä¸ª):
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/draw/AiDrawService.java` (529è¡Œ,å…¨TODO)
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/draw/AiDrawCommentService.java`
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/draw/AiDrawStarService.java`

**Controllerç±»** (1ä¸ª):
- `scm-ai/src/main/java/com/xinyirun/scm/ai/controller/draw/DrawController.java` (370è¡Œ)

#### 4.2.3 åˆ é™¤æ•°æ®åº“è¡¨ (3ä¸ª)

```sql
-- Step 1: å¤‡ä»½è¡¨ç»“æ„
CREATE TABLE ai_draw_backup_20251126 LIKE ai_draw;
CREATE TABLE ai_draw_comment_backup_20251126 LIKE ai_draw_comment;
CREATE TABLE ai_draw_star_backup_20251126 LIKE ai_draw_star;

-- Step 2: åˆ é™¤è¡¨
DROP TABLE IF EXISTS ai_draw;
DROP TABLE IF EXISTS ai_draw_comment;
DROP TABLE IF EXISTS ai_draw_star;
```

### 4.3 ai_mcpæ¨¡å—åˆ é™¤

#### 4.3.1 åˆ é™¤åŸå› 
- MCPåŠŸèƒ½æ”¹ä¸º**å®šä¹‰æ–¹å¼** (ä»£ç ä¸­æ³¨å†Œ,éæ•°æ®åº“ç®¡ç†)
- mcpToolCallbackMapåœ¨ä»£ç ä¸­ç›´æ¥å®šä¹‰
- è¡¨ç®¡ç†æ–¹å¼å·²åºŸå¼ƒ

#### 4.3.2 åˆ é™¤æ–‡ä»¶æ¸…å• (8ä¸ª)

**Entityç±»** (2ä¸ª):
- `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/entity/mcp/AiMcpEntity.java`
- `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/entity/mcp/AiUserMcpEntity.java`

**VOç±»** (2ä¸ª):
- `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/mcp/AiMcpVo.java`
- `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/mcp/AiUserMcpVo.java`

**Mapperç±»** (2ä¸ª):
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/mapper/mcp/AiMcpMapper.java`
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/mapper/mcp/AiUserMcpMapper.java`

**Serviceç±»** (2ä¸ª):
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/mcp/AiMcpService.java` (246è¡Œ)
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/mcp/AiUserMcpService.java` (291è¡Œ)

**Controllerç±»** (1ä¸ª):
- `scm-ai/src/main/java/com/xinyirun/scm/ai/controller/mcp/McpController.java` (315è¡Œ)

#### 4.3.3 åˆ é™¤æ•°æ®åº“è¡¨ (2ä¸ª)

```sql
-- Step 1: å¤‡ä»½è¡¨ç»“æ„
CREATE TABLE ai_mcp_backup_20251126 LIKE ai_mcp;
CREATE TABLE ai_user_mcp_backup_20251126 LIKE ai_user_mcp;

-- Step 2: åˆ é™¤è¡¨
DROP TABLE IF EXISTS ai_mcp;
DROP TABLE IF EXISTS ai_user_mcp;
```

---

## 5. æ•°æ®ä¿®æ­£æ–¹æ¡ˆ

### 5.1 å†å²æ•°æ®ä¿®æ­£

**é—®é¢˜**: å·²å­˜åœ¨çš„é”™è¯¯æ•°æ®éœ€è¦æ‰¹é‡ä¿®æ­£

#### 5.1.1 æŸ¥è¯¢å—å½±å“æ•°æ®

```sql
-- ç»Ÿè®¡é”™è¯¯æ•°æ®é‡
SELECT
    COUNT(*) as total_count,
    COUNT(CASE WHEN model_source_id IS NULL THEN 1 END) as null_count,
    COUNT(CASE WHEN provider_name = 'workflow' THEN 1 END) as workflow_count
FROM ai_conversation_content
WHERE runtime_uuid IS NOT NULL;  -- Workflowåœºæ™¯çš„æ•°æ®
```

#### 5.1.2 æ‰¹é‡ä¿®æ­£è„šæœ¬

```sql
-- Step 1: è·å–é»˜è®¤LLMæ¨¡å‹ID
SET @default_model_id = (
    SELECT config_value
    FROM ai_config
    WHERE config_key = 'DEFAULT_LLM_MODEL_ID'
);

-- Step 2: è·å–é»˜è®¤æ¨¡å‹ä¿¡æ¯
SELECT
    @provider := provider,
    @model_name := model_name
FROM ai_model_config
WHERE id = @default_model_id;

-- Step 3: æ‰¹é‡æ›´æ–°é”™è¯¯æ•°æ®
UPDATE ai_conversation_content
SET
    model_source_id = @default_model_id,
    provider_name = @provider,
    base_name = @model_name
WHERE
    runtime_uuid IS NOT NULL  -- Workflowåœºæ™¯
    AND (
        model_source_id IS NULL
        OR provider_name = 'workflow'
        OR base_name = 'workflow'
    );
```

### 5.2 ä¿®æ­£éªŒè¯

```sql
-- éªŒè¯ä¿®æ­£ç»“æœ
SELECT
    model_source_id,
    provider_name,
    base_name,
    COUNT(*) as count
FROM ai_conversation_content
WHERE runtime_uuid IS NOT NULL
GROUP BY model_source_id, provider_name, base_name;

-- é¢„æœŸç»“æœ:
-- model_source_id | provider_name | base_name                  | count
-- 5               | SiliconFlow   | deepseek-ai/DeepSeek-V3.1  | 300+
```

---

## 6. æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### 6.1 å•å…ƒæµ‹è¯•ç”¨ä¾‹

#### æµ‹è¯•ç”¨ä¾‹1: æ­£å¸¸åœºæ™¯ - è·å–é»˜è®¤æ¨¡å‹æˆåŠŸ
```java
@Test
public void testSaveContent_WithDefaultModel_Success() {
    // Given: é…ç½®é»˜è®¤LLMæ¨¡å‹
    AiModelConfigVo mockModel = new AiModelConfigVo();
    mockModel.setId(5L);
    mockModel.setProvider("SiliconFlow");
    mockModel.setModelName("deepseek-ai/DeepSeek-V3.1-Terminus");
    when(aiModelConfigService.getDefaultModelConfigWithKey("LLM"))
        .thenReturn(mockModel);

    // When: ä¿å­˜Workflowå¯¹è¯å†…å®¹
    AiConversationContentVo result = aiConversationContentService.saveContent(
        "conv_123", 2, "AIå›å¤å†…å®¹", 164L, "runtime_abc"
    );

    // Then: éªŒè¯æ¨¡å‹å­—æ®µæ­£ç¡®
    assertEquals("5", result.getModel_source_id());
    assertEquals("SiliconFlow", result.getProvider_name());
    assertEquals("deepseek-ai/DeepSeek-V3.1-Terminus", result.getBase_name());
}
```

#### æµ‹è¯•ç”¨ä¾‹2: é™çº§åœºæ™¯ - è·å–é»˜è®¤æ¨¡å‹å¤±è´¥
```java
@Test
public void testSaveContent_GetModelFailed_UseFallback() {
    // Given: æ¨¡æ‹Ÿè·å–æ¨¡å‹é…ç½®å¤±è´¥
    when(aiModelConfigService.getDefaultModelConfigWithKey("LLM"))
        .thenThrow(new RuntimeException("æœªé…ç½®é»˜è®¤LLMæ¨¡å‹"));

    // When: ä¿å­˜å¯¹è¯å†…å®¹
    AiConversationContentVo result = aiConversationContentService.saveContent(
        "conv_123", 2, "AIå›å¤å†…å®¹", 164L, "runtime_abc"
    );

    // Then: éªŒè¯ä½¿ç”¨é™çº§å€¼,ä¸”ä¸æŠ›å‡ºå¼‚å¸¸
    assertNull(result.getModel_source_id());
    assertEquals("workflow", result.getProvider_name());
    assertEquals("workflow", result.getBase_name());
}
```

### 6.2 é›†æˆæµ‹è¯•åœºæ™¯

#### æµ‹è¯•åœºæ™¯1: AI Chat â†’ Workflow â†’ LLMèŠ‚ç‚¹ ç«¯åˆ°ç«¯æµç¨‹
```bash
# Step 1: å‘èµ·AI Chatå¯¹è¯,è§¦å‘Workflow
POST /scm/ai/chat/conversation/send
{
  "question": "å¸®æˆ‘åˆ†æé”€å”®æ•°æ®",
  "conversationId": "conv_test_001"
}

# Step 2: ç³»ç»Ÿè‡ªåŠ¨è·¯ç”±åˆ°Workflowæ‰§è¡Œ

# Step 3: éªŒè¯æ•°æ®åº“è®°å½•
SELECT
    message_id,
    model_source_id,
    provider_name,
    base_name,
    runtime_uuid
FROM ai_conversation_content
WHERE conversation_id = 'conv_test_001'
ORDER BY c_time DESC LIMIT 1;

# é¢„æœŸç»“æœ:
# model_source_id: "5"
# provider_name: "SiliconFlow"
# base_name: "deepseek-ai/DeepSeek-V3.1-Terminus"
```

### 6.3 å›å½’æµ‹è¯•æ£€æŸ¥ç‚¹

1. **éWorkflowåœºæ™¯ä¸å—å½±å“**
   - ç›´æ¥è°ƒç”¨`saveConversationContent()`æ–¹æ³•çš„åœºæ™¯
   - æ¨¡å‹å­—æ®µæ­£ç¡®ä¼ é€’å’Œä¿å­˜

2. **MQæ¶ˆæ¯å‘é€æ­£å¸¸**
   - ClickHouseæ—¥å¿—åŒ…å«æ­£ç¡®çš„æ¨¡å‹ä¿¡æ¯
   - `SLogAiChatVo`çš„provider_nameå’Œbase_nameæ­£ç¡®

3. **æ€§èƒ½æ— å›é€€**
   - æ–°å¢æ¨¡å‹é…ç½®æŸ¥è¯¢,æ€§èƒ½æŸè€—<10ms
   - æ•°æ®åº“è¿æ¥æ± æ­£å¸¸,æ— é¢å¤–è¿æ¥æ³„æ¼

---

## 7. ä¸Šçº¿éƒ¨ç½²æ–¹æ¡ˆ

### 7.1 éƒ¨ç½²æ­¥éª¤

#### Step 1: æ•°æ®å¤‡ä»½ (é‡è¦!)
```bash
# å¤‡ä»½ai_conversation_contentè¡¨
mysqldump -u root -p scm_tenant_20250519_001 ai_conversation_content > ai_conversation_content_backup_20251126.sql

# å¤‡ä»½ai_configå’Œai_model_configè¡¨
mysqldump -u root -p scm_tenant_20250519_001 ai_config ai_model_config > ai_model_config_backup_20251126.sql
```

#### Step 2: éªŒè¯é…ç½®å®Œæ•´æ€§
```sql
-- éªŒè¯é»˜è®¤LLMæ¨¡å‹é…ç½®å­˜åœ¨
SELECT * FROM ai_config WHERE config_key = 'DEFAULT_LLM_MODEL_ID';
-- é¢„æœŸ: è¿”å›1è¡Œ,config_valueä¸ä¸ºç©º

-- éªŒè¯æ¨¡å‹é…ç½®æœ‰æ•ˆ
SELECT * FROM ai_model_config WHERE id = (
    SELECT config_value FROM ai_config WHERE config_key = 'DEFAULT_LLM_MODEL_ID'
);
-- é¢„æœŸ: è¿”å›1è¡Œ,enabled=1,model_type='LLM'
```

#### Step 3: éƒ¨ç½²æ–°ä»£ç 
```bash
# ç¼–è¯‘æ‰“åŒ…
cd scm-ai
mvn clean package -DskipTests

# é‡å¯åº”ç”¨
cd ../scm-start
./restart.sh
```

#### Step 4: åŠŸèƒ½éªŒè¯
```bash
# å‘èµ·æµ‹è¯•å¯¹è¯
curl -X POST http://localhost:8088/scm/ai/chat/conversation/send \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -d '{"question":"æµ‹è¯•Workflowè°ƒç”¨","conversationId":"test_001"}'

# æ£€æŸ¥æ•°æ®åº“è®°å½•
SELECT model_source_id, provider_name, base_name
FROM ai_conversation_content
WHERE conversation_id = 'test_001'
ORDER BY c_time DESC LIMIT 1;
```

#### Step 5: å†å²æ•°æ®ä¿®æ­£ (å¯é€‰)
```sql
-- æ‰§è¡Œ5.1.2èŠ‚çš„æ‰¹é‡ä¿®æ­£è„šæœ¬
-- å»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œ,å½±å“çº¦300+æ¡è®°å½•
```

### 7.2 å›æ»šæ–¹æ¡ˆ

**å¦‚æœå‘ç°é—®é¢˜**:
```bash
# Step 1: åœæ­¢åº”ç”¨
cd scm-start
./stop.sh

# Step 2: å›æ»šä»£ç 
git revert <commit_hash>
mvn clean package -DskipTests

# Step 3: æ¢å¤æ•°æ® (å¦‚æœä¿®æ”¹äº†å†å²æ•°æ®)
mysql -u root -p scm_tenant_20250519_001 < ai_conversation_content_backup_20251126.sql

# Step 4: é‡å¯åº”ç”¨
./start.sh
```

---

## 8. é£é™©è¯„ä¼°

### 8.1 æŠ€æœ¯é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | å½±å“èŒƒå›´ | ç¼“è§£æªæ–½ |
|--------|---------|---------|---------|
| é»˜è®¤æ¨¡å‹é…ç½®ç¼ºå¤± | ğŸŸ¡ ä¸­ | Workflowå¯¹è¯ä¿å­˜å¤±è´¥ | é™çº§ç­–ç•¥: ä½¿ç”¨æ—§å€¼"workflow" |
| æ¨¡å‹é…ç½®æŸ¥è¯¢æ€§èƒ½ | ğŸŸ¢ ä½ | æ¯æ¬¡ä¿å­˜+10mså»¶è¿Ÿ | æœªæ¥å¯å¼•å…¥Redisç¼“å­˜ |
| å†å²æ•°æ®ä¿®æ­£æ—¶é—´ | ğŸŸ¢ ä½ | 300+æ¡è®°å½•,çº¦5ç§’ | ä½å³°æœŸæ‰§è¡Œ |
| å­—æ®µåˆ é™¤å½±å“å‰ç«¯ | ğŸŸ¡ ä¸­ | å‰ç«¯å¯èƒ½è¯»å–workflow_id | éœ€å‰ç«¯å›¢é˜Ÿç¡®è®¤APIä¾èµ– |

### 8.2 ä¸šåŠ¡é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | å½±å“ | ç¼“è§£æªæ–½ |
|--------|---------|------|---------|
| æ¨¡å‹æˆæœ¬ç»Ÿè®¡å»¶è¿Ÿ | ğŸŸ¢ ä½ | å†å²æ•°æ®ç»Ÿè®¡ä¸å‡† | ä¿®æ­£è„šæœ¬è¡¥å…¨å†å²æ•°æ® |
| ClickHouseæ—¥å¿—ä¸ä¸€è‡´ | ğŸŸ¢ ä½ | éƒ¨åˆ†æ—¥å¿—ä¸ºæ—§æ ¼å¼ | æ—¥å¿—åˆ†ææ—¶è¿‡æ»¤"workflow"å€¼ |
| ai_drawåŠŸèƒ½éœ€æ±‚å˜æ›´ | ğŸŸ¢ ä½ | æœªæ¥éœ€è¦é‡æ–°å¼€å‘ | ä¿ç•™è¡¨ç»“æ„å¤‡ä»½ |

---

## 9. ç›‘æ§å‘Šè­¦

### 9.1 æ–°å¢ç›‘æ§æŒ‡æ ‡

```java
// æ·»åŠ åˆ°AiConversationContentService
@Autowired
private MeterRegistry meterRegistry;

public AiConversationContentVo saveContent(...) {
    try {
        AiModelConfigVo defaultModel = aiModelConfigService.getDefaultModelConfigWithKey("LLM");
        // âœ… æˆåŠŸè·å–æ¨¡å‹é…ç½®
        meterRegistry.counter("ai.conversation.model.success").increment();
    } catch (Exception e) {
        // âš ï¸ è·å–æ¨¡å‹é…ç½®å¤±è´¥
        meterRegistry.counter("ai.conversation.model.fallback").increment();
        log.warn("è·å–é»˜è®¤LLMæ¨¡å‹é…ç½®å¤±è´¥,ä½¿ç”¨é™çº§å€¼: {}", e.getMessage());
    }
}
```

### 9.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: ai_model_config
    rules:
      - alert: AiModelConfigFallbackHigh
        expr: rate(ai_conversation_model_fallback_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "AIæ¨¡å‹é…ç½®è·å–å¤±è´¥ç‡è¿‡é«˜"
          description: "æœ€è¿‘5åˆ†é’Ÿå†…,Workflowåœºæ™¯è·å–é»˜è®¤æ¨¡å‹é…ç½®å¤±è´¥ç‡>10%"
```

---

## 10. é¡¹ç›®æ—¶é—´çº¿

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº |
|------|------|---------|--------|
| Stage 4 | æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£ç¼–å†™ | 2h | âœ… å·²å®Œæˆ |
| Stage 5 | æ–¹æ¡ˆå®¡æ‰¹ | 0.5h | å¾…å®¡æ‰¹ |
| Stage 6 | ä»£ç å®æ–½ | 1h | å¾…æ‰§è¡Œ |
| Stage 7 | QAä»£ç è¯„å®¡ | 0.5h | å¾…æ‰§è¡Œ |
| Stage 8 | æµ‹è¯•éªŒæ”¶ | 1h | å¾…æ‰§è¡Œ |
| **æ€»è®¡** | | **5h** | |

---

## 11. é™„å½•

### 11.1 ç›¸å…³æ–‡æ¡£

- [Spring AIé›†æˆæ–‡æ¡£](./2025-10-15-Spring-AIé›†æˆæ–¹æ¡ˆ.md)
- [Workflow Orchestratorè®¾è®¡](./2025-11-08-Workflow-Orchestratorè®¾è®¡.md)
- [MCPå·¥å…·é›†æˆæ–‡æ¡£](./2025-11-24-MCPå·¥å…·é›†æˆæ–¹æ¡ˆ.md)

### 11.2 æ•°æ®åº“è¡¨ç»“æ„

#### ai_configè¡¨ç»“æ„
```sql
CREATE TABLE `ai_config` (
  `id` varchar(50) NOT NULL COMMENT 'é…ç½®ID',
  `config_key` varchar(100) NOT NULL COMMENT 'é…ç½®é”®',
  `config_value` varchar(500) NOT NULL COMMENT 'é…ç½®å€¼',
  `description` varchar(200) DEFAULT NULL COMMENT 'é…ç½®è¯´æ˜',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_ai_config_key` (`config_key`)
) COMMENT='AIç³»ç»Ÿé…ç½®è¡¨';
```

#### ai_model_configè¡¨ç»“æ„
```sql
CREATE TABLE `ai_model_config` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT 'é…ç½®ID',
  `name` varchar(200) DEFAULT NULL COMMENT 'æ¨¡å‹æ˜¾ç¤ºåç§°',
  `model_name` varchar(100) NOT NULL COMMENT 'æ¨¡å‹åç§°(å¦‚siliconflow-deepseek-chat)',
  `model_type` varchar(50) NOT NULL DEFAULT 'CHAT' COMMENT 'æ¨¡å‹ç±»å‹:CHAT/EMBEDDING/IMAGE',
  `provider` varchar(50) NOT NULL COMMENT 'ä¾›åº”å•†åç§°(OPENAI/SILICONFLOW/OLLAMAç­‰)',
  `api_key` varchar(500) DEFAULT NULL COMMENT 'APIå¯†é’¥',
  `base_url` varchar(500) DEFAULT NULL COMMENT 'åŸºç¡€URL(å¦‚https://api.siliconflow.cn)',
  `enabled` tinyint(1) DEFAULT '1' COMMENT 'çŠ¶æ€:0-ç¦ç”¨,1-å¯ç”¨',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_model` (`model_name`)
) COMMENT='AIæ¨¡å‹é…ç½®è¡¨';
```

### 11.3 å…³é”®ä»£ç ç‰‡æ®µ

#### getDefaultModelConfigWithKeyæ–¹æ³• (AiModelConfigService.java:332-376)
```java
public AiModelConfigVo getDefaultModelConfigWithKey(String modelType) {
    // Step 1: éªŒè¯æ¨¡å‹ç±»å‹
    if (!Arrays.asList("LLM", "VISION", "EMBEDDING").contains(modelType.toUpperCase())) {
        throw new IllegalArgumentException("ä¸æ”¯æŒçš„æ¨¡å‹ç±»å‹: " + modelType);
    }

    // Step 2: ä»ai_configè·å–é»˜è®¤æ¨¡å‹ID
    String configKey = "DEFAULT_" + modelType.toUpperCase() + "_MODEL_ID";
    String modelIdStr = aiConfigService.getConfigValue(configKey);

    if (StringUtils.isBlank(modelIdStr)) {
        throw new RuntimeException("æœªé…ç½®é»˜è®¤" + modelType + "æ¨¡å‹");
    }

    Long modelId = Long.parseLong(modelIdStr);

    // Step 3: ä»ai_model_configè·å–æ¨¡å‹é…ç½®
    AiModelConfigEntity config = aiModelConfigMapper.selectById(modelId);

    if (config == null) {
        throw new RuntimeException("æ¨¡å‹é…ç½®ä¸å­˜åœ¨: ID=" + modelId);
    }

    // Step 4: éªŒè¯æ¨¡å‹çŠ¶æ€
    if (!config.getEnabled()) {
        throw new RuntimeException("æ¨¡å‹æœªå¯ç”¨: " + config.getModelName());
    }

    // Step 5: è½¬æ¢ä¸ºVOè¿”å›(ä¸è„±æ•API Key)
    AiModelConfigVo vo = new AiModelConfigVo();
    BeanUtils.copyProperties(config, vo);
    return vo;
}
```

---

**æ–‡æ¡£ç»“æŸ**

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æäº¤æ–¹æ¡ˆå®¡æ‰¹** â†’ Stage 5: æ–¹æ¡ˆå®¡æ‰¹ç­‰å¾…
2. **å®¡æ‰¹é€šè¿‡å** â†’ Stage 6: ä»£ç å®æ–½
3. **ä»£ç å®Œæˆå** â†’ Stage 7: QAä»£ç è¯„å®¡
4. **æµ‹è¯•é€šè¿‡å** â†’ Stage 8: å®ŒæˆéªŒæ”¶
