# 临时知识库节点智能集成开发方案

**文档编号**: 2025-12-04-143000
**功能名称**: 临时知识库节点智能集成
**设计日期**: 2025-12-04
**设计人员**: zzxxhh
**审批状态**: 待审批

---

## 一、需求概述

### 1.1 业务背景

当前系统已实现临时知识库节点(TempKnowledgeBase),该节点可以创建2小时自动过期的临时知识库,并完成向量索引。临时知识库节点成功执行后,会输出临时知识库的UUID(如ID=1996389698257305601)。

然而,下游的知识检索节点(KnowledgeRetrieval)无法方便地使用上游临时知识库节点创建的临时知识库。用户需要手动复制临时知识库UUID,然后手动输入到知识检索节点的属性面板中,这个过程既不直观也容易出错。

### 1.2 核心问题

1. **用户体验差**:用户无法直观地看到上游临时知识库节点
2. **操作繁琐**:需要手动复制UUID,容易出错
3. **逻辑割裂**:临时知识库节点和知识检索节点之间缺乏智能连接
4. **维护困难**:当上游临时知识库节点被删除或断开连线时,知识检索节点仍然保留已失效的UUID

### 1.3 解决目标

实现知识检索节点智能检测和使用上游临时知识库节点,具体包括:

1. **智能检测**:自动检测上游是否存在临时知识库节点
2. **动态显示**:只有当上游存在临时知识库节点时,才显示"临时知识库"选项组
3. **变量引用**:使用变量引用机制自动关联临时知识库
4. **自动清理**:当上游临时知识库节点被删除或断线时,自动清除已选中的临时知识库

---

## 二、完整调用链路分析

### 2.1 当前知识检索节点的调用链路

```
用户操作
  ↓
WorkflowDesigner.vue (画布组件)
  ↓ 选中知识检索节点
WorkflowPropertyPanel.vue (属性面板容器)
  ↓ 动态加载属性组件
KnowledgeRetrievalNodeProperty.vue (知识检索节点属性配置)
  ↓ 使用知识库选择器
WfKnowledgeSelector.vue (知识库选择器)
  ↓ 调用API搜索知识库
知识库API (/components/70_ai/components/rag/utils)
  ↓ 获取永久知识库列表
用户选择知识库
  ↓ 触发@selected事件
KnowledgeRetrievalNodeProperty.handleKnowledgeSelected()
  ↓ 更新nodeConfig.knowledge_base_uuid
触发workflow:update-node事件
  ↓ X6 graph更新节点数据
用户保存workflow
  ↓ 后端接收workflow JSON
AiWorkflowService.save()
  ↓ 保存节点配置到数据库
```

### 2.2 临时知识库节点的执行链路

```
用户执行workflow
  ↓
WorkflowEngine.execute()
  ↓ 遍历节点执行
WfNodeFactory.create("TempKnowledgeBase")
  ↓ 创建临时知识库节点实例
TempKnowledgeBaseNode.onProcess()
  ↓ 构建LLM prompt
WorkflowUtil.streamingInvokeLLM()
  ↓ LLM调用MCP工具(Function Calling)
TempKnowledgeBaseMcpTools.createTempKnowledgeBase()
  ↓ 创建临时知识库
Milvus向量化索引
  ↓ 返回kbUuid
流式输出JSON: {"kbUuid": "scm_tenant_20250519_001::uuid"}
  ↓ 下游节点引用
KnowledgeRetrievalNode.onProcess()
  ↓ 解析变量引用
WorkflowUtil.renderTemplate("${nodeUuid_kbUuid}", inputs)
  ↓ 替换为实际的kbUuid
MilvusVectorRetrievalService.searchSimilarDocuments(kbUuid)
  ↓ 向量检索
返回检索结果
```

### 2.3 目标调用链路(新增智能检测机制)

```
用户在画布上连接临时知识库节点 → 知识检索节点
  ↓
graph.on('edge:connected') 触发
  ↓ KnowledgeRetrievalNodeProperty检测上游节点
detectUpstreamTempKbNodes()
  ↓ graph.getIncomingEdges(currentNodeId)
获取所有入边 → 遍历source节点
  ↓ 判断sourceNode.data.wfComponent.name === 'TempKnowledgeBase'
更新upstreamTempKbNodes数组
  ↓ 响应式更新UI
el-option-group显示"临时知识库"选项组
  ↓ 用户选择临时知识库
handleTempKbSelected(tempKbNode)
  ↓ 设置变量引用: `{nodeUuid_kbUuid}`
nodeConfig.knowledge_base_uuid = `{${tempKbNode.uuid}_kbUuid}`
nodeConfig.is_temp_kb = true
nodeConfig.temp_kb_node_uuid = tempKbNode.uuid
  ↓ 触发workflow:update-node事件
X6 graph更新节点数据
  ↓ 用户断开连线
graph.on('cell:removed') 触发
  ↓ validateTempKbSelection()
检查temp_kb_node_uuid是否仍在upstreamTempKbNodes中
  ↓ 如果不存在
清除临时知识库选择
  nodeConfig.knowledge_base_uuid = ''
  nodeConfig.is_temp_kb = false
  nodeConfig.temp_kb_node_uuid = null
```

---

## 三、问题诊断和根因分析

### 3.1 问题诊断

通过分析现有代码,发现以下问题:

1. **WfKnowledgeSelector.vue只支持永久知识库**:
   - 只从`knowledgeBaseSearchMine`和`knowledgeBaseSearchPublic` API获取知识库列表
   - 没有检测上游临时知识库节点的逻辑
   - 无法显示临时知识库选项

2. **KnowledgeRetrievalNodeConfig.java缺少临时知识库标识字段**:
   - 只有`knowledgeBaseUuid`字段
   - 无法区分是永久知识库还是临时知识库
   - 无法记录临时知识库节点的UUID

3. **缺少X6 graph事件监听机制**:
   - 没有监听edge的添加和删除事件
   - 无法实时检测上游节点的变化
   - 无法自动清理失效的临时知识库选择

### 3.2 根因分析

**根本原因**:知识检索节点的设计初衷只考虑了永久知识库的场景,没有考虑临时知识库的动态引用需求。

**技术原因**:
1. 前端组件(WfKnowledgeSelector)与API强耦合,缺少上游节点检测逻辑
2. 后端配置类缺少临时知识库相关字段
3. 缺少X6 graph事件监听机制,无法响应图结构变化

---

## 四、方案设计(方案A:智能检测 + 下拉选择器)

### 4.1 设计原则

1. **零破坏性**:不改变现有永久知识库选择逻辑
2. **向后兼容**:没有临时知识库节点时,界面和功能与现在完全一致
3. **KISS原则**:使用最简单的方法实现功能,避免过度设计
4. **用户友好**:操作直观,自动检测,自动清理

### 4.2 核心设计思路

#### 4.2.1 前端智能检测机制

使用X6 graph API检测上游节点:

```javascript
// 在KnowledgeRetrievalNodeProperty.vue中
detectUpstreamTempKbNodes() {
  const graph = this.workflow.graph
  const currentNodeId = this.wfNode.uuid

  // 获取所有入边
  const incomingEdges = graph.getIncomingEdges(currentNodeId)

  // 遍历入边,检测source节点
  const tempKbNodes = []
  incomingEdges.forEach(edge => {
    const sourceNode = graph.getCell(edge.source.cell)
    if (sourceNode && sourceNode.data.wfComponent.name === 'TempKnowledgeBase') {
      tempKbNodes.push(sourceNode.data)
    }
  })

  this.upstreamTempKbNodes = tempKbNodes
}
```

#### 4.2.2 动态UI显示机制

使用el-option-group分组显示:

```vue
<el-select v-model="selectedKbSource">
  <!-- 永久知识库选项组 -->
  <el-option-group label="永久知识库">
    <el-option
      v-for="kb in permanentKbs"
      :key="kb.id"
      :label="kb.name"
      :value="`permanent_${kb.id}`"
    />
  </el-option-group>

  <!-- 临时知识库选项组(仅在有上游临时知识库节点时显示) -->
  <el-option-group
    v-if="upstreamTempKbNodes.length > 0"
    label="临时知识库"
  >
    <el-option
      v-for="node in upstreamTempKbNodes"
      :key="node.uuid"
      :label="`${node.title}(上游临时)`"
      :value="`temp_${node.uuid}`"
    >
      <span>{{ node.title }}</span>
      <span style="color: #8492a6; font-size: 12px"> - 上游临时知识库</span>
    </el-option>
  </el-option-group>
</el-select>
```

#### 4.2.3 变量引用机制

选择临时知识库时,使用变量引用语法:

```javascript
handleTempKbSelected(tempKbNode) {
  // 使用变量引用语法: {nodeUuid_kbUuid}
  this.nodeConfig.knowledge_base_uuid = `{${tempKbNode.uuid}_kbUuid}`
  this.nodeConfig.is_temp_kb = true
  this.nodeConfig.temp_kb_node_uuid = tempKbNode.uuid

  // 触发X6节点更新
  this.$root.$emit('workflow:update-node', {
    nodeUuid: this.wfNode.uuid,
    nodeData: this.wfNode
  })
}
```

#### 4.2.4 断线自动清理机制

监听X6 graph的cell:removed事件:

```javascript
mounted() {
  // 初始检测
  this.detectUpstreamTempKbNodes()

  // 监听图变化
  const graph = this.workflow.graph

  // 监听边删除事件
  graph.on('cell:removed', ({ cell }) => {
    if (cell.isEdge()) {
      // 如果删除的是指向当前节点的边
      const targetNodeId = cell.target.cell
      if (targetNodeId === this.wfNode.uuid) {
        // 重新检测上游节点
        this.$nextTick(() => {
          this.detectUpstreamTempKbNodes()
          this.validateTempKbSelection()
        })
      }
    }
  })
}

validateTempKbSelection() {
  // 如果当前选择的是临时知识库
  if (this.nodeConfig.is_temp_kb && this.nodeConfig.temp_kb_node_uuid) {
    // 检查临时知识库节点是否仍然存在
    const stillExists = this.upstreamTempKbNodes.some(
      node => node.uuid === this.nodeConfig.temp_kb_node_uuid
    )

    if (!stillExists) {
      // 自动清除失效的临时知识库选择
      this.nodeConfig.knowledge_base_uuid = ''
      this.nodeConfig.is_temp_kb = false
      this.nodeConfig.temp_kb_node_uuid = null
      this.$message.warning('上游临时知识库节点已移除,已清除选择')
    }
  }
}
```

#### 4.2.5 后端配置字段设计

新增字段到`KnowledgeRetrievalNodeConfig.java`:

```java
/**
 * 是否使用临时知识库
 */
@JsonProperty("is_temp_kb")
private Boolean isTempKb;

/**
 * 临时知识库节点UUID
 * (用于前端关联和验证)
 */
@JsonProperty("temp_kb_node_uuid")
private String tempKbNodeUuid;
```

#### 4.2.6 后端变量引用解析

修改`KnowledgeRetrievalNode.java`的逻辑:

```java
String kbUuid = nodeConfig.getKnowledgeBaseUuid();

// 如果是变量引用,渲染变量
if (kbUuid != null && kbUuid.startsWith("{") && kbUuid.endsWith("}")) {
    kbUuid = WorkflowUtil.renderTemplate(kbUuid, state.getInputs());
    log.info("渲染临时知识库变量引用: {} -> {}", nodeConfig.getKnowledgeBaseUuid(), kbUuid);
}

// 验证知识库UUID
if (StringUtils.isBlank(kbUuid)) {
    throw new BusinessException("知识库UUID不能为空");
}
```

---

## 五、按文件进行设计

### 5.1 前端修改文件清单

#### 5.1.1 需要修改的文件

**文件1**: `D:\2025_project\20_project_in_github\01_scm_frontend\scm_frontend\src\components\70_ai\components\workflow\components\properties\KnowledgeRetrievalNodeProperty.vue`

**功能**: 知识检索节点属性配置组件

**修改内容**:
1. 新增`upstreamTempKbNodes`数据字段,用于存储检测到的上游临时知识库节点
2. 新增`detectUpstreamTempKbNodes()`方法,检测上游临时知识库节点
3. 新增`validateTempKbSelection()`方法,验证临时知识库选择的有效性
4. 修改`mounted()`生命周期,增加X6 graph事件监听
5. 修改模板,增加临时知识库选项显示逻辑

**关键代码片段**:
```vue
<template>
  <div class="knowledge-retrieval-node-property">
    <!-- 保留原有的输入变量定义 -->
    <node-property-input ... />

    <!-- 修改知识库选择部分 -->
    <div class="property-section">
      <div class="section-title">知识库</div>

      <!-- 新增临时知识库切换逻辑 -->
      <el-select
        v-model="selectedKbSource"
        placeholder="请选择知识库"
        @change="handleKbSourceChange"
      >
        <!-- 永久知识库选项组 -->
        <el-option-group label="永久知识库">
          <el-option
            v-for="kb in permanentKbs"
            :key="kb.value"
            :label="kb.label"
            :value="`permanent_${kb.value}`"
          />
        </el-option-group>

        <!-- 临时知识库选项组(仅在有上游节点时显示) -->
        <el-option-group
          v-if="upstreamTempKbNodes.length > 0"
          label="临时知识库(上游节点)"
        >
          <el-option
            v-for="node in upstreamTempKbNodes"
            :key="node.uuid"
            :label="`${node.title} (临时)`"
            :value="`temp_${node.uuid}`"
          >
            <span>{{ node.title }}</span>
            <el-tag size="mini" type="warning" style="margin-left: 8px;">临时</el-tag>
          </el-option>
        </el-option-group>
      </el-select>
    </div>

    <!-- 保留原有的其他配置项 -->
  </div>
</template>

<script>
export default {
  data() {
    return {
      upstreamTempKbNodes: [],
      permanentKbs: [],
      selectedKbSource: ''
    }
  },

  mounted() {
    // 初始检测上游临时知识库节点
    this.detectUpstreamTempKbNodes()

    // 监听X6 graph事件
    this.watchGraphChanges()

    // 加载永久知识库列表
    this.loadPermanentKnowledgeBases()
  },

  methods: {
    detectUpstreamTempKbNodes() {
      // 实现上游节点检测逻辑
    },

    validateTempKbSelection() {
      // 实现临时知识库选择验证逻辑
    },

    watchGraphChanges() {
      // 监听图变化事件
    },

    handleKbSourceChange(value) {
      // 处理知识库选择变化
    }
  }
}
</script>
```

### 5.2 后端修改文件清单

#### 5.2.1 需要修改的文件

**文件1**: `D:\2025_project\20_project_in_github\00_scm_backend\scm_backend\scm-ai\src\main\java\com\xinyirun\scm\ai\workflow\node\knowledgeretrieval\KnowledgeRetrievalNodeConfig.java`

**功能**: 知识检索节点配置类

**修改内容**:
1. 新增`isTempKb`字段(Boolean),标识是否使用临时知识库
2. 新增`tempKbNodeUuid`字段(String),记录临时知识库节点UUID

**关键代码片段**:
```java
@Data
public class KnowledgeRetrievalNodeConfig {

    // 现有字段保留
    @JsonProperty("knowledge_base_uuid")
    private String knowledgeBaseUuid;

    @JsonProperty("knowledge_base_name")
    private String knowledgeBaseName;

    // 其他现有字段...

    // 新增字段

    /**
     * 是否使用临时知识库
     * <p>默认false,使用永久知识库,保持向后兼容</p>
     * <p>设置为true时,表示使用上游临时知识库节点创建的临时知识库</p>
     */
    @JsonProperty("is_temp_kb")
    private Boolean isTempKb;

    /**
     * 临时知识库节点UUID
     * <p>当isTempKb=true时有效</p>
     * <p>用于前端验证上游节点是否仍然存在</p>
     * <p>格式:节点的uuid字段</p>
     */
    @JsonProperty("temp_kb_node_uuid")
    private String tempKbNodeUuid;
}
```

**文件2**: `D:\2025_project\20_project_in_github\00_scm_backend\scm_backend\scm-ai\src\main\java\com\xinyirun\scm\ai\workflow\node\knowledgeretrieval\KnowledgeRetrievalNode.java`

**功能**: 知识检索节点执行类

**修改内容**:
1. 在`onProcess()`方法中增加变量引用解析逻辑
2. 增加日志输出,记录临时知识库的使用情况

**关键代码片段**:
```java
@Override
public NodeProcessResult onProcess() {
    KnowledgeRetrievalNodeConfig nodeConfig = checkAndGetConfig(KnowledgeRetrievalNodeConfig.class);

    if (StringUtils.isBlank(nodeConfig.getKnowledgeBaseUuid())) {
        log.warn("知识检索节点缺少知识库UUID");
        throw new BusinessException("知识库UUID不能为空");
    }

    String kbUuid = nodeConfig.getKnowledgeBaseUuid();

    // 检查是否是临时知识库
    if (Boolean.TRUE.equals(nodeConfig.getIsTempKb())) {
        log.info("使用临时知识库,节点UUID: {}, 变量引用: {}",
            nodeConfig.getTempKbNodeUuid(), kbUuid);
    }

    // 如果是变量引用,渲染变量
    if (kbUuid.startsWith("{") && kbUuid.endsWith("}")) {
        String originalKbUuid = kbUuid;
        kbUuid = WorkflowUtil.renderTemplate(kbUuid, state.getInputs());
        log.info("渲染临时知识库变量引用: {} -> {}", originalKbUuid, kbUuid);
    }

    // 验证知识库UUID
    if (StringUtils.isBlank(kbUuid)) {
        throw new BusinessException("知识库UUID不能为空(变量引用解析失败)");
    }

    log.info("开始知识库检索,知识库UUID: {}, 是否临时: {}",
        kbUuid, nodeConfig.getIsTempKb());

    // 后续逻辑保持不变...
}
```

---

## 六、KISS原则7问题回答

### 6.1 这是个真问题还是臆想出来的?
**✅ 真问题**
- 临时知识库节点已经实现,但无法被下游节点方便使用
- 用户需要手动复制UUID,既不直观也容易出错
- 这是一个真实的用户体验问题,不是臆想

### 6.2 有更简单的方法吗?
**✅ 当前方案已经是最简方案**
- 方案A(智能检测+下拉选择器)是3个备选方案中最简单且最实用的
- 使用X6现有的graph API,不需要引入新的依赖
- 使用现有的变量引用机制,不需要重新设计数据流

### 6.3 会破坏什么吗?
**✅ 零破坏性**
- 只是在知识检索节点属性面板增加"临时知识库"选项组
- 不改变现有永久知识库的选择逻辑
- 新增字段都是可选字段,向后兼容
- 没有临时知识库节点时,界面和功能与现在完全一致

### 6.4 当前项目真的需要这个功能吗?
**✅ 必要功能**
- 临时知识库节点已经实现,但无法被下游节点使用,这是一个残缺的功能
- 用户提出的3个核心思考点都是真实的使用场景
- 没有这个功能,临时知识库节点就失去了实用价值

### 6.5 这个问题过度设计了吗?有缺少必要信息吗?能否继续评估?
**✅ 设计恰当,信息充足**
- 方案A的设计刚好满足需求,没有过度设计
- 已经收集了临时知识库节点、知识检索节点、X6 graph API的完整实现
- 已经分析了WorkflowUtil.renderTemplate()的变量引用机制
- 可以立即实施

### 6.6 话题是否模糊,是否会导致幻觉的产生?
**✅ 话题清晰,不会产生幻觉**
- 需求明确:让知识检索节点能使用上游临时知识库节点创建的知识库
- 技术实现清晰:X6 graph事件监听+变量引用机制
- 用户已经提供了3个核心思考点作为验证
- 临时知识库节点已经实现,可以作为参考

### 6.7 是否已经学习了关于代码实施的注意事项的内容?
**✅ 已经学习并应用**
- 将遵循插入/更新使用bean,查询使用sql的原则
- 将使用BeanUtils.copyProperties转换,不使用convertToVo
- 将使用UuidUtil.createShort()生成UUID
- 前端将使用Vue 2.7的响应式机制和X6 graph API
- 后端使用@JsonProperty注解,遵循现有命名规范

---

## 七、支撑数据和分析

### 7.1 现有代码实现分析

#### 7.1.1 临时知识库节点实现(已实施)
- **后端**: `TempKnowledgeBaseNode.java`已实现,使用LLM的Function Calling调用MCP工具
- **输出格式**: 流式输出JSON,包含`kbUuid`字段
- **生命周期**: 2小时自动过期
- **索引方式**: 同步完成Milvus向量索引

#### 7.1.2 知识检索节点现有实现
- **配置类**: `KnowledgeRetrievalNodeConfig.java`已有`knowledgeBaseUuid`字段
- **执行类**: `KnowledgeRetrievalNode.java`已支持`WorkflowUtil.renderTemplate()`变量引用
- **前端组件**: `KnowledgeRetrievalNodeProperty.vue`使用`WfKnowledgeSelector.vue`选择知识库
- **当前限制**: 只支持永久知识库,无法选择临时知识库

#### 7.1.3 X6 Graph API分析
- **获取入边**: `graph.getIncomingEdges(nodeId)`返回指向节点的所有边
- **获取节点**: `graph.getCell(cellId)`获取节点或边对象
- **获取数据**: `node.getData()`获取节点的data属性
- **监听事件**: `graph.on('edge:connected')`监听边连接,`graph.on('cell:removed')`监听单元格删除

#### 7.1.4 WorkflowUtil变量引用机制
- **语法**: `${paramName}`格式
- **实现**: `WorkflowUtil.renderTemplate(template, values)`方法
- **支持类型**: 文本、文件列表、数组等
- **实际应用**: 知识检索节点的`query_template`字段已使用变量引用

### 7.2 技术可行性验证

#### 7.2.1 X6 Graph API可行性
通过阅读`WorkflowDesigner.vue`源码,确认:
- ✅ X6 graph实例可以通过`this.workflow.graph`访问
- ✅ `graph.getIncomingEdges()`方法已存在并被使用
- ✅ `graph.on('cell:removed')`事件已被监听(用于删除节点和边)
- ✅ 节点数据通过`node.getData()`获取,结构包含`wfComponent.name`字段

#### 7.2.2 变量引用机制可行性
通过阅读`KnowledgeRetrievalNode.java`源码,确认:
- ✅ `query_template`字段已使用`WorkflowUtil.renderTemplate()`渲染变量
- ✅ 变量引用格式为`${input}`,支持引用上游节点输出
- ✅ 临时知识库节点的输出字段为`kbUuid`
- ✅ 变量引用语法应为:`{nodeUuid_kbUuid}`

#### 7.2.3 临时知识库节点识别可行性
通过阅读`WfNodeFactory.java`源码,确认:
- ✅ 临时知识库节点的组件名为`TempKnowledgeBase`
- ✅ 通过`wfComponent.name === 'TempKnowledgeBase'`可以准确识别
- ✅ 节点数据包含`uuid`、`title`等字段,可用于显示

---

## 八、方案设计(架构图和时序图)

### 8.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                     工作流设计器 (WorkflowDesigner)              │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                   X6 Graph (画布)                           │ │
│  │                                                              │ │
│  │  ┌──────────────┐      ┌──────────────┐                   │ │
│  │  │ 临时知识库    │──────>│ 知识检索     │                   │ │
│  │  │ 节点         │ edge │ 节点         │                   │ │
│  │  └──────────────┘      └──────────────┘                   │ │
│  │        │                      │                            │ │
│  │        │ 输出kbUuid            │ 引用变量                   │ │
│  │        │                      │ {nodeUuid_kbUuid}         │ │
│  └────────┼──────────────────────┼────────────────────────────┘ │
│           │                      │                              │
│           │ on('cell:removed')   │ detectUpstreamTempKbNodes() │
│           │                      │                              │
│  ┌────────▼──────────────────────▼────────────────────────────┐ │
│  │       属性面板 (WorkflowPropertyPanel)                       │ │
│  │                                                              │ │
│  │  ┌────────────────────────────────────────────────────────┐│ │
│  │  │ KnowledgeRetrievalNodeProperty                          ││ │
│  │  │                                                          ││ │
│  │  │  ┌──────────────┐   ┌──────────────┐                  ││ │
│  │  │  │ 永久知识库    │   │ 临时知识库    │                  ││ │
│  │  │  │ (API)        │   │ (graph检测)   │                  ││ │
│  │  │  └──────────────┘   └──────────────┘                  ││ │
│  │  │         │                  │                            ││ │
│  │  │         └──────┬───────────┘                            ││ │
│  │  │                │ el-select                              ││ │
│  │  │                ▼                                        ││ │
│  │  │    nodeConfig.knowledge_base_uuid                       ││ │
│  │  │    nodeConfig.is_temp_kb                                ││ │
│  │  │    nodeConfig.temp_kb_node_uuid                         ││ │
│  │  └────────────────────────────────────────────────────────┘│ │
│  └──────────────────────────────────────────────────────────── │ │
└───────────────────────────────────────────────────────────────┘
                              │
                              │ workflow.save()
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         后端服务                                 │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │           WorkflowEngine.execute()                          │ │
│  │                                                              │ │
│  │  ┌──────────────┐      ┌──────────────┐                   │ │
│  │  │TempKnowledge │      │Knowledge      │                   │ │
│  │  │BaseNode      │      │RetrievalNode  │                   │ │
│  │  └──────┬───────┘      └───────┬───────┘                   │ │
│  │         │                      │                            │ │
│  │         │ 输出kbUuid            │ renderTemplate()          │ │
│  │         │                      │ {uuid_kbUuid}->kbUuid    │ │
│  │         │                      │                            │ │
│  │         ▼                      ▼                            │ │
│  │  ┌──────────────┐      ┌──────────────┐                   │ │
│  │  │MCP工具调用    │      │Milvus向量检索│                   │ │
│  │  └──────────────┘      └──────────────┘                   │ │
│  └────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────┘
```

### 8.2 核心交互时序图

#### 8.2.1 用户连接临时知识库节点到知识检索节点

```
用户                  画布                X6 Graph        知识检索属性面板
 │                    │                    │                 │
 │ 拖拽连线             │                    │                 │
 ├──────────────────>│                    │                 │
 │                    │ edge:connected    │                 │
 │                    ├─────────────────>│                 │
 │                    │                    │ 触发检测         │
 │                    │                    ├───────────────>│
 │                    │                    │ detectUpstream  │
 │                    │                    │ TempKbNodes()   │
 │                    │                    │                 │
 │                    │                    │ getIncoming     │
 │                    │                    │ Edges()         │
 │                    │                    │<───┐            │
 │                    │                    │    │ 遍历edge    │
 │                    │                    │    │ 检查source  │
 │                    │                    │    │ wfComponent │
 │                    │                    │<───┘            │
 │                    │                    │ return nodes    │
 │                    │                    │<───────────────│
 │                    │                    │                 │
 │                    │                    │ 更新upstreamTemp │
 │                    │                    │ KbNodes数组      │
 │                    │                    │<───┐            │
 │                    │                    │    │ 响应式更新   │
 │                    │                    │    │ UI显示临时库 │
 │                    │                    │<───┘            │
 │                    │                    │                 │
 │ 选择临时知识库       │                    │                 │
 │───────────────────────────────────────────────────────>│
 │                    │                    │ handleTempKb    │
 │                    │                    │ Selected()      │
 │                    │                    │<───┐            │
 │                    │                    │    │ 设置变量引用 │
 │                    │                    │    │ {uuid_kbUuid}│
 │                    │                    │<───┘            │
 │                    │                    │                 │
 │                    │                    │ emit workflow:  │
 │                    │                    │ update-node     │
 │                    │<───────────────────┼─────────────────│
 │                    │                    │                 │
 │                    │ x6Node.setData()  │                 │
 │                    ├─────────────────>│                 │
 │                    │                    │                 │
```

#### 8.2.2 用户断开连线或删除节点

```
用户                  画布                X6 Graph        知识检索属性面板
 │                    │                    │                 │
 │ 删除边/节点          │                    │                 │
 ├──────────────────>│                    │                 │
 │                    │ cell:removed      │                 │
 │                    ├─────────────────>│                 │
 │                    │                    │ 检查target       │
 │                    │                    │ 是否是当前节点   │
 │                    │                    │<───┐            │
 │                    │                    │    │ 如果是       │
 │                    │                    │<───┘            │
 │                    │                    │                 │
 │                    │                    │ 重新检测上游     │
 │                    │                    ├───────────────>│
 │                    │                    │ detectUpstream  │
 │                    │                    │ TempKbNodes()   │
 │                    │                    │<───────────────│
 │                    │                    │                 │
 │                    │                    │ validate        │
 │                    │                    │ TempKbSelection()│
 │                    │                    │<───┐            │
 │                    │                    │    │ 检查temp_kb  │
 │                    │                    │    │ _node_uuid   │
 │                    │                    │    │ 是否仍存在   │
 │                    │                    │<───┘            │
 │                    │                    │                 │
 │                    │                    │ 如果不存在       │
 │                    │                    │<───┐            │
 │                    │                    │    │ 清除选择     │
 │                    │                    │    │ is_temp_kb  │
 │                    │                    │    │ =false      │
 │                    │                    │<───┘            │
 │                    │                    │                 │
 │                    │                    │ 显示警告消息     │
 │                    │                    ├───────────────>│
 │<───────────────────┴────────────────────┴─────────────────│
 │ "上游临时知识库节点已移除,已清除选择"                       │
```

#### 8.2.3 执行workflow时的变量引用解析

```
WorkflowEngine    KnowledgeRetrievalNode   WorkflowUtil    Milvus
    │                     │                    │             │
    │ execute()           │                    │             │
    ├──────────────────>│                    │             │
    │                     │ onProcess()        │             │
    │                     │<───┐               │             │
    │                     │    │ 读取配置       │             │
    │                     │    │ knowledge_base │             │
    │                     │    │ _uuid:         │             │
    │                     │    │ {node1_kbUuid} │             │
    │                     │<───┘               │             │
    │                     │                    │             │
    │                     │ 检测变量引用        │             │
    │                     │<───┐               │             │
    │                     │    │ startsWith("{")│             │
    │                     │    │ endsWith("}")  │             │
    │                     │<───┘               │             │
    │                     │                    │             │
    │                     │ renderTemplate()   │             │
    │                     ├──────────────────>│             │
    │                     │ {node1_kbUuid}     │             │
    │                     │ state.getInputs()  │             │
    │                     │                    │<───┐        │
    │                     │                    │    │ 查找node1│
    │                     │                    │    │ 的输出   │
    │                     │                    │    │ kbUuid   │
    │                     │                    │<───┘        │
    │                     │                    │             │
    │                     │ return:            │             │
    │                     │ scm_tenant::uuid123│             │
    │                     │<──────────────────│             │
    │                     │                    │             │
    │                     │ searchSimilar      │             │
    │                     │ Documents()        │             │
    │                     ├────────────────────────────────>│
    │                     │ kbUuid, query      │             │
    │                     │                    │             │
    │                     │                    │ 向量检索     │
    │                     │<────────────────────────────────│
    │                     │ 返回检索结果        │             │
    │                     │                    │             │
```

---

## 九、风险分析和缓解措施

### 9.1 技术风险

#### 风险1: X6 graph事件监听可能影响性能
**风险等级**: 低
**影响范围**: 知识检索节点属性面板
**风险描述**: 频繁监听graph事件可能导致性能问题
**缓解措施**:
1. 只在知识检索节点属性面板mounted时监听,destroyed时解绑
2. 使用节流(throttle)机制,避免频繁检测
3. 只在edge相关事件触发时执行检测,不在每次渲染时执行

#### 风险2: 变量引用解析失败
**风险等级**: 中
**影响范围**: 知识检索节点执行
**风险描述**: 如果临时知识库节点未执行或执行失败,变量引用解析会失败
**缓解措施**:
1. 在`KnowledgeRetrievalNode.onProcess()`中增加明确的异常处理
2. 记录详细的日志,方便问题诊断
3. 给用户清晰的错误提示:"临时知识库尚未创建,请先执行上游临时知识库节点"

#### 风险3: 前端Vue响应式更新可能失效
**风险等级**: 低
**影响范围**: 知识检索节点属性面板
**风险描述**: upstreamTempKbNodes数组更新后,UI可能不会立即响应
**缓解措施**:
1. 使用`this.$set()`确保响应式更新
2. 使用`this.$nextTick()`确保DOM更新
3. 使用computed属性计算显示状态,确保响应式

### 9.2 业务风险

#### 风险1: 用户误删临时知识库节点
**风险等级**: 低
**影响范围**: 知识检索节点配置
**风险描述**: 用户可能误删上游临时知识库节点,导致知识检索节点失效
**缓解措施**:
1. 自动清理机制会立即清除失效的临时知识库选择
2. 显示明确的警告消息:"上游临时知识库节点已移除,已清除选择"
3. 用户可以重新选择永久知识库

#### 风险2: 临时知识库过期
**风险等级**: 低
**影响范围**: workflow执行
**风险描述**: 临时知识库2小时后自动过期,再次执行workflow会失败
**缓解措施**:
1. 临时知识库过期是预期行为,符合设计
2. 后端会返回明确的错误:"知识库不存在或已过期"
3. 用户可以重新执行临时知识库节点创建新的临时知识库

### 9.3 兼容性风险

#### 风险1: 向后兼容性
**风险等级**: 极低
**影响范围**: 所有现有workflow
**风险描述**: 新增字段可能影响现有workflow的解析
**缓解措施**:
1. 新增字段都是可选字段,默认值为null/false
2. 后端解析配置时,缺少字段不会报错
3. 前端显示逻辑使用`v-if="upstreamTempKbNodes.length > 0"`,没有临时知识库节点时不显示

---

## 十、实施计划

### 10.1 前端实施步骤

1. **修改KnowledgeRetrievalNodeProperty.vue**:
   - 新增数据字段:`upstreamTempKbNodes`、`permanentKbs`、`selectedKbSource`
   - 新增方法:`detectUpstreamTempKbNodes()`、`validateTempKbSelection()`、`watchGraphChanges()`
   - 修改模板:增加临时知识库选项组显示
   - 修改`mounted()`生命周期:增加X6 graph事件监听

2. **测试前端功能**:
   - 测试上游节点检测:连接临时知识库节点到知识检索节点,验证临时知识库选项显示
   - 测试变量引用设置:选择临时知识库,验证`knowledge_base_uuid`字段格式
   - 测试断线清理:删除连线或节点,验证自动清理功能
   - 测试响应式更新:验证UI实时响应graph变化

### 10.2 后端实施步骤

1. **修改KnowledgeRetrievalNodeConfig.java**:
   - 新增`isTempKb`字段
   - 新增`tempKbNodeUuid`字段
   - 添加字段注释和@JsonProperty注解

2. **修改KnowledgeRetrievalNode.java**:
   - 在`onProcess()`方法中增加变量引用解析逻辑
   - 增加日志输出
   - 增加异常处理

3. **测试后端功能**:
   - 测试变量引用解析:执行包含临时知识库引用的workflow,验证解析结果
   - 测试日志输出:验证日志记录临时知识库的使用情况
   - 测试异常处理:测试变量引用解析失败的场景

### 10.3 集成测试

1. **端到端测试**:
   - 创建包含临时知识库节点和知识检索节点的workflow
   - 连接两个节点,验证临时知识库选项显示
   - 选择临时知识库,保存workflow
   - 执行workflow,验证临时知识库正确使用
   - 断开连线,验证自动清理功能
   - 重新连接,验证功能恢复

2. **兼容性测试**:
   - 打开现有workflow,验证向后兼容性
   - 使用永久知识库的workflow,验证功能不受影响
   - 升级后的workflow,验证新旧节点混合使用

---

## 十一、验收标准

### 11.1 功能验收标准

1. ✅ 知识检索节点能自动检测上游临时知识库节点
2. ✅ 只有当上游存在临时知识库节点且有连线时,才显示"临时知识库"选项组
3. ✅ 选择临时知识库后,自动使用变量引用语法:`{nodeUuid_kbUuid}`
4. ✅ 当上游临时知识库节点被删除或断线时,自动清除已选中的临时知识库
5. ✅ workflow执行时,变量引用正确解析为实际的知识库UUID
6. ✅ 向后兼容:没有临时知识库节点时,功能和界面与现在完全一致

### 11.2 性能验收标准

1. ✅ 上游节点检测耗时 < 50ms
2. ✅ UI响应时间 < 100ms
3. ✅ 不影响X6 graph的正常渲染性能

### 11.3 代码质量验收标准

1. ✅ 代码符合KISS原则,简洁清晰
2. ✅ 注释完整,符合规范
3. ✅ 日志输出完整,便于问题诊断
4. ✅ 异常处理完备,错误提示清晰

---

## 十二、参考文档

### 12.1 相关文件

- `D:\2025_project\20_project_in_github\01_scm_frontend\scm_frontend\src\components\70_ai\components\workflow\components\properties\TempKnowledgeBaseNodeProperty.vue`
- `D:\2025_project\20_project_in_github\01_scm_frontend\scm_frontend\src\components\70_ai\components\workflow\components\nodes\TempKnowledgeBaseNode.vue`
- `D:\2025_project\20_project_in_github\00_scm_backend\scm_backend\scm-ai\src\main\java\com\xinyirun\scm\ai\workflow\node\tempknowledgebase\TempKnowledgeBaseNode.java`
- `D:\2025_project\20_project_in_github\01_scm_frontend\scm_frontend\src\components\70_ai\components\workflow\components\properties\KnowledgeRetrievalNodeProperty.vue`
- `D:\2025_project\20_project_in_github\00_scm_backend\scm_backend\scm-ai\src\main\java\com\xinyirun\scm\ai\workflow\node\knowledgeretrieval\KnowledgeRetrievalNode.java`
- `D:\2025_project\20_project_in_github\00_scm_backend\scm_backend\scm-ai\src\main\java\com\xinyirun\scm\ai\workflow\node\knowledgeretrieval\KnowledgeRetrievalNodeConfig.java`
- `D:\2025_project\20_project_in_github\01_scm_frontend\scm_frontend\src\components\70_ai\components\workflow\components\WorkflowDesigner.vue`
- `D:\2025_project\20_project_in_github\00_scm_backend\scm_backend\scm-ai\src\main\java\com\xinyirun\scm\ai\workflow\WorkflowUtil.java`

### 12.2 X6 Graph API文档

- X6 Graph: https://x6.antv.antgroup.com/zh/docs/api/graph/graph
- X6 Events: https://x6.antv.antgroup.com/zh/docs/api/graph/events

---

## 十三、附录

### 13.1 数据库操作规范(遵循代码实施注意事项第17条)

本方案**不涉及数据库操作**,所有配置存储在workflow的JSON字段中,无需修改数据库表结构。

### 13.2 前端常量定义(如需新增)

本方案**不需要新增前端常量**,使用现有的节点类型标识即可。

### 13.3 后端常量定义(如需新增)

本方案**不需要新增后端常量**,使用现有的组件名称标识即可。

---

**方案编写完成,等待审批**
