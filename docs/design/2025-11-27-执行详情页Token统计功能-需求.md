# æ‰§è¡Œè¯¦æƒ…é¡µTokenç»Ÿè®¡åŠŸèƒ½ - éœ€æ±‚æ–‡æ¡£

## éœ€æ±‚èƒŒæ™¯

åœ¨AI Chatçš„"æ‰§è¡Œè¯¦æƒ…"é¡µé¢ï¼Œéœ€è¦å±•ç¤ºå·¥ä½œæµæ‰§è¡Œçš„Tokenæ¶ˆè€—æƒ…å†µï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£LLMè°ƒç”¨æˆæœ¬ã€‚

## é—®é¢˜ç°çŠ¶

1. **æ‰§è¡Œæ—¶é•¿ä¸ºç©º**ï¼šé¡µé¢æ˜¾ç¤º"æ‰§è¡Œæ—¶é•¿: -"
2. **ç¼ºå°‘Tokenç»Ÿè®¡**ï¼šæ— æ³•æŸ¥çœ‹å·¥ä½œæµçš„æ€»Tokenæ¶ˆè€—å’Œå„èŠ‚ç‚¹çš„Tokenæ¶ˆè€—

## éœ€æ±‚è¯´æ˜

### 1. ä¿®å¤æ‰§è¡Œæ—¶é•¿è®¡ç®—

**é—®é¢˜åˆ†æ**ï¼š
- åç«¯ `AiConversationRuntimeService.convertToDetailVo()` æ–¹æ³•ä¸­ï¼Œè®¡ç®— `elapsed_time` çš„é€»è¾‘ä¾èµ– `c_time` å’Œ `u_time`
- éœ€è¦ç¡®ä¿è¿™ä¸¤ä¸ªå­—æ®µåœ¨Entityâ†’VOè½¬æ¢æ—¶æ­£ç¡®æ˜ å°„

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ `BeanUtils.copyProperties()` æ˜¯å¦æ­£ç¡®å¤åˆ¶ `c_time` å’Œ `u_time`
- å¦‚æœå­—æ®µåä¸åŒ¹é…ï¼Œæ‰‹åŠ¨æ˜ å°„è¿™ä¸¤ä¸ªå­—æ®µ

### 2. Tokenç»Ÿè®¡åŠŸèƒ½

#### 2.1 æ€»Tokenæ˜¾ç¤º

åœ¨"æ‰§è¡Œè¯¦æƒ…"é¡µé¢**æœ€ä¸Šé¢çš„åŸºæœ¬ä¿¡æ¯åŒºåŸŸ**å¢åŠ å­—æ®µï¼š

```
| å·¥ä½œæµåç§° | æ‰§è¡ŒçŠ¶æ€ | æ‰§è¡Œæ—¶é•¿ |
| å¼€å§‹æ—¶é—´ | ç»“æŸæ—¶é—´ | åˆ›å»ºäºº |
| æ€»Tokenæ¶ˆè€— | - | - |  <-- æ–°å¢è¡Œ
```

**æ•°æ®æ¥æº**ï¼š
- ä» `ai_token_usage` è¡¨æŸ¥è¯¢è¯¥runtimeå…³è”çš„æ‰€æœ‰Tokenè®°å½•
- ç­›é€‰æ¡ä»¶ï¼š`serial_type = 'ai_conversation_runtime_node'` ä¸” `serial_id` å±äºè¯¥runtimeçš„èŠ‚ç‚¹
- æ±‡æ€»ï¼š`SUM(total_tokens)`

#### 2.2 èŠ‚ç‚¹Tokenæ˜¾ç¤º

åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„è¯¦æƒ…åŒºåŸŸï¼Œå¦‚æœè¯¥èŠ‚ç‚¹è°ƒç”¨äº†LLMï¼Œæ˜¾ç¤ºTokenæ¶ˆè€—ï¼š

```
èŠ‚ç‚¹ 1                               æˆåŠŸ
æ‰§è¡Œæ—¶é—´: 2025/11/27 13:33:02
Tokenæ¶ˆè€—: è¾“å…¥ 1234 / è¾“å‡º 5678 / æ€»è®¡ 6912  <-- æ–°å¢
è¾“å…¥æ•°æ®: {...}
è¾“å‡ºæ•°æ®: {...}
```

**æ•°æ®æ¥æº**ï¼š
- ä» `ai_token_usage` è¡¨æŸ¥è¯¢è¯¥èŠ‚ç‚¹çš„Tokenè®°å½•
- ç­›é€‰æ¡ä»¶ï¼š`serial_type = 'ai_conversation_runtime_node'` ä¸” `serial_id = èŠ‚ç‚¹ID`
- å­—æ®µï¼š`prompt_tokens`, `completion_tokens`, `total_tokens`

## æŠ€æœ¯å®ç°

### åç«¯å®ç°

#### 1. æ–°å¢Tokenç»Ÿè®¡Serviceæ–¹æ³•

**æ–‡ä»¶**ï¼š`AiTokenUsageService.java`

```java
/**
 * è·å–runtimeçš„æ€»Tokenæ¶ˆè€—
 * @param runtimeUuid è¿è¡Œå®ä¾‹UUID
 * @return æ€»Tokenæ•°
 */
public Long getTotalTokensByRuntimeUuid(String runtimeUuid);

/**
 * è·å–èŠ‚ç‚¹çš„Tokenæ¶ˆè€—
 * @param nodeId èŠ‚ç‚¹ID
 * @return Tokenæ¶ˆè€—è¯¦æƒ…(åŒ…å«prompt_tokens, completion_tokens, total_tokens)
 */
public NodeTokenUsageVo getNodeTokenUsage(Long nodeId);
```

#### 2. ä¿®æ”¹VOç±»

**æ–‡ä»¶**ï¼š`AiConversationRuntimeVo.java`

æ–°å¢å­—æ®µï¼š
```java
/**
 * æ€»Tokenæ¶ˆè€—(ä»ai_token_usageæ±‡æ€»)
 */
private Long totalTokens;
```

**æ–‡ä»¶**ï¼š`AiConversationRuntimeNodeVo.java`ï¼ˆæ–°å»ºæˆ–ä¿®æ”¹ï¼‰

æ–°å¢å­—æ®µï¼š
```java
/**
 * è¾“å…¥Tokenæ•°
 */
private Long promptTokens;

/**
 * è¾“å‡ºTokenæ•°
 */
private Long completionTokens;

/**
 * æ€»Tokenæ•°
 */
private Long totalTokens;
```

#### 3. ä¿®æ”¹Controllerè¿”å›æ•°æ®

**æ–‡ä»¶**ï¼š`AiConversationController.java`

åœ¨ `getConversationRuntimeDetail` å’Œ `getConversationRuntimeNodeDetails` æ–¹æ³•ä¸­ï¼š
- è°ƒç”¨Tokenç»Ÿè®¡Serviceè·å–æ•°æ®
- å¡«å……åˆ°VOä¸­è¿”å›ç»™å‰ç«¯

### å‰ç«¯å®ç°

#### 1. ä¿®æ”¹ExecutionDetailDialogç»„ä»¶

**æ–‡ä»¶**ï¼š`ExecutionDetailDialog.vue`

**ä¿®æ”¹åŸºæœ¬ä¿¡æ¯åŒºåŸŸ**ï¼ˆç¬¬14-37è¡Œï¼‰ï¼š
```vue
<el-descriptions :column="3" border>
  <!-- åŸæœ‰å­—æ®µ -->
  <el-descriptions-item label="å·¥ä½œæµåç§°">...</el-descriptions-item>
  <el-descriptions-item label="æ‰§è¡ŒçŠ¶æ€">...</el-descriptions-item>
  <el-descriptions-item label="æ‰§è¡Œæ—¶é•¿">...</el-descriptions-item>

  <!-- æ–°å¢ï¼šæ€»Tokenæ¶ˆè€— -->
  <el-descriptions-item label="æ€»Tokenæ¶ˆè€—" :span="3">
    <span v-if="runtimeDetail.totalTokens">
      {{ formatNumber(runtimeDetail.totalTokens) }} tokens
    </span>
    <span v-else>-</span>
  </el-descriptions-item>
</el-descriptions>
```

**ä¿®æ”¹èŠ‚ç‚¹è¯¦æƒ…åŒºåŸŸ**ï¼ˆç¬¬58-60è¡Œä¹‹åï¼‰ï¼š
```vue
<!-- èŠ‚ç‚¹æ‰§è¡Œæ—¶é—´ -->
<div v-if="node.c_time" class="node-time">
  æ‰§è¡Œæ—¶é—´: {{ formatDateTime(node.c_time) }}
</div>

<!-- æ–°å¢ï¼šTokenæ¶ˆè€— -->
<div v-if="node.totalTokens" class="node-token">
  Tokenæ¶ˆè€—:
  è¾“å…¥ {{ formatNumber(node.promptTokens || 0) }} /
  è¾“å‡º {{ formatNumber(node.completionTokens || 0) }} /
  æ€»è®¡ {{ formatNumber(node.totalTokens) }}
</div>
```

**æ–°å¢æ–¹æ³•**ï¼š
```javascript
methods: {
  // æ ¼å¼åŒ–æ•°å­—ï¼ˆåƒåˆ†ä½ï¼‰
  formatNumber(num) {
    if (!num) return '0'
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')
  }
}
```

## æ•°æ®åº“æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢runtimeçš„æ€»Token

```sql
SELECT
    SUM(total_tokens) as total_tokens
FROM ai_token_usage
WHERE serial_type = 'ai_conversation_runtime_node'
  AND serial_id IN (
      SELECT id
      FROM ai_conversation_runtime_node
      WHERE conversation_workflow_runtime_id = (
          SELECT id
          FROM ai_conversation_runtime
          WHERE runtime_uuid = 'xxx'
      )
  )
```

### æŸ¥è¯¢èŠ‚ç‚¹Token

```sql
SELECT
    prompt_tokens,
    completion_tokens,
    total_tokens
FROM ai_token_usage
WHERE serial_type = 'ai_conversation_runtime_node'
  AND serial_id = 'èŠ‚ç‚¹ID'
LIMIT 1
```

## æµ‹è¯•éªŒè¯

1. åˆ›å»ºæ–°å¯¹è¯ï¼Œè§¦å‘å·¥ä½œæµæ‰§è¡Œ
2. ç‚¹å‡»"æ‰§è¡Œè¯¦æƒ…"icon
3. éªŒè¯ï¼š
   - æ‰§è¡Œæ—¶é•¿æ­£ç¡®æ˜¾ç¤ºï¼ˆé"-"ï¼‰
   - æ€»Tokenæ¶ˆè€—æ˜¾ç¤ºåœ¨åŸºæœ¬ä¿¡æ¯åŒº
   - è°ƒç”¨LLMçš„èŠ‚ç‚¹æ˜¾ç¤ºTokenæ¶ˆè€—

## æ³¨æ„äº‹é¡¹

1. **å­—æ®µåä¸€è‡´æ€§**ï¼šç¡®ä¿Entity/VOçš„å­—æ®µåä¸BeanUtilså¤åˆ¶å…¼å®¹
2. **NULLå€¼å¤„ç†**ï¼šTokenç»Ÿè®¡å¯èƒ½ä¸ºç©ºï¼ˆèŠ‚ç‚¹æœªè°ƒç”¨LLMï¼‰ï¼Œå‰ç«¯éœ€è¦åˆ¤æ–­
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…N+1æŸ¥è¯¢é—®é¢˜ï¼Œè€ƒè™‘æ‰¹é‡æŸ¥è¯¢æˆ–JOINä¼˜åŒ–
4. **æ•°æ®ç²¾åº¦**ï¼šTokenæ•°å€¼å¯èƒ½è¾ƒå¤§ï¼Œä½¿ç”¨Longç±»å‹

## å®ç°ä¼˜å…ˆçº§

1. âœ… ä¿®å¤æ‰§è¡Œæ—¶é•¿è®¡ç®—ï¼ˆP0 - ç«‹å³ä¿®å¤ï¼‰
2. ğŸ”² åç«¯Tokenç»Ÿè®¡APIï¼ˆP0 - æ ¸å¿ƒåŠŸèƒ½ï¼‰
3. ğŸ”² å‰ç«¯Tokenå±•ç¤ºï¼ˆP0 - ç”¨æˆ·å¯è§ï¼‰
4. ğŸ”² æ€§èƒ½ä¼˜åŒ–ï¼ˆP1 - åç»­è¿­ä»£ï¼‰
