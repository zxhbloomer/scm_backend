# AIå·¥ä½œæµæ™ºèƒ½è·¯ç”±-å¤šè½®å¯¹è¯é›†æˆæ–¹æ¡ˆ

## æ–‡æ¡£ä¿¡æ¯
- **åˆ›å»ºæ—¶é—´**: 2025-11-10
- **åŠŸèƒ½æ¨¡å—**: SCM AIæ¨¡å— - å·¥ä½œæµè·¯ç”±ä¸å¤šè½®å¯¹è¯
- **è®¾è®¡äººå‘˜**: SCM-AIå›¢é˜Ÿ

---

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 æ ¸å¿ƒéœ€æ±‚
åœ¨AI Chaté€»è¾‘ä¸­é›†æˆAIå·¥ä½œæµè·¯ç”±å’Œæ„å›¾è¯†åˆ«ï¼Œå®ç°ï¼š
1. æ ¹æ®å¯¹è¯å†…å®¹è‡ªåŠ¨è¿è¡Œç›¸åº”çš„workflow
2. æ”¯æŒå·¥ä½œæµå¤šè½®å¯¹è¯åœºæ™¯ï¼ˆæš‚åœç­‰å¾…ç”¨æˆ·è¾“å…¥ â†’ æ¢å¤æ‰§è¡Œï¼‰
3. å¯ç”¨å·¥ä½œæµèŒƒå›´ï¼šç”¨æˆ·çš„å·²å‘å¸ƒéå…¬å¼€å·¥ä½œæµ + å…¬å¼€å·¥ä½œæµï¼ˆè‡ªåŠ¨å»é‡ï¼‰
4. æ— åŒ¹é…å·¥ä½œæµæ—¶ä½¿ç”¨å…œåº•å·¥ä½œæµï¼ˆç”¨æˆ·é…ç½®çš„é»˜è®¤å·¥ä½œæµï¼‰

### 1.2 å…¸å‹åœºæ™¯
```
åœºæ™¯1ï¼šé¦–æ¬¡å·¥ä½œæµè°ƒç”¨
- ç”¨æˆ·: "å¸®æˆ‘æŸ¥è¯¢è®¢å•"
- ç³»ç»Ÿ: [è·¯ç”±åˆ°è®¢å•æŸ¥è¯¢å·¥ä½œæµ]
- å·¥ä½œæµ: "è¯·æä¾›è®¢å•å·"
- çŠ¶æ€: WORKFLOW_WAITING_INPUT

åœºæ™¯2ï¼šå¤šè½®å¯¹è¯ - æä¾›è¾“å…¥
- ç”¨æˆ·: "ORD-20251110-001"
- ç³»ç»Ÿ: [è¯†åˆ«å¯¹è¯å†å²ï¼Œæ¢å¤è®¢å•æŸ¥è¯¢å·¥ä½œæµ]
- å·¥ä½œæµ: ç»§ç»­æ‰§è¡Œï¼ŒæŸ¥è¯¢è®¢å•è¯¦æƒ…
- çŠ¶æ€: WORKFLOW_COMPLETED â†’ IDLE
```

### 1.3 å…³é”®çº¦æŸ
- âŒ **ä¸èµ°æ™®é€šAIå¯¹è¯**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡å·¥ä½œæµè·¯ç”±ï¼Œæ— åŒ¹é…æ—¶èµ°å…œåº•å·¥ä½œæµ
- âœ… **Spring AIæ ‡å‡†**ï¼šéµå¾ªSpring AIçš„å“åº”å¼ç¼–ç¨‹æ¨¡å¼å’Œè¶…æ—¶/å–æ¶ˆæœºåˆ¶
- âœ… **é›¶ç ´åæ€§**ï¼šç°æœ‰éå·¥ä½œæµå¯¹è¯å®Œå…¨ä¸å—å½±å“ï¼ˆFeature Toggleä¿æŠ¤ï¼‰

---

## äºŒã€KISSåŸåˆ™è¯„ä¼°

### 2.1 å››é—®é¢˜è¯„ä¼°

| é—®é¢˜ | å›ç­” | è¯´æ˜ |
|------|------|------|
| 1. è¿™æ˜¯çœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³ï¼Ÿ | âœ… çœŸé—®é¢˜ | ç”¨æˆ·æ˜ç¡®éœ€æ±‚ï¼Œæ— æ­¤åŠŸèƒ½åˆ™å·¥ä½œæµæ— æ³•æš‚åœç­‰å¾…ç”¨æˆ·è¾“å…¥ã€‚"å–æ¶ˆåç»§ç»­å¯¹è¯"ä¹Ÿæ˜¯çœŸå®åœºæ™¯(è¯¯ç‚¹åœæ­¢/ä¸´æ—¶ä¸­æ–­) |
| 2. æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ | âœ… å¯ç®€åŒ– | æ•°æ®ç»“æ„æœ€å°åŒ–(3ä¸ªå­—æ®µ)âœ…ï¼Œä½†çŠ¶æ€å¯ä»5ä¸ªç®€åŒ–ä¸º3ä¸ªï¼ŒçŠ¶æ€æ›´æ–°å¯ä»7æ¬¡ç®€åŒ–ä¸º2æ¬¡ |
| 3. ä¼šç ´åä»€ä¹ˆå—ï¼Ÿ | âœ… æ— ç ´å | æ–°å­—æ®µDEFAULT NULLï¼ŒFeature Toggleä¿æŠ¤ï¼Œç°æœ‰ä»£ç ä¸å—å½±å“ |
| 4. å½“å‰é¡¹ç›®çœŸéœ€è¦è¿™ä¸ªåŠŸèƒ½å—ï¼Ÿ | âœ… å¿…éœ€ | å·¥ä½œæµæ ¸å¿ƒèƒ½åŠ›ï¼Œé˜»æ–­å¤šè½®å¯¹è¯åœºæ™¯ |

### 2.1.1 KISSä¼˜åŒ–è¦ç‚¹

ç»è¿‡æ·±åº¦KISSåˆ†æï¼Œè¯†åˆ«å‡ºä»¥ä¸‹ä¼˜åŒ–ç‚¹ï¼š

1. **çŠ¶æ€æœºç®€åŒ–**: 5ä¸ªçŠ¶æ€ â†’ 3ä¸ªçŠ¶æ€
   - åˆ é™¤: `ROUTING`(ç¬æ€<100msï¼Œåªéœ€æ—¥å¿—)ã€`WORKFLOW_COMPLETED`(ç¬æ€<1msï¼Œç›´æ¥è½¬IDLE)
   - ä¿ç•™: `IDLE`ã€`WORKFLOW_RUNNING`ã€`WORKFLOW_WAITING_INPUT`

2. **çŠ¶æ€æ›´æ–°å»å†—ä½™**: 7æ¬¡æ›´æ–° â†’ 2æ¬¡æ›´æ–°
   - åˆ é™¤"é¢„æ›´æ–°"é€»è¾‘(æ‰§è¡Œå‰æ›´æ–°ä¸ºRUNNINGæ˜¯å†—ä½™çš„)
   - åªåœ¨workflowäº‹ä»¶å“åº”æ—¶æ›´æ–°çŠ¶æ€

3. **å»¶é•¿TTL**: 10åˆ†é’Ÿ â†’ 30åˆ†é’Ÿ
   - ç”¨æˆ·å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´æ€è€ƒ(æŸ¥èµ„æ–™/æ¥ç”µè¯ç­‰)

4. **è¿‡æœŸä¼˜é›…é™çº§**: æŠ¥é”™ â†’ è‡ªåŠ¨é‡å¯
   - runtimeè¿‡æœŸæ—¶ï¼Œç”¨ç”¨æˆ·è¾“å…¥é‡å¯å·¥ä½œæµï¼Œè€ŒéæŠ¥é”™

5. **æ™ºèƒ½è·¯ç”±åˆ¤æ–­**: æ–°å¢æ„å›¾è¯†åˆ«
   - çŠ¶æ€=WAITING_INPUTæ—¶ï¼Œåˆ¤æ–­ç”¨æˆ·è¾“å…¥æ˜¯ç»§ç»­è¿˜æ˜¯æ–°æ„å›¾
   - æ–°æ„å›¾æ—¶æ¸…ç†æ—§çŠ¶æ€ï¼Œè§¦å‘æ–°å·¥ä½œæµ

### 2.2 æ•°æ®ç»“æ„åˆ†æï¼ˆç¬¬ä¸€å±‚ï¼‰
**æ ¸å¿ƒæ•°æ®**ï¼š
- `ai_conversation`æ–°å¢3ä¸ªå­—æ®µï¼š
  - `current_workflow_uuid`: å½“å‰æ´»è·ƒå·¥ä½œæµUUID
  - `current_runtime_uuid`: å·¥ä½œæµè¿è¡Œæ—¶UUIDï¼ˆæ¢å¤æ‰§è¡Œç”¨ï¼‰
  - `workflow_state`: å·¥ä½œæµçŠ¶æ€ï¼ˆ**KISSç®€åŒ–**: IDLE/WORKFLOW_RUNNING/WORKFLOW_WAITING_INPUTï¼‰

**æ•°æ®æµå‘**ï¼š
```
ç”¨æˆ·è¾“å…¥
â†’ chatStream() æ£€æŸ¥workflow_state
â†’ å¦‚æœWAITING_INPUT:
    â†’ åˆ¤æ–­æ˜¯ç»§ç»­è¿˜æ˜¯æ–°æ„å›¾(æ™ºèƒ½è·¯ç”±)
    â†’ ç»§ç»­: resumeFlowAsFlux(runtime_uuid, userInput)
    â†’ æ–°æ„å›¾: æ¸…ç†çŠ¶æ€ â†’ routeæ–°å·¥ä½œæµ
â†’ å¦‚æœIDLE: route(prompt, userId) è·å–workflowUuid â†’ streaming(workflowUuid)
â†’ å·¥ä½œæµäº‹ä»¶ â†’ ä¿å­˜åˆ°ai_conversation_content
â†’ onNodeWaitFeedback: æ›´æ–°state=WAITING_INPUT (ä»…2å¤„æ›´æ–°ä¹‹ä¸€)
â†’ onComplete: æ›´æ–°state=IDLE, æ¸…ç©ºworkflowå­—æ®µ (ä»…2å¤„æ›´æ–°ä¹‹äºŒ)
```

**æ— ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶**ï¼š
- âœ… ä¸éœ€è¦å•ç‹¬çš„workflow_contextè¡¨ï¼ˆé¿å…1:Nå¤æ‚æ€§ï¼‰
- âœ… RUNTIME_TO_GRAPHæ˜¯å†…å­˜ç¼“å­˜ï¼ˆ**KISSä¼˜åŒ–**: 30åˆ†é’ŸTTLï¼Œä¸éœ€è¦æŒä¹…åŒ–ï¼‰

### 2.3 å¤æ‚åº¦è¯„ä¼°ï¼ˆç¬¬ä¸‰å±‚ï¼‰
**æœ¬è´¨**ï¼šåœ¨AIå¯¹è¯ä¸­åµŒå…¥å·¥ä½œæµçŠ¶æ€æœºï¼Œæ ¹æ®å¯¹è¯çŠ¶æ€å†³å®šæ˜¯è·¯ç”±æ–°å·¥ä½œæµè¿˜æ˜¯æ¢å¤æš‚åœçš„å·¥ä½œæµã€‚

**æ ¸å¿ƒæ¦‚å¿µæ•°é‡**ï¼š8ä¸ªï¼ˆéƒ½æ˜¯å¿…éœ€çš„ï¼‰
1. ai_conversationçš„3ä¸ªæ–°å­—æ®µï¼ˆçŠ¶æ€æŒä¹…åŒ–ï¼‰
2. WorkflowRoutingServiceï¼ˆè·¯ç”±åˆ¤æ–­ï¼‰
3. WorkflowStarter.streaming()ï¼ˆæ–°å·¥ä½œæµæ‰§è¡Œï¼‰
4. WorkflowStarter.resumeFlowAsFlux()ï¼ˆæ¢å¤å·¥ä½œæµæ‰§è¡Œï¼Œå¾…å®ç°ï¼‰
5. WorkflowEventVoçš„7ç§äº‹ä»¶ç±»å‹ï¼ˆçŠ¶æ€è½¬æ¢ï¼‰
6. InterruptedFlow.RUNTIME_TO_GRAPHï¼ˆå†…å­˜ç¼“å­˜ï¼‰
7. timeout()è¶…æ—¶å¤„ç†
8. doOnCancel()å–æ¶ˆå¤„ç†

**ç®€åŒ–ç©ºé—´**ï¼šæ— ã€‚æ¯ä¸ªæ¦‚å¿µéƒ½æ˜¯åŠŸèƒ½å¿…éœ€çš„ã€‚

---

## ä¸‰ã€æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

### 3.1 æ•°æ®åº“å˜æ›´

#### 3.1.1 SQLå˜æ›´è„šæœ¬
**æ–‡ä»¶ä½ç½®**: `docs/design/sql/2025-11-10-ai-conversation-workflow-state.sql`

```sql
-- ä¸ºai_conversationè¡¨å¢åŠ å·¥ä½œæµçŠ¶æ€å­—æ®µ
ALTER TABLE ai_conversation
ADD COLUMN current_workflow_uuid VARCHAR(50) DEFAULT NULL COMMENT 'å½“å‰æ´»è·ƒå·¥ä½œæµUUID',
ADD COLUMN current_runtime_uuid VARCHAR(50) DEFAULT NULL COMMENT 'å½“å‰å·¥ä½œæµè¿è¡Œæ—¶UUID(ç”¨äºæ¢å¤æ‰§è¡Œ)',
ADD COLUMN workflow_state VARCHAR(20) DEFAULT 'IDLE' COMMENT 'å·¥ä½œæµçŠ¶æ€: IDLE-ç©ºé—², WORKFLOW_RUNNING-æ‰§è¡Œä¸­, WORKFLOW_WAITING_INPUT-ç­‰å¾…è¾“å…¥';

-- åˆ›å»ºç´¢å¼•
ALTER TABLE ai_conversation
ADD INDEX idx_ai_conversation_workflow_state (workflow_state),
ADD INDEX idx_ai_conversation_workflow_uuid (current_workflow_uuid),
ADD INDEX idx_ai_conversation_runtime_uuid (current_runtime_uuid);
```

#### 3.1.2 å®ä½“ç±»å˜æ›´
**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/entity/chat/AiConversationEntity.java`

```java
@TableName("ai_conversation")
public class AiConversationEntity implements Serializable {
    // ç°æœ‰å­—æ®µ...

    /**
     * å½“å‰æ´»è·ƒå·¥ä½œæµUUID
     */
    @TableField("current_workflow_uuid")
    private String currentWorkflowUuid;

    /**
     * å½“å‰å·¥ä½œæµè¿è¡Œæ—¶UUID(ç”¨äºæ¢å¤æ‰§è¡Œ)
     */
    @TableField("current_runtime_uuid")
    private String currentRuntimeUuid;

    /**
     * å·¥ä½œæµçŠ¶æ€
     * IDLE-ç©ºé—², WORKFLOW_RUNNING-æ‰§è¡Œä¸­, WORKFLOW_WAITING_INPUT-ç­‰å¾…è¾“å…¥
     * (KISSç®€åŒ–: ç§»é™¤ROUTINGå’ŒWORKFLOW_COMPLETEDç¬æ€çŠ¶æ€)
     */
    @TableField("workflow_state")
    private String workflowState;
}
```

#### 3.1.3 å¯¹åº”VOç±»å˜æ›´
**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/chat/AiConversationVo.java`

```java
public class AiConversationVo implements Serializable {
    // ç°æœ‰å­—æ®µ...

    /**
     * å½“å‰æ´»è·ƒå·¥ä½œæµUUID
     */
    private String currentWorkflowUuid;

    /**
     * å½“å‰å·¥ä½œæµè¿è¡Œæ—¶UUID
     */
    private String currentRuntimeUuid;

    /**
     * å·¥ä½œæµçŠ¶æ€
     */
    private String workflowState;
}
```

---

### 3.2 æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®ç°

#### 3.2.1 WorkflowStarteræ–°å¢resumeFlowAsFlux()æ–¹æ³•

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WorkflowStarter.java`

**è®¾è®¡æ€è·¯**ï¼šéµå¾ªSpring AIçš„å“åº”å¼æ¨¡å¼ - æ¯æ¬¡HTTPè¯·æ±‚åˆ›å»ºæ–°Fluxï¼Œå¤ç”¨WorkflowEngineä½†æ›¿æ¢StreamHandlerã€‚

**å‰ç½®æ¡ä»¶**: ä¿®æ”¹WorkflowEngine.javaï¼Œç§»é™¤streamHandlerçš„finalä¿®é¥°ç¬¦å¹¶æ·»åŠ setteræ–¹æ³•ï¼š

```java
// æ–‡ä»¶: scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WorkflowEngine.java
// ä¿®æ”¹ç¬¬45è¡Œ
- private final WorkflowStreamHandler streamHandler;
+ private WorkflowStreamHandler streamHandler; // ç§»é™¤final

// æ·»åŠ setteræ–¹æ³•
+ public void setStreamHandler(WorkflowStreamHandler handler) {
+     this.streamHandler = handler;
+ }
```

**resumeFlowAsFlux()å®ç°**ï¼š

```java
/**
 * æ¢å¤æš‚åœçš„å·¥ä½œæµï¼ˆæµå¼å“åº”ï¼‰
 * ç”¨äºå¤šè½®å¯¹è¯åœºæ™¯ï¼šå·¥ä½œæµæš‚åœç­‰å¾…ç”¨æˆ·è¾“å…¥åï¼Œç”¨æˆ·æä¾›è¾“å…¥ç»§ç»­æ‰§è¡Œ
 *
 * éµå¾ªSpring AIæ¨¡å¼ï¼šæ¯æ¬¡HTTPè¯·æ±‚åˆ›å»ºæ–°Fluxï¼Œä½†å¤ç”¨WorkflowEngine
 *
 * @param runtimeUuid å·¥ä½œæµè¿è¡Œæ—¶UUIDï¼ˆä»InterruptedFlow.RUNTIME_TO_GRAPHè·å–ï¼‰
 * @param workflowUuid å·¥ä½œæµUUIDï¼ˆç”¨äºruntimeè¿‡æœŸæ—¶é‡å¯ï¼‰
 * @param userInput ç”¨æˆ·æä¾›çš„è¾“å…¥å†…å®¹
 * @param tenantId ç§Ÿæˆ·ID
 * @return å·¥ä½œæµäº‹ä»¶æµï¼ˆFlux<WorkflowEventVo>ï¼‰
 */
public Flux<WorkflowEventVo> resumeFlowAsFlux(String runtimeUuid, String workflowUuid,
                                               String userInput, String tenantId) {
    // ä»ç¼“å­˜ä¸­è·å–æš‚åœçš„å·¥ä½œæµå¼•æ“
    WorkflowEngine workflowEngine = InterruptedFlow.RUNTIME_TO_GRAPH.get(runtimeUuid);

    if (workflowEngine == null) {
        // KISSä¼˜åŒ–: è¿‡æœŸä¼˜é›…é™çº§ - ç”¨æˆ·è¾“å…¥é‡å¯å·¥ä½œæµ,è€ŒéæŠ¥é”™
        log.info("è¿è¡Œæ—¶å·²è¿‡æœŸ(>30åˆ†é’Ÿ),ä½¿ç”¨ç”¨æˆ·è¾“å…¥é‡æ–°å¼€å§‹å·¥ä½œæµ: workflowUuid={}", workflowUuid);
        List<JSONObject> userInputs = List.of(
            new JSONObject().fluentPut("content", userInput)
        );
        return streaming(workflowUuid, userInputs, tenantId);
    }

    // ä¸ºæœ¬æ¬¡HTTPè¯·æ±‚åˆ›å»ºæ–°Fluxï¼ˆSpring AIæ¨¡å¼ï¼‰
    return Flux.<WorkflowEventVo>create(fluxSink -> {
        // ä¸ºæœ¬æ¬¡è¯·æ±‚åˆ›å»ºæ–°çš„StreamHandler
        WorkflowStreamHandler newHandler = new WorkflowStreamHandler(
            new WorkflowStreamHandler.StreamCallback() {
                @Override
                public void onStart(String runtimeData) {
                    fluxSink.next(WorkflowEventVo.createStartEvent(runtimeData));
                }

                @Override
                public void onNodeRun(String nodeUuid, String nodeData) {
                    fluxSink.next(WorkflowEventVo.createNodeRunEvent(nodeUuid, nodeData));
                }

                @Override
                public void onNodeInput(String nodeUuid, String inputData) {
                    fluxSink.next(WorkflowEventVo.createNodeInputEvent(nodeUuid, inputData));
                }

                @Override
                public void onNodeOutput(String nodeUuid, String outputData) {
                    fluxSink.next(WorkflowEventVo.createNodeOutputEvent(nodeUuid, outputData));
                }

                @Override
                public void onNodeChunk(String nodeUuid, String chunk) {
                    fluxSink.next(WorkflowEventVo.createNodeChunkEvent(nodeUuid, chunk));
                }

                @Override
                public void onNodeWaitFeedback(String nodeUuid, String tip) {
                    fluxSink.next(WorkflowEventVo.createNodeWaitFeedbackEvent(nodeUuid, tip));
                }

                @Override
                public void onComplete(String data) {
                    fluxSink.next(WorkflowEventVo.createDoneEvent(data));
                    fluxSink.complete();
                }

                @Override
                public void onError(Throwable error) {
                    fluxSink.error(error);
                }
            }
        );

        // æ›¿æ¢WorkflowEngineçš„StreamHandlerï¼ˆè¿æ¥åˆ°å½“å‰HTTPå“åº”æµï¼‰
        workflowEngine.setStreamHandler(newHandler);

        // å¼‚æ­¥æ¢å¤å·¥ä½œæµæ‰§è¡Œ
        CompletableFuture.runAsync(() -> {
            try {
                String tenantCode = workflowEngine.getTenantCode();
                if (tenantCode != null) {
                    DataSourceHelper.use(tenantCode);
                }

                // è°ƒç”¨WorkflowEngine.resume()æ¢å¤æ‰§è¡Œ
                workflowEngine.resume(userInput);

            } catch (Exception e) {
                log.error("å·¥ä½œæµæ¢å¤æ‰§è¡Œå¤±è´¥, runtimeUuid={}", runtimeUuid, e);
                newHandler.onError(e);
            } finally {
                DataSourceHelper.close();
            }
        }, asyncWorkflowExecutor);
    })
    .timeout(Duration.ofMinutes(30)) // KISSä¼˜åŒ–: å»¶é•¿åˆ°30åˆ†é’Ÿ
    .onErrorResume(TimeoutException.class, e -> {
        log.warn("å·¥ä½œæµæ¢å¤æ‰§è¡Œè¶…æ—¶: runtimeUuid={}", runtimeUuid);
        InterruptedFlow.RUNTIME_TO_GRAPH.remove(runtimeUuid);
        return Flux.just(WorkflowEventVo.createErrorEvent("å·¥ä½œæµæ‰§è¡Œè¶…æ—¶ï¼Œå·²è‡ªåŠ¨å–æ¶ˆ"));
    })
    .doOnCancel(() -> {
        log.info("ç”¨æˆ·å–æ¶ˆå·¥ä½œæµæ‰§è¡Œ: runtimeUuid={}", runtimeUuid);
        // KISSéªŒè¯: ä¿ç•™çŠ¶æ€ä¾›åç»­æ¢å¤(æ”¯æŒè¯¯ç‚¹åœæ­¢/ä¸´æ—¶ä¸­æ–­åœºæ™¯)
        // PassiveExpiringMapä¼šåœ¨30åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†
    })
    .subscribeOn(Schedulers.boundedElastic())
    .doFinally(signalType -> {
        DataSourceHelper.close();
    });
}
```

**å…³é”®Spring AIè®¾è®¡æ¨¡å¼**ï¼š
1. **æ¯æ¬¡åˆ›å»ºæ–°Flux**ï¼šç±»ä¼¼`chatModel.stream()`æ¯æ¬¡è¿”å›æ–°æµ
2. **æ›¿æ¢è€Œéå¤ç”¨Handler**ï¼šWorkflowEngineä»ç¼“å­˜æ¢å¤ï¼Œä½†StreamHandlerå¿…é¡»æ˜¯æ–°çš„ï¼ˆè¿æ¥åˆ°å½“å‰HTTPå“åº”ï¼‰
3. **å–æ¶ˆä¿ç•™çŠ¶æ€**ï¼šç”¨æˆ·å–æ¶ˆåä¿ç•™WORKFLOW_WAITING_INPUTçŠ¶æ€ï¼Œæ”¯æŒè¯¯ç‚¹åœæ­¢å’Œä¸´æ—¶ä¸­æ–­åœºæ™¯
4. **è¶…æ—¶30åˆ†é’Ÿ**ï¼šç»™ç”¨æˆ·å……è¶³æ—¶é—´æ€è€ƒï¼ˆæŸ¥èµ„æ–™/æ¥ç”µè¯ç­‰ï¼‰
5. **è¿‡æœŸä¼˜é›…é™çº§**ï¼šruntimeè¿‡æœŸæ—¶è‡ªåŠ¨é‡å¯å·¥ä½œæµï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

---

#### 3.2.2 AiConversationServiceæ–°å¢çŠ¶æ€æ›´æ–°æ–¹æ³•

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/chat/AiConversationService.java`

```java
/**
 * æ›´æ–°å¯¹è¯çš„å·¥ä½œæµçŠ¶æ€
 *
 * @param conversationId å¯¹è¯ID
 * @param workflowState å·¥ä½œæµçŠ¶æ€ï¼ˆIDLE/WORKFLOW_RUNNING/WORKFLOW_WAITING_INPUTï¼‰
 * @param workflowUuid å·¥ä½œæµUUIDï¼ˆå¯é€‰ï¼ŒIDLEæ—¶ä¼ nullï¼‰
 * @param runtimeUuid è¿è¡Œæ—¶UUIDï¼ˆå¯é€‰ï¼ŒIDLE/WORKFLOW_RUNNINGæ—¶ä¼ nullï¼‰
 */
@Transactional(rollbackFor = Exception.class)
public void updateWorkflowState(String conversationId, String workflowState,
                                 String workflowUuid, String runtimeUuid) {
    AiConversationEntity entity = aiConversationMapper.selectById(conversationId);
    if (entity == null) {
        throw new AiBusinessException("å¯¹è¯ä¸å­˜åœ¨: " + conversationId);
    }

    entity.setWorkflowState(workflowState);
    entity.setCurrentWorkflowUuid(workflowUuid);
    entity.setCurrentRuntimeUuid(runtimeUuid);

    aiConversationMapper.updateById(entity);

    log.info("æ›´æ–°å¯¹è¯å·¥ä½œæµçŠ¶æ€: conversationId={}, state={}, workflowUuid={}, runtimeUuid={}",
             conversationId, workflowState, workflowUuid, runtimeUuid);
}
```

---

#### 3.2.3 AiConversationControlleré›†æˆå·¥ä½œæµè·¯ç”±é€»è¾‘

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/controller/chat/AiConversationController.java`

**æ ¸å¿ƒæ”¹é€ ç‚¹**ï¼šéµå¾ªSpring AIçš„å“åº”å¼é“¾å¼è°ƒç”¨æ¨¡å¼ï¼Œä½¿ç”¨`.flatMapMany()`è¿›è¡ŒMonoâ†’Fluxè½¬æ¢ï¼Œé¿å…åµŒå¥—è®¢é˜…åæ¨¡å¼ã€‚

**Spring AIçš„æ­£ç¡®æ¨¡å¼ vs é”™è¯¯çš„åµŒå¥—è®¢é˜…**ï¼š

âŒ **é”™è¯¯æ¨¡å¼ï¼ˆåµŒå¥—è®¢é˜…åæ¨¡å¼ï¼‰**ï¼š
```java
return Flux.create(fluxSink -> {
    workflowStarter.streaming(...).subscribe(...); // è¿åå“åº”å¼è§„èŒƒ!
})
```

âœ… **Spring AIæ­£ç¡®æ¨¡å¼ï¼ˆç›´æ¥é“¾å¼è°ƒç”¨ï¼‰**ï¼š
```java
return Mono.fromCallable(() -> getConversation(conversationId))
    .flatMapMany(conversation -> workflowStarter.streaming(...))
    .map(event -> convert(event))
    .doOnNext(response -> updateState(...)); // é—­åŒ…æ•è·conversationId
```

**å®Œæ•´å®ç°**ï¼š

```java
@PostMapping(value = "/chat/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
@Operation(summary = "æµå¼èŠå¤© (æ”¯æŒå·¥ä½œæµè·¯ç”±+æ™ºèƒ½æ„å›¾åˆ¤æ–­)")
@SysLogAnnotion("AIæµå¼èŠå¤©")
public Flux<ChatResponseVo> chatStream(@Validated @RequestBody AIChatRequestVo request) {
    // Feature Toggle: å·¥ä½œæµè·¯ç”±åŠŸèƒ½å¼€å…³
    boolean workflowEnabled = enableWorkflowRouting; // ä»é…ç½®è¯»å–

    if (!workflowEnabled) {
        // å·¥ä½œæµåŠŸèƒ½æœªå¯ç”¨ï¼Œèµ°åŸæœ‰é€»è¾‘
        return chatStreamWithoutWorkflow(request);
    }

    // è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¤–å±‚å˜é‡ï¼Œä¾›é—­åŒ…æ•è·ï¼‰
    String conversationId = request.getConversationId();
    Long operatorId = SecurityUtil.getStaff_id();
    String userId = operatorId.toString();
    String tenantId = conversationId.split("::", 2)[0];

    // Spring AIæ¨¡å¼ï¼šMono â†’ Flux é“¾å¼è°ƒç”¨
    return Mono.fromCallable(() -> {
                // Step 1: å¼‚æ­¥æŸ¥è¯¢å¯¹è¯çŠ¶æ€
                DataSourceHelper.use(tenantId);
                AiConversationVo conversation = aiConversationService.getConversation(conversationId);
                if (conversation == null) {
                    throw new AiBusinessException("å¯¹è¯ä¸å­˜åœ¨: " + conversationId);
                }
                return conversation;
            })
            .flatMapMany(conversation -> {
                // Step 2: æ ¹æ®çŠ¶æ€å†³å®šæ‰§è¡Œè·¯å¾„ï¼ˆMono â†’ Fluxè½¬æ¢ï¼‰
                String workflowState = conversation.getWorkflowState();
                if (workflowState == null) {
                    workflowState = WorkflowStateConstant.STATE_IDLE;
                }

                if (WorkflowStateConstant.STATE_WORKFLOW_WAITING_INPUT.equals(workflowState)) {
                    // KISSä¼˜åŒ–5: æ™ºèƒ½è·¯ç”±åˆ¤æ–­
                    boolean isContinuation = isInputContinuation(
                        request.getPrompt(),
                        conversation.getCurrentWorkflowUuid(),
                        userId
                    );

                    if (isContinuation) {
                        // åœºæ™¯2A: ç»§ç»­å½“å‰å·¥ä½œæµ(å¦‚"ORD-001"ã€"ç»§ç»­")
                        String runtimeUuid = conversation.getCurrentRuntimeUuid();

                        // KISSä¼˜åŒ–2: åˆ é™¤é¢„æ›´æ–°çŠ¶æ€,åªåœ¨äº‹ä»¶å“åº”æ—¶æ›´æ–°
                        return workflowStarter.resumeFlowAsFlux(
                            runtimeUuid,
                            conversation.getCurrentWorkflowUuid(),
                            request.getPrompt(),
                            tenantId
                        );
                    } else {
                        // åœºæ™¯2B: æ–°æ„å›¾,æ¸…ç†æ—§çŠ¶æ€,è·¯ç”±æ–°å·¥ä½œæµ
                        aiConversationService.updateWorkflowState(
                            conversationId,
                            WorkflowStateConstant.STATE_IDLE,
                            null,
                            null
                        );

                        String newWorkflowUuid = workflowRoutingService.route(
                            request.getPrompt(),
                            userId,
                            null
                        );

                        if (newWorkflowUuid == null) {
                            newWorkflowUuid = getFallbackWorkflowUuid(userId);
                            if (newWorkflowUuid == null) {
                                return Flux.error(new AiBusinessException("æ²¡æœ‰å¯ç”¨çš„å·¥ä½œæµ"));
                            }
                        }

                        List<JSONObject> userInputs = List.of(
                            new JSONObject().fluentPut("content", request.getPrompt())
                        );
                        return workflowStarter.streaming(newWorkflowUuid, userInputs, tenantId);
                    }

                } else {
                    // åœºæ™¯1ï¼šæ–°è¯·æ±‚ - è·¯ç”±åˆ°å·¥ä½œæµ
                    String workflowUuid = workflowRoutingService.route(
                        request.getPrompt(),
                        userId,
                        null
                    );

                    if (workflowUuid == null) {
                        // è·å–å…œåº•å·¥ä½œæµ
                        workflowUuid = getFallbackWorkflowUuid(userId);
                        if (workflowUuid == null) {
                            return Flux.error(new AiBusinessException("æ²¡æœ‰å¯ç”¨çš„å·¥ä½œæµ"));
                        }
                    }

                    // KISSä¼˜åŒ–2: ä¸é¢„æ›´æ–°çŠ¶æ€,ç›´æ¥æ‰§è¡Œå·¥ä½œæµ
                    List<JSONObject> userInputs = List.of(
                        new JSONObject().fluentPut("content", request.getPrompt())
                    );
                    return workflowStarter.streaming(workflowUuid, userInputs, tenantId);
                }
            })
            // Step 3: è½¬æ¢å·¥ä½œæµäº‹ä»¶ä¸ºå“åº”æ ¼å¼
            .map(event -> convertWorkflowEventToResponse(event))

            // Step 4: KISSä¼˜åŒ–2 - åªåœ¨workflowäº‹ä»¶å“åº”æ—¶æ›´æ–°çŠ¶æ€(2æ¬¡)
            .doOnNext(response -> {
                if (response.isWaitingInput()) {
                    // æ›´æ–°1: å·¥ä½œæµç­‰å¾…ç”¨æˆ·è¾“å…¥
                    aiConversationService.updateWorkflowState(
                        conversationId,
                        WorkflowStateConstant.STATE_WORKFLOW_WAITING_INPUT,
                        response.getWorkflowUuid(),
                        response.getRuntimeUuid()
                    );
                }
                if (response.isComplete()) {
                    // æ›´æ–°2: å·¥ä½œæµå®Œæˆ
                    aiConversationService.updateWorkflowState(
                        conversationId,
                        WorkflowStateConstant.STATE_IDLE,
                        null,
                        null
                    );
                }
            })

            // Step 5: é”™è¯¯å’Œèµ„æºç®¡ç†(ç»Ÿä¸€å¤„ç†)
            .timeout(Duration.ofMinutes(30)) // KISSä¼˜åŒ–3: å»¶é•¿åˆ°30åˆ†é’Ÿ
            .onErrorResume(e -> {
                // ç»Ÿä¸€é”™è¯¯å¤„ç†(åŒ…å«timeoutå’Œæ™®é€šå¼‚å¸¸)
                log.error("å·¥ä½œæµæ‰§è¡Œå¼‚å¸¸: conversationId={}", conversationId, e);
                aiConversationService.updateWorkflowState(
                    conversationId,
                    WorkflowStateConstant.STATE_IDLE,
                    null,
                    null
                );
                String errorMsg = e instanceof TimeoutException ?
                    "å·¥ä½œæµæ‰§è¡Œè¶…æ—¶ï¼Œå·²è‡ªåŠ¨å–æ¶ˆ" : "å·¥ä½œæµæ‰§è¡Œå¤±è´¥: " + e.getMessage();
                return Flux.just(ChatResponseVo.createErrorResponse(errorMsg));
            })
            .doOnCancel(() -> {
                // ç”¨æˆ·å–æ¶ˆ: ä¿ç•™çŠ¶æ€(æ”¯æŒè¯¯ç‚¹åœæ­¢/ä¸´æ—¶ä¸­æ–­)
                log.info("ç”¨æˆ·å–æ¶ˆå·¥ä½œæµæ‰§è¡Œ: conversationId={}", conversationId);
            })
            .doFinally(signalType -> {
                DataSourceHelper.close();
            });
}

/**
 * KISSä¼˜åŒ–5: æ™ºèƒ½è·¯ç”±åˆ¤æ–­ - åˆ¤æ–­ç”¨æˆ·è¾“å…¥æ˜¯ç»§ç»­å½“å‰å·¥ä½œæµè¿˜æ˜¯æ–°æ„å›¾
 *
 * @param userInput ç”¨æˆ·è¾“å…¥
 * @param currentWorkflowUuid å½“å‰å·¥ä½œæµUUID
 * @param userId ç”¨æˆ·ID
 * @return true-ç»§ç»­å½“å‰å·¥ä½œæµ, false-æ–°æ„å›¾éœ€è¦è·¯ç”±
 */
private boolean isInputContinuation(String userInput, String currentWorkflowUuid, String userId) {
    // ç­–ç•¥1: æ˜ç¡®çš„ç»§ç»­å…³é”®è¯
    if (userInput.matches("(?i)ç»§ç»­|continue|æ˜¯|å¥½|ç¡®è®¤|ok")) {
        return true;
    }

    // ç­–ç•¥2: çŸ­è¾“å…¥(<20å­—ç¬¦),å¯èƒ½æ˜¯å…·ä½“å€¼(è®¢å•å·/æ•°é‡ç­‰)
    if (userInput.length() <= 20) {
        return true;
    }

    // ç­–ç•¥3: è·¯ç”±åˆ¤æ–­ - æ˜¯å¦åŒ¹é…åˆ°æ–°å·¥ä½œæµ
    String newWorkflowUuid = workflowRoutingService.route(userInput, userId, null);

    // æ²¡æœ‰åŒ¹é…æ–°å·¥ä½œæµ,æˆ–åŒ¹é…çš„è¿˜æ˜¯å½“å‰å·¥ä½œæµ â†’ ç»§ç»­
    return newWorkflowUuid == null || newWorkflowUuid.equals(currentWorkflowUuid);
}

/**
 * è½¬æ¢WorkflowEventVoä¸ºChatResponseVo
 */
private ChatResponseVo convertWorkflowEventToResponse(WorkflowEventVo event) {
    ChatResponseVo response = ChatResponseVo.builder()
        .type(event.getEvent())
        .content(event.getData())
        .build();

    // æ ‡è®°ç‰¹æ®Šäº‹ä»¶
    if (event.getEvent().equals("done")) {
        response.setComplete(true);
    }
    if (event.getEvent().startsWith("[NODE_WAIT_FEEDBACK_BY_")) {
        response.setWaitingInput(true);
        response.setRuntimeUuid(extractRuntimeUuidFromEvent(event));
    }

    return response;
}

/**
 * è·å–ç”¨æˆ·çš„å…œåº•å·¥ä½œæµUUID
 */
private String getFallbackWorkflowUuid(String userId) {
    // æŸ¥è¯¢ç”¨æˆ·é…ç½®çš„é»˜è®¤å·¥ä½œæµ
    // å®ç°é€»è¾‘...
    return null;
}

/**
 * åŸæœ‰é€»è¾‘ï¼ˆä¸å¯ç”¨å·¥ä½œæµè·¯ç”±æ—¶ä½¿ç”¨ï¼‰
 */
private Flux<ChatResponseVo> chatStreamWithoutWorkflow(AIChatRequestVo request) {
    // ä¿æŒåŸæœ‰çš„chatStream()å®ç°ä¸å˜
    // ...ï¼ˆåŸæœ‰ä»£ç 166-277è¡Œï¼‰
    return null;
}
```

**å…³é”®Spring AIè®¾è®¡æ¨¡å¼è¯´æ˜**ï¼š

| æ“ä½œç¬¦ | ç”¨é€” | ä¸ºä»€ä¹ˆè¿™æ ·åš |
|-------|------|------------|
| **Mono.fromCallable()** | å¼‚æ­¥æ‰§è¡ŒåŒæ­¥ä»£ç  | å°†`getConversation()`åŒ…è£…ä¸ºMonoï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ |
| **.flatMapMany()** | Mono â†’ Flux è½¬æ¢ | 1ä¸ªä¼šè¯å¯¹è±¡ â†’ Nä¸ªæµå¼äº‹ä»¶ï¼Œè¿™æ˜¯æ­£ç¡®çš„å“åº”å¼è½¬æ¢æ–¹å¼ |
| **.map()** | æ•°æ®æ ¼å¼è½¬æ¢ | WorkflowEventVo â†’ ChatResponseVo |
| **.doOnNext()** | å‰¯ä½œç”¨å¤„ç† | çŠ¶æ€æ›´æ–°ã€æ—¥å¿—è®°å½•ï¼ˆ**é—­åŒ…æ•è·conversationId**ï¼‰ |
| **.timeout()** | è¶…æ—¶æ§åˆ¶ | 10åˆ†é’Ÿæ— å“åº”è‡ªåŠ¨å–æ¶ˆ |
| **.onErrorResume()** | é”™è¯¯å¤„ç† | å°†å¼‚å¸¸è½¬æ¢ä¸ºæ­£å¸¸çš„é”™è¯¯å“åº” |
| **.doOnCancel()** | å–æ¶ˆå¤„ç† | ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’®æ—¶è§¦å‘ |
| **.doFinally()** | èµ„æºæ¸…ç† | æ— è®ºæˆåŠŸ/å¤±è´¥/å–æ¶ˆéƒ½æ‰§è¡Œ |

**ä¸åµŒå¥—è®¢é˜…çš„å¯¹æ¯”**ï¼š

```java
// âŒ é”™è¯¯ï¼šåµŒå¥—è®¢é˜…ç ´åå“åº”å¼è§„èŒƒ
Flux.create(fluxSink -> {
    workflowStarter.streaming(...).subscribe(
        event -> fluxSink.next(event),  // æ‰‹åŠ¨è½¬å‘
        error -> fluxSink.error(error),
        () -> fluxSink.complete()
    );
})

// âœ… æ­£ç¡®ï¼šç›´æ¥é“¾å¼è°ƒç”¨
return workflowStarter.streaming(...)
    .map(event -> convert(event))
    .doOnNext(response -> updateState(...))
```

---

### 3.3 Spring AIè§£å†³æ–¹æ¡ˆæ€»ç»“

æœ¬æ–¹æ¡ˆä¸¥æ ¼éµå¾ªSpring AIçš„å®˜æ–¹å“åº”å¼ç¼–ç¨‹æ¨¡å¼ï¼Œè§£å†³äº†è®¾è®¡åˆç¨¿ä¸­çš„3ä¸ªå…³é”®æŠ€æœ¯é—®é¢˜ï¼š

#### é—®é¢˜1: WorkflowStarter.resumeFlowAsFlux() å®ç°æ–¹æ¡ˆ

**Spring AIæ ¸å¿ƒç†å¿µ**: æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–°çš„Fluxï¼Œè€Œä¸æ˜¯"æ¢å¤"æ—§çš„Flux

**è§£å†³æ–¹æ¡ˆ**:
1. ä¿®æ”¹`WorkflowEngine.streamHandler`å­—æ®µï¼Œç§»é™¤`final`ä¿®é¥°ç¬¦
2. æ·»åŠ `setStreamHandler()`æ–¹æ³•
3. `resumeFlowAsFlux()`æ¯æ¬¡åˆ›å»ºæ–°Fluxï¼Œä½†å¤ç”¨WorkflowEngine
4. ä¸ºæ¯æ¬¡HTTPè¯·æ±‚åˆ›å»ºæ–°StreamHandlerï¼ˆè¿æ¥åˆ°å½“å‰å“åº”æµï¼‰

**ç±»æ¯”**: å°±åƒSpring AIçš„`chatModel.stream(prompt)`æ¯æ¬¡è¿”å›æ–°Fluxï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥æ¯æ¬¡åˆ›å»ºæ–°æµ

---

#### é—®é¢˜2: updateWorkflowState() å¦‚ä½•è·å– conversationId

**Spring AIæ¨¡å¼**: ä½¿ç”¨é—­åŒ…æ•è·(Closure Capture)

**è§£å†³æ–¹æ¡ˆ**:
```java
String conversationId = request.getConversationId(); // å¤–å±‚å˜é‡

return workflowStarter.streaming(...)
    .doOnNext(event -> {
        // âœ… Lambdaè‡ªåŠ¨æ•è·å¤–å±‚çš„conversationId
        updateWorkflowState(conversationId, ...);
    });
```

**åŸç†**: Java Lambdaè‡ªåŠ¨æ•è·å¤–å±‚çš„effectively-finalå˜é‡ï¼Œæ— éœ€ç‰¹æ®Šä¼ é€’æœºåˆ¶

---

#### é—®é¢˜3: ControlleråµŒå¥—è®¢é˜…åæ¨¡å¼ä¿®å¤

**Spring AIæ¨¡å¼**: ç›´æ¥Fluxé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨`.flatMapMany()`è¿›è¡ŒMonoâ†’Fluxè½¬æ¢

**é”™è¯¯æ¨¡å¼**ï¼ˆåˆç¨¿ï¼‰:
```java
âŒ return Flux.create(fluxSink -> {
    workflowStarter.streaming(...).subscribe(...); // è¿åå“åº”å¼è§„èŒƒ!
})
```

**æ­£ç¡®æ¨¡å¼**ï¼ˆSpring AIæ ‡å‡†ï¼‰:
```java
âœ… return Mono.fromCallable(() -> getConversation(conversationId))
    .flatMapMany(conversation -> workflowStarter.streaming(...))
    .map(event -> convert(event))
    .doOnNext(response -> updateState(conversationId, response))
    .timeout(Duration.ofMinutes(10))
    .onErrorResume(...)
    .doOnCancel(...)
    .doFinally(...);
```

**æ ¸å¿ƒä¼˜åŠ¿**:
- âœ… ç¬¦åˆReactive Streamsè§„èŒƒçš„èƒŒå‹æœºåˆ¶
- âœ… è‡ªåŠ¨ç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸ
- âœ… å£°æ˜å¼é”™è¯¯å¤„ç†å’Œå–æ¶ˆæœºåˆ¶
- âœ… æ— å†…å­˜æ³„æ¼å’Œçº¿ç¨‹é˜»å¡é£é™©

---

### 3.4 å·¥ä½œæµå†å²è®°å½•ç­–ç•¥

åŸºäºé˜¶æ®µ1çš„æ¾„æ¸…ï¼Œå·¥ä½œæµå†å²è®°å½•ç­–ç•¥å¦‚ä¸‹ï¼š

#### 3.3.1 è¡¨èŒè´£ç¡®è®¤
| è¡¨å | èŒè´£ | æ˜¯å¦ç”¨äºå·¥ä½œæµå†å² |
|------|------|-------------------|
| `ai_conversation` | å­˜å‚¨å¯¹è¯ä¼šè¯å’Œå½“å‰å·¥ä½œæµçŠ¶æ€ | âœ… **æ˜¯**ï¼ˆcurrent_workflow_uuid, current_runtime_uuid, workflow_stateï¼‰ |
| `ai_conversation_content` | å­˜å‚¨æ‰€æœ‰å¯¹è¯æ¶ˆæ¯ï¼ˆUSER/ASSISTANT/SYSTEM/TOOLï¼‰ | âœ… **æ˜¯**ï¼ˆå·¥ä½œæµè¾“å‡ºä½œä¸ºASSISTANTæ¶ˆæ¯å­˜å‚¨ï¼‰ |
| `ai_conversation_content_ref_embedding` | é“¾æ¥æ¶ˆæ¯åˆ°å‘é‡æœç´¢ç»“æœ | âŒ **å¦**ï¼ˆä¸å·¥ä½œæµæ— å…³ï¼‰ |
| `ai_conversation_content_ref_graph` | é“¾æ¥æ¶ˆæ¯åˆ°çŸ¥è¯†å›¾è°±å®ä½“ | âŒ **å¦**ï¼ˆä¸å·¥ä½œæµæ— å…³ï¼‰ |

#### 3.3.2 å·¥ä½œæµæ¶ˆæ¯ä¿å­˜ç­–ç•¥
å·¥ä½œæµè¾“å‡ºæ¶ˆæ¯ä¿å­˜åˆ°`ai_conversation_content`è¡¨ï¼š

```java
/**
 * ä¿å­˜å·¥ä½œæµè¾“å‡ºæ¶ˆæ¯åˆ°å¯¹è¯å†å²
 * åœ¨WorkflowEventVo.event="done"æ—¶è°ƒç”¨
 */
private void saveWorkflowOutputToHistory(String conversationId, String workflowOutput, Long operatorId) {
    aiConversationContentService.saveConversationContent(
        conversationId,
        AiMessageTypeConstant.MESSAGE_TYPE_ASSISTANT, // ç±»å‹ï¼šASSISTANT
        workflowOutput, // å·¥ä½œæµçš„å®Œæ•´è¾“å‡º
        null, // model_source_id (å·¥ä½œæµæ²¡æœ‰æ¨¡å‹)
        "workflow", // provider_name (æ ‡è®°ä¸ºå·¥ä½œæµ)
        "workflow-engine", // base_name (æ ‡è®°ä¸ºå·¥ä½œæµå¼•æ“)
        operatorId
    );
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨`MESSAGE_TYPE_ASSISTANT`ç±»å‹ï¼ˆä¸æ™®é€šAIå›å¤ä¸€è‡´ï¼‰
- é€šè¿‡`provider_name="workflow"`åŒºåˆ†å·¥ä½œæµæ¶ˆæ¯å’ŒAIæ¶ˆæ¯
- ä¸ä¿å­˜ä¸­é—´äº‹ä»¶ï¼ˆNODE_RUN/NODE_OUTPUTï¼‰ï¼Œåªä¿å­˜æœ€ç»ˆdoneäº‹ä»¶çš„data

---

### 3.4 è¶…æ—¶å’Œå–æ¶ˆæœºåˆ¶

#### 3.4.1 è¶…æ—¶å¤„ç†ï¼ˆå‚è€ƒSpring AIï¼‰
**Spring AIæ¨¡å¼**ï¼šä½¿ç”¨`timeout(Duration)` + `onErrorResume(TimeoutException.class, ...)`

**æˆ‘ä»¬çš„å®ç°**ï¼š
```java
.timeout(Duration.ofMinutes(10)) // 10åˆ†é’Ÿè¶…æ—¶ï¼ˆä¸RUNTIME_TO_GRAPHçš„TTLä¸€è‡´ï¼‰
.onErrorResume(TimeoutException.class, e -> {
    log.warn("å·¥ä½œæµæ‰§è¡Œè¶…æ—¶: conversationId={}", conversationId);

    // æ¸…ç†è¿è¡Œæ—¶å®ä¾‹
    InterruptedFlow.RUNTIME_TO_GRAPH.remove(runtimeUuid);

    // æ›´æ–°å¯¹è¯çŠ¶æ€ä¸ºIDLE
    aiConversationService.updateWorkflowState(conversationId, "IDLE", null, null);

    // è¿”å›è¶…æ—¶äº‹ä»¶ï¼ˆé€šçŸ¥å‰ç«¯ï¼‰
    return Flux.just(ChatResponseVo.createErrorResponse("å·¥ä½œæµæ‰§è¡Œè¶…æ—¶ï¼Œå·²è‡ªåŠ¨å–æ¶ˆ"));
})
```

**ä¸PassiveExpiringMapçš„ååŒ**ï¼š
- `RUNTIME_TO_GRAPH`çš„TTLæ˜¯10åˆ†é’Ÿ
- Fluxçš„timeoutä¹Ÿæ˜¯10åˆ†é’Ÿ
- ä¸¤è€…ååŒå·¥ä½œï¼šå³ä½¿Fluxè¶…æ—¶æ²¡è§¦å‘ï¼ŒPassiveExpiringMapä¹Ÿä¼šæ¸…ç†è¿‡æœŸå®ä¾‹

#### 3.4.2 ç”¨æˆ·å–æ¶ˆæœºåˆ¶ï¼ˆå‚è€ƒSpring AIï¼‰
**Spring AIæ¨¡å¼**ï¼šå“åº”å¼æµçš„è‡ªç„¶å–æ¶ˆï¼ˆå‰ç«¯å…³é—­EventSourceå³è§¦å‘å–æ¶ˆï¼‰

**æˆ‘ä»¬çš„å®ç°**ï¼š
```java
.doOnCancel(() -> {
    log.info("ç”¨æˆ·å–æ¶ˆå·¥ä½œæµæ‰§è¡Œ: conversationId={}", conversationId);

    // æ¸…ç†RUNTIME_TO_GRAPHä¸­çš„è¿è¡Œæ—¶å®ä¾‹
    InterruptedFlow.RUNTIME_TO_GRAPH.remove(runtimeUuid);

    // æ›´æ–°å¯¹è¯çŠ¶æ€ä¸ºIDLE
    aiConversationService.updateWorkflowState(conversationId, "IDLE", null, null);
})
```

**å‰ç«¯å–æ¶ˆæ–¹å¼**ï¼š
```javascript
// å‰ç«¯é€šè¿‡å…³é—­EventSourceè§¦å‘å–æ¶ˆ
const eventSource = new EventSource('/api/v1/ai/conversation/chat/stream');
eventSource.close(); // è§¦å‘åç«¯çš„doOnCancel()
```

**å¯é€‰ï¼šæ˜¾å¼å–æ¶ˆAPI**ï¼ˆå¦‚æœéœ€è¦åç«¯ä¸»åŠ¨å–æ¶ˆï¼‰ï¼š
```java
@PostMapping("/workflow/cancel/{conversationId}")
public ResponseEntity<Void> cancelWorkflow(@PathVariable String conversationId) {
    AiConversationVo conversation = aiConversationService.getConversation(conversationId);
    if (conversation != null && conversation.getCurrentRuntimeUuid() != null) {
        // æ¸…ç†è¿è¡Œæ—¶å®ä¾‹
        InterruptedFlow.RUNTIME_TO_GRAPH.remove(conversation.getCurrentRuntimeUuid());

        // æ›´æ–°çŠ¶æ€ä¸ºIDLE
        aiConversationService.updateWorkflowState(conversationId, "IDLE", null, null);
    }
    return ResponseEntity.ok().build();
}
```

---

## å››ã€æ–‡ä»¶æ”¹åŠ¨æ¸…å•

### 4.1 åç«¯æ–‡ä»¶æ”¹åŠ¨

#### æ ¸å¿ƒå¼•æ“ä¿®æ”¹ï¼ˆå‰ç½®æ¡ä»¶ï¼‰
- [ ] `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WorkflowEngine.java` - **ç§»é™¤streamHandlerçš„finalä¿®é¥°ç¬¦ï¼Œæ·»åŠ setteræ–¹æ³•**
  ```java
  // ç¬¬45è¡Œä¿®æ”¹
  - private final WorkflowStreamHandler streamHandler;
  + private WorkflowStreamHandler streamHandler;

  // æ·»åŠ setteræ–¹æ³•
  + public void setStreamHandler(WorkflowStreamHandler handler) {
  +     this.streamHandler = handler;
  + }
  ```

#### æ•°æ®åº“å˜æ›´
- [ ] `docs/design/sql/2025-11-10-ai-conversation-workflow-state.sql` - **å·²å­˜åœ¨**ï¼Œéœ€æ‰§è¡Œ

#### å®ä½“ç±»
- [ ] `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/entity/chat/AiConversationEntity.java` - å¢åŠ 3ä¸ªå­—æ®µ

#### VOç±»
- [ ] `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/chat/AiConversationVo.java` - å¢åŠ 3ä¸ªå­—æ®µ
- [ ] `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/response/ChatResponseVo.java` - å¢åŠ `isWaitingInput`, `isComplete`, `runtimeUuid`, `workflowUuid`å­—æ®µ

#### Serviceå±‚
- [ ] `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WorkflowStarter.java` - æ–°å¢`resumeFlowAsFlux()`æ–¹æ³•
- [ ] `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/chat/AiConversationService.java` - æ–°å¢`updateWorkflowState()`æ–¹æ³•

#### Controllerå±‚
- [ ] `scm-ai/src/main/java/com/xinyirun/scm/ai/controller/chat/AiConversationController.java` - **å®Œå…¨é‡æ„`chatStream()`æ–¹æ³•**ï¼Œé‡‡ç”¨Spring AIé“¾å¼è°ƒç”¨æ¨¡å¼

#### é…ç½®
- [ ] `scm-ai/src/main/resources/application.yml` - å¢åŠ Feature Toggleé…ç½®ï¼š
```yaml
scm:
  ai:
    workflow:
      enabled: false # é»˜è®¤å…³é—­ï¼Œæµ‹è¯•é€šè¿‡åå†å¯ç”¨
```

### 4.2 å‰ç«¯æ–‡ä»¶æ”¹åŠ¨ï¼ˆå¯é€‰ï¼Œå¦‚éœ€é€‚é…ï¼‰
- å‰ç«¯æ— éœ€å¼ºåˆ¶æ”¹åŠ¨ï¼ˆAPIç­¾åä¸å˜ï¼Œå“åº”æ ¼å¼å…¼å®¹ï¼‰
- å¯é€‰ï¼šå¢åŠ å·¥ä½œæµçŠ¶æ€å±•ç¤ºï¼ˆWORKFLOW_WAITING_INPUTæ—¶æ˜¾ç¤º"ç­‰å¾…æ‚¨çš„è¾“å…¥..."ï¼‰

---

## äº”ã€é£é™©åˆ†æä¸ç¼“è§£æªæ–½

### 5.1 é£é™©æ¸…å•

| é£é™©ç‚¹ | é£é™©ç­‰çº§ | å½±å“èŒƒå›´ | ç¼“è§£æªæ–½ |
|-------|---------|---------|---------|
| chatStream()å…¥å£æ”¹åŠ¨ç ´åç°æœ‰é€»è¾‘ | ğŸ”´ é«˜ | æ‰€æœ‰å¯¹è¯åŠŸèƒ½ | Feature Toggleä¿æŠ¤ï¼Œé»˜è®¤å…³é—­ |
| RUNTIME_TO_GRAPHå†…å­˜æ³„æ¼ | ğŸŸ¡ ä¸­ | æœåŠ¡å™¨å†…å­˜ | PassiveExpiringMapè‡ªåŠ¨æ¸…ç†ï¼ˆ10åˆ†é’ŸTTLï¼‰ |
| çŠ¶æ€ä¸ä¸€è‡´ï¼ˆstate=WAITING_INPUTä½†runtime_uuid=nullï¼‰ | ğŸŸ¡ ä¸­ | å¤šè½®å¯¹è¯å¤±è´¥ | å¢åŠ æ•°æ®æ ¡éªŒï¼Œå¼‚å¸¸æ—¶é‡ç½®ä¸ºIDLE |
| å·¥ä½œæµè¶…æ—¶æœªæ¸…ç†å¯¼è‡´å†…å­˜å ç”¨ | ğŸŸ¡ ä¸­ | æœåŠ¡å™¨å†…å­˜ | timeout() + PassiveExpiringMapåŒé‡ä¿æŠ¤ |
| æ•°æ®åº“å˜æ›´é£é™© | ğŸŸ¢ ä½ | ai_conversationè¡¨ | DEFAULT NULLï¼Œä¸å½±å“ç°æœ‰æ•°æ® |

### 5.2 å›æ»šæ–¹æ¡ˆ
1. **é…ç½®å›æ»š**ï¼šå°†`scm.ai.workflow.enabled`è®¾ä¸º`false`ï¼Œç«‹å³å›åˆ°åŸæœ‰é€»è¾‘
2. **ä»£ç å›æ»š**ï¼šå›æ»šchatStream()çš„æ”¹åŠ¨ï¼Œä¿ç•™Feature Toggleåˆ†æ”¯
3. **æ•°æ®åº“å›æ»š**ï¼š
```sql
ALTER TABLE ai_conversation
DROP COLUMN current_workflow_uuid,
DROP COLUMN current_runtime_uuid,
DROP COLUMN workflow_state;
```

---

## å…­ã€æµ‹è¯•è®¡åˆ’

### 6.1 å•å…ƒæµ‹è¯•
- [ ] `WorkflowStarter.resumeFlowAsFlux()` - æ­£å¸¸æ¢å¤ã€è¶…æ—¶ã€å–æ¶ˆã€å·¥ä½œæµä¸å­˜åœ¨
- [ ] `AiConversationService.updateWorkflowState()` - çŠ¶æ€æ›´æ–°ã€äº‹åŠ¡å›æ»š

### 6.2 é›†æˆæµ‹è¯•

- [ ] **åœºæ™¯1ï¼šé¦–æ¬¡å·¥ä½œæµè°ƒç”¨** - IDLE â†’ WORKFLOW_RUNNING â†’ WORKFLOW_WAITING_INPUT
- [ ] **åœºæ™¯2Aï¼šå¤šè½®å¯¹è¯-ç»§ç»­** - WORKFLOW_WAITING_INPUT + "ORD-001" â†’ resumeFlow â†’ done â†’ IDLE
- [ ] **åœºæ™¯2Bï¼šå¤šè½®å¯¹è¯-æ–°æ„å›¾** - WORKFLOW_WAITING_INPUT + "å¸®æˆ‘æŸ¥åº“å­˜" â†’ æ¸…ç†çŠ¶æ€ â†’ è·¯ç”±æ–°å·¥ä½œæµ â†’ IDLE
- [ ] **åœºæ™¯3ï¼šè¶…æ—¶å¤„ç†** - å·¥ä½œæµæ‰§è¡Œè¶…è¿‡30åˆ†é’Ÿï¼Œè‡ªåŠ¨å–æ¶ˆå¹¶é‡ç½®çŠ¶æ€
- [ ] **åœºæ™¯4ï¼šç”¨æˆ·å–æ¶ˆ** - å‰ç«¯å…³é—­EventSourceï¼Œåç«¯ä¿ç•™WORKFLOW_WAITING_INPUTçŠ¶æ€(æ”¯æŒç»§ç»­)
- [ ] **åœºæ™¯5ï¼šruntimeè¿‡æœŸä¼˜é›…é™çº§** - 35åˆ†é’Ÿåç”¨æˆ·è¾“å…¥ï¼Œè‡ªåŠ¨é‡å¯å·¥ä½œæµ(ç”¨æˆ·æ— æ„ŸçŸ¥)
- [ ] **åœºæ™¯6ï¼šå…œåº•å·¥ä½œæµ** - æ— åŒ¹é…å·¥ä½œæµæ—¶èµ°é»˜è®¤å·¥ä½œæµ
- [ ] **åœºæ™¯7ï¼šæ™ºèƒ½è·¯ç”±åˆ¤æ–­** - çŸ­è¾“å…¥(<20å­—ç¬¦)è¢«åˆ¤å®šä¸ºç»§ç»­ï¼Œé•¿è¾“å…¥åŒ¹é…æ–°å·¥ä½œæµè¢«åˆ¤å®šä¸ºæ–°æ„å›¾

### 6.3 æ€§èƒ½æµ‹è¯•
- [ ] **å¹¶å‘æµ‹è¯•** - 100ä¸ªç”¨æˆ·åŒæ—¶å‘èµ·å·¥ä½œæµå¯¹è¯
- [ ] **å†…å­˜ç›‘æ§** - éªŒè¯RUNTIME_TO_GRAPHçš„å†…å­˜å ç”¨å’Œæ¸…ç†æœºåˆ¶
- [ ] **å“åº”æ—¶é—´** - å·¥ä½œæµè·¯ç”±å»¶è¿Ÿ < 500ms

---

## ä¸ƒã€å®æ–½æ­¥éª¤

### 7.1 Phase 1ï¼šæ•°æ®åº“å˜æ›´ï¼ˆé£é™©æœ€ä½ï¼‰
1. æ‰§è¡ŒSQLå˜æ›´è„šæœ¬
2. éªŒè¯ç´¢å¼•åˆ›å»º
3. æ›´æ–°å®ä½“ç±»å’ŒVOç±»

### 7.2 Phase 2ï¼šæ ¸å¿ƒé€»è¾‘å®ç°ï¼ˆFeature Toggleä¿æŠ¤ï¼‰
1. å®ç°`WorkflowStarter.resumeFlowAsFlux()`
2. å®ç°`AiConversationService.updateWorkflowState()`
3. æ”¹é€ `AiConversationController.chatStream()`ï¼ˆFeature Toggleé»˜è®¤å…³é—­ï¼‰

### 7.3 Phase 3ï¼šæµ‹è¯•éªŒè¯
1. å•å…ƒæµ‹è¯•é€šè¿‡
2. é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆæœ¬åœ°ç¯å¢ƒï¼ŒFeature Toggleå¼€å¯ï¼‰
3. æ€§èƒ½æµ‹è¯•é€šè¿‡

### 7.4 Phase 4ï¼šç°åº¦å‘å¸ƒ
1. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆFeature Toggleå…³é—­ï¼‰
2. é€‰æ‹©1-2ä¸ªæµ‹è¯•ç”¨æˆ·å¼€å¯Feature Toggle
3. è§‚å¯Ÿæ—¥å¿—å’Œç›‘æ§æŒ‡æ ‡
4. æ— é—®é¢˜åé€æ­¥æ‰©å¤§èŒƒå›´

### 7.5 Phase 5ï¼šå…¨é‡å‘å¸ƒ
1. å°†`scm.ai.workflow.enabled`é»˜è®¤å€¼æ”¹ä¸º`true`
2. å…¨é‡å‘å¸ƒ

---

## å…«ã€é™„å½•

### 8.1 çŠ¶æ€æœºè½¬æ¢å›¾(KISSç®€åŒ–ç‰ˆ)

```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 IDLE                    â”‚ â† åˆå§‹çŠ¶æ€/å·¥ä½œæµå®Œæˆ/è¶…æ—¶/é”™è¯¯
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ ç”¨æˆ·è¾“å…¥ + è·¯ç”±åˆ¤æ–­(æ—¥å¿—è®°å½•,ä¸æŒä¹…åŒ–)
                        â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         WORKFLOW_RUNNING                â”‚ â† å·¥ä½œæµæ‰§è¡Œä¸­
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚                            â”‚
               â”‚ onNodeWaitFeedback         â”‚ doneäº‹ä»¶
               â†“                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   WORKFLOW_WAITING_INPUT     â”‚            â”‚
â”‚                              â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
       â”‚        â”‚                            â”‚
       â”‚        â”‚ æ–°æ„å›¾(æ™ºèƒ½åˆ¤æ–­)           â”‚
       â”‚        â””â”€â”€â”€â”€â†’ æ¸…ç†çŠ¶æ€ â”€â”€â”€â”€â”€â”€â†’ å›åˆ°IDLE
       â”‚
       â”‚ ç»§ç»­/çŸ­è¾“å…¥(æ™ºèƒ½åˆ¤æ–­)
       â”‚ resumeFlowAsFlux()
       â”‚    â†“
       â”‚  æ‰§è¡Œå·¥ä½œæµ
       â”‚    â†“
       â”‚  doneäº‹ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å›åˆ°IDLE
       â”‚
       â”‚ ç”¨æˆ·å–æ¶ˆ(ä¿ç•™çŠ¶æ€,æ”¯æŒè¯¯ç‚¹/ä¸´æ—¶ä¸­æ–­)
       â”‚ 30åˆ†é’Ÿè¶…æ—¶ â†’ PassiveExpiringMapæ¸…ç†runtime
       â”‚ è¿‡æœŸåç”¨æˆ·è¾“å…¥ â†’ ä¼˜é›…é™çº§(é‡å¯å·¥ä½œæµ)
```

**KISSä¼˜åŒ–ç‚¹**:
- âŒ ç§»é™¤`ROUTING`çŠ¶æ€: ç¬æ€<100ms,åªéœ€æ—¥å¿—è®°å½•
- âŒ ç§»é™¤`WORKFLOW_COMPLETED`çŠ¶æ€: ç¬æ€<1ms,doneäº‹ä»¶ç›´æ¥è½¬IDLE
- âœ… æ–°å¢æ™ºèƒ½è·¯ç”±åˆ¤æ–­: WAITING_INPUTæ—¶åŒºåˆ†ç»§ç»­vsæ–°æ„å›¾
- âœ… å»¶é•¿TTLåˆ°30åˆ†é’Ÿ: ç»™ç”¨æˆ·å……è¶³æ—¶é—´æ€è€ƒ
- âœ… è¿‡æœŸä¼˜é›…é™çº§: runtime=nullæ—¶è‡ªåŠ¨é‡å¯å·¥ä½œæµ

### 8.2 å…³é”®å¸¸é‡å®šä¹‰

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/common/constant/WorkflowStateConstant.java`

```java
/**
 * å·¥ä½œæµçŠ¶æ€å¸¸é‡(KISSç®€åŒ–ç‰ˆ)
 *
 * @author SCM-AIå›¢é˜Ÿ
 * @since 2025-11-10
 */
public class WorkflowStateConstant {
    /**
     * ç©ºé—²çŠ¶æ€ - æ²¡æœ‰æ´»è·ƒå·¥ä½œæµ
     */
    public static final String STATE_IDLE = "IDLE";

    /**
     * æ‰§è¡Œä¸­ - å·¥ä½œæµæ­£åœ¨æ‰§è¡Œ
     */
    public static final String STATE_WORKFLOW_RUNNING = "WORKFLOW_RUNNING";

    /**
     * ç­‰å¾…è¾“å…¥ - å·¥ä½œæµæš‚åœ,ç­‰å¾…ç”¨æˆ·æä¾›è¾“å…¥
     */
    public static final String STATE_WORKFLOW_WAITING_INPUT = "WORKFLOW_WAITING_INPUT";

    // KISSä¼˜åŒ–: ç§»é™¤ROUTINGå’ŒWORKFLOW_COMPLETEDç¬æ€çŠ¶æ€
}
```

### 8.3 InterruptedFlowç¼“å­˜é…ç½®

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/InterruptedFlow.java`

```java
/**
 * KISSä¼˜åŒ–: TTLå»¶é•¿åˆ°30åˆ†é’Ÿ
 * åŸå› : ç”¨æˆ·å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´æ€è€ƒ(æŸ¥èµ„æ–™/æ¥ç”µè¯ç­‰)
 */
public static final PassiveExpiringMap<String, WorkflowEngine> RUNTIME_TO_GRAPH =
    new PassiveExpiringMap<>(30, TimeUnit.MINUTES);
```

### 8.3 å‚è€ƒæ–‡æ¡£
- Spring AIå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-ai/reference/
- Spring AI Advisors: https://docs.spring.io/spring-ai/reference/api/chatclient.html#_advisors
- LangGraph4jæ–‡æ¡£ï¼šhttps://github.com/langchain4j/langgraph4j

---

**æ–¹æ¡ˆç¼–å†™å®Œæˆæ—¶é—´**: 2025-11-10
**é¢„è®¡å®æ–½å·¥æ—¶**: 3-5å¤©ï¼ˆå«æµ‹è¯•ï¼‰
