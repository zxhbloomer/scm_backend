# Workflowå¯¹è¯è®°å½•é¢†åŸŸéš”ç¦»é‡æ„æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-08
**ä½œè€…**: SCM-AIå›¢é˜Ÿ
**çŠ¶æ€**: å¾…å®¡æ‰¹

---

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

### ç›®æ ‡

å°†Workflowé—®ç­”å¯¹è¯çš„å¯¹è¯è®°å½•ä»Chaté¢†åŸŸçš„ `ai_conversation_content` è¡¨è¿ç§»åˆ°Workflowä¸“å±çš„ `ai_workflow_conversation_content` è¡¨ï¼Œå®ç°é¢†åŸŸéš”ç¦»ï¼Œè§£é™¤Workflowä¸Chatçš„è€¦åˆã€‚

### èƒŒæ™¯

**å½“å‰é—®é¢˜**ï¼š
- Workflowæ¨¡å—ä½¿ç”¨Chaté¢†åŸŸçš„ `ai_conversation_content` è¡¨å­˜å‚¨å¯¹è¯å†å²
- Workflowä¾èµ–Chaté¢†åŸŸçš„ `AiConversationContentService`
- é€ æˆé¢†åŸŸè€¦åˆï¼Œè¿åDDDçš„é™ç•Œä¸Šä¸‹æ–‡åŸåˆ™
- ä¿®æ”¹Chatå¯èƒ½å½±å“Workflowï¼Œç»´æŠ¤æˆæœ¬é«˜

**é‡æ„åŸå› **ï¼š
- é¢†åŸŸéš”ç¦»ï¼šChatå’ŒWorkflowæ˜¯ä¸åŒçš„ä¸šåŠ¡é¢†åŸŸ
- æ•°æ®æ¸…æ™°ï¼šç‹¬ç«‹è¡¨ä¾¿äºç®¡ç†å’ŒæŸ¥è¯¢
- å¯æ‰©å±•æ€§ï¼šå¯è‡ªç”±å¢åŠ workflowç‰¹æœ‰å­—æ®µ
- ç»´æŠ¤æ€§ï¼šä¸¤ä¸ªé¢†åŸŸç‹¬ç«‹ç»´æŠ¤ï¼Œäº’ä¸å½±å“

---

## ğŸ¯ KISSåŸåˆ™éªŒè¯

### é—®é¢˜1ï¼šè¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ

âœ… **çœŸé—®é¢˜**
- Workflowå’ŒChatæ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ä¸šåŠ¡é¢†åŸŸ
- å½“å‰æ··ç”¨ai_conversation_contenté€ æˆäº†é¢†åŸŸè€¦åˆ
- è¿™æ˜¯çœŸå®çš„æ¶æ„é—®é¢˜ï¼Œå½±å“ä»£ç ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§

### é—®é¢˜2ï¼šæœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ

âœ… **å½“å‰æ–¹æ¡ˆå·²æ˜¯æœ€ç®€**
- åˆ›å»ºç‹¬ç«‹çš„è¡¨ï¼šæ¸…æ™°éš”ç¦»
- å¤ç”¨ç°æœ‰é€»è¾‘ï¼šå‡å°‘é‡å¤å¼€å‘
- è¡¨ç»“æ„ç›¸åŒï¼šé™ä½å­¦ä¹ æˆæœ¬
- æ— éœ€ä¿®æ”¹ä¸šåŠ¡é€»è¾‘ï¼Œåªéœ€åˆ‡æ¢Service

### é—®é¢˜3ï¼šä¼šç ´åä»€ä¹ˆå—ï¼Ÿ

âœ… **ä¸ä¼šç ´åç°æœ‰åŠŸèƒ½**
- æ•°æ®è¿ç§»ä¿è¯å†å²æ•°æ®å®Œæ•´
- ä¸šåŠ¡é€»è¾‘ä¿æŒä¸å˜
- ChatåŠŸèƒ½å®Œå…¨ä¸å—å½±å“
- WorkflowåŠŸèƒ½å¹³æ»‘è¿‡æ¸¡

### é—®é¢˜4ï¼šå½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—ï¼Ÿ

âœ… **å¿…éœ€**
- é¢†åŸŸéš”ç¦»æ˜¯è‰¯å¥½æ¶æ„çš„åŸºç¡€
- ä¾¿äºåç»­ç‹¬ç«‹ç»´æŠ¤å’Œæ‰©å±•
- é¿å…ä¿®æ”¹Chatå½±å“Workflow

---

## ğŸ“Š æ•°æ®ç»“æ„è®¾è®¡

### æ–°è¡¨ï¼šai_workflow_conversation_content

```sql
CREATE TABLE `ai_workflow_conversation_content` (
  `id` VARCHAR(50) NOT NULL COMMENT 'ID',
  `message_id` VARCHAR(50) NOT NULL COMMENT 'æ¶ˆæ¯IDï¼ˆä¸šåŠ¡ä¸»é”®ï¼ŒUUIDæ ¼å¼ï¼‰',
  `conversation_id` VARCHAR(100) NOT NULL COMMENT 'å¯¹è¯IDï¼ˆæ ¼å¼ï¼štenantCode::workflowUuid::userIdï¼‰',
  `type` VARCHAR(20) NOT NULL COMMENT 'è®°å½•ç±»å‹ï¼ˆUSER, ASSISTANT, SYSTEM, TOOLï¼‰',
  `content` LONGTEXT NOT NULL COMMENT 'å¯¹è¯å†…å®¹',
  `model_source_id` VARCHAR(50) DEFAULT NULL COMMENT 'AIæ¨¡å‹æºID',
  `c_time` DATETIME DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `u_time` DATETIME DEFAULT NULL COMMENT 'ä¿®æ”¹æ—¶é—´',
  `c_id` BIGINT DEFAULT NULL COMMENT 'åˆ›å»ºäººID',
  `u_id` BIGINT DEFAULT NULL COMMENT 'ä¿®æ”¹äººID',
  `dbversion` INT DEFAULT 1 COMMENT 'æ•°æ®ç‰ˆæœ¬ï¼ˆä¹è§‚é”ï¼‰',
  `provider_name` VARCHAR(255) DEFAULT NULL COMMENT 'AIæä¾›å•†åç§°',
  `base_name` VARCHAR(255) DEFAULT NULL COMMENT 'åŸºç¡€æ¨¡å‹åç§°',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_ai_workflow_conv_content_message` (`message_id`),
  KEY `idx_ai_workflow_conv_content_1` (`conversation_id`),
  KEY `idx_ai_workflow_conv_content_provider` (`provider_name`),
  KEY `idx_ai_workflow_conv_content_model` (`base_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
COMMENT='AIå·¥ä½œæµå¯¹è¯å†…å®¹';
```

**è®¾è®¡è¯´æ˜**ï¼š
- è¡¨ç»“æ„ä¸ `ai_conversation_content` å®Œå…¨ç›¸åŒ
- ä¿ç•™ `conversation_id` å­—æ®µï¼Œæ ¼å¼ä¸ºï¼š"tenantCode::workflowUuid::userId"
- ç´¢å¼•è®¾è®¡ä¸åŸè¡¨ä¸€è‡´ï¼Œç¡®ä¿æŸ¥è¯¢æ€§èƒ½

---

## ğŸ—ï¸ ä»£ç è®¾è®¡

### æ–‡ä»¶ç»“æ„

#### åç«¯

**æ–°å»ºæ–‡ä»¶**ï¼š

1. **å®ä½“ç±»**
   è·¯å¾„ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/bean/entity/workflow/AiWorkflowConversationContentEntity.java`

2. **VOç±»**
   è·¯å¾„ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/workflow/AiWorkflowConversationContentVo.java`

3. **Mapperç±»**
   è·¯å¾„ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/core/mapper/workflow/AiWorkflowConversationContentMapper.java`

4. **Serviceç±»**
   è·¯å¾„ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/workflow/AiWorkflowConversationContentService.java`

**ä¿®æ”¹æ–‡ä»¶**ï¼š

1. **WorkflowUtil.java**
   è·¯å¾„ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WorkflowUtil.java`
   - ä¿®æ”¹ `saveUserMessage()` æ–¹æ³•
   - ä¿®æ”¹ `saveAssistantMessage()` æ–¹æ³•

2. **AiWorkflowRuntimeService.java**
   è·¯å¾„ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/workflow/AiWorkflowRuntimeService.java`
   - ä¿®æ”¹ `delete()` æ–¹æ³•
   - ä¿®æ”¹ `deleteAll()` æ–¹æ³•

---

## ğŸ”„ è°ƒç”¨é“¾è·¯å˜æ›´

### ä¿®æ”¹å‰ï¼ˆä½¿ç”¨Chaté¢†åŸŸï¼‰

```
WorkflowUtil.streamingInvokeLLM()
  â”œâ”€ saveUserMessage(conversationId, content, ...)
  â”‚   â””â”€ AiConversationContentService.saveConversationContent()  âŒ Chaté¢†åŸŸ
  â”‚       â””â”€ INSERT INTO ai_conversation_content
  â”‚
  â””â”€ saveAssistantMessage(conversationId, response, ...)
      â””â”€ AiConversationContentService.saveConversationContent()  âŒ Chaté¢†åŸŸ
          â””â”€ INSERT INTO ai_conversation_content

AiWorkflowRuntimeService.delete()
  â””â”€ AiConversationContentService.deleteByConversationId()  âŒ Chaté¢†åŸŸ
      â””â”€ DELETE FROM ai_conversation_content
```

### ä¿®æ”¹åï¼ˆä½¿ç”¨Workflowé¢†åŸŸï¼‰

```
WorkflowUtil.streamingInvokeLLM()
  â”œâ”€ saveUserMessage(conversationId, content, ...)
  â”‚   â””â”€ AiWorkflowConversationContentService.saveMessage()  âœ… Workflowé¢†åŸŸ
  â”‚       â””â”€ INSERT INTO ai_workflow_conversation_content
  â”‚
  â””â”€ saveAssistantMessage(conversationId, response, ...)
      â””â”€ AiWorkflowConversationContentService.saveMessage()  âœ… Workflowé¢†åŸŸ
          â””â”€ INSERT INTO ai_workflow_conversation_content

AiWorkflowRuntimeService.delete()
  â””â”€ AiWorkflowConversationContentService.deleteByConversationId()  âœ… Workflowé¢†åŸŸ
      â””â”€ DELETE FROM ai_workflow_conversation_content
```

---

## ğŸ“ è¯¦ç»†å®ç°æ–¹æ¡ˆ

### æ­¥éª¤1ï¼šåˆ›å»ºæ•°æ®åº“è¡¨

æ‰§è¡ŒSQLè„šæœ¬åˆ›å»ºæ–°è¡¨ `ai_workflow_conversation_content`ï¼ˆè§ä¸Šæ–‡SQLï¼‰

### æ­¥éª¤2ï¼šåˆ›å»ºå®ä½“ç±» AiWorkflowConversationContentEntity

å‚è€ƒ `AiConversationContentEntity`ï¼Œå­—æ®µå®Œå…¨ç›¸åŒï¼š
- id (ä¸»é”®)
- messageId (ä¸šåŠ¡é”®)
- conversationId (å¯¹è¯ID)
- type (USER/ASSISTANT)
- content (å¯¹è¯å†…å®¹)
- modelSourceId
- providerName
- baseName
- createTime, updateTime, cId, uId, dbversion

### æ­¥éª¤3ï¼šåˆ›å»ºVOç±» AiWorkflowConversationContentVo

**ç®€åŒ–ç‰ˆVO**ï¼ˆWorkflowä¸éœ€è¦Chatçš„å¤æ‚ä¸šåŠ¡å­—æ®µï¼‰ï¼š
- åŸºç¡€å­—æ®µï¼šid, message_id, conversation_id, type, content
- æ¨¡å‹ä¿¡æ¯ï¼šmodel_source_id, provider_name, base_name
- æ—¶é—´å­—æ®µï¼šc_time

**ä¸åŒ…å«**ï¼š
- Chatç‰¹æœ‰çš„å­—æ®µï¼ˆstatus, error_message, tags, attachmentsç­‰ï¼‰
- Chatçš„å†…åµŒç±»ï¼ˆAiModelInfo, PerformanceStats, ContentAnalysisç­‰ï¼‰

### æ­¥éª¤4ï¼šåˆ›å»ºMapperç±» AiWorkflowConversationContentMapper

**æ–¹æ³•**ï¼š
```java
@Delete("DELETE FROM ai_workflow_conversation_content WHERE conversation_id = #{conversationId}")
int deleteByConversationId(@Param("conversationId") String conversationId);

@Select("SELECT * FROM ai_workflow_conversation_content WHERE conversation_id = #{conversationId} ORDER BY c_time DESC LIMIT #{limit}")
List<AiWorkflowConversationContentEntity> selectByConversationId(
    @Param("conversationId") String conversationId,
    @Param("limit") int limit
);
```

### æ­¥éª¤5ï¼šåˆ›å»ºServiceç±» AiWorkflowConversationContentService

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```java
// ä¿å­˜å¯¹è¯æ¶ˆæ¯
public void saveMessage(String conversationId, String type, String content,
                       String modelSourceId, String providerName, String baseName);

// æŸ¥è¯¢å¯¹è¯å†å²
public List<AiWorkflowConversationContentEntity> queryHistory(String conversationId, int limit);

// åˆ é™¤å¯¹è¯è®°å½•
public int deleteByConversationId(String conversationId);
```

### æ­¥éª¤6ï¼šä¿®æ”¹ WorkflowUtil.java

**ä¿®æ”¹å‰**ï¼š
```java
private static void saveUserMessage(String conversationId, String content, ...) {
    AiConversationContentService conversationContentService =
            SpringUtil.getBean(AiConversationContentService.class);  // âŒ
    conversationContentService.saveConversationContent(conversationId, "user", content, ...);
}
```

**ä¿®æ”¹å**ï¼š
```java
private static void saveUserMessage(String conversationId, String content, ...) {
    AiWorkflowConversationContentService workflowConvService =
            SpringUtil.getBean(AiWorkflowConversationContentService.class);  // âœ…
    workflowConvService.saveMessage(conversationId, "USER", content,
                                    modelSourceId, providerName, baseName);
}
```

åŒæ ·ä¿®æ”¹ `saveAssistantMessage()` æ–¹æ³•ã€‚

**åˆ é™¤ä¾èµ–**ï¼š
```java
// åˆ é™¤è¿™ä¸ªimport
// import com.xinyirun.scm.ai.core.service.chat.AiConversationContentService;  âŒ

// æ–°å¢è¿™ä¸ªimport
import com.xinyirun.scm.ai.core.service.workflow.AiWorkflowConversationContentService;  âœ…
```

### æ­¥éª¤7ï¼šä¿®æ”¹ AiWorkflowRuntimeService.java

**ä¿®æ”¹å‰**ï¼š
```java
@Resource
private AiConversationContentService conversationContentService;  // âŒ

public boolean delete(String runtimeUuid) {
    ...
    // åˆ é™¤å¯¹è¯å†å²
    if (StringUtils.isNotBlank(conversationId)) {
        int conversationCount = conversationContentService.deleteByConversationId(conversationId);  // âŒ
    }
    ...
}
```

**ä¿®æ”¹å**ï¼š
```java
@Resource
private AiWorkflowConversationContentService workflowConversationContentService;  // âœ…

public boolean delete(String runtimeUuid) {
    ...
    // åˆ é™¤å·¥ä½œæµå¯¹è¯å†å²
    if (StringUtils.isNotBlank(conversationId)) {
        int conversationCount = workflowConversationContentService.deleteByConversationId(conversationId);  // âœ…
        log.info("åˆ é™¤å·¥ä½œæµå¯¹è¯å†å²: conversation_id={}, count={}", conversationId, conversationCount);
    }
    ...
}
```

---

## ğŸ”§ æ•°æ®è¿ç§»æ–¹æ¡ˆ

### è¿ç§»SQLè„šæœ¬

```sql
-- ========================================
-- Workflowå¯¹è¯è®°å½•æ•°æ®è¿ç§»è„šæœ¬
-- ========================================

-- 1. è¿ç§»å·¥ä½œæµå¯¹è¯æ•°æ®åˆ°æ–°è¡¨
INSERT INTO ai_workflow_conversation_content
(id, message_id, conversation_id, type, content,
 model_source_id, provider_name, base_name,
 c_time, u_time, c_id, u_id, dbversion)
SELECT
    acc.id,
    acc.message_id,
    acc.conversation_id,
    acc.type,
    acc.content,
    acc.model_source_id,
    acc.provider_name,
    acc.base_name,
    acc.c_time,
    acc.u_time,
    acc.c_id,
    acc.u_id,
    acc.dbversion
FROM ai_conversation_content acc
WHERE acc.conversation_id LIKE '%::%::%'  -- å·¥ä½œæµconversationIdæ ¼å¼
ORDER BY acc.c_time;

-- 2. éªŒè¯è¿ç§»æ•°æ®æ•°é‡
SELECT
    'è¿ç§»å‰ï¼ˆai_conversation_contentä¸­çš„workflowæ•°æ®ï¼‰' AS stage,
    COUNT(*) AS count
FROM ai_conversation_content acc
WHERE acc.conversation_id LIKE '%::%::%'

UNION ALL

SELECT
    'è¿ç§»åï¼ˆai_workflow_conversation_contentï¼‰' AS stage,
    COUNT(*) AS count
FROM ai_workflow_conversation_content;

-- 3. ç¡®è®¤æ•°æ®ä¸€è‡´æ€§åï¼Œåˆ é™¤æ—§æ•°æ®
-- âš ï¸ è¯·åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åå†åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œ
DELETE FROM ai_conversation_content
WHERE conversation_id LIKE '%::%::%';

-- 4. éªŒè¯åˆ é™¤ç»“æœ
SELECT
    'åˆ é™¤åai_conversation_contentä¸­çš„workflowæ•°æ®' AS stage,
    COUNT(*) AS count
FROM ai_conversation_content
WHERE conversation_id LIKE '%::%::%';
```

### è¿ç§»æ‰§è¡Œæ­¥éª¤

1. **æµ‹è¯•ç¯å¢ƒéªŒè¯**ï¼š
   - æ‰§è¡Œæ­¥éª¤1ï¼šè¿ç§»æ•°æ®
   - æ‰§è¡Œæ­¥éª¤2ï¼šéªŒè¯æ•°æ®æ•°é‡
   - æ£€æŸ¥æ•°æ®å†…å®¹ä¸€è‡´æ€§
   - æµ‹è¯•WorkflowåŠŸèƒ½

2. **ç”Ÿäº§ç¯å¢ƒè¿ç§»**ï¼š
   - é€‰æ‹©ä¸šåŠ¡ä½å³°æœŸ
   - å…ˆå¤‡ä»½æ•°æ®åº“
   - æ‰§è¡Œæ­¥éª¤1å’Œæ­¥éª¤2
   - éƒ¨ç½²æ–°ä»£ç 
   - æµ‹è¯•WorkflowåŠŸèƒ½
   - ç¡®è®¤æ— è¯¯åæ‰§è¡Œæ­¥éª¤3å’Œæ­¥éª¤4

---

## âš ï¸ é£é™©è¯„ä¼°ä¸ç¼“è§£æªæ–½

### é£é™©1ï¼šæ•°æ®è¿ç§»é—æ¼

**é£é™©æè¿°**ï¼šè¿ç§»è„šæœ¬WHEREæ¡ä»¶é”™è¯¯ï¼Œæ¼æ‰éƒ¨åˆ†æ•°æ®

**å½±å“ç¨‹åº¦**ï¼šğŸ”´ é«˜

**ç¼“è§£æªæ–½**ï¼š
- è¿ç§»å‰åé€šè¿‡COUNTéªŒè¯æ•°æ®æ•°é‡
- æŠ½æ ·æ£€æŸ¥æ•°æ®å†…å®¹ä¸€è‡´æ€§
- æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯

### é£é™©2ï¼šconversationIdæ ¼å¼é”™è¯¯

**é£é™©æè¿°**ï¼šå¦‚æœè¯¯æ”¹conversationIdæ ¼å¼ï¼Œä¼šå¯¼è‡´æŸ¥è¯¢å¤±è´¥

**å½±å“ç¨‹åº¦**ï¼šğŸŸ¡ ä¸­

**ç¼“è§£æªæ–½**ï¼š
- ä¿æŒæ ¼å¼ä¸å˜ï¼š"tenantCode::workflowUuid::userId"
- ä»£ç Reviewä¸¥æ ¼æ£€æŸ¥

### é£é™©3ï¼šå¹¶å‘é—®é¢˜

**é£é™©æè¿°**ï¼šè¿ç§»è¿‡ç¨‹ä¸­æœ‰æ–°çš„workflowæ‰§è¡Œ

**å½±å“ç¨‹åº¦**ï¼šğŸŸ¡ ä¸­

**ç¼“è§£æªæ–½**ï¼š
- é€‰æ‹©ä¸šåŠ¡ä½å³°æœŸè¿ç§»
- æˆ–ä¸´æ—¶åœæ­¢workflowåŠŸèƒ½
- è¿ç§»å®Œæˆåç«‹å³éƒ¨ç½²æ–°ä»£ç 

### é£é™©4ï¼šServiceæ³¨å…¥é”™è¯¯

**é£é™©æè¿°**ï¼šä¿®æ”¹ä»£ç æ—¶æ³¨å…¥é”™è¯¯çš„Service

**å½±å“ç¨‹åº¦**ï¼šğŸŸ¡ ä¸­

**ç¼“è§£æªæ–½**ï¼š
- ä¸¥æ ¼ä»£ç Review
- å•å…ƒæµ‹è¯•è¦†ç›–
- é›†æˆæµ‹è¯•éªŒè¯

---

## âœ… æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

**AiWorkflowConversationContentServiceæµ‹è¯•**ï¼š
- æµ‹è¯•saveMessage()æ–¹æ³•
- æµ‹è¯•queryHistory()æ–¹æ³•
- æµ‹è¯•deleteByConversationId()æ–¹æ³•

### é›†æˆæµ‹è¯•

**Workflowæ‰§è¡Œæµ‹è¯•**ï¼š
1. åˆ›å»ºworkflowè¿è¡Œå®ä¾‹
2. æ‰§è¡Œå¸¦LLMçš„èŠ‚ç‚¹ï¼ˆé—®ç­”èŠ‚ç‚¹ï¼‰
3. éªŒè¯å¯¹è¯è®°å½•ä¿å­˜åˆ° `ai_workflow_conversation_content`
4. éªŒè¯å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½
5. åˆ é™¤runtimeï¼ŒéªŒè¯å¯¹è¯è®°å½•çº§è”åˆ é™¤

**ChatåŠŸèƒ½å›å½’æµ‹è¯•**ï¼š
1. åˆ›å»ºå¯¹è¯
2. å‘é€æ¶ˆæ¯
3. éªŒè¯å¯¹è¯è®°å½•ä¿å­˜åˆ° `ai_conversation_content`
4. ç¡®è®¤ChatåŠŸèƒ½ä¸å—å½±å“

### æ•°æ®éªŒè¯

**è¿ç§»æ•°æ®éªŒè¯**ï¼š
1. æ•°é‡éªŒè¯ï¼šè¿ç§»å‰åCOUNTä¸€è‡´
2. å†…å®¹éªŒè¯ï¼šéšæœºæŠ½æ ·10æ¡è®°å½•å¯¹æ¯”
3. æ ¼å¼éªŒè¯ï¼šconversationIdæ ¼å¼æ­£ç¡®

---

## ğŸ“… å®æ–½è®¡åˆ’

### ç¬¬1å¤©ï¼šå‡†å¤‡é˜¶æ®µ
- âœ… ç¼–å†™æ–¹æ¡ˆæ–‡æ¡£
- â³ æ–¹æ¡ˆå®¡æ‰¹

### ç¬¬2å¤©ï¼šå¼€å‘é˜¶æ®µ
- åˆ›å»ºæ•°æ®åº“è¡¨
- åˆ›å»ºEntity/VO/Mapper/Service
- ä¿®æ”¹WorkflowUtilå’ŒAiWorkflowRuntimeService
- ç¼–å†™å•å…ƒæµ‹è¯•

### ç¬¬3å¤©ï¼šæµ‹è¯•é˜¶æ®µ
- æµ‹è¯•ç¯å¢ƒéƒ¨ç½²
- æ‰§è¡Œæ•°æ®è¿ç§»
- é›†æˆæµ‹è¯•
- å›å½’æµ‹è¯•

### ç¬¬4å¤©ï¼šä¸Šçº¿é˜¶æ®µ
- ç”Ÿäº§ç¯å¢ƒæ•°æ®è¿ç§»
- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- åŠŸèƒ½éªŒè¯
- ç›‘æ§è§‚å¯Ÿ

---

## ğŸ“Š å½±å“èŒƒå›´

### å˜æ›´æ–‡ä»¶

**æ–°å¢æ–‡ä»¶**ï¼ˆ4ä¸ªï¼‰ï¼š
- AiWorkflowConversationContentEntity.java
- AiWorkflowConversationContentVo.java
- AiWorkflowConversationContentMapper.java
- AiWorkflowConversationContentService.java

**ä¿®æ”¹æ–‡ä»¶**ï¼ˆ2ä¸ªï¼‰ï¼š
- WorkflowUtil.java
- AiWorkflowRuntimeService.java

**æ–°å¢è¡¨**ï¼ˆ1ä¸ªï¼‰ï¼š
- ai_workflow_conversation_content

**æ•°æ®è¿ç§»**ï¼š
- ä» ai_conversation_content è¿ç§»workflowæ•°æ®åˆ°æ–°è¡¨

### åŠŸèƒ½å½±å“

**ä¸å—å½±å“**ï¼š
- ChatåŠŸèƒ½å®Œå…¨ä¸å—å½±å“
- Workflowçš„å…¶ä»–åŠŸèƒ½ï¼ˆé™¤å¯¹è¯è®°å½•å¤–ï¼‰

**éœ€è¦éªŒè¯**ï¼š
- Workflowé—®ç­”èŠ‚ç‚¹çš„å¤šè½®å¯¹è¯åŠŸèƒ½
- å­å·¥ä½œæµçš„ä¸Šä¸‹æ–‡ç»§æ‰¿åŠŸèƒ½
- Workflowè¿è¡Œè®°å½•çš„åˆ é™¤åŠŸèƒ½

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

1. âœ… æ–°è¡¨ `ai_workflow_conversation_content` åˆ›å»ºæˆåŠŸ
2. âœ… æ–°ä»£ç ï¼ˆEntity/VO/Mapper/Serviceï¼‰ç¼–è¯‘é€šè¿‡
3. âœ… å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
4. âœ… Workflowå¯¹è¯è®°å½•ä¿å­˜åˆ°æ–°è¡¨
5. âœ… å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½æ­£å¸¸
6. âœ… åˆ é™¤runtimeèƒ½çº§è”åˆ é™¤å¯¹è¯è®°å½•
7. âœ… ChatåŠŸèƒ½ä¸å—å½±å“
8. âœ… æ•°æ®è¿ç§»å®Œæˆï¼Œæ•°æ®æ— ä¸¢å¤±

---

## ğŸ“š é™„å½•

### conversationIdæ ¼å¼è¯´æ˜

**æ ¼å¼**ï¼š`"tenantCode::workflowUuid::userId"`

**ç¤ºä¾‹**ï¼š`"scm_tenant_001::wf-uuid-123::user-456"`

**å­—æ®µè¯´æ˜**ï¼š
- tenantCode: ç§Ÿæˆ·ç¼–ç ï¼ˆæ•°æ®æºåç§°ï¼‰
- workflowUuid: å·¥ä½œæµUUID
- userId: ç”¨æˆ·ID

**ä½œç”¨**ï¼š
- å¤šç§Ÿæˆ·éš”ç¦»
- ç”¨æˆ·çº§åˆ«çš„å¯¹è¯è®°å¿†
- æ”¯æŒå­å·¥ä½œæµç»§æ‰¿çˆ¶å·¥ä½œæµä¸Šä¸‹æ–‡

### å‚è€ƒä»£ç ä½ç½®

**ç°æœ‰ä»£ç **ï¼š
- `ai_conversation_content` è¡¨
- `AiConversationContentEntity.java`
- `AiConversationContentVo.java`
- `AiConversationContentMapper.java`
- `AiConversationContentService.java`

**ä¿®æ”¹ä½ç½®**ï¼š
- `WorkflowUtil.java:232-256` (saveUserMessage)
- `WorkflowUtil.java:267-291` (saveAssistantMessage)
- `AiWorkflowRuntimeService.java:48` (æ³¨å…¥Service)
- `AiWorkflowRuntimeService.java:369-373` (åˆ é™¤å¯¹è¯å†å²)

---

**æ–¹æ¡ˆç¼–å†™å®Œæˆï¼Œç­‰å¾…å®¡æ‰¹ã€‚**
