# å­å·¥ä½œæµèŠ‚ç‚¹å®ç°æ–¹æ¡ˆ

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 åŠŸèƒ½æè¿°
åœ¨å·¥ä½œæµç³»ç»Ÿä¸­æ–°å¢"å­å·¥ä½œæµ"èŠ‚ç‚¹ï¼Œç”¨äºåœ¨å½“å‰å·¥ä½œæµä¸­å¤ç”¨å…¶ä»–å·²å®šä¹‰çš„å·¥ä½œæµï¼Œå®ç°å·¥ä½œæµçš„æ¨¡å—åŒ–å’Œå¯é‡ç”¨æ€§ã€‚

### 1.2 æ ¸å¿ƒéœ€æ±‚
- **èŠ‚ç‚¹åç§°**ï¼šå­å·¥ä½œæµ (SubWorkflow)
- **èŠ‚ç‚¹å›¾æ ‡**ï¼šğŸ”—ï¼ˆé“¾æ¥ç¬¦å·ï¼Œè¡¨ç¤ºè¿æ¥åˆ°å…¶ä»–å·¥ä½œæµï¼‰
- **èŠ‚ç‚¹ç”»å¸ƒæ˜¾ç¤º**ï¼š
  - å¤´éƒ¨ï¼šä½¿ç”¨é€šç”¨èŠ‚ç‚¹å¤´éƒ¨æ ·å¼ï¼ˆä¸å…¶ä»–èŠ‚ç‚¹ä¿æŒä¸€è‡´ï¼‰
  - Bodyï¼šæ˜¾ç¤ºå·²é€‰æ‹©çš„å·¥ä½œæµåç§°ï¼Œæœªé€‰æ‹©æ—¶æ˜¾ç¤º"è¯·é€‰æ‹©å·¥ä½œæµ"
- **èŠ‚ç‚¹å±æ€§é¢æ¿**ï¼š
  1. è¯´æ˜æ–‡å­—ï¼šæè¿°å­å·¥ä½œæµç”¨äºå¿«é€Ÿå¤ç”¨å…¶ä»–å·¥ä½œæµ
  2. è¾“å…¥å‚æ•°ï¼šä¸å¸¸è§„èŠ‚ç‚¹ç›¸åŒçš„å‚æ•°å®šä¹‰æœºåˆ¶
  3. å·¥ä½œæµé€‰æ‹©å™¨ï¼šä¸‹æ‹‰é€‰æ‹©"å¯ä½¿ç”¨çš„å·¥ä½œæµ"
     - æ•°æ®æºï¼šæ‰€æœ‰å…¬å¼€çš„å·¥ä½œæµ + å½“å‰ç”¨æˆ·è‡ªå·±çš„å·¥ä½œæµ
     - åˆ†ç»„æ˜¾ç¤ºï¼šå…¬å¼€å·¥ä½œæµä¸€ç»„ï¼Œæˆ‘çš„å·¥ä½œæµä¸€ç»„ï¼ˆå‚è€ƒè¾“å…¥å‚æ•°çš„åˆ†ç»„æ–¹å¼ï¼‰
     - é€‰æ‹©è”åŠ¨ï¼šé€‰æ‹©åè‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹bodyæ˜¾ç¤º

### 1.3 KISSåŸåˆ™è¯„ä¼°

#### é—®é¢˜1ï¼šè¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ
âœ… **çœŸé—®é¢˜**
- å½“å‰å·¥ä½œæµç³»ç»Ÿä¸­ï¼Œå¤æ‚æµç¨‹éœ€è¦é‡å¤å®šä¹‰ç›¸åŒçš„èŠ‚ç‚¹åºåˆ—
- ç”¨æˆ·åé¦ˆéœ€è¦æ¨¡å—åŒ–èƒ½åŠ›æ¥å¤ç”¨å¸¸è§çš„å·¥ä½œæµç‰‡æ®µï¼ˆå¦‚ï¼šæ ‡å‡†çš„FAQæå–æµç¨‹ã€å…³é”®è¯æå–æµç¨‹ï¼‰
- å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå­å·¥ä½œæµæ˜¯å·¥ä½œæµå¼•æ“çš„æ ‡å‡†èƒ½åŠ›ï¼ˆLangGraphæ”¯æŒå­å›¾SubGraphï¼‰

#### é—®é¢˜2ï¼šæœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ
âœ… **å½“å‰æ–¹æ¡ˆå·²æ˜¯æœ€ç®€**
- æ›¿ä»£æ–¹æ¡ˆ1ï¼šèŠ‚ç‚¹æ¨¡æ¿å¤åˆ¶ â†’ ä¼šå¯¼è‡´ç»´æŠ¤å›°éš¾ï¼Œä¿®æ”¹ä¸€å¤„éœ€è¦æ”¹å¤šä¸ªåœ°æ–¹
- æ›¿ä»£æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨é‡å»ºèŠ‚ç‚¹åºåˆ— â†’ æ“ä½œç¹çï¼Œå®¹æ˜“å‡ºé”™
- å½“å‰æ–¹æ¡ˆï¼šå¤ç”¨æ•´ä¸ªå·¥ä½œæµå®šä¹‰ â†’ ä¸€å¤„å®šä¹‰ï¼Œå¤šå¤„ä½¿ç”¨ï¼Œç¬¦åˆDRYåŸåˆ™

#### é—®é¢˜3ï¼šä¼šç ´åä»€ä¹ˆå—ï¼Ÿ
âœ… **é›¶ç ´åæ€§**
- æ–°å¢èŠ‚ç‚¹ç±»å‹ï¼Œä¸ä¿®æ”¹ç°æœ‰èŠ‚ç‚¹
- æ•°æ®åº“åªæ–°å¢ä¸€æ¡componentè®°å½•ï¼Œä¸æ”¹è¡¨ç»“æ„
- å‰ç«¯åªå¢åŠ ç»„ä»¶ï¼Œä¸ä¿®æ”¹ç°æœ‰ç»„ä»¶
- åç«¯åªå¢åŠ SubWorkflowNodeç±»ï¼Œä¸ä¿®æ”¹AbstractWfNodeåŸºç±»
- å®Œå…¨å‘åå…¼å®¹ï¼Œç°æœ‰å·¥ä½œæµä¸å—å½±å“

#### é—®é¢˜4ï¼šå½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—ï¼Ÿ
âœ… **å¿…è¦åŠŸèƒ½**
- å½“å‰å·¥ä½œæµç³»ç»Ÿå·²æœ‰8ç§èŠ‚ç‚¹ç±»å‹ï¼Œå¤æ‚æµç¨‹å·²ç»å‡ºç°èŠ‚ç‚¹é‡å¤å®šä¹‰
- FAQæå–å™¨ã€å…³é”®è¯æå–å™¨ç­‰é€šç”¨æµç¨‹é€‚åˆæŠ½å–ä¸ºå­å·¥ä½œæµ
- ç³»ç»Ÿæ¶æ„å·²æ”¯æŒï¼ˆLangGraph4jçš„StateGraphæ”¯æŒåµŒå¥—ï¼‰
- å±äºå·¥ä½œæµå¼•æ“çš„æ ‡å‡†èƒ½åŠ›ï¼Œä¸æ˜¯è¿‡åº¦è®¾è®¡

---

## 2. æ¶æ„è®¾è®¡

### 2.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å·¥ä½œæµè®¾è®¡å™¨ (Frontend)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WorkflowDesigner.vue                                        â”‚
â”‚  â”œâ”€ WorkflowNodePalette.vue (èŠ‚ç‚¹é¢æ¿)                        â”‚
â”‚  â”‚  â””â”€ [æ–°å¢] SubWorkflow èŠ‚ç‚¹                               â”‚
â”‚  â”œâ”€ X6 Canvas (ç”»å¸ƒ)                                         â”‚
â”‚  â”‚  â””â”€ [æ–°å¢] SubWorkflowNode.vue (èŠ‚ç‚¹æ ·å¼)                  â”‚
â”‚  â””â”€ WorkflowPropertyPanel.vue (å±æ€§é¢æ¿)                      â”‚
â”‚     â””â”€ [æ–°å¢] SubWorkflowNodeProperty.vue (å­å·¥ä½œæµå±æ€§)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ API Call
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å·¥ä½œæµæ‰§è¡Œå¼•æ“ (Backend)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WorkflowController.java                                     â”‚
â”‚  â””â”€ WorkflowStarter.java                                     â”‚
â”‚     â””â”€ WorkflowEngine.java                                   â”‚
â”‚        â””â”€ WfNodeFactory.create()                             â”‚
â”‚           â””â”€ [æ–°å¢] SubWorkflowNode.java                      â”‚
â”‚              â”œâ”€ åŠ è½½å­å·¥ä½œæµå®šä¹‰                               â”‚
â”‚              â”œâ”€ æ˜ å°„è¾“å…¥å‚æ•°                                   â”‚
â”‚              â”œâ”€ æ‰§è¡Œå­å·¥ä½œæµ (é€’å½’WorkflowEngine)              â”‚
â”‚              â””â”€ è¿”å›å­å·¥ä½œæµè¾“å‡º                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ Query
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®åº“å±‚ (MySQL)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ai_workflow_component (æ–°å¢SubWorkflowç»„ä»¶)                  â”‚
â”‚  ai_workflow (å·¥ä½œæµå®šä¹‰)                                      â”‚
â”‚  ai_workflow_node (èŠ‚ç‚¹å®šä¹‰ï¼ŒåŒ…å«nodeConfig)                   â”‚
â”‚  ai_workflow_runtime (è¿è¡Œæ—¶å®ä¾‹)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®ç»“æ„è®¾è®¡

#### 2.2.1 æ•°æ®åº“è®¾è®¡

**ai_workflow_component æ–°å¢è®°å½•**ï¼š
```sql
INSERT INTO ai_workflow_component (
    uuid, name, category, description, icon, input_definition, output_definition
) VALUES (
    'subworkflow_component_uuid',
    'SubWorkflow',
    'logic',
    'å­å·¥ä½œæµèŠ‚ç‚¹ï¼Œç”¨äºå¤ç”¨å…¶ä»–å·¥ä½œæµ',
    'ğŸ”—',
    '[]',  -- è¾“å…¥ç”±ç”¨æˆ·åœ¨nodeConfigä¸­å®šä¹‰
    '[{"name":"result","type":"any","description":"å­å·¥ä½œæµæ‰§è¡Œç»“æœ"}]'
);
```

**ai_workflow_node.node_config ç»“æ„**ï¼š
```json
{
  "workflow_uuid": "è¢«å¼•ç”¨çš„å·¥ä½œæµUUID",
  "workflow_name": "è¢«å¼•ç”¨çš„å·¥ä½œæµåç§°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰",
  "input_mapping": [
    {
      "source_key": "parent_input_1",
      "target_key": "sub_workflow_input_1"
    }
  ]
}
```

#### 2.2.2 å‰ç«¯æ•°æ®ç»“æ„

**èŠ‚ç‚¹å®šä¹‰ (AiWorkflowNodeVo)**ï¼š
```javascript
{
  uuid: "node_uuid",
  wfComponent: {
    name: "SubWorkflow",
    icon: "ğŸ”—"
  },
  nodeConfig: {
    workflow_uuid: "sub_wf_uuid",
    workflow_name: "FAQæå–å·¥ä½œæµ",
    input_mapping: [...]
  },
  inputs: [
    { name: "text", type: "string", description: "è¾“å…¥æ–‡æœ¬" }
  ],
  position: { x: 100, y: 100 }
}
```

**å·¥ä½œæµé€‰æ‹©å™¨æ•°æ®ç»“æ„**ï¼š
```javascript
[
  {
    label: "å…¬å¼€å·¥ä½œæµ",
    options: [
      { value: "wf_uuid_1", label: "FAQæå–æ ‡å‡†æµç¨‹" },
      { value: "wf_uuid_2", label: "å…³é”®è¯æå–æ ‡å‡†æµç¨‹" }
    ]
  },
  {
    label: "æˆ‘çš„å·¥ä½œæµ",
    options: [
      { value: "wf_uuid_3", label: "è‡ªå®šä¹‰ä¸šåŠ¡æµç¨‹A" },
      { value: "wf_uuid_4", label: "è‡ªå®šä¹‰ä¸šåŠ¡æµç¨‹B" }
    ]
  }
]
```

### 2.3 æ‰§è¡Œæµç¨‹è®¾è®¡

#### 2.3.1 æ‰§è¡Œæ—¶åºå›¾

```
çˆ¶å·¥ä½œæµæ‰§è¡Œ                 å­å·¥ä½œæµèŠ‚ç‚¹                  å­å·¥ä½œæµå¼•æ“
    â”‚                            â”‚                            â”‚
    â”œâ”€ æ‰§è¡Œåˆ°SubWorkflowèŠ‚ç‚¹ â”€â”€â†’â”‚                            â”‚
    â”‚                            â”œâ”€ 1. åŠ è½½å­å·¥ä½œæµå®šä¹‰        â”‚
    â”‚                            â”œâ”€ 2. æ˜ å°„è¾“å…¥å‚æ•°           â”‚
    â”‚                            â”œâ”€ 3. åˆ›å»ºå­å·¥ä½œæµå¼•æ“ â”€â”€â”€â”€â†’â”‚
    â”‚                            â”‚                            â”œâ”€ 4. åˆå§‹åŒ–å­WfState
    â”‚                            â”‚                            â”œâ”€ 5. æ„å»ºå­StateGraph
    â”‚                            â”‚                            â”œâ”€ 6. æ‰§è¡Œå­å·¥ä½œæµ
    â”‚                            â”‚                            â”œâ”€ 7. è¿”å›æ‰§è¡Œç»“æœ
    â”‚                            â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                            â”œâ”€ 8. æå–è¾“å‡ºç»“æœ           â”‚
    â”‚â†â”€ è¿”å›ç»“æœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
    â”œâ”€ ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹        â”‚                            â”‚
```

#### 2.3.2 è¾“å…¥å‚æ•°æ˜ å°„æœºåˆ¶

**åœºæ™¯**ï¼šçˆ¶å·¥ä½œæµæœ‰è¾“å…¥`{text: "ç”¨æˆ·é—®é¢˜", context: "ä¸Šä¸‹æ–‡"}`ï¼Œå­å·¥ä½œæµéœ€è¦è¾“å…¥`{question: "é—®é¢˜"}`

**æ˜ å°„é…ç½®**ï¼š
```json
{
  "input_mapping": [
    {
      "source_key": "text",
      "target_key": "question"
    }
  ]
}
```

**æ‰§è¡Œé€»è¾‘**ï¼š
```java
// SubWorkflowNode.java
public NodeProcessResult process(...) {
    // 1. è·å–çˆ¶å·¥ä½œæµå½“å‰èŠ‚ç‚¹çš„è¾“å…¥
    Map<String, Object> parentInputs = state.getInputs();

    // 2. æ ¹æ®input_mappingæ˜ å°„åˆ°å­å·¥ä½œæµè¾“å…¥
    Map<String, Object> subInputs = new HashMap<>();
    for (InputMapping mapping : nodeConfig.getInputMapping()) {
        Object value = parentInputs.get(mapping.getSourceKey());
        subInputs.put(mapping.getTargetKey(), value);
    }

    // 3. æ‰§è¡Œå­å·¥ä½œæµ
    WorkflowEngine subEngine = new WorkflowEngine(subWorkflowId);
    Map<String, Object> subOutputs = subEngine.runSync(subInputs);

    // 4. å°†å­å·¥ä½œæµè¾“å‡ºä½œä¸ºå½“å‰èŠ‚ç‚¹è¾“å‡º
    state.setOutputs(subOutputs);

    return new NodeProcessResult(getNextNodeUuid());
}
```

### 2.4 å…³é”®æŠ€æœ¯å†³ç­–

#### 2.4.1 å­å·¥ä½œæµæ‰§è¡Œç­–ç•¥

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š
| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | å†³ç­– |
|------|------|------|------|
| **é€’å½’æ‰§è¡Œ**ï¼šåˆ›å»ºæ–°çš„WorkflowEngineå®ä¾‹ | 1. å­å·¥ä½œæµå®Œå…¨ç‹¬ç«‹<br>2. çŠ¶æ€éš”ç¦»æ¸…æ™°<br>3. æ”¯æŒæ— é™åµŒå¥— | 1. èµ„æºæ¶ˆè€—è¾ƒé«˜<br>2. è°ƒè¯•é“¾è·¯è¾ƒé•¿ | âœ… **é‡‡ç”¨** |
| **æ‰å¹³åŒ–å±•å¼€**ï¼šå°†å­å·¥ä½œæµèŠ‚ç‚¹å±•å¼€åˆ°çˆ¶å›¾ä¸­ | 1. æ‰§è¡Œæ•ˆç‡é«˜<br>2. è°ƒè¯•ç›´è§‚ | 1. çŠ¶æ€æ±¡æŸ“é£é™©<br>2. åµŒå¥—æ·±åº¦å—é™<br>3. è¿åå°è£…åŸåˆ™ | âŒ **ä¸é‡‡ç”¨** |

**é‡‡ç”¨é€’å½’æ‰§è¡Œçš„ç†ç”±**ï¼š
1. **å°è£…æ€§**ï¼šå­å·¥ä½œæµæ˜¯ç‹¬ç«‹çš„æ‰§è¡Œå•å…ƒï¼Œæœ‰è‡ªå·±çš„WfStateå’ŒWfNodeState
2. **å¯ç»´æŠ¤æ€§**ï¼šå­å·¥ä½œæµä¿®æ”¹ä¸å½±å“çˆ¶å·¥ä½œæµ
3. **ç³»ç»Ÿæ¶æ„ä¸€è‡´æ€§**ï¼šæ‰€æœ‰å·¥ä½œæµéƒ½é€šè¿‡WorkflowEngineæ‰§è¡Œï¼Œä»£ç å¤ç”¨åº¦é«˜
4. **LangGraphæ”¯æŒ**ï¼šLangGraph4jåŸç”Ÿæ”¯æŒå­å›¾ï¼ˆSubGraphï¼‰ï¼Œé€’å½’è°ƒç”¨æ˜¯æ ‡å‡†æ¨¡å¼

#### 2.4.2 å¾ªç¯ä¾èµ–æ£€æµ‹

**é—®é¢˜**ï¼šå·¥ä½œæµAè°ƒç”¨å·¥ä½œæµBï¼Œå·¥ä½œæµBåˆè°ƒç”¨å·¥ä½œæµAï¼Œå½¢æˆå¾ªç¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// WorkflowEngine.java
private Set<String> executionStack = new HashSet<>();

public void run(...) {
    if (executionStack.contains(workflowId)) {
        throw new WorkflowException("æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–ï¼š" + executionStack + " â†’ " + workflowId);
    }
    executionStack.add(workflowId);

    try {
        // æ‰§è¡Œå·¥ä½œæµ
    } finally {
        executionStack.remove(workflowId);
    }
}
```

#### 2.4.3 å­å·¥ä½œæµå¯è§æ€§æ§åˆ¶

**è§„åˆ™**ï¼š
1. **å…¬å¼€å·¥ä½œæµ**ï¼š`ai_workflow.is_public = 1`ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è§
2. **ç§æœ‰å·¥ä½œæµ**ï¼š`ai_workflow.is_public = 0 AND user_id = å½“å‰ç”¨æˆ·`ï¼Œä»…åˆ›å»ºè€…å¯è§

**SQLæŸ¥è¯¢**ï¼š
```sql
SELECT uuid, name, is_public
FROM ai_workflow
WHERE (is_public = 1 OR user_id = #{userId})
  AND status = 'active'
ORDER BY is_public DESC, name ASC
```

---

## 3. è¯¦ç»†è®¾è®¡

### 3.1 å‰ç«¯ç»„ä»¶è®¾è®¡

#### 3.1.1 SubWorkflowNode.vue (èŠ‚ç‚¹æ ·å¼ç»„ä»¶)

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/70_ai/components/workflow/components/nodes/SubWorkflowNode.vue`

**ç»„ä»¶ç»“æ„**ï¼š
```vue
<template>
  <div class="subworkflow-node">
    <!-- å¤´éƒ¨ï¼šä½¿ç”¨é€šç”¨å¤´éƒ¨ç»„ä»¶ -->
    <common-node-header :wf-node="node" />

    <!-- Bodyï¼šæ˜¾ç¤ºå·¥ä½œæµåç§° -->
    <div class="node-content">
      <div class="workflow-line">
        <i class="workflow-icon">ğŸ”—</i>
        <span class="workflow-name">{{ localWorkflowName || 'è¯·é€‰æ‹©å·¥ä½œæµ' }}</span>
      </div>
    </div>
  </div>
</template>

<script>
import CommonNodeHeader from './CommonNodeHeader.vue'

export default {
  name: 'SubWorkflowNode',
  components: { CommonNodeHeader },
  inject: ['getNode'],
  data() {
    return {
      localWorkflowName: ''
    }
  },
  computed: {
    node() {
      return this.getNode().data
    }
  },
  mounted() {
    const node = this.getNode()
    this.localWorkflowName = node.data.nodeConfig?.workflow_name || ''

    // ç›‘å¬X6èŠ‚ç‚¹æ•°æ®å˜åŒ–
    node.on('change:data', ({ current }) => {
      this.localWorkflowName = current.nodeConfig?.workflow_name || ''
    })
  }
}
</script>

<style scoped>
.subworkflow-node {
  width: 100%;
  height: 100%;
  background: #ffffff;
  border: 2px solid #409eff;
  border-radius: 8px;
  overflow: hidden;
}

.node-content {
  padding: 8px 12px;
  font-size: 13px;
}

.workflow-line {
  display: flex;
  align-items: center;
  gap: 6px;
}

.workflow-icon {
  font-size: 16px;
  flex-shrink: 0;
}

.workflow-name {
  color: #303133;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
</style>
```

#### 3.1.2 SubWorkflowNodeProperty.vue (å±æ€§é¢æ¿ç»„ä»¶)

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/70_ai/components/workflow/components/properties/SubWorkflowNodeProperty.vue`

**ç»„ä»¶ç»“æ„**ï¼š
```vue
<template>
  <div class="subworkflow-node-property">
    <!-- è¯´æ˜æ–‡å­— -->
    <div class="property-description">
      <i class="el-icon-info"></i>
      <span>å­å·¥ä½œæµèŠ‚ç‚¹ç”¨äºå¿«é€Ÿå¤ç”¨å…¶ä»–å·²å®šä¹‰çš„å·¥ä½œæµï¼Œå®ç°æµç¨‹æ¨¡å—åŒ–ã€‚</span>
    </div>

    <!-- è¾“å…¥å‚æ•°é…ç½® -->
    <node-property-input
      :workflow="workflow"
      :wf-node="wfNode"
    />

    <!-- å·¥ä½œæµé€‰æ‹©å™¨ -->
    <div class="property-section">
      <div class="section-title">
        <span>å¯ä½¿ç”¨çš„å·¥ä½œæµ</span>
        <el-tooltip content="é€‰æ‹©è¦è°ƒç”¨çš„å­å·¥ä½œæµ" placement="top">
          <i class="el-icon-question"></i>
        </el-tooltip>
      </div>

      <el-select
        v-model="nodeConfig.workflow_uuid"
        placeholder="è¯·é€‰æ‹©å·¥ä½œæµ"
        filterable
        @change="handleWorkflowChange"
      >
        <el-option-group
          v-for="group in workflowOptions"
          :key="group.label"
          :label="group.label"
        >
          <el-option
            v-for="item in group.options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          />
        </el-option-group>
      </el-select>
    </div>

    <!-- è¾“å…¥å‚æ•°æ˜ å°„ (å¦‚æœå­å·¥ä½œæµæœ‰è¾“å…¥å®šä¹‰) -->
    <div v-if="subWorkflowInputs.length > 0" class="property-section">
      <div class="section-title">è¾“å…¥å‚æ•°æ˜ å°„</div>
      <div
        v-for="subInput in subWorkflowInputs"
        :key="subInput.name"
        class="mapping-item"
      >
        <span class="mapping-label">{{ subInput.name }}:</span>
        <el-select
          v-model="inputMappingMap[subInput.name]"
          placeholder="é€‰æ‹©çˆ¶å·¥ä½œæµå‚æ•°"
          size="small"
          @change="updateInputMapping"
        >
          <el-option
            v-for="parentInput in wfNode.inputs"
            :key="parentInput.name"
            :label="parentInput.name"
            :value="parentInput.name"
          />
        </el-select>
      </div>
    </div>
  </div>
</template>

<script>
import NodePropertyInput from './NodePropertyInput.vue'
import { getAvailableWorkflows } from '@/components/70_ai/api/workflow'

export default {
  name: 'SubWorkflowNodeProperty',
  components: { NodePropertyInput },
  props: {
    workflow: { type: Object, required: true },
    wfNode: { type: Object, required: true }
  },
  data() {
    return {
      workflowOptions: [],
      subWorkflowInputs: [],
      inputMappingMap: {}
    }
  },
  computed: {
    nodeConfig() {
      return this.wfNode.nodeConfig || {}
    }
  },
  mounted() {
    this.loadWorkflowOptions()
    if (this.nodeConfig.workflow_uuid) {
      this.loadSubWorkflowInputs(this.nodeConfig.workflow_uuid)
    }
    this.initInputMapping()
  },
  methods: {
    async loadWorkflowOptions() {
      try {
        const response = await getAvailableWorkflows()
        const publicWorkflows = response.data.filter(wf => wf.is_public === 1)
        const myWorkflows = response.data.filter(wf => wf.is_public === 0)

        this.workflowOptions = [
          {
            label: 'å…¬å¼€å·¥ä½œæµ',
            options: publicWorkflows.map(wf => ({
              value: wf.uuid,
              label: wf.name
            }))
          },
          {
            label: 'æˆ‘çš„å·¥ä½œæµ',
            options: myWorkflows.map(wf => ({
              value: wf.uuid,
              label: wf.name
            }))
          }
        ]
      } catch (error) {
        this.$message.error('åŠ è½½å·¥ä½œæµåˆ—è¡¨å¤±è´¥')
      }
    },

    async handleWorkflowChange(workflowUuid) {
      // æŸ¥æ‰¾é€‰ä¸­çš„å·¥ä½œæµåç§°
      let workflowName = ''
      for (const group of this.workflowOptions) {
        const found = group.options.find(opt => opt.value === workflowUuid)
        if (found) {
          workflowName = found.label
          break
        }
      }

      // æ›´æ–°nodeConfig
      this.nodeConfig.workflow_name = workflowName

      // åŠ è½½å­å·¥ä½œæµè¾“å…¥å®šä¹‰
      await this.loadSubWorkflowInputs(workflowUuid)

      // è§¦å‘X6æ›´æ–°ï¼ˆè”åŠ¨åˆ°èŠ‚ç‚¹bodyæ˜¾ç¤ºï¼‰
      this.$root.$emit('workflow:update-node', {
        nodeUuid: this.wfNode.uuid,
        nodeData: this.wfNode
      })
    },

    async loadSubWorkflowInputs(workflowUuid) {
      // TODO: è°ƒç”¨APIè·å–å­å·¥ä½œæµçš„StartèŠ‚ç‚¹è¾“å…¥å®šä¹‰
      // ä¸´æ—¶mockæ•°æ®
      this.subWorkflowInputs = []
    },

    initInputMapping() {
      const mapping = this.nodeConfig.input_mapping || []
      this.inputMappingMap = {}
      mapping.forEach(m => {
        this.inputMappingMap[m.target_key] = m.source_key
      })
    },

    updateInputMapping() {
      const mapping = []
      Object.keys(this.inputMappingMap).forEach(targetKey => {
        const sourceKey = this.inputMappingMap[targetKey]
        if (sourceKey) {
          mapping.push({ source_key: sourceKey, target_key: targetKey })
        }
      })
      this.nodeConfig.input_mapping = mapping

      // è§¦å‘æ›´æ–°
      this.$root.$emit('workflow:update-node', {
        nodeUuid: this.wfNode.uuid,
        nodeData: this.wfNode
      })
    }
  }
}
</script>

<style scoped>
.subworkflow-node-property {
  padding: 16px;
}

.property-description {
  display: flex;
  gap: 8px;
  padding: 12px;
  background: #ecf5ff;
  border-radius: 4px;
  margin-bottom: 16px;
  font-size: 13px;
  color: #409eff;
}

.property-section {
  margin-bottom: 16px;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #303133;
}

.mapping-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.mapping-label {
  width: 120px;
  font-size: 13px;
  color: #606266;
}
</style>
```

#### 3.1.3 èŠ‚ç‚¹æ³¨å†Œ (registerX6Nodes.js)

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/70_ai/components/workflow/utils/registerX6Nodes.js`

**æ–°å¢æ³¨å†Œä»£ç **ï¼š
```javascript
import { register } from '@antv/x6-vue-shape'
import SubWorkflowNode from '../components/nodes/SubWorkflowNode.vue'

// æ³¨å†Œå­å·¥ä½œæµèŠ‚ç‚¹
register({
  shape: 'subworkflow',
  width: 220,
  height: 80,
  component: SubWorkflowNode,
  ports: {
    groups: {
      target: {
        position: 'left',
        attrs: {
          circle: {
            r: 4,
            magnet: true,
            stroke: '#409eff',
            strokeWidth: 2,
            fill: '#fff'
          }
        }
      },
      source: {
        position: 'right',
        attrs: {
          circle: {
            r: 4,
            magnet: true,
            stroke: '#409eff',
            strokeWidth: 2,
            fill: '#fff'
          }
        }
      }
    },
    items: [
      { group: 'target', id: 'left' },
      { group: 'source', id: 'right' }
    ]
  }
})
```

#### 3.1.4 èŠ‚ç‚¹é¢æ¿æ·»åŠ  (WorkflowNodePalette.vue)

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/70_ai/components/workflow/components/WorkflowNodePalette.vue`

**æ–°å¢èŠ‚ç‚¹é¡¹**ï¼š
```vue
<template>
  <div class="workflow-node-palette">
    <!-- ... å…¶ä»–èŠ‚ç‚¹ ... -->

    <!-- å­å·¥ä½œæµèŠ‚ç‚¹ -->
    <div
      class="palette-node"
      draggable="true"
      @dragstart="handleDragStart($event, 'subworkflow')"
    >
      <i class="node-icon">ğŸ”—</i>
      <span class="node-label">å­å·¥ä½œæµ</span>
    </div>
  </div>
</template>

<script>
export default {
  methods: {
    handleDragStart(event, nodeType) {
      event.dataTransfer.effectAllowed = 'move'
      event.dataTransfer.setData('application/reactflow', nodeType)
      event.dataTransfer.setData('application/node-type', JSON.stringify({
        shape: nodeType,
        wfComponent: { name: 'SubWorkflow', icon: 'ğŸ”—' }
      }))
    }
  }
}
</script>
```

#### 3.1.5 å±æ€§é¢æ¿è·¯ç”± (WorkflowPropertyPanel.vue)

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/70_ai/components/workflow/components/WorkflowPropertyPanel.vue`

**æ–°å¢æ¡ä»¶æ¸²æŸ“**ï¼š
```vue
<template>
  <div class="workflow-property-panel">
    <!-- ... å…¶ä»–èŠ‚ç‚¹å±æ€§ ... -->

    <!-- SubWorkflow èŠ‚ç‚¹ -->
    <subworkflow-node-property
      v-else-if="selectedNode.wfComponent.name === 'SubWorkflow'"
      :workflow="workflow"
      :wf-node="selectedNode"
    />
  </div>
</template>

<script>
import SubWorkflowNodeProperty from './properties/SubWorkflowNodeProperty.vue'

export default {
  components: {
    SubWorkflowNodeProperty
    // ... å…¶ä»–ç»„ä»¶
  }
}
</script>
```

### 3.2 åç«¯è®¾è®¡

#### 3.2.1 SubWorkflowNode.java (èŠ‚ç‚¹æ‰§è¡Œç±»)

**æ–‡ä»¶ä½ç½®**ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/node/subworkflow/SubWorkflowNode.java`

**ä»£ç å®ç°**ï¼š
```java
package com.xinyirun.scm.ai.workflow.node.subworkflow;

import com.alibaba.fastjson2.JSON;
import com.xinyirun.scm.ai.bean.entity.workflow.AiWorkflowComponentEntity;
import com.xinyirun.scm.ai.bean.vo.workflow.AiWorkflowNodeVo;
import com.xinyirun.scm.ai.workflow.WorkflowEngine;
import com.xinyirun.scm.ai.workflow.node.AbstractWfNode;
import com.xinyirun.scm.ai.workflow.node.NodeProcessResult;
import com.xinyirun.scm.ai.workflow.state.WfNodeState;
import com.xinyirun.scm.ai.workflow.state.WfState;
import lombok.extern.slf4j.Slf4j;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.function.Consumer;

/**
 * å­å·¥ä½œæµèŠ‚ç‚¹
 * åŠŸèƒ½ï¼šåœ¨å½“å‰å·¥ä½œæµä¸­è°ƒç”¨å…¶ä»–å·¥ä½œæµï¼Œå®ç°å·¥ä½œæµå¤ç”¨
 */
@Slf4j
public class SubWorkflowNode extends AbstractWfNode {

    public SubWorkflowNode(AiWorkflowComponentEntity wfComponent,
                          AiWorkflowNodeVo nodeDefinition,
                          WfState wfState,
                          WfNodeState nodeState) {
        super(wfComponent, nodeDefinition, wfState, nodeState);
    }

    @Override
    public NodeProcessResult process(Consumer<WfNodeState> inputConsumer,
                                    Consumer<WfNodeState> outputConsumer) {
        log.info("å¼€å§‹æ‰§è¡Œå­å·¥ä½œæµèŠ‚ç‚¹: {}", nodeDefinition.getLabel());

        state.setProcessStatus(NODE_PROCESS_STATUS_DOING);

        try {
            // 1. åˆå§‹åŒ–è¾“å…¥
            initInput();
            inputConsumer.accept(state);

            // 2. è§£æå­å·¥ä½œæµé…ç½®
            SubWorkflowNodeConfig config = parseConfig();
            String subWorkflowUuid = config.getWorkflowUuid();

            if (subWorkflowUuid == null || subWorkflowUuid.isEmpty()) {
                throw new RuntimeException("å­å·¥ä½œæµæœªé…ç½®");
            }

            // 3. æ£€æµ‹å¾ªç¯ä¾èµ–
            if (wfState.isInExecutionStack(subWorkflowUuid)) {
                throw new RuntimeException("æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–: " +
                    wfState.getExecutionStack() + " â†’ " + subWorkflowUuid);
            }

            // 4. æ˜ å°„è¾“å…¥å‚æ•°
            Map<String, Object> subInputs = mapInputs(config);

            // 5. æ‰§è¡Œå­å·¥ä½œæµ
            log.info("è°ƒç”¨å­å·¥ä½œæµ: {} ({})", config.getWorkflowName(), subWorkflowUuid);
            WorkflowEngine subEngine = new WorkflowEngine(
                subWorkflowUuid,
                wfState.getUserId(),
                wfState.getExecutionStack()
            );

            Map<String, Object> subOutputs = subEngine.runSync(
                convertToInputList(subInputs),
                wfState.getTenantCode()
            );

            // 6. è®¾ç½®è¾“å‡º
            Map<String, Object> outputs = new HashMap<>();
            outputs.put("result", subOutputs);
            state.setOutputs(outputs);

            outputConsumer.accept(state);
            state.setProcessStatus(NODE_PROCESS_STATUS_DONE);

            log.info("å­å·¥ä½œæµèŠ‚ç‚¹æ‰§è¡Œå®Œæˆ: {}", nodeDefinition.getLabel());

            // 7. è¿”å›ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
            return new NodeProcessResult(getNextNodeUuid());

        } catch (Exception e) {
            log.error("å­å·¥ä½œæµèŠ‚ç‚¹æ‰§è¡Œå¤±è´¥: {}", nodeDefinition.getLabel(), e);
            state.setProcessStatus(NODE_PROCESS_STATUS_ERROR);
            state.setErrorMessage(e.getMessage());
            throw new RuntimeException("å­å·¥ä½œæµæ‰§è¡Œå¤±è´¥: " + e.getMessage(), e);
        }
    }

    /**
     * è§£æèŠ‚ç‚¹é…ç½®
     */
    private SubWorkflowNodeConfig parseConfig() {
        if (nodeDefinition.getNodeConfig() == null) {
            throw new RuntimeException("èŠ‚ç‚¹é…ç½®ä¸ºç©º");
        }
        return JSON.parseObject(
            JSON.toJSONString(nodeDefinition.getNodeConfig()),
            SubWorkflowNodeConfig.class
        );
    }

    /**
     * æ˜ å°„è¾“å…¥å‚æ•°
     */
    private Map<String, Object> mapInputs(SubWorkflowNodeConfig config) {
        Map<String, Object> parentInputs = state.getInputs();
        Map<String, Object> subInputs = new HashMap<>();

        List<SubWorkflowNodeConfig.InputMapping> mappings = config.getInputMapping();
        if (mappings != null && !mappings.isEmpty()) {
            for (SubWorkflowNodeConfig.InputMapping mapping : mappings) {
                Object value = parentInputs.get(mapping.getSourceKey());
                if (value != null) {
                    subInputs.put(mapping.getTargetKey(), value);
                }
            }
        } else {
            // å¦‚æœæ²¡æœ‰é…ç½®æ˜ å°„ï¼Œç›´æ¥ä¼ é€’æ‰€æœ‰è¾“å…¥
            subInputs.putAll(parentInputs);
        }

        return subInputs;
    }

    /**
     * è½¬æ¢ä¸ºWorkflowEngineéœ€è¦çš„è¾“å…¥æ ¼å¼
     */
    private List<com.alibaba.fastjson2.JSONObject> convertToInputList(Map<String, Object> inputs) {
        com.alibaba.fastjson2.JSONObject inputJson = new com.alibaba.fastjson2.JSONObject();
        inputJson.putAll(inputs);
        return List.of(inputJson);
    }
}
```

#### 3.2.2 SubWorkflowNodeConfig.java (é…ç½®ç±»)

**æ–‡ä»¶ä½ç½®**ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/node/subworkflow/SubWorkflowNodeConfig.java`

**ä»£ç å®ç°**ï¼š
```java
package com.xinyirun.scm.ai.workflow.node.subworkflow;

import lombok.Data;
import java.util.List;

/**
 * å­å·¥ä½œæµèŠ‚ç‚¹é…ç½®
 */
@Data
public class SubWorkflowNodeConfig {

    /**
     * å­å·¥ä½œæµUUID
     */
    private String workflowUuid;

    /**
     * å­å·¥ä½œæµåç§°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
     */
    private String workflowName;

    /**
     * è¾“å…¥å‚æ•°æ˜ å°„
     */
    private List<InputMapping> inputMapping;

    /**
     * è¾“å…¥å‚æ•°æ˜ å°„é¡¹
     */
    @Data
    public static class InputMapping {
        /**
         * çˆ¶å·¥ä½œæµå‚æ•°åï¼ˆæºï¼‰
         */
        private String sourceKey;

        /**
         * å­å·¥ä½œæµå‚æ•°åï¼ˆç›®æ ‡ï¼‰
         */
        private String targetKey;
    }
}
```

#### 3.2.3 WorkflowEngine.java (å¼•æ“å¢å¼º)

**ä¿®æ”¹æ–‡ä»¶**ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WorkflowEngine.java`

**æ–°å¢å­—æ®µå’Œæ–¹æ³•**ï¼š
```java
public class WorkflowEngine {

    // æ–°å¢ï¼šæ‰§è¡Œæ ˆï¼Œç”¨äºæ£€æµ‹å¾ªç¯ä¾èµ–
    private Set<String> executionStack;

    // ä¿®æ”¹ï¼šæ”¯æŒä¼ å…¥æ‰§è¡Œæ ˆ
    public WorkflowEngine(String workflowId, Long userId, Set<String> parentStack) {
        this.workflowId = workflowId;
        this.userId = userId;
        this.executionStack = new HashSet<>(parentStack);
        this.executionStack.add(workflowId);
    }

    // æ–°å¢ï¼šåŒæ­¥æ‰§è¡Œæ–¹æ³•ï¼ˆä¾›SubWorkflowNodeè°ƒç”¨ï¼‰
    public Map<String, Object> runSync(List<JSONObject> userInputs, String tenantCode) {
        run(userId, userInputs, tenantCode);

        // ç­‰å¾…æ‰§è¡Œå®Œæˆï¼Œè¿”å›æœ€ç»ˆçŠ¶æ€
        NodeOutput endNodeOutput = app.invoke(invokeConfig);
        return extractOutputs(endNodeOutput);
    }

    private Map<String, Object> extractOutputs(NodeOutput output) {
        // ä»EndèŠ‚ç‚¹çš„outputsä¸­æå–ç»“æœ
        // å®ç°ç•¥
    }
}
```

#### 3.2.4 WfState.java (çŠ¶æ€ç±»å¢å¼º)

**ä¿®æ”¹æ–‡ä»¶**ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/state/WfState.java`

**æ–°å¢æ–¹æ³•**ï¼š
```java
public class WfState {

    // æ‰§è¡Œæ ˆ
    private Set<String> executionStack = new HashSet<>();

    public boolean isInExecutionStack(String workflowId) {
        return executionStack.contains(workflowId);
    }

    public Set<String> getExecutionStack() {
        return new HashSet<>(executionStack);
    }
}
```

#### 3.2.5 WfNodeFactory.java (å·¥å‚ç±»å¢å¼º)

**ä¿®æ”¹æ–‡ä»¶**ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WfNodeFactory.java`

**æ–°å¢case**ï¼š
```java
public static AbstractWfNode create(AiWorkflowComponentEntity wfComponent,
                                   AiWorkflowNodeVo nodeDefinition,
                                   WfState wfState,
                                   WfNodeState nodeState) {
    String componentName = wfComponent.getName();

    // ... å…¶ä»–case ...

    if ("SubWorkflow".equals(componentName)) {
        return new SubWorkflowNode(wfComponent, nodeDefinition, wfState, nodeState);
    }

    throw new RuntimeException("ä¸æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹: " + componentName);
}
```

#### 3.2.6 WorkflowController.java (APIå¢å¼º)

**ä¿®æ”¹æ–‡ä»¶**ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/controller/workflow/WorkflowController.java`

**æ–°å¢API**ï¼š
```java
@RestController
@RequestMapping("/api/v1/ai/workflow")
public class WorkflowController {

    @Autowired
    private AiWorkflowService workflowService;

    /**
     * æŸ¥è¯¢å¯ç”¨çš„å·¥ä½œæµåˆ—è¡¨ï¼ˆç”¨äºå­å·¥ä½œæµé€‰æ‹©å™¨ï¼‰
     */
    @GetMapping("/available")
    public Response<List<WorkflowOptionVo>> getAvailableWorkflows(HttpServletRequest request) {
        Long userId = SecurityUtil.getStaff_id();

        List<AiWorkflowEntity> workflows = workflowService.getAvailableWorkflows(userId);

        List<WorkflowOptionVo> result = workflows.stream()
            .map(wf -> {
                WorkflowOptionVo vo = new WorkflowOptionVo();
                vo.setUuid(wf.getUuid());
                vo.setName(wf.getName());
                vo.setIsPublic(wf.getIsPublic());
                vo.setUserId(wf.getUserId());
                return vo;
            })
            .collect(Collectors.toList());

        return Response.success(result);
    }
}
```

#### 3.2.7 AiWorkflowService.java (Serviceå±‚)

**ä¿®æ”¹æ–‡ä»¶**ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/workflow/AiWorkflowService.java`

**æ–°å¢æ–¹æ³•**ï¼š
```java
public interface AiWorkflowService extends IService<AiWorkflowEntity> {

    /**
     * æŸ¥è¯¢ç”¨æˆ·å¯ç”¨çš„å·¥ä½œæµï¼ˆå…¬å¼€çš„ + è‡ªå·±çš„ï¼‰
     */
    List<AiWorkflowEntity> getAvailableWorkflows(Long userId);
}
```

**å®ç°ç±»**ï¼š
```java
@Service
public class AiWorkflowServiceImpl extends ServiceImpl<AiWorkflowMapper, AiWorkflowEntity>
        implements AiWorkflowService {

    @Override
    public List<AiWorkflowEntity> getAvailableWorkflows(Long userId) {
        return this.baseMapper.selectAvailableWorkflows(userId);
    }
}
```

#### 3.2.8 AiWorkflowMapper.java (Mapperå±‚)

**ä¿®æ”¹æ–‡ä»¶**ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/core/mapper/workflow/AiWorkflowMapper.java`

**æ–°å¢æ–¹æ³•**ï¼š
```java
@Mapper
public interface AiWorkflowMapper extends BaseMapper<AiWorkflowEntity> {

    @Select("""
        SELECT uuid, name, is_public, user_id, description
        FROM ai_workflow
        WHERE (is_public = 1 OR user_id = #{userId})
          AND status = 1
        ORDER BY is_public DESC, name ASC
    """)
    List<AiWorkflowEntity> selectAvailableWorkflows(@Param("userId") Long userId);
}
```

---

## 4. å®æ–½è®¡åˆ’

### 4.1 å®æ–½é¡ºåº

```
é˜¶æ®µ1: æ•°æ®åº“å‡†å¤‡ (30åˆ†é’Ÿ)
â”œâ”€ 1.1 åœ¨ai_workflow_componentè¡¨æ’å…¥SubWorkflowç»„ä»¶è®°å½•
â””â”€ 1.2 éªŒè¯æ•°æ®æ’å…¥æˆåŠŸ

é˜¶æ®µ2: åç«¯APIå®ç° (2å°æ—¶)
â”œâ”€ 2.1 åˆ›å»ºSubWorkflowNodeConfig.javaé…ç½®ç±»
â”œâ”€ 2.2 åˆ›å»ºSubWorkflowNode.javaèŠ‚ç‚¹æ‰§è¡Œç±»
â”œâ”€ 2.3 ä¿®æ”¹WorkflowEngine.javaæ”¯æŒæ‰§è¡Œæ ˆ
â”œâ”€ 2.4 ä¿®æ”¹WfState.javaå¢åŠ å¾ªç¯æ£€æµ‹æ–¹æ³•
â”œâ”€ 2.5 ä¿®æ”¹WfNodeFactory.javaæ³¨å†Œæ–°èŠ‚ç‚¹ç±»å‹
â”œâ”€ 2.6 åˆ›å»ºWorkflowOptionVo.java
â”œâ”€ 2.7 åœ¨WorkflowController.javaæ·»åŠ /availableæ¥å£
â”œâ”€ 2.8 åœ¨AiWorkflowServiceæ·»åŠ getAvailableWorkflowsæ–¹æ³•
â”œâ”€ 2.9 åœ¨AiWorkflowMapperæ·»åŠ selectAvailableWorkflowsæ–¹æ³•
â””â”€ 2.10 ç¼–è¯‘æµ‹è¯•åç«¯ä»£ç 

é˜¶æ®µ3: å‰ç«¯ç»„ä»¶å®ç° (3å°æ—¶)
â”œâ”€ 3.1 åˆ›å»ºSubWorkflowNode.vueèŠ‚ç‚¹æ ·å¼ç»„ä»¶
â”œâ”€ 3.2 åˆ›å»ºSubWorkflowNodeProperty.vueå±æ€§é¢æ¿ç»„ä»¶
â”œâ”€ 3.3 åœ¨registerX6Nodes.jsæ³¨å†ŒsubworkflowèŠ‚ç‚¹
â”œâ”€ 3.4 åœ¨WorkflowNodePalette.vueæ·»åŠ å­å·¥ä½œæµèŠ‚ç‚¹é¡¹
â”œâ”€ 3.5 åœ¨WorkflowPropertyPanel.vueæ·»åŠ è·¯ç”±
â”œâ”€ 3.6 åœ¨workflow.js APIæ–‡ä»¶æ·»åŠ getAvailableWorkflowsæ–¹æ³•
â””â”€ 3.7 æœ¬åœ°å¯åŠ¨æµ‹è¯•å‰ç«¯åŠŸèƒ½

é˜¶æ®µ4: é›†æˆæµ‹è¯• (1.5å°æ—¶)
â”œâ”€ 4.1 æµ‹è¯•èŠ‚ç‚¹æ‹–æ‹½åˆ°ç”»å¸ƒ
â”œâ”€ 4.2 æµ‹è¯•å·¥ä½œæµé€‰æ‹©å™¨æ•°æ®åŠ è½½
â”œâ”€ 4.3 æµ‹è¯•é€‰æ‹©å·¥ä½œæµåèŠ‚ç‚¹bodyæ›´æ–°
â”œâ”€ 4.4 æµ‹è¯•è¾“å…¥å‚æ•°é…ç½®
â”œâ”€ 4.5 æµ‹è¯•ç®€å•å­å·¥ä½œæµæ‰§è¡Œ
â”œâ”€ 4.6 æµ‹è¯•å‚æ•°æ˜ å°„æ­£ç¡®æ€§
â”œâ”€ 4.7 æµ‹è¯•å¾ªç¯ä¾èµ–æ£€æµ‹
â””â”€ 4.8 æµ‹è¯•åµŒå¥—å­å·¥ä½œæµï¼ˆå­å·¥ä½œæµä¸­å†è°ƒç”¨å­å·¥ä½œæµï¼‰

é˜¶æ®µ5: æ–‡æ¡£å’ŒéªŒæ”¶ (30åˆ†é’Ÿ)
â”œâ”€ 5.1 æ›´æ–°ç”¨æˆ·æ‰‹å†Œï¼ˆå¦‚ä½•ä½¿ç”¨å­å·¥ä½œæµèŠ‚ç‚¹ï¼‰
â”œâ”€ 5.2 ä»£ç æ³¨é‡Šæ£€æŸ¥
â””â”€ 5.3 æäº¤ä»£ç å®¡æŸ¥
```

### 4.2 é¢„è®¡æ—¶é—´

- **æ€»å·¥æ—¶**ï¼š7å°æ—¶
- **å»ºè®®åˆ†é…**ï¼š2å¤©å®Œæˆï¼ˆæ¯å¤©3.5å°æ—¶ï¼‰

---

## 5. é£é™©åˆ†æ

### 5.1 æŠ€æœ¯é£é™©

| é£é™©é¡¹ | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|-------|------|------|---------|
| **å¾ªç¯ä¾èµ–æ£€æµ‹å¤±è´¥** | å¯¼è‡´æ ˆæº¢å‡º | ä½ | 1. åœ¨WorkflowEngineä¸­ç»´æŠ¤executionStack<br>2. åœ¨SubWorkflowNode.process()å¼€å§‹æ—¶æ£€æŸ¥<br>3. å•å…ƒæµ‹è¯•è¦†ç›–å¾ªç¯ä¾èµ–åœºæ™¯ |
| **å­å·¥ä½œæµæ‰§è¡Œè¶…æ—¶** | çˆ¶å·¥ä½œæµé˜»å¡ | ä¸­ | 1. è®¾ç½®å­å·¥ä½œæµæ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰<br>2. è¶…æ—¶åæŠ›å‡ºå¼‚å¸¸ï¼Œç»ˆæ­¢çˆ¶å·¥ä½œæµ |
| **è¾“å…¥å‚æ•°æ˜ å°„é”™è¯¯** | å­å·¥ä½œæµæ‰§è¡Œå¤±è´¥ | ä¸­ | 1. åœ¨å‰ç«¯å±æ€§é¢æ¿åšå‚æ•°ç±»å‹æç¤º<br>2. åç«¯æ‰§è¡Œå‰éªŒè¯å‚æ•°å®Œæ•´æ€§<br>3. æä¾›é»˜è®¤æ˜ å°„è§„åˆ™ï¼ˆåŒåå‚æ•°è‡ªåŠ¨æ˜ å°„ï¼‰ |
| **å­å·¥ä½œæµå®šä¹‰è¢«åˆ é™¤** | çˆ¶å·¥ä½œæµæ‰§è¡Œå¤±è´¥ | ä½ | 1. æŸ¥è¯¢å­å·¥ä½œæµæ—¶æ£€æŸ¥status<br>2. æ‰§è¡Œå‰æ£€æŸ¥å­å·¥ä½œæµæ˜¯å¦å­˜åœ¨<br>3. å‰ç«¯é€‰æ‹©å™¨åªæ˜¾ç¤ºactiveçŠ¶æ€çš„å·¥ä½œæµ |
| **åµŒå¥—å±‚çº§è¿‡æ·±** | æ€§èƒ½é—®é¢˜ | ä½ | 1. é™åˆ¶æœ€å¤§åµŒå¥—å±‚çº§ä¸º5å±‚<br>2. è¶…è¿‡å±‚çº§é™åˆ¶æŠ›å‡ºå¼‚å¸¸ |

### 5.2 ä¸šåŠ¡é£é™©

| é£é™©é¡¹ | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|-------|------|------|---------|
| **å­å·¥ä½œæµç‰ˆæœ¬å˜æ›´** | çˆ¶å·¥ä½œæµè¡Œä¸ºæ”¹å˜ | é«˜ | 1. æ–‡æ¡£è¯´æ˜ï¼šä¿®æ”¹å­å·¥ä½œæµä¼šå½±å“æ‰€æœ‰å¼•ç”¨å®ƒçš„çˆ¶å·¥ä½œæµ<br>2. æœªæ¥ç‰ˆæœ¬è€ƒè™‘ï¼šæ”¯æŒå­å·¥ä½œæµç‰ˆæœ¬é”å®š |
| **æƒé™æ§åˆ¶ä¸ä¸¥** | ç”¨æˆ·è°ƒç”¨æ— æƒé™çš„å·¥ä½œæµ | ä¸­ | 1. APIåªè¿”å›ç”¨æˆ·å¯è®¿é—®çš„å·¥ä½œæµ<br>2. æ‰§è¡Œå‰æ£€æŸ¥ç”¨æˆ·å¯¹å­å·¥ä½œæµçš„è®¿é—®æƒé™ |
| **è°ƒè¯•å›°éš¾** | æ’æŸ¥é—®é¢˜æ—¶é—´é•¿ | ä¸­ | 1. æ—¥å¿—ä¸­è®°å½•å®Œæ•´çš„è°ƒç”¨é“¾è·¯<br>2. è¿è¡Œæ—¶è®°å½•æ˜¾ç¤ºåµŒå¥—å±‚çº§<br>3. é”™è¯¯æ¶ˆæ¯åŒ…å«çˆ¶å­å·¥ä½œæµä¿¡æ¯ |

---

## 6. æµ‹è¯•ç”¨ä¾‹

### 6.1 åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹1ï¼šèŠ‚ç‚¹åˆ›å»ºå’Œé…ç½®
```
å‰ç½®æ¡ä»¶ï¼š
1. ç”¨æˆ·å·²ç™»å½•
2. å·¥ä½œæµè®¾è®¡å™¨å·²æ‰“å¼€

æµ‹è¯•æ­¥éª¤ï¼š
1. ä»èŠ‚ç‚¹é¢æ¿æ‹–æ‹½"å­å·¥ä½œæµ"èŠ‚ç‚¹åˆ°ç”»å¸ƒ
2. ç‚¹å‡»èŠ‚ç‚¹ï¼Œæ‰“å¼€å±æ€§é¢æ¿
3. ç‚¹å‡»"å¯ä½¿ç”¨çš„å·¥ä½œæµ"ä¸‹æ‹‰æ¡†
4. éªŒè¯ä¸‹æ‹‰æ¡†æ˜¾ç¤º"å…¬å¼€å·¥ä½œæµ"å’Œ"æˆ‘çš„å·¥ä½œæµ"ä¸¤ä¸ªåˆ†ç»„
5. é€‰æ‹©"å…¬å¼€å·¥ä½œæµ"ä¸­çš„"FAQæå–æ ‡å‡†æµç¨‹"
6. éªŒè¯èŠ‚ç‚¹bodyæ˜¾ç¤º"FAQæå–æ ‡å‡†æµç¨‹"

é¢„æœŸç»“æœï¼š
- èŠ‚ç‚¹æˆåŠŸåˆ›å»ºï¼Œå›¾æ ‡ä¸ºğŸ”—
- å±æ€§é¢æ¿æ­£ç¡®æ˜¾ç¤ºè¯´æ˜æ–‡å­—å’Œé€‰æ‹©å™¨
- é€‰æ‹©å·¥ä½œæµåï¼ŒèŠ‚ç‚¹bodyç«‹å³æ›´æ–°æ˜¾ç¤ºå·¥ä½œæµåç§°
```

#### æµ‹è¯•ç”¨ä¾‹2ï¼šè¾“å…¥å‚æ•°æ˜ å°„
```
å‰ç½®æ¡ä»¶ï¼š
1. å­å·¥ä½œæµèŠ‚ç‚¹å·²é…ç½®å·¥ä½œæµ
2. çˆ¶å·¥ä½œæµStartèŠ‚ç‚¹æœ‰è¾“å…¥å‚æ•°ï¼š[{name: "text", type: "string"}]
3. å­å·¥ä½œæµStartèŠ‚ç‚¹æœ‰è¾“å…¥å‚æ•°ï¼š[{name: "question", type: "string"}]

æµ‹è¯•æ­¥éª¤ï¼š
1. åœ¨å­å·¥ä½œæµèŠ‚ç‚¹å±æ€§é¢æ¿ä¸­é…ç½®è¾“å…¥å‚æ•°
2. åœ¨"è¾“å…¥å‚æ•°æ˜ å°„"åŒºåŸŸï¼Œå°†çˆ¶å·¥ä½œæµçš„"text"æ˜ å°„åˆ°å­å·¥ä½œæµçš„"question"
3. ä¿å­˜å·¥ä½œæµ
4. è¿è¡Œçˆ¶å·¥ä½œæµï¼Œè¾“å…¥{"text": "ä»€ä¹ˆæ˜¯AI?"}
5. æŸ¥çœ‹å­å·¥ä½œæµèŠ‚ç‚¹çš„è¾“å…¥æ—¥å¿—

é¢„æœŸç»“æœï¼š
- å‚æ•°æ˜ å°„é…ç½®æˆåŠŸä¿å­˜
- å­å·¥ä½œæµæ”¶åˆ°è¾“å…¥{"question": "ä»€ä¹ˆæ˜¯AI?"}
- æ˜ å°„å…³ç³»æ­£ç¡®
```

#### æµ‹è¯•ç”¨ä¾‹3ï¼šå­å·¥ä½œæµæ‰§è¡Œ
```
å‰ç½®æ¡ä»¶ï¼š
1. å­˜åœ¨ä¸€ä¸ªç®€å•çš„å­å·¥ä½œæµï¼ˆStart â†’ Answer â†’ Endï¼‰
2. çˆ¶å·¥ä½œæµä¸­é…ç½®äº†å­å·¥ä½œæµèŠ‚ç‚¹

æµ‹è¯•æ­¥éª¤ï¼š
1. è¿è¡Œçˆ¶å·¥ä½œæµ
2. è§‚å¯Ÿæ‰§è¡Œè¿‡ç¨‹
3. éªŒè¯å­å·¥ä½œæµè¢«è°ƒç”¨
4. éªŒè¯å­å·¥ä½œæµè¾“å‡ºè¢«ä¼ é€’åˆ°çˆ¶å·¥ä½œæµä¸‹ä¸€ä¸ªèŠ‚ç‚¹

é¢„æœŸç»“æœï¼š
- çˆ¶å·¥ä½œæµæ‰§è¡Œåˆ°å­å·¥ä½œæµèŠ‚ç‚¹æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨å­å·¥ä½œæµ
- å­å·¥ä½œæµæ‰§è¡Œå®Œæˆåï¼Œçˆ¶å·¥ä½œæµç»§ç»­æ‰§è¡Œ
- å­å·¥ä½œæµè¾“å‡ºæ­£ç¡®ä¼ é€’
```

#### æµ‹è¯•ç”¨ä¾‹4ï¼šå¾ªç¯ä¾èµ–æ£€æµ‹
```
å‰ç½®æ¡ä»¶ï¼š
1. å·¥ä½œæµAåŒ…å«å­å·¥ä½œæµèŠ‚ç‚¹ï¼Œå¼•ç”¨å·¥ä½œæµB
2. å·¥ä½œæµBåŒ…å«å­å·¥ä½œæµèŠ‚ç‚¹ï¼Œå¼•ç”¨å·¥ä½œæµA

æµ‹è¯•æ­¥éª¤ï¼š
1. è¿è¡Œå·¥ä½œæµA
2. è§‚å¯Ÿæ‰§è¡Œæƒ…å†µ

é¢„æœŸç»“æœï¼š
- ç³»ç»Ÿæ£€æµ‹åˆ°å¾ªç¯ä¾èµ–
- æŠ›å‡ºå¼‚å¸¸ï¼š"æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–: [A] â†’ B â†’ A"
- å·¥ä½œæµæ‰§è¡Œç»ˆæ­¢ï¼Œä¸ä¼šå‡ºç°æ ˆæº¢å‡º
```

### 6.2 è¾¹ç•Œæµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹5ï¼šæœªé€‰æ‹©å·¥ä½œæµ
```
æµ‹è¯•æ­¥éª¤ï¼š
1. åˆ›å»ºå­å·¥ä½œæµèŠ‚ç‚¹ï¼Œä¸é€‰æ‹©ä»»ä½•å·¥ä½œæµ
2. è¿è¡Œå·¥ä½œæµ

é¢„æœŸç»“æœï¼š
- èŠ‚ç‚¹bodyæ˜¾ç¤º"è¯·é€‰æ‹©å·¥ä½œæµ"
- æ‰§è¡Œåˆ°è¯¥èŠ‚ç‚¹æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š"å­å·¥ä½œæµæœªé…ç½®"
```

#### æµ‹è¯•ç”¨ä¾‹6ï¼šå­å·¥ä½œæµè¢«åˆ é™¤
```
å‰ç½®æ¡ä»¶ï¼š
1. çˆ¶å·¥ä½œæµé…ç½®äº†å­å·¥ä½œæµA
2. å­å·¥ä½œæµAè¢«åˆ é™¤

æµ‹è¯•æ­¥éª¤ï¼š
1. è¿è¡Œçˆ¶å·¥ä½œæµ

é¢„æœŸç»“æœï¼š
- æ‰§è¡Œåˆ°å­å·¥ä½œæµèŠ‚ç‚¹æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š"å­å·¥ä½œæµä¸å­˜åœ¨"
```

#### æµ‹è¯•ç”¨ä¾‹7ï¼šåµŒå¥—å±‚çº§é™åˆ¶
```
å‰ç½®æ¡ä»¶ï¼š
1. å·¥ä½œæµAè°ƒç”¨Bï¼ŒBè°ƒç”¨Cï¼ŒCè°ƒç”¨Dï¼ŒDè°ƒç”¨Eï¼ŒEè°ƒç”¨Fï¼ˆ6å±‚åµŒå¥—ï¼‰

æµ‹è¯•æ­¥éª¤ï¼š
1. è¿è¡Œå·¥ä½œæµA

é¢„æœŸç»“æœï¼š
- æ‰§è¡Œåˆ°ç¬¬6å±‚æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š"è¶…è¿‡æœ€å¤§åµŒå¥—å±‚çº§ï¼ˆ5å±‚ï¼‰"
```

---

## 7. åç»­ä¼˜åŒ–æ–¹å‘

### 7.1 ç‰ˆæœ¬é”å®š
**éœ€æ±‚**ï¼šé”å®šå­å·¥ä½œæµç‰ˆæœ¬ï¼Œé˜²æ­¢å­å·¥ä½œæµä¿®æ”¹å½±å“çˆ¶å·¥ä½œæµ
**å®ç°æ€è·¯**ï¼š
1. ä¸ºai_workflowè¡¨å¢åŠ versionå­—æ®µ
2. å­å·¥ä½œæµèŠ‚ç‚¹é…ç½®æ”¹ä¸º{workflow_uuid, version}
3. æ‰§è¡Œæ—¶æŸ¥è¯¢æŒ‡å®šç‰ˆæœ¬çš„å·¥ä½œæµå®šä¹‰

### 7.2 è¾“å‡ºæ˜ å°„
**éœ€æ±‚**ï¼šæ”¯æŒå°†å­å·¥ä½œæµè¾“å‡ºæ˜ å°„åˆ°çˆ¶å·¥ä½œæµç‰¹å®šå˜é‡
**å®ç°æ€è·¯**ï¼š
1. åœ¨SubWorkflowNodeConfigå¢åŠ output_mappingé…ç½®
2. ç±»ä¼¼input_mappingï¼Œæ”¯æŒ{source_key, target_key}æ˜ å°„
3. æ‰§è¡Œå®Œæˆåï¼Œæ ¹æ®æ˜ å°„è§„åˆ™è½¬æ¢è¾“å‡º

### 7.3 å­å·¥ä½œæµå‚æ•°é¢„è§ˆ
**éœ€æ±‚**ï¼šåœ¨å‰ç«¯é€‰æ‹©å­å·¥ä½œæµæ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºå…¶è¾“å…¥è¾“å‡ºå®šä¹‰
**å®ç°æ€è·¯**ï¼š
1. APIè¿”å›å­å·¥ä½œæµçš„StartèŠ‚ç‚¹inputså’ŒEndèŠ‚ç‚¹outputs
2. å±æ€§é¢æ¿æ˜¾ç¤ºå‚æ•°åˆ—è¡¨
3. è‡ªåŠ¨ç”Ÿæˆinput_mappingçš„åˆå§‹å€¼ï¼ˆåŒåå‚æ•°è‡ªåŠ¨æ˜ å°„ï¼‰

### 7.4 å¯è§†åŒ–è°ƒç”¨é“¾
**éœ€æ±‚**ï¼šè¿è¡Œæ—¶æ˜¾ç¤ºçˆ¶å­å·¥ä½œæµçš„è°ƒç”¨å…³ç³»
**å®ç°æ€è·¯**ï¼š
1. åœ¨WorkflowRuntimeä¸­è®°å½•parent_runtime_id
2. å‰ç«¯å±•ç¤ºè°ƒç”¨æ ‘ï¼ˆç±»ä¼¼Chrome DevToolsçš„Call Stackï¼‰
3. æ”¯æŒç‚¹å‡»è·³è½¬åˆ°å­å·¥ä½œæµæ‰§è¡Œè¯¦æƒ…

---

## 8. æ€»ç»“

### 8.1 æ ¸å¿ƒä»·å€¼
1. **ä»£ç å¤ç”¨**ï¼šé¿å…é‡å¤å®šä¹‰ç›¸åŒçš„èŠ‚ç‚¹åºåˆ—ï¼Œæå‡å·¥ä½œæµå¼€å‘æ•ˆç‡
2. **æ¨¡å—åŒ–**ï¼šå°†é€šç”¨æµç¨‹æŠ½å–ä¸ºå­å·¥ä½œæµï¼Œé™ä½å¤æ‚åº¦
3. **å¯ç»´æŠ¤æ€§**ï¼šä¿®æ”¹å­å·¥ä½œæµï¼Œæ‰€æœ‰å¼•ç”¨å®ƒçš„çˆ¶å·¥ä½œæµè‡ªåŠ¨ç”Ÿæ•ˆ
4. **æ¶æ„ä¸€è‡´æ€§**ï¼šåˆ©ç”¨LangGraphçš„å­å›¾èƒ½åŠ›ï¼Œç¬¦åˆå·¥ä½œæµå¼•æ“è®¾è®¡ç†å¿µ

### 8.2 æŠ€æœ¯äº®ç‚¹
1. **é€’å½’æ‰§è¡Œ**ï¼šé€šè¿‡WorkflowEngineé€’å½’è°ƒç”¨ï¼Œå®ç°ä»»æ„åµŒå¥—
2. **å¾ªç¯æ£€æµ‹**ï¼šexecutionStackæœºåˆ¶ï¼Œé¿å…æ­»å¾ªç¯å’Œæ ˆæº¢å‡º
3. **å‚æ•°æ˜ å°„**ï¼šçµæ´»çš„input_mappingé…ç½®ï¼Œæ”¯æŒçˆ¶å­å·¥ä½œæµå‚æ•°é€‚é…
4. **çŠ¶æ€éš”ç¦»**ï¼šæ¯ä¸ªå­å·¥ä½œæµæœ‰ç‹¬ç«‹çš„WfStateå’ŒWfNodeState
5. **é›¶ç ´åæ€§**ï¼šæ–°å¢åŠŸèƒ½ï¼Œä¸ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œå‘åå…¼å®¹

### 8.3 é£é™©å¯æ§
1. **å¾ªç¯ä¾èµ–**ï¼šexecutionStackæ£€æµ‹ + å•å…ƒæµ‹è¯•è¦†ç›–
2. **æ‰§è¡Œè¶…æ—¶**ï¼šè®¾ç½®è¶…æ—¶æ—¶é—´ + å¼‚å¸¸å¤„ç†
3. **æƒé™æ§åˆ¶**ï¼šAPIåªè¿”å›å¯è®¿é—®çš„å·¥ä½œæµ
4. **åµŒå¥—å±‚çº§**ï¼šé™åˆ¶æœ€å¤§5å±‚ï¼Œé˜²æ­¢æ€§èƒ½é—®é¢˜

### 8.4 å®æ–½å¯è¡Œæ€§
âœ… **æŠ€æœ¯å¯è¡Œ**ï¼šLangGraph4jæ”¯æŒå­å›¾ï¼Œæ¶æ„å·²é¢„ç•™æ‰©å±•ç‚¹
âœ… **å·¥æœŸå¯æ§**ï¼šé¢„è®¡7å°æ—¶ï¼Œ2å¤©å®Œæˆ
âœ… **é£é™©å¯æ§**ï¼šè¾¹ç•Œæƒ…å†µå·²åˆ†æï¼Œç¼“è§£æªæ–½æ˜ç¡®
âœ… **ä»·å€¼æ˜ç¡®**ï¼šè§£å†³å®é™…ä¸šåŠ¡ç—›ç‚¹ï¼Œç¬¦åˆKISSåŸåˆ™

---

## é™„å½•Aï¼šå‚è€ƒæ–‡ä»¶æ¸…å•

### å‰ç«¯å‚è€ƒæ–‡ä»¶
1. `WorkflowDesigner.vue` - å·¥ä½œæµè®¾è®¡å™¨ä¸»ç»„ä»¶
2. `AnswerNode.vue` - èŠ‚ç‚¹æ ·å¼ç»„ä»¶å‚è€ƒ
3. `AnswerNodeProperty.vue` - å±æ€§é¢æ¿ç»„ä»¶å‚è€ƒ
4. `registerX6Nodes.js` - èŠ‚ç‚¹æ³¨å†Œé€»è¾‘
5. `WorkflowNodePalette.vue` - èŠ‚ç‚¹é¢æ¿
6. `WorkflowPropertyPanel.vue` - å±æ€§é¢æ¿è·¯ç”±

### åç«¯å‚è€ƒæ–‡ä»¶
1. `AbstractWfNode.java` - èŠ‚ç‚¹åŸºç±»
2. `LLMAnswerNode.java` - èŠ‚ç‚¹å®ç°å‚è€ƒ
3. `WorkflowEngine.java` - å·¥ä½œæµæ‰§è¡Œå¼•æ“
4. `WfNodeFactory.java` - èŠ‚ç‚¹å·¥å‚ç±»
5. `WorkflowController.java` - å·¥ä½œæµAPI

### æ•°æ®åº“è¡¨
1. `ai_workflow` - å·¥ä½œæµå®šä¹‰
2. `ai_workflow_component` - å·¥ä½œæµç»„ä»¶
3. `ai_workflow_node` - èŠ‚ç‚¹å®šä¹‰
4. `ai_workflow_runtime` - è¿è¡Œæ—¶å®ä¾‹

---

## é™„å½•Bï¼šAPIæ¥å£è§„èŒƒ

### GET /api/v1/ai/workflow/available
**åŠŸèƒ½**ï¼šæŸ¥è¯¢å½“å‰ç”¨æˆ·å¯ç”¨çš„å·¥ä½œæµåˆ—è¡¨ï¼ˆç”¨äºå­å·¥ä½œæµé€‰æ‹©å™¨ï¼‰

**è¯·æ±‚å‚æ•°**ï¼šæ— 

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "uuid": "wf_uuid_1",
      "name": "FAQæå–æ ‡å‡†æµç¨‹",
      "is_public": 1,
      "user_id": null,
      "description": "ä»æ–‡æ¡£ä¸­æå–FAQçš„æ ‡å‡†æµç¨‹"
    },
    {
      "uuid": "wf_uuid_2",
      "name": "æˆ‘çš„ä¸šåŠ¡æµç¨‹A",
      "is_public": 0,
      "user_id": 10001,
      "description": "è‡ªå®šä¹‰ä¸šåŠ¡æµç¨‹"
    }
  ]
}
```

**å‰ç«¯åˆ†ç»„å¤„ç†**ï¼š
```javascript
const publicWorkflows = data.filter(wf => wf.is_public === 1)
const myWorkflows = data.filter(wf => wf.is_public === 0)

const workflowOptions = [
  { label: 'å…¬å¼€å·¥ä½œæµ', options: publicWorkflows.map(wf => ({value: wf.uuid, label: wf.name})) },
  { label: 'æˆ‘çš„å·¥ä½œæµ', options: myWorkflows.map(wf => ({value: wf.uuid, label: wf.name})) }
]
```

---

## é™„å½•Cï¼šKISSåŸåˆ™æœ€ç»ˆè¯„åˆ†

| é—®é¢˜ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| 1. è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ | âœ… çœŸé—®é¢˜ | ç”¨æˆ·å·²æœ‰é‡å¤å®šä¹‰èŠ‚ç‚¹åºåˆ—çš„ç—›ç‚¹ |
| 2. æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ | âœ… å·²æ˜¯æœ€ç®€ | æ›¿ä»£æ–¹æ¡ˆéƒ½æ›´å¤æ‚æˆ–ä¸ç¬¦åˆDRYåŸåˆ™ |
| 3. ä¼šç ´åä»€ä¹ˆå—ï¼Ÿ | âœ… é›¶ç ´åæ€§ | æ–°å¢åŠŸèƒ½ï¼Œä¸ä¿®æ”¹ç°æœ‰ä»£ç  |
| 4. å½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—ï¼Ÿ | âœ… å¿…è¦åŠŸèƒ½ | å±äºå·¥ä½œæµå¼•æ“æ ‡å‡†èƒ½åŠ› |

**æ€»ç»“**ï¼šè¯¥æ–¹æ¡ˆç¬¦åˆKISSåŸåˆ™ï¼ŒæŠ€æœ¯å®ç°ç®€æ´ï¼Œä¸šåŠ¡ä»·å€¼æ˜ç¡®ï¼Œé£é™©å¯æ§ï¼Œå»ºè®®å®æ–½ã€‚
