# å·¥ä½œæµè¿è¡Œå®ä¾‹åˆ é™¤éš”ç¦»ä¿®å¤æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-08
**è´Ÿè´£äºº**: Claude AI Assistant
**æ–¹æ¡ˆç±»å‹**: Bugä¿®å¤ + æ•°æ®ç»“æ„ä¼˜åŒ–

---

## ä¸€ã€é—®é¢˜è¯Šæ–­å’Œæ ¹å› åˆ†æ

### 1.1 é—®é¢˜ç°è±¡

å½“ç”¨æˆ·é€šè¿‡ `POST /scm/api/v1/ai/workflow/runtime/del/{runtimeUuid}` åˆ é™¤ä¸€ä¸ªå·¥ä½œæµè¿è¡Œå®ä¾‹æ—¶ï¼Œç³»ç»Ÿ**é”™è¯¯åœ°åˆ é™¤äº†æ‰€æœ‰å…±äº«ç›¸åŒ conversationId çš„å¯¹è¯å†å²è®°å½•**ï¼ŒåŒ…æ‹¬å…¶ä»–è¿è¡Œå®ä¾‹çš„å¯¹è¯æ•°æ®ã€‚

**å®é™…æ¡ˆä¾‹**ï¼š
- ç”¨æˆ·å¯¹åŒä¸€ä¸ªå·¥ä½œæµæ‰§è¡Œäº†3æ¬¡ï¼ˆç”Ÿæˆ3ä¸ªruntimeå®ä¾‹ï¼‰
- 3æ¬¡æ‰§è¡Œå…±äº«åŒä¸€ä¸ª conversationIdï¼ˆæ ¼å¼ï¼š`tenantCode::workflowUuid::userId`ï¼‰
- åˆ é™¤ç¬¬1æ¬¡æ‰§è¡Œçš„runtime â†’ **æ‰€æœ‰3æ¬¡æ‰§è¡Œçš„å¯¹è¯å†å²å…¨éƒ¨è¢«æ¸…ç©º**
- é¢„æœŸè¡Œä¸ºï¼šåªåˆ é™¤ç¬¬1æ¬¡æ‰§è¡Œçš„å¯¹è¯å†å²

### 1.2 æ ¹å› åˆ†æ

#### é—®é¢˜æ ¹æºï¼šconversationId çš„è®¾è®¡å±‚çº§é”™è¯¯

**conversationId æ ¼å¼**: `tenantCode::workflowUuid::userId`

è¿™ä¸ªæ ¼å¼çš„é—®é¢˜åœ¨äºï¼š
- **å·¥ä½œæµçº§åˆ«è®°å¿†**ï¼šconversationId ä»£è¡¨çš„æ˜¯"æŸä¸ªç”¨æˆ·åœ¨æŸä¸ªå·¥ä½œæµä¸‹çš„æ‰€æœ‰å¯¹è¯"
- **éè¿è¡Œæ—¶çº§åˆ«**ï¼šåŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡æ‰§è¡ŒåŒä¸€ä¸ªå·¥ä½œæµï¼Œä¼šç”Ÿæˆå¤šä¸ª runtime å®ä¾‹ï¼Œä½†å®ƒä»¬å…±äº«åŒä¸€ä¸ª conversationId
- **åˆ é™¤æ­§ä¹‰**ï¼šåˆ é™¤æŸä¸ª runtime æ—¶ï¼Œç”¨ conversationId ä½œä¸ºæ¡ä»¶ä¼šè¯¯åˆ å…¶ä»– runtime çš„æ•°æ®

#### æŠ€æœ¯å±‚é¢åˆ†æ

**æ•°æ®æµå‘è¿½è¸ª**ï¼š

1. **Runtime åˆ›å»ºé˜¶æ®µ** (AiWorkflowRuntimeService.java:56-92)
   ```java
   // æ¯æ¬¡åˆ›å»ºruntimeå®ä¾‹æ—¶ç”ŸæˆconversationId
   String conversationId = tenantCode + "::" + workflow.getWorkflowUuid() + "::" + userId;
   runtime.setConversationId(conversationId);
   ```
   - conversationId ä¸åŒ…å« runtimeUuid
   - å¤šä¸ª runtime å…±äº«åŒä¸€ä¸ª conversationId

2. **å¯¹è¯ä¿å­˜é˜¶æ®µ** (ScmWorkflowMessageChatMemory.java:63-96)
   ```java
   @Override
   public void add(String conversationId, List<Message> messages) {
       // ä¿å­˜å¯¹è¯æ¶ˆæ¯åˆ°æ•°æ®åº“
       aiWorkflowConversationContentService.saveMessage(
           conversationId,  // â† åªæœ‰conversationIdï¼Œæ²¡æœ‰runtime_uuid
           messageType,
           content,
           ...
       );
   }
   ```
   - ä¿å­˜æ¶ˆæ¯æ—¶åªä½¿ç”¨ conversationId
   - **æœªä¿å­˜ runtime_uuid**

3. **Runtime åˆ é™¤é˜¶æ®µ** (AiWorkflowRuntimeService.java:353-379)
   ```java
   public boolean delete(String runtimeUuid) {
       String conversationId = runtime.getConversationId();

       // âŒ é—®é¢˜ä»£ç ï¼šä½¿ç”¨conversationIdåˆ é™¤
       int conversationCount = workflowConversationContentService
           .deleteByConversationId(conversationId);
   }
   ```
   - åˆ é™¤SQLï¼š`DELETE FROM ai_workflow_conversation_content WHERE conversation_id = #{conversationId}`
   - **é”™è¯¯**ï¼šconversationId ä¸æ˜¯å”¯ä¸€çš„ï¼Œä¼šåˆ é™¤å¤šä¸ª runtime çš„æ•°æ®

#### å¯¹æ¯”æ­£ç¡®çš„è®¾è®¡æ¨¡å¼

**ai_workflow_runtime_node è¡¨çš„åˆ é™¤é€»è¾‘**ï¼ˆæ­£ç¡®ç¤ºä¾‹ï¼‰ï¼š

```java
// AiWorkflowRuntimeNodeService.java
public int deleteByRuntimeId(Long runtimeId) {
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨runtimeå”¯ä¸€IDåˆ é™¤
    return aiWorkflowRuntimeNodeMapper.deleteByRuntimeId(runtimeId);
}

// SQL:
DELETE FROM ai_workflow_runtime_node
WHERE workflow_runtime_id = #{runtimeId}  -- âœ… runtimeå”¯ä¸€ID
```

**ä¸ºä»€ä¹ˆ runtime_node æ²¡æœ‰é—®é¢˜ï¼Ÿ**
- ä½¿ç”¨ `workflow_runtime_id` ä½œä¸ºå¤–é”®ï¼ˆLongç±»å‹ï¼Œå”¯ä¸€ï¼‰
- åˆ é™¤æ¡ä»¶ç²¾å‡†å®šä½åˆ°å•ä¸ª runtime å®ä¾‹

### 1.3 å½±å“èŒƒå›´

**å—å½±å“çš„åŠŸèƒ½**ï¼š
- âœ… Workflow å¯¹è¯è®°å¿†åˆ é™¤ - æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒ
- âŒ Chat å¯¹è¯è®°å¿†åˆ é™¤ - **ä¸åœ¨æœ¬æ¬¡ä¿®å¤èŒƒå›´**ï¼ˆç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼‰

**æ•°æ®å®Œæ•´æ€§é£é™©**ï¼š
- **ä¸¥é‡æ€§**ï¼šé«˜ - å¯¼è‡´ç”¨æˆ·æ•°æ®ä¸¢å¤±
- **é¢‘ç‡**ï¼šæ¯æ¬¡åˆ é™¤ runtime å®ä¾‹æ—¶å¿…ç°
- **å½±å“ç”¨æˆ·**ï¼šæ‰€æœ‰ä½¿ç”¨å¤šè½®å¯¹è¯å·¥ä½œæµçš„ç”¨æˆ·

---

## äºŒã€å®Œæ•´çš„è°ƒç”¨é“¾è·¯åˆ†æ

### 2.1 Runtime åˆ›å»º â†’ å¯¹è¯ä¿å­˜ â†’ Runtime åˆ é™¤ å®Œæ•´é“¾è·¯

```
ã€åˆ›å»ºé˜¶æ®µã€‘
POST /api/v1/ai/workflow/runtime/create
  â†“
AiWorkflowRuntimeController.create()
  â†“
AiWorkflowRuntimeService.create()
  â”‚
  â”œâ”€ ç”Ÿæˆ runtimeUuid = UuidUtil.createShort()
  â”œâ”€ ç”Ÿæˆ conversationId = tenantCode + "::" + workflowUuid + "::" + userId
  â””â”€ ä¿å­˜åˆ° ai_workflow_runtime è¡¨
      â””â”€ å­—æ®µï¼šid, runtime_uuid, conversation_id, workflow_id, user_id, ...

ã€å¯¹è¯ä¿å­˜é˜¶æ®µã€‘
WorkflowUtil.streamingInvokeLLM()
  â†“
AiChatBaseService.chatWithWorkflowMemoryStream(chatOption)
  â†“
workflowDomainChatClient.prompt()
  .user(prompt)
  .advisors(a -> {
      a.advisors(workflowMessageChatMemoryAdvisor);  // â† Spring AIæ‹¦æˆªå™¨
      a.param(ChatMemory.CONVERSATION_ID, conversationId);
  })
  .stream()
  â†“
ã€Spring AI æ¡†æ¶è‡ªåŠ¨è°ƒç”¨ã€‘
MessageChatMemoryAdvisor.aroundCall()
  â†“
ScmWorkflowMessageChatMemory.add(conversationId, messages)
  â†“
AiWorkflowConversationContentService.saveMessage(
    conversationId,    // â† åªæœ‰è¿™ä¸ªå‚æ•°
    messageType,
    content,
    ...
)
  â†“
ä¿å­˜åˆ° ai_workflow_conversation_content è¡¨
  â””â”€ å­—æ®µï¼šid, message_id, conversation_id, type, content, ...
      â””â”€ âŒ ç¼ºå°‘ runtime_uuid å­—æ®µ

ã€åˆ é™¤é˜¶æ®µã€‘
POST /api/v1/ai/workflow/runtime/del/{runtimeUuid}
  â†“
AiWorkflowRuntimeController.deleteRuntime()
  â†“
AiWorkflowRuntimeService.delete(runtimeUuid)
  â”‚
  â”œâ”€ 1. æŸ¥è¯¢ runtime è®°å½•ï¼šgetByUuid(runtimeUuid)
  â”œâ”€ 2. åˆ é™¤è¿è¡ŒèŠ‚ç‚¹ï¼šworkflowRuntimeNodeService.deleteByRuntimeId(runtimeId)
  â”‚      â””â”€ SQL: DELETE FROM ai_workflow_runtime_node WHERE workflow_runtime_id = ?
  â”‚      â””â”€ âœ… æ­£ç¡®ï¼šä½¿ç”¨å”¯ä¸€çš„ runtimeId
  â”‚
  â”œâ”€ 3. åˆ é™¤å¯¹è¯å†å²ï¼šworkflowConversationContentService.deleteByConversationId(conversationId)
  â”‚      â””â”€ SQL: DELETE FROM ai_workflow_conversation_content WHERE conversation_id = ?
  â”‚      â””â”€ âŒ é”™è¯¯ï¼šconversationId ä¸å”¯ä¸€ï¼Œè¯¯åˆ å…¶ä»– runtime çš„å¯¹è¯
  â”‚
  â””â”€ 4. åˆ é™¤ runtime ä¸»è®°å½•ï¼šaiWorkflowRuntimeMapper.deleteById(runtimeId)
```

### 2.2 æ•°æ®ä¾èµ–å…³ç³»å›¾

```
ai_workflow_runtime (ä¸»è¡¨)
â”œâ”€ id (ä¸»é”®ï¼Œå”¯ä¸€)
â”œâ”€ runtime_uuid (ä¸šåŠ¡ä¸»é”®ï¼Œå”¯ä¸€) â† åº”è¯¥ç”¨è¿™ä¸ªåšå…³è”
â”œâ”€ conversation_id (å·¥ä½œæµçº§åˆ«ï¼Œéå”¯ä¸€) â† å½“å‰é”™è¯¯åœ°ç”¨è¿™ä¸ªåšå…³è”
â”œâ”€ workflow_id
â””â”€ user_id

     1:N å…³ç³»
       â†“
ai_workflow_runtime_node (è¿è¡ŒèŠ‚ç‚¹è¡¨)
â”œâ”€ id (ä¸»é”®)
â”œâ”€ runtime_node_uuid (ä¸šåŠ¡ä¸»é”®ï¼Œå”¯ä¸€)
â”œâ”€ workflow_runtime_id â†’ ai_workflow_runtime.id (å¤–é”®ï¼Œå”¯ä¸€) âœ… æ­£ç¡®å…³è”
â”œâ”€ node_id
â””â”€ ...

     1:N å…³ç³»
       â†“
ai_workflow_conversation_content (å¯¹è¯å†å²è¡¨) â† æœ¬æ¬¡ä¿®å¤ç›®æ ‡
â”œâ”€ id (ä¸»é”®)
â”œâ”€ message_id (æ¶ˆæ¯UUIDï¼Œå”¯ä¸€)
â”œâ”€ conversation_id (å·¥ä½œæµçº§åˆ«ï¼Œéå”¯ä¸€) âŒ å½“å‰é”™è¯¯å…³è”
â”œâ”€ runtime_uuid (ç¼ºå¤±å­—æ®µ) âš ï¸ éœ€è¦æ–°å¢
â”œâ”€ type (USER/ASSISTANT/SYSTEM)
â”œâ”€ content (æ¶ˆæ¯å†…å®¹)
â”œâ”€ model_source_id
â””â”€ ...
```

---

## ä¸‰ã€æŒ‰æ–‡ä»¶è¿›è¡Œçš„è®¾è®¡æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆAï¼šæ–°å¢ runtime_uuid å­—æ®µï¼‰

### 3.1 æ•°æ®åº“è¡¨ç»“æ„ä¿®æ”¹

#### æ–‡ä»¶ï¼šSQL è¿ç§»è„šæœ¬

**æ–°å»ºæ–‡ä»¶**: `scm-ai/src/main/resources/db/migration/V1.1__add_runtime_uuid_to_workflow_conversation.sql`

```sql
-- åŠŸèƒ½ï¼šä¸º ai_workflow_conversation_content è¡¨æ–°å¢ runtime_uuid å­—æ®µ
-- ä½œç”¨ï¼šå®ç°è¿è¡Œæ—¶çº§åˆ«çš„å¯¹è¯è®°å½•éš”ç¦»ï¼Œæ”¯æŒç²¾å‡†åˆ é™¤å•ä¸ª runtime çš„å¯¹è¯å†å²
-- æ—¥æœŸï¼š2025-01-08

ALTER TABLE ai_workflow_conversation_content
ADD COLUMN runtime_uuid VARCHAR(32) COMMENT 'è¿è¡Œæ—¶UUIDï¼Œå…³è” ai_workflow_runtime.runtime_uuid'
AFTER conversation_id;

-- ä¸ºæ–°å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œæå‡åˆ é™¤æ“ä½œæ€§èƒ½
CREATE INDEX idx_ai_workflow_conversation_content_runtime_uuid
ON ai_workflow_conversation_content(runtime_uuid);

-- æ³¨æ„ï¼šå†å²æ•°æ®çš„ runtime_uuid ä¸º NULL
-- å»ºè®®ï¼šåœ¨ä¸šåŠ¡ä»£ç ä¸­å¿½ç•¥ runtime_uuid=NULL çš„å†å²æ•°æ®ï¼Œæˆ–æ‰§è¡Œæ•°æ®æ¸…ç†
```

**å…³é”®è®¾è®¡å†³ç­–**ï¼š
- å­—æ®µç±»å‹ï¼š`VARCHAR(32)` - ä¸ `ai_workflow_runtime.runtime_uuid` ä¿æŒä¸€è‡´
- ç´¢å¼•ï¼šåˆ›å»ºç´¢å¼•ä¼˜åŒ–åˆ é™¤æŸ¥è¯¢æ€§èƒ½
- å†å²æ•°æ®ï¼šå…è®¸ NULLï¼Œä¸å½±å“å·²æœ‰æ•°æ®

---

### 3.2 åç«¯ä»£ç ä¿®æ”¹ï¼ˆè¯¦ç»†åˆ°æ–‡ä»¶çº§åˆ«ï¼‰

#### æ–‡ä»¶ 1: AiWorkflowConversationContentEntity.java
**è·¯å¾„**: `scm-bean/src/main/java/com/xinyirun/scm/bean/entity/workflow/AiWorkflowConversationContentEntity.java`

**ä¿®æ”¹ç±»å‹**: æ–°å¢å­—æ®µ

**ä¿®æ”¹å†…å®¹**:
```java
@TableName("ai_workflow_conversation_content")
public class AiWorkflowConversationContentEntity extends BaseEntity {

    @TableId(value = "id", type = IdType.AUTO)
    private Long id;

    @TableField("message_id")
    private String message_id;

    @TableField("conversation_id")
    private String conversation_id;

    // âœ… æ–°å¢å­—æ®µ
    @TableField("runtime_uuid")
    private String runtime_uuid;

    @TableField("type")
    private String type;

    // ... å…¶ä»–å­—æ®µä¿æŒä¸å˜
}
```

**å˜æ›´ç†ç”±**: å®ä½“ç±»éœ€è¦æ˜ å°„æ–°å¢çš„æ•°æ®åº“å­—æ®µ

---

#### æ–‡ä»¶ 2: ScmWorkflowMessageChatMemory.java
**è·¯å¾„**: `scm-ai/src/main/java/com/xinyirun/scm/ai/config/memory/ScmWorkflowMessageChatMemory.java`

**ä¿®æ”¹ç±»å‹**: ä¿®æ”¹ add() æ–¹æ³•é€»è¾‘ï¼Œä¼ é€’ runtime_uuid

**æ ¸å¿ƒæŒ‘æˆ˜**: Spring AI çš„ ChatMemory æ¥å£ç­¾åæ˜¯å›ºå®šçš„ï¼š
```java
void add(String conversationId, List<Message> messages);
```
- åªæœ‰ conversationId å‚æ•°
- æ²¡æœ‰ runtime_uuid å‚æ•°
- **å¦‚ä½•ä¼ é€’ runtime_uuidï¼Ÿ**

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ **ThreadLocal** å­˜å‚¨ runtime_uuid

**ä¿®æ”¹å†…å®¹**:
```java
@Service
@Slf4j
public class ScmWorkflowMessageChatMemory implements ChatMemory {

    private static final String TENANT_SEPARATOR = "::";

    // âœ… æ–°å¢ï¼šThreadLocal å­˜å‚¨å½“å‰çº¿ç¨‹çš„ runtime_uuid
    private static final ThreadLocal<String> CURRENT_RUNTIME_UUID = new ThreadLocal<>();

    @Resource
    private AiWorkflowConversationContentService aiWorkflowConversationContentService;

    /**
     * âœ… æ–°å¢ï¼šè®¾ç½®å½“å‰çº¿ç¨‹çš„ runtime_uuid
     * åœ¨ WorkflowUtil.streamingInvokeLLM() è°ƒç”¨ LLM å‰è®¾ç½®
     */
    public static void setRuntimeUuid(String runtimeUuid) {
        CURRENT_RUNTIME_UUID.set(runtimeUuid);
        log.debug("ğŸ”§ [ThreadLocal] è®¾ç½® runtime_uuid: {}", runtimeUuid);
    }

    /**
     * âœ… æ–°å¢ï¼šæ¸…ç†å½“å‰çº¿ç¨‹çš„ runtime_uuid
     * åœ¨ LLM è°ƒç”¨ç»“æŸåæ¸…ç†ï¼Œé˜²æ­¢çº¿ç¨‹å¤ç”¨å¯¼è‡´æ•°æ®æ±¡æŸ“
     */
    public static void clearRuntimeUuid() {
        String uuid = CURRENT_RUNTIME_UUID.get();
        CURRENT_RUNTIME_UUID.remove();
        log.debug("ğŸ§¹ [ThreadLocal] æ¸…ç† runtime_uuid: {}", uuid);
    }

    @Override
    public void add(String conversationId, List<Message> messages) {
        log.info("ğŸ’¾ [Memory] ChatMemory.add()è¢«è°ƒç”¨ - conversationId: {}, messagesæ•°é‡: {}",
                conversationId,
                messages != null ? messages.size() : 0);

        if (messages == null || messages.isEmpty()) {
            return;
        }

        try {
            // âœ… ä» ThreadLocal è·å– runtime_uuid
            String runtimeUuid = CURRENT_RUNTIME_UUID.get();
            log.info("ğŸ“‹ [Memory] ä»ThreadLocalè·å– runtime_uuid: {}", runtimeUuid);

            // ä»conversationIdè§£æç§Ÿæˆ·IDå¹¶è®¾ç½®æ•°æ®æº
            String tenantId = parseTenantId(conversationId);
            DataSourceHelper.use(tenantId);

            for (int i = 0; i < messages.size(); i++) {
                Message msg = messages.get(i);
                String messageType = msg.getMessageType().getValue();
                String content = extractMessageContent(msg);

                log.info("ğŸ“ [Memory] å¤„ç†æ¶ˆæ¯ #{} - ç±»å‹: {}, runtime_uuid: {}, å†…å®¹é•¿åº¦: {}",
                        i + 1, messageType, runtimeUuid, content != null ? content.length() : 0);

                // âœ… ä¿®æ”¹ï¼šä¼ é€’ runtime_uuid
                aiWorkflowConversationContentService.saveMessage(
                        conversationId,
                        messageType,
                        content,
                        runtimeUuid,  // â† æ–°å¢å‚æ•°
                        null,  // modelSourceId
                        null,  // providerName
                        null,  // baseName
                        null   // operatorId
                );

                log.info("âœ… [Memory] æˆåŠŸä¿å­˜{}æ¶ˆæ¯åˆ°æ•°æ®åº“ - conversationId: {}, runtime_uuid: {}",
                        messageType, conversationId, runtimeUuid);
            }
        } catch (Exception e) {
            log.error("âŒ [Memory] ä¿å­˜æ¶ˆæ¯å¤±è´¥ - conversationId: {}", conversationId, e);
        } finally {
            DataSourceHelper.close();
        }
    }

    // ... å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜
}
```

**å…³é”®è®¾è®¡ç‚¹**:
1. **ThreadLocal æ¨¡å¼**: è§£å†³ Spring AI æ¥å£é™åˆ¶
2. **çº¿ç¨‹å®‰å…¨**: æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹å­˜å‚¨ runtime_uuid
3. **èµ„æºæ¸…ç†**: å¿…é¡»åœ¨ finally ä¸­æ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

---

#### æ–‡ä»¶ 3: WorkflowUtil.java
**è·¯å¾„**: `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WorkflowUtil.java`

**ä¿®æ”¹ç±»å‹**: åœ¨ LLM è°ƒç”¨å‰åè®¾ç½®/æ¸…ç† runtime_uuid

**ä¿®æ”¹å†…å®¹**:
```java
public static void streamingInvokeLLM(WfState wfState, WfNodeState nodeState, AiWorkflowNodeVo node,
                                       String modelName, String prompt) {
    String conversationId = wfState.getConversationId();
    String runtimeUuid = wfState.getUuid();  // â† è·å– runtime_uuid

    log.info("invoke LLM (streaming), modelName: {}, conversationId: {}, runtime_uuid: {}, prompt length: {}",
            modelName, conversationId, runtimeUuid,
            StringUtils.isNotBlank(prompt) ? prompt.length() : 0);

    try {
        // ... æ„å»º chatOption çš„ä»£ç ä¿æŒä¸å˜ ...

        if (StringUtils.isBlank(conversationId)) {
            // æ— è®°å¿†æ¨¡å¼ - ä»£ç ä¿æŒä¸å˜
        } else {
            // âœ… æœ‰è®°å¿†æ¨¡å¼ - åœ¨è°ƒç”¨ LLM å‰è®¾ç½® runtime_uuid
            ScmWorkflowMessageChatMemory.setRuntimeUuid(runtimeUuid);

            try {
                chatOption.setConversationId(conversationId);

                aiChatBaseService.chatWithWorkflowMemoryStream(chatOption)
                        .chatResponse()
                        .doOnNext(chatResponse -> {
                            // Reactoræµå›è°ƒé€»è¾‘ä¿æŒä¸å˜
                        })
                        .blockLast();

            } finally {
                // âœ… LLM è°ƒç”¨ç»“æŸåæ¸…ç† runtime_uuid
                ScmWorkflowMessageChatMemory.clearRuntimeUuid();
            }
        }

        // ... åç»­å¤„ç†ä»£ç ä¿æŒä¸å˜ ...

    } catch (Exception e) {
        log.error("âŒ LLM invocation failed", e);
        throw new RuntimeException("LLMè°ƒç”¨å¤±è´¥: " + e.getMessage(), e);
    }
}
```

**å…³é”®è®¾è®¡ç‚¹**:
1. **è·å– runtime_uuid**: ä» `wfState.getUuid()` è·å–
2. **è®¾ç½®æ—¶æœº**: åœ¨è°ƒç”¨ `chatWithWorkflowMemoryStream()` ä¹‹å‰
3. **æ¸…ç†æ—¶æœº**: åœ¨ finally å—ä¸­ï¼Œç¡®ä¿å¼‚å¸¸æƒ…å†µä¹Ÿèƒ½æ¸…ç†

---

#### æ–‡ä»¶ 4: AiWorkflowConversationContentService.java
**è·¯å¾„**: `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/workflow/AiWorkflowConversationContentService.java`

**ä¿®æ”¹ç±»å‹**: ä¿®æ”¹ saveMessage() æ–¹æ³•ç­¾åï¼Œæ–°å¢ deleteByRuntimeUuid() æ–¹æ³•

**ä¿®æ”¹å†…å®¹**:
```java
@Service
@Slf4j
public class AiWorkflowConversationContentService {

    @Resource
    private AiWorkflowConversationContentMapper mapper;

    /**
     * ä¿å­˜å¯¹è¯æ¶ˆæ¯ï¼ˆWorkflowé¢†åŸŸä¸“ç”¨ï¼‰
     *
     * âœ… ä¿®æ”¹ï¼šæ–°å¢ runtimeUuid å‚æ•°
     */
    public void saveMessage(String conversationId,
                          String type,
                          String content,
                          String runtimeUuid,  // â† æ–°å¢å‚æ•°
                          Long modelSourceId,
                          String providerName,
                          String baseName,
                          Long operatorId) {

        AiWorkflowConversationContentEntity entity = new AiWorkflowConversationContentEntity();
        entity.setMessage_id(UuidUtil.createShort());
        entity.setConversation_id(conversationId);
        entity.setRuntime_uuid(runtimeUuid);  // âœ… è®¾ç½®æ–°å­—æ®µ
        entity.setType(type);
        entity.setContent(content);
        entity.setModel_source_id(modelSourceId);
        entity.setProvider_name(providerName);
        entity.setBase_name(baseName);
        entity.setOperator_id(operatorId);

        mapper.insert(entity);

        log.debug("ä¿å­˜Workflowå¯¹è¯æ¶ˆæ¯: conversation_id={}, runtime_uuid={}, type={}, content_length={}",
                conversationId, runtimeUuid, type, content != null ? content.length() : 0);
    }

    /**
     * âœ… æ–°å¢ï¼šæ ¹æ® runtime_uuid åˆ é™¤å¯¹è¯å†å²
     * ç”¨äºåˆ é™¤å•ä¸ªè¿è¡Œæ—¶å®ä¾‹çš„å¯¹è¯è®°å½•
     */
    public int deleteByRuntimeUuid(String runtimeUuid) {
        log.info("åˆ é™¤Workflowå¯¹è¯å†å² - runtime_uuid: {}", runtimeUuid);
        return mapper.deleteByRuntimeUuid(runtimeUuid);
    }

    /**
     * âš ï¸ ä¿ç•™ä½†æ ‡è®°ä¸ºåºŸå¼ƒï¼šæ ¹æ® conversation_id åˆ é™¤
     * æ­¤æ–¹æ³•ä¼šåˆ é™¤æ‰€æœ‰ runtime çš„å¯¹è¯ï¼Œä¸åº”å†ä½¿ç”¨
     */
    @Deprecated
    public int deleteByConversationId(String conversationId) {
        log.warn("âš ï¸ ä½¿ç”¨åºŸå¼ƒæ–¹æ³• deleteByConversationIdï¼Œå»ºè®®ä½¿ç”¨ deleteByRuntimeUuid");
        return mapper.deleteByConversationId(conversationId);
    }

    // ... å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜
}
```

**å…³é”®è®¾è®¡ç‚¹**:
1. **ç­¾åå˜æ›´**: saveMessage() æ–°å¢ runtimeUuid å‚æ•°
2. **æ–°æ–¹æ³•**: deleteByRuntimeUuid() å®ç°ç²¾å‡†åˆ é™¤
3. **åºŸå¼ƒæ ‡è®°**: æ—§æ–¹æ³•ä¿ç•™ä½†æ ‡è®° @Deprecatedï¼Œé˜²æ­¢è¯¯ç”¨

---

#### æ–‡ä»¶ 5: AiWorkflowConversationContentMapper.java
**è·¯å¾„**: `scm-ai/src/main/java/com/xinyirun/scm/ai/core/mapper/workflow/AiWorkflowConversationContentMapper.java`

**ä¿®æ”¹ç±»å‹**: æ–°å¢ deleteByRuntimeUuid() æ–¹æ³•

**ä¿®æ”¹å†…å®¹**:
```java
@Mapper
public interface AiWorkflowConversationContentMapper extends BaseMapper<AiWorkflowConversationContentEntity> {

    /**
     * âœ… æ–°å¢ï¼šæ ¹æ® runtime_uuid åˆ é™¤å¯¹è¯å†å²
     * åŠŸèƒ½ï¼šåˆ é™¤æŒ‡å®šè¿è¡Œæ—¶å®ä¾‹çš„æ‰€æœ‰å¯¹è¯è®°å½•
     */
    @Delete("""
        DELETE FROM ai_workflow_conversation_content
        WHERE runtime_uuid = #{runtimeUuid}
        """)
    int deleteByRuntimeUuid(@Param("runtimeUuid") String runtimeUuid);

    /**
     * âš ï¸ åºŸå¼ƒä½†ä¿ç•™ï¼šæ ¹æ® conversation_id åˆ é™¤
     * é—®é¢˜ï¼šä¼šè¯¯åˆ å…¶ä»– runtime å®ä¾‹çš„å¯¹è¯
     * å»ºè®®ï¼šä½¿ç”¨ deleteByRuntimeUuid ä»£æ›¿
     */
    @Deprecated
    @Delete("""
        DELETE FROM ai_workflow_conversation_content
        WHERE conversation_id = #{conversationId}
        """)
    int deleteByConversationId(@Param("conversationId") String conversationId);

    // ... å…¶ä»–æŸ¥è¯¢æ–¹æ³•ä¿æŒä¸å˜
}
```

---

#### æ–‡ä»¶ 6: AiWorkflowRuntimeService.java
**è·¯å¾„**: `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/workflow/AiWorkflowRuntimeService.java`

**ä¿®æ”¹ç±»å‹**: ä¿®æ”¹ delete() æ–¹æ³•ï¼Œä½¿ç”¨ runtime_uuid åˆ é™¤å¯¹è¯

**ä¿®æ”¹å†…å®¹**:
```java
public boolean delete(String runtimeUuid) {
    log.info("å¼€å§‹ç‰©ç†åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•: {}", runtimeUuid);

    AiWorkflowRuntimeEntity runtime = getByUuid(runtimeUuid);
    if (runtime == null) {
        throw new RuntimeException("è¿è¡Œå®ä¾‹ä¸å­˜åœ¨: " + runtimeUuid);
    }

    Long runtimeId = runtime.getId();

    // 1. çº§è”åˆ é™¤è¿è¡ŒèŠ‚ç‚¹è®°å½•ï¼ˆé€»è¾‘ä¿æŒä¸å˜ï¼‰
    int nodeCount = workflowRuntimeNodeService.deleteByRuntimeId(runtimeId);
    log.info("åˆ é™¤è¿è¡ŒèŠ‚ç‚¹è®°å½•: runtime_id={}, count={}", runtimeId, nodeCount);

    // 2. âœ… ä¿®æ”¹ï¼šä½¿ç”¨ runtime_uuid åˆ é™¤å¯¹è¯å†å²ï¼ˆè€Œä¸æ˜¯ conversation_idï¼‰
    int conversationCount = workflowConversationContentService.deleteByRuntimeUuid(runtimeUuid);
    log.info("åˆ é™¤å¯¹è¯å†å²: runtime_uuid={}, count={}", runtimeUuid, conversationCount);

    // 3. ç‰©ç†åˆ é™¤ä¸»è®°å½•ï¼ˆé€»è¾‘ä¿æŒä¸å˜ï¼‰
    int result = aiWorkflowRuntimeMapper.deleteById(runtimeId);
    log.info("åˆ é™¤è¿è¡Œè®°å½•: runtime_id={}, result={}", runtimeId, result);

    return result > 0;
}
```

**å…³é”®å˜æ›´**:
- **åˆ é™¤å‰**: `deleteByConversationId(conversationId)` - é”™è¯¯åˆ é™¤æ‰€æœ‰ runtime çš„å¯¹è¯
- **åˆ é™¤å**: `deleteByRuntimeUuid(runtimeUuid)` - ç²¾å‡†åˆ é™¤å•ä¸ª runtime çš„å¯¹è¯

---

### 3.3 ä¿®æ”¹æ–‡ä»¶æ¸…å•æ€»ç»“

| åºå· | æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | å…³é”®å˜æ›´ |
|-----|---------|---------|---------|
| 1 | `db/migration/V1.1__add_runtime_uuid.sql` | æ–°å»º | æ–°å¢ runtime_uuid å­—æ®µ + ç´¢å¼• |
| 2 | `scm-bean/.../AiWorkflowConversationContentEntity.java` | æ–°å¢å­—æ®µ | æ–°å¢ runtime_uuid å­—æ®µæ˜ å°„ |
| 3 | `scm-ai/.../ScmWorkflowMessageChatMemory.java` | é€»è¾‘ä¿®æ”¹ | ThreadLocal ä¼ é€’ runtime_uuid |
| 4 | `scm-ai/.../WorkflowUtil.java` | é€»è¾‘ä¿®æ”¹ | LLM è°ƒç”¨å‰åè®¾ç½®/æ¸…ç† runtime_uuid |
| 5 | `scm-ai/.../AiWorkflowConversationContentService.java` | æ–¹æ³•ç­¾å | saveMessage() æ–°å¢å‚æ•° + æ–°å¢ deleteByRuntimeUuid() |
| 6 | `scm-ai/.../AiWorkflowConversationContentMapper.java` | æ–°å¢æ–¹æ³• | deleteByRuntimeUuid() SQL |
| 7 | `scm-ai/.../AiWorkflowRuntimeService.java` | é€»è¾‘ä¿®æ”¹ | delete() ä½¿ç”¨ runtime_uuid åˆ é™¤ |

**å½±å“èŒƒå›´**: ä»… Workflow é¢†åŸŸï¼Œä¸å½±å“ Chat é¢†åŸŸï¼ˆai_conversation_content è¡¨ï¼‰

---

## å››ã€æ”¯æ’‘æ•°æ®å’Œåˆ†æ

### 4.1 conversationId æ ¼å¼åˆ†æ

**Chat é¢†åŸŸ** (ai_conversation_content):
- æ ¼å¼: `tenantCode::conversationUUID`
- ç‰¹ç‚¹: conversationUUID æ˜¯æ¯æ¬¡å¯¹è¯ä¼šè¯çš„å”¯ä¸€ID
- åˆ é™¤: åˆ é™¤ä¸€ä¸ª conversation ä¸ä¼šè¯¯åˆ å…¶ä»– conversation

**Workflow é¢†åŸŸ** (ai_workflow_conversation_content):
- æ ¼å¼: `tenantCode::workflowUuid::userId`
- ç‰¹ç‚¹: **å·¥ä½œæµçº§åˆ«è®°å¿†**ï¼Œå¤šä¸ª runtime å…±äº«
- é—®é¢˜: åˆ é™¤ä¸€ä¸ª runtime ä¼šè¯¯åˆ å…¶ä»– runtime çš„å¯¹è¯

**å¯¹æ¯”è¡¨**:

| é¢†åŸŸ | conversationId æ ¼å¼ | å”¯ä¸€æ€§ | åˆ é™¤é—®é¢˜ |
|-----|-------------------|-------|---------|
| Chat | `tenant::uuid` | âœ… å”¯ä¸€ | âœ… æ— é—®é¢˜ |
| Workflow | `tenant::workflow::user` | âŒ éå”¯ä¸€ | âŒ è¯¯åˆ é—®é¢˜ |

### 4.2 Runtime å’Œ ConversationId çš„æ•°é‡å…³ç³»

**å®é™…åœºæ™¯ç¤ºä¾‹**:

```
ç”¨æˆ·: user_123
å·¥ä½œæµ: workflow_abc

runtime_1:
  - runtime_uuid: "rt_001"
  - conversation_id: "tenant01::workflow_abc::user_123"
  - å¯¹è¯: ["ä½ å¥½", "æˆ‘æ˜¯Claude"]

runtime_2:
  - runtime_uuid: "rt_002"
  - conversation_id: "tenant01::workflow_abc::user_123"  â† ç›¸åŒï¼
  - å¯¹è¯: ["ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·", "æ™´å¤©"]

runtime_3:
  - runtime_uuid: "rt_003"
  - conversation_id: "tenant01::workflow_abc::user_123"  â† ç›¸åŒï¼
  - å¯¹è¯: ["å¸®æˆ‘å†™ä»£ç ", "å¥½çš„"]

åˆ é™¤ runtime_1 æ—¶ï¼š
âŒ æ—§é€»è¾‘: DELETE WHERE conversation_id = 'tenant01::workflow_abc::user_123'
   â†’ åˆ é™¤äº†æ‰€æœ‰3ä¸ªruntimeçš„å¯¹è¯ï¼ˆ6æ¡æ¶ˆæ¯å…¨éƒ¨ä¸¢å¤±ï¼‰

âœ… æ–°é€»è¾‘: DELETE WHERE runtime_uuid = 'rt_001'
   â†’ åªåˆ é™¤ runtime_1 çš„å¯¹è¯ï¼ˆ2æ¡æ¶ˆæ¯ï¼‰
```

### 4.3 Spring AI æ¡†æ¶çº¦æŸåˆ†æ

**MessageChatMemoryAdvisor å·¥ä½œåŸç†**:

```java
// Spring AI æºç ï¼ˆç®€åŒ–ç‰ˆï¼‰
public class MessageChatMemoryAdvisor {

    private final ChatMemory chatMemory;

    public ChatResponse aroundCall(ChatRequest request) {
        String conversationId = request.getAdvisorParams()
            .get(ChatMemory.CONVERSATION_ID);

        // 1. åœ¨è°ƒç”¨ LLM å‰ï¼Œè‡ªåŠ¨ä¿å­˜ USER æ¶ˆæ¯
        chatMemory.add(conversationId, List.of(userMessage));

        // 2. è°ƒç”¨ LLM
        ChatResponse response = callLLM(request);

        // 3. åœ¨è°ƒç”¨ LLM åï¼Œè‡ªåŠ¨ä¿å­˜ ASSISTANT æ¶ˆæ¯
        chatMemory.add(conversationId, List.of(assistantMessage));

        return response;
    }
}
```

**æ¥å£çº¦æŸ**:
```java
public interface ChatMemory {
    void add(String conversationId, List<Message> messages);
    List<Message> get(String conversationId, int lastN);
    void clear(String conversationId);
}
```

**é—®é¢˜**:
- `add()` æ–¹æ³•åªæœ‰ `conversationId` å‚æ•°
- æ— æ³•ç›´æ¥ä¼ é€’ `runtime_uuid`

**è§£å†³æ–¹æ¡ˆ**: ThreadLocal

```java
// è°ƒç”¨é“¾è·¯ï¼š
WorkflowUtil.streamingInvokeLLM()
  â”œâ”€ è®¾ç½®: ScmWorkflowMessageChatMemory.setRuntimeUuid(uuid)
  â”œâ”€ è°ƒç”¨: aiChatBaseService.chatWithWorkflowMemoryStream()
  â”‚    â†“
  â”‚  MessageChatMemoryAdvisor.aroundCall()
  â”‚    â†“
  â”‚  ScmWorkflowMessageChatMemory.add(conversationId, messages)
  â”‚    â””â”€ è·å–: CURRENT_RUNTIME_UUID.get()  â† ThreadLocal
  â”‚
  â””â”€ æ¸…ç†: ScmWorkflowMessageChatMemory.clearRuntimeUuid()
```

**ä¸ºä»€ä¹ˆ ThreadLocal å®‰å…¨ï¼Ÿ**
1. **çº¿ç¨‹éš”ç¦»**: æ¯ä¸ª HTTP è¯·æ±‚ç”±ç‹¬ç«‹çº¿ç¨‹å¤„ç†
2. **ç”Ÿå‘½å‘¨æœŸçŸ­**: è¯·æ±‚å¼€å§‹è®¾ç½®ï¼Œè¯·æ±‚ç»“æŸæ¸…ç†
3. **å¼‚å¸¸å®‰å…¨**: finally å—ç¡®ä¿æ¸…ç†

---

## äº”ã€æ–¹æ¡ˆè®¾è®¡ï¼ˆæ—¶åºå›¾ + æ¶æ„å›¾ï¼‰

### 5.1 ä¿®æ”¹åçš„å®Œæ•´æ—¶åºå›¾

```
ç”¨æˆ·                 Controller              Service                Mapper              ChatMemory           ThreadLocal
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚                   â”‚
 â”‚â”€â”€â”€â”€â”€POST deleteâ”€â”€â”€â”€â†’â”‚                      â”‚                      â”‚                      â”‚                   â”‚
 â”‚   runtime_uuid      â”‚                      â”‚                      â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚                   â”‚
 â”‚                      â”‚â”€â”€delete(uuid)â”€â”€â”€â”€â”€â”€â†’â”‚                      â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚â”€â”€getByUuid()â”€â”€â”€â”€â”€â”€â”€â†’â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚â†â”€runtime entityâ”€â”€â”€â”€â”€â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚â”€â”€deleteByRuntimeIdâ†’â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚  (è¿è¡ŒèŠ‚ç‚¹)          â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚â†â”€nodeCountâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚â”€â”€deleteByRuntimeUuidâ†’â”‚  âœ… æ–°æ–¹æ³•          â”‚                   â”‚
 â”‚                      â”‚                      â”‚  (å¯¹è¯å†å²)          â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚                      â”‚â”€â”€DELETE WHEREâ”€â”€â”€â”€â†’ Database           â”‚
 â”‚                      â”‚                      â”‚                      â”‚  runtime_uuid=?    âœ… ç²¾å‡†åˆ é™¤        â”‚
 â”‚                      â”‚                      â”‚â†â”€conversationCountâ”€â”€â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚â”€â”€deleteById()â”€â”€â”€â”€â”€â”€â†’â”‚                      â”‚                   â”‚
 â”‚                      â”‚                      â”‚  (ä¸»è®°å½•)            â”‚                      â”‚                   â”‚
 â”‚                      â”‚â†â”€trueâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                      â”‚                   â”‚
 â”‚â†â”€â”€â”€â”€â”€200 OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                      â”‚                      â”‚                   â”‚


ã€å¯¹è¯ä¿å­˜é˜¶æ®µ - ä¿®æ”¹åã€‘
WorkflowUtil          ChatMemory             ThreadLocal            Service               Mapper
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚
 â”‚â”€â”€setRuntimeUuidâ”€â”€â”€â”€â†’â”‚                      â”‚                      â”‚                      â”‚
 â”‚  (wfState.uuid)      â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚â”€â”€set(uuid)â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ âœ… å­˜å‚¨              â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚
 â”‚â”€â”€chatWithMemoryâ”€â”€â”€â”€â†’â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚
 â”‚                 [Spring AI Advisor]        â”‚                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚â”€â”€add(conversationId,â”‚                      â”‚                      â”‚
 â”‚                      â”‚      messages)       â”‚                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚â”€â”€get()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ âœ… è·å–              â”‚                      â”‚
 â”‚                      â”‚â†â”€runtime_uuidâ”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚â”€â”€saveMessage(       â”‚                      â”‚                      â”‚
 â”‚                      â”‚    conversationId,   â”‚                      â”‚                      â”‚
 â”‚                      â”‚    type,             â”‚                      â”‚                      â”‚
 â”‚                      â”‚    content,          â”‚                      â”‚                      â”‚
 â”‚                      â”‚    runtime_uuid)â”€â”€â”€â”€â†’â”‚ âœ… ä¼ é€’             â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚â”€â”€insert()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
 â”‚                      â”‚                      â”‚                      â”‚  (å«runtime_uuid)  â”‚
 â”‚                      â”‚                      â”‚                      â”‚                      â”‚
 â”‚â”€â”€clearRuntimeUuidâ”€â”€â†’â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚â”€â”€remove()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ âœ… æ¸…ç†              â”‚                      â”‚
```

### 5.2 æ•°æ®æµæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Workflow Execution                          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ WfState    â”‚          â”‚ WorkflowUtil â”‚                      â”‚
â”‚  â”‚            â”‚          â”‚              â”‚                      â”‚
â”‚  â”‚ - uuid     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ LLM è°ƒç”¨å‰ï¼š â”‚                      â”‚
â”‚  â”‚ - conversationId      â”‚ setRuntimeUuid()                   â”‚
â”‚  â”‚ - tenantCode â”‚        â”‚              â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ LLM è°ƒç”¨åï¼š â”‚                      â”‚
â”‚                          â”‚ clearRuntimeUuid()                  â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â†“ chatWithWorkflowMemoryStream()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Spring AI Framework                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ MessageChatMemoryAdvisor  â”‚                                 â”‚
â”‚  â”‚                           â”‚                                 â”‚
â”‚  â”‚  1. æ‹¦æˆª LLM è¯·æ±‚         â”‚                                 â”‚
â”‚  â”‚  2. è°ƒç”¨ ChatMemory.add() â”‚                                 â”‚
â”‚  â”‚  3. ä¼ é€’ conversationId   â”‚ â† åªæœ‰è¿™ä¸ªå‚æ•°                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â†“ add(conversationId, messages)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ScmWorkflowMessageChatMemory                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ ThreadLocal      â”‚        â”‚ add() æ–¹æ³•        â”‚              â”‚
â”‚  â”‚                  â”‚        â”‚                  â”‚              â”‚
â”‚  â”‚ CURRENT_RUNTIME  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”‚ 1. get()         â”‚              â”‚
â”‚  â”‚ _UUID            â”‚        â”‚    runtime_uuid  â”‚              â”‚
â”‚  â”‚                  â”‚        â”‚                  â”‚              â”‚
â”‚  â”‚ - set()          â”‚        â”‚ 2. saveMessage(  â”‚              â”‚
â”‚  â”‚ - get()          â”‚        â”‚      conversationId,           â”‚
â”‚  â”‚ - remove()       â”‚        â”‚      type,       â”‚              â”‚
â”‚  â”‚                  â”‚        â”‚      content,    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚      runtime_uuid) â† ä¼ é€’      â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â†“ saveMessage()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          AiWorkflowConversationContentService                   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ saveMessage(                       â”‚                        â”‚
â”‚  â”‚   conversationId,                  â”‚                        â”‚
â”‚  â”‚   type,                            â”‚                        â”‚
â”‚  â”‚   content,                         â”‚                        â”‚
â”‚  â”‚   runtime_uuid  â† æ¥æ”¶             â”‚                        â”‚
â”‚  â”‚ )                                  â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                   â”‚                             â”‚
â”‚                                   â†“ insert()                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ Mapper.insert(entity)              â”‚                        â”‚
â”‚  â”‚   - conversation_id                â”‚                        â”‚
â”‚  â”‚   - runtime_uuid â† ä¿å­˜åˆ°æ•°æ®åº“    â”‚                        â”‚
â”‚  â”‚   - type                           â”‚                        â”‚
â”‚  â”‚   - content                        â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Database                               â”‚
â”‚                                                                 â”‚
â”‚  ai_workflow_conversation_content                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ id | message_id | conversation_id |       â”‚                 â”‚
â”‚  â”‚    | runtime_uuid âœ… | type | content    â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ 1  | msg_001    | tenant::wf::user |      â”‚                 â”‚
â”‚  â”‚    | rt_001      | USER | ä½ å¥½           â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ 2  | msg_002    | tenant::wf::user |      â”‚                 â”‚
â”‚  â”‚    | rt_001      | ASSISTANT | æ‚¨å¥½      â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ 3  | msg_003    | tenant::wf::user |      â”‚                 â”‚
â”‚  â”‚    | rt_002 âœ…   | USER | å¤©æ°”           â”‚ â† ä¸åŒruntime   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                 â”‚
â”‚  åˆ é™¤æ“ä½œï¼š                                                     â”‚
â”‚  DELETE WHERE runtime_uuid = 'rt_001' âœ…                       â”‚
â”‚  â†’ åªåˆ é™¤ msg_001, msg_002                                     â”‚
â”‚  â†’ msg_003 ä¿ç•™ï¼ˆä¸åŒ runtime_uuidï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€KISSåŸåˆ™4é—®é¢˜å›ç­”

### é—®é¢˜1: "è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ"

âœ… **çœŸå®é—®é¢˜**

**è¯æ®**:
1. ç”¨æˆ·å®é™…é‡åˆ°ï¼šåˆ é™¤ä¸€ä¸ª runtime å®ä¾‹åï¼Œæ‰€æœ‰å¯¹è¯å†å²éƒ½è¢«æ¸…ç©º
2. ä»£ç é€»è¾‘ç¡®è®¤ï¼š`DELETE WHERE conversation_id = ?` ä¼šåˆ é™¤å¤šä¸ª runtime çš„æ•°æ®
3. æ•°æ®ç»“æ„ç¼ºé™·ï¼šconversationId æ ¼å¼ `tenant::workflow::user` ä¸åŒ…å« runtime å”¯ä¸€æ ‡è¯†

**å½±å“**:
- æ•°æ®ä¸¢å¤±ï¼šç”¨æˆ·çš„å†å²å¯¹è¯è®°å½•è¢«è¯¯åˆ 
- é¢‘ç‡ï¼šæ¯æ¬¡åˆ é™¤ runtime å¿…ç°
- ä¸¥é‡æ€§ï¼šé«˜ - æ¶‰åŠç”¨æˆ·æ•°æ®å®Œæ•´æ€§

### é—®é¢˜2: "æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ"

**è€ƒè™‘è¿‡çš„æ–¹æ¡ˆ**:

| æ–¹æ¡ˆ | æè¿° | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ˜¯å¦é‡‡ç”¨ |
|-----|------|------|------|---------|
| A. æ–°å¢ runtime_uuid å­—æ®µ | æœ¬æ–¹æ¡ˆ | ç²¾å‡†éš”ç¦»ï¼Œæ€§èƒ½å¥½ | éœ€ä¿®æ”¹è¡¨ç»“æ„ | âœ… é‡‡ç”¨ |
| B. ä¿®æ”¹ conversationId æ ¼å¼ | æ”¹ä¸º `tenant::workflow::user::runtime` | æ— éœ€æ–°å¢å­—æ®µ | ç ´åç°æœ‰æ ¼å¼ï¼Œéœ€è¿ç§»å†å²æ•°æ® | âŒ å¤æ‚åº¦é«˜ |
| C. è½¯åˆ é™¤æ ‡è®° | æ–°å¢ deleted_at å­—æ®µ | å¯æ¢å¤æ•°æ® | æŸ¥è¯¢éœ€åŠ è¿‡æ»¤æ¡ä»¶ï¼Œæ€§èƒ½å·® | âŒ å¤æ‚åº¦é«˜ |
| D. ä¸åˆ é™¤å¯¹è¯å†å² | åªåˆ é™¤ runtime ä¸»è®°å½• | æœ€ç®€å• | æ•°æ®æ³„æ¼é£é™©ï¼Œä¸ç¬¦åˆéšç§ä¿æŠ¤ | âŒ ä¸åˆç† |

**ç»“è®º**: æ–¹æ¡ˆA æ˜¯**æœ€ç®€å•ä¸”æœ‰æ•ˆ**çš„è§£å†³æ–¹æ¡ˆ
- **ç®€å•æ€§**: åªæ–°å¢1ä¸ªå­—æ®µï¼Œä¿®æ”¹7ä¸ªæ–‡ä»¶
- **æœ‰æ•ˆæ€§**: å®Œå…¨è§£å†³é—®é¢˜ï¼Œæ— å‰¯ä½œç”¨
- **æ€§èƒ½**: ç´¢å¼•ä¼˜åŒ–ï¼Œåˆ é™¤æ€§èƒ½ä¸å—å½±å“

### é—®é¢˜3: "ä¼šç ´åä»€ä¹ˆå—ï¼Ÿ"

âœ… **å‘åå…¼å®¹**

**å†å²æ•°æ®å…¼å®¹**:
- æ–°å¢å­—æ®µå…è®¸ NULL
- å†å²è®°å½•çš„ runtime_uuid ä¸º NULL
- æŸ¥è¯¢é€»è¾‘ä¸å—å½±å“ï¼ˆæŸ¥è¯¢ä¸ä¾èµ– runtime_uuidï¼‰

**API å…¼å®¹**:
- åˆ é™¤æ¥å£ï¼š`POST /api/v1/ai/workflow/runtime/del/{runtimeUuid}` - ç­¾åä¸å˜
- æŸ¥è¯¢æ¥å£ï¼šä¸æ¶‰åŠä¿®æ”¹

**ä»£ç å…¼å®¹**:
- æ—§çš„ `deleteByConversationId()` æ–¹æ³•ä¿ç•™ä½†æ ‡è®° @Deprecated
- ä¸ä¼šå½±å“å…¶ä»–æ¨¡å—ï¼ˆChat é¢†åŸŸä¸å—å½±å“ï¼‰

**æ•°æ®è¿ç§»**:
- **ä¸éœ€è¦**è¿ç§»å†å²æ•°æ®
- æ–°æ•°æ®è‡ªåŠ¨åŒ…å« runtime_uuid
- å†å²æ•°æ®å¯é€‰æ‹©æ€§æ¸…ç†æˆ–ä¿æŒ NULL

**é£é™©ç‚¹**:
- âš ï¸ ThreadLocal èµ„æºæ³„æ¼é£é™© â†’ é€šè¿‡ finally æ¸…ç†è§£å†³
- âš ï¸ å¹¶å‘åœºæ™¯ä¸‹ ThreadLocal æ··ä¹± â†’ æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹çº¿ç¨‹ï¼Œæ— é—®é¢˜

### é—®é¢˜4: "å½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—ï¼Ÿ"

âœ… **å¿…è¦åŠŸèƒ½**

**ä¸šåŠ¡éœ€æ±‚**:
- ç”¨æˆ·éšç§ä¿æŠ¤ï¼šåˆ é™¤ runtime æ—¶å¿…é¡»åˆ é™¤å¯¹è¯å†å²
- æ•°æ®éš”ç¦»ï¼šå¤šæ¬¡æ‰§è¡Œå·¥ä½œæµçš„å¯¹è¯è®°å½•ä¸åº”äº’ç›¸å½±å“
- æ•°æ®å®Œæ•´æ€§ï¼šåˆ é™¤æ“ä½œä¸åº”è¯¯åˆ å…¶ä»–æ•°æ®

**æŠ€æœ¯éœ€æ±‚**:
- ç¬¦åˆ GDPR ç­‰æ•°æ®ä¿æŠ¤æ³•è§„
- ç¬¦åˆ SCM ç³»ç»Ÿçš„å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡
- é˜²æ­¢æ•°æ®æ³„æ¼å’Œè¯¯åˆ 

**æ›¿ä»£æ–¹æ¡ˆ**:
- å¦‚æœä¸ä¿®å¤ï¼šç”¨æˆ·ä¼šä¸¢å¤±æ•°æ® â†’ **ä¸å¯æ¥å—**
- å¦‚æœä¸åˆ é™¤å¯¹è¯ï¼šæ•°æ®æ³„æ¼é£é™© â†’ **ä¸å¯æ¥å—**

**ç»“è®º**: è¿™æ˜¯**å¿…é¡»è§£å†³**çš„é—®é¢˜ï¼Œä¸æ˜¯å¯é€‰åŠŸèƒ½

---

## ä¸ƒã€é£é™©åˆ†æå’Œç¼“è§£æªæ–½

### 7.1 æŠ€æœ¯é£é™©

| é£é™© | ä¸¥é‡æ€§ | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|-----|-------|------|------|---------|
| ThreadLocal æœªæ¸…ç†å¯¼è‡´å†…å­˜æ³„æ¼ | é«˜ | ä¸­ | å†…å­˜æº¢å‡º | finally å—å¼ºåˆ¶æ¸…ç† + å•å…ƒæµ‹è¯•éªŒè¯ |
| å¹¶å‘åœºæ™¯ä¸‹ runtime_uuid æ··ä¹± | é«˜ | ä½ | æ•°æ®é”™ä¹± | æ¯ä¸ª HTTP è¯·æ±‚ç‹¬ç«‹çº¿ç¨‹ï¼Œæ— å…±äº« |
| å†å²æ•°æ® runtime_uuid=NULL | ä¸­ | é«˜ | æŸ¥è¯¢å¼‚å¸¸ | æŸ¥è¯¢é€»è¾‘ä¸ä¾èµ–æ­¤å­—æ®µï¼Œä¸å—å½±å“ |
| ç´¢å¼•æ€§èƒ½å½±å“ | ä½ | ä½ | æŸ¥è¯¢å˜æ…¢ | å·²åˆ›å»ºç´¢å¼•ï¼Œåˆ é™¤æ“ä½œæ€§èƒ½ä¸å—å½±å“ |
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ä¸­ | ä½ | æœåŠ¡ä¸å¯ç”¨ | è¿ç§»è„šæœ¬å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ |

### 7.2 ä¸šåŠ¡é£é™©

| é£é™© | ä¸¥é‡æ€§ | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|-----|-------|------|------|---------|
| åˆ é™¤é€»è¾‘é”™è¯¯å¯¼è‡´æ•°æ®ä¸¢å¤± | é«˜ | ä½ | ç”¨æˆ·æ•°æ®ä¸¢å¤± | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•è¦†ç›–åˆ é™¤åœºæ™¯ |
| ä¿®æ”¹å½±å“ Chat é¢†åŸŸ | é«˜ | ä½ | Chat åŠŸèƒ½å¼‚å¸¸ | æ˜ç¡®åªä¿®æ”¹ Workflow é¢†åŸŸï¼ŒChat ä¸å˜ |
| ThreadLocal åœ¨å¼‚æ­¥åœºæ™¯å¤±æ•ˆ | ä¸­ | ä¸­ | runtime_uuid ä¸º NULL | ç¡®ä¿ LLM è°ƒç”¨åœ¨åŒä¸€çº¿ç¨‹ï¼Œä¸è·¨çº¿ç¨‹ |

### 7.3 å…¼å®¹æ€§é£é™©

| é£é™© | ä¸¥é‡æ€§ | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|-----|-------|------|------|---------|
| å†å² runtime åˆ é™¤å¤±è´¥ | ä¸­ | ä¸­ | å†å²æ•°æ®æ®‹ç•™ | WHERE runtime_uuid IS NOT NULL OR ... å…¼å®¹ NULL |
| API è°ƒç”¨æ–¹å—å½±å“ | ä½ | ä½ | å‰ç«¯æŠ¥é”™ | API ç­¾åä¸å˜ï¼Œæ— å½±å“ |

### 7.4 ç¼“è§£æªæ–½æ€»ç»“

**ä»£ç å±‚é¢**:
1. âœ… finally å—å¼ºåˆ¶æ¸…ç† ThreadLocal
2. âœ… å•å…ƒæµ‹è¯•è¦†ç›– ThreadLocal è®¾ç½®/æ¸…ç†é€»è¾‘
3. âœ… é›†æˆæµ‹è¯•è¦†ç›–åˆ é™¤åœºæ™¯ï¼ˆæ­£å¸¸åˆ é™¤ + è¯¯åˆ æ£€æµ‹ï¼‰

**æµ‹è¯•å±‚é¢**:
1. âœ… å•å…ƒæµ‹è¯•ï¼šThreadLocal ç”Ÿå‘½å‘¨æœŸæµ‹è¯•
2. âœ… é›†æˆæµ‹è¯•ï¼šåˆ é™¤æ“ä½œéš”ç¦»æ€§æµ‹è¯•
3. âœ… æ€§èƒ½æµ‹è¯•ï¼šåˆ é™¤æ“ä½œæ€§èƒ½æµ‹è¯•

**è¿ç»´å±‚é¢**:
1. âœ… æ•°æ®åº“è¿ç§»è„šæœ¬å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
2. âœ… ç›‘æ§æ—¥å¿—ï¼šè§‚å¯Ÿ ThreadLocal æ¸…ç†æ—¥å¿—
3. âœ… å›æ»šæ–¹æ¡ˆï¼šä¿ç•™æ—§æ–¹æ³• deleteByConversationId()ï¼Œå¿…è¦æ—¶å›æ»š

---

## å…«ã€å®æ–½è®¡åˆ’

### 8.1 å¼€å‘é˜¶æ®µ

| åºå· | ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº |
|-----|------|---------|--------|
| 1 | æ•°æ®åº“è¿ç§»è„šæœ¬ç¼–å†™ | 0.5h | å¾…å®š |
| 2 | Entity ç±»æ–°å¢å­—æ®µ | 0.5h | å¾…å®š |
| 3 | ScmWorkflowMessageChatMemory ä¿®æ”¹ | 1h | å¾…å®š |
| 4 | WorkflowUtil ä¿®æ”¹ | 0.5h | å¾…å®š |
| 5 | Service å’Œ Mapper ä¿®æ”¹ | 1h | å¾…å®š |
| 6 | å•å…ƒæµ‹è¯•ç¼–å†™ | 1h | å¾…å®š |
| 7 | é›†æˆæµ‹è¯•ç¼–å†™ | 1h | å¾…å®š |

**æ€»è®¡**: çº¦ 5.5 å°æ—¶

### 8.2 æµ‹è¯•è®¡åˆ’

**å•å…ƒæµ‹è¯•**:
- ScmWorkflowMessageChatMemory: ThreadLocal è®¾ç½®/è·å–/æ¸…ç†
- AiWorkflowRuntimeService: åˆ é™¤é€»è¾‘è¦†ç›–

**é›†æˆæµ‹è¯•**:
- åœºæ™¯1ï¼šåˆ›å»º3ä¸ªruntime â†’ åˆ é™¤1ä¸ª â†’ éªŒè¯å…¶ä»–2ä¸ªå¯¹è¯ä»å­˜åœ¨
- åœºæ™¯2ï¼šåˆ›å»ºruntime â†’ ä¿å­˜å¯¹è¯ â†’ åˆ é™¤runtime â†’ éªŒè¯å¯¹è¯è¢«åˆ é™¤
- åœºæ™¯3ï¼šå¹¶å‘åˆ›å»ºå¤šä¸ªruntime â†’ éªŒè¯ runtime_uuid æ­£ç¡®éš”ç¦»

**æ€§èƒ½æµ‹è¯•**:
- åˆ é™¤æ“ä½œå“åº”æ—¶é—´ < 500msï¼ˆåŒ…å«åˆ é™¤å¯¹è¯å†å²ï¼‰

### 8.3 éƒ¨ç½²è®¡åˆ’

1. **æµ‹è¯•ç¯å¢ƒéªŒè¯**: æ‰§è¡Œæ•°æ®åº“è¿ç§» + åŠŸèƒ½æµ‹è¯•
2. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**:
   - æ•°æ®åº“è¿ç§»ï¼ˆALTER TABLEï¼Œä½å³°æœŸæ‰§è¡Œï¼‰
   - åº”ç”¨ä»£ç éƒ¨ç½²ï¼ˆæ»šåŠ¨å‘å¸ƒï¼Œç¡®ä¿é›¶åœæœºï¼‰
3. **ç›‘æ§è§‚å¯Ÿ**: è§‚å¯Ÿæ—¥å¿—ï¼Œç¡®è®¤ ThreadLocal æ­£å¸¸å·¥ä½œ

---

## ä¹ã€æ€»ç»“

### 9.1 æ–¹æ¡ˆä¼˜åŠ¿

1. âœ… **ç²¾å‡†éš”ç¦»**: æ¯ä¸ª runtime å®ä¾‹çš„å¯¹è¯è®°å½•ç‹¬ç«‹ç®¡ç†
2. âœ… **å‘åå…¼å®¹**: ä¸å½±å“å†å²æ•°æ®ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½
3. âœ… **æ€§èƒ½ä¼˜åŒ–**: ç´¢å¼•æ”¯æŒï¼Œåˆ é™¤æ“ä½œæ€§èƒ½ä¸å—å½±å“
4. âœ… **ç®€æ´è®¾è®¡**: åªæ–°å¢1ä¸ªå­—æ®µï¼Œä¿®æ”¹7ä¸ªæ–‡ä»¶
5. âœ… **ç¬¦åˆ Spring AI æ¡†æ¶**: ä½¿ç”¨ ThreadLocal ä¼˜é›…è§£å†³æ¥å£é™åˆ¶

### 9.2 å…³é”®æŠ€æœ¯ç‚¹

1. **ThreadLocal ä¼ é€’ runtime_uuid**: è§£å†³ Spring AI æ¥å£å‚æ•°é™åˆ¶
2. **finally å—èµ„æºæ¸…ç†**: ç¡®ä¿ ThreadLocal ä¸æ³„æ¼
3. **ç´¢å¼•ä¼˜åŒ–**: æ”¯æŒé«˜æ•ˆçš„ runtime_uuid åˆ é™¤æŸ¥è¯¢
4. **é¢†åŸŸéš”ç¦»**: åªä¿®æ”¹ Workflow é¢†åŸŸï¼Œä¸å½±å“ Chat é¢†åŸŸ

### 9.3 é¢„æœŸæ•ˆæœ

**ä¿®å¤å‰**:
- åˆ é™¤ runtime_1 â†’ åˆ é™¤æ‰€æœ‰ runtime çš„å¯¹è¯ï¼ˆæ•°æ®ä¸¢å¤±ï¼‰

**ä¿®å¤å**:
- åˆ é™¤ runtime_1 â†’ åªåˆ é™¤ runtime_1 çš„å¯¹è¯ï¼ˆç²¾å‡†éš”ç¦»ï¼‰

---

**æ–¹æ¡ˆçŠ¶æ€**: å¾…å®¡æ‰¹
**ä¸‹ä¸€æ­¥**: ç­‰å¾…ç”¨æˆ·æ‰¹å‡†åè¿›å…¥ç¼–ç é˜¶æ®µ
