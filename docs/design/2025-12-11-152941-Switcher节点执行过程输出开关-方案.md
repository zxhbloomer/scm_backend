# Switcher节点(权限判断条件)增加"执行过程输出"开关

## 需求背景

用户在测试MCP工具节点的"执行过程输出"开关时发现，即使MCP工具节点的开关关闭，聊天界面仍然显示"OK"。经过日志分析，发现"OK"来自下游的Switcher节点（权限判断条件），而非MCP工具节点本身。

**问题日志证据**:
```
跳过NODE_OUTPUT事件 - componentName: McpTool, showProcessOutput: false
【SSE发送】NODE_OUTPUT - nodeUuid: HvyaRpKFTK_fw3TRxwjHwtfCGOiWOQe, outputData: {"content":{"title":"","type":1,"value":"OK"},"name":"output"}
```

MCP工具节点(UcjXyNLy4vQohVGhXDSNq7bTWHkntEEr)正确跳过了，但Switcher节点(HvyaRpKFTK_fw3TRxwjHwtfCGOiWOQe)仍然发送了NODE_OUTPUT。

## 需求描述

为Switcher节点（权限判断条件）增加"执行过程输出"开关：
- 默认：开启（显示执行过程）
- 关闭后：不在流式输出显示具体过程，但数据仍传递给下游节点

与MCP工具节点的实现保持一致。

## 技术方案

### 核心判断

✅ **值得做**：这是一个真实的用户痛点，MCP工具的静默模式被Switcher节点破坏了

### 关键洞察

- **数据结构**：`SwitcherNodeConfig` 需要增加 `showProcessOutput` 字段
- **复杂度**：WorkflowEngine已支持通用的`show_process_output`检查，无需修改
- **风险点**：零破坏性，纯增量改动

### 改动清单

#### 1. 后端：SwitcherNodeConfig.java

**文件路径**: `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/node/switcher/SwitcherNodeConfig.java`

**改动内容**: 增加 `showProcessOutput` 字段

```java
package com.xinyirun.scm.ai.workflow.node.switcher;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

import java.util.List;

@Data
public class SwitcherNodeConfig {

    private List<SwitcherCase> cases;

    @JsonProperty("default_target_node_uuid")
    private String defaultTargetNodeUuid;

    /**
     * 是否显示执行过程输出到chat流
     * true(默认): 流式输出显示在聊天界面
     * false: 不显示流式输出，但结果仍传递给下游节点
     */
    @JsonProperty("show_process_output")
    private Boolean showProcessOutput = true;
}
```

#### 2. 前端：SwitcherNodeProperty.vue

**文件路径**: `src/components/70_ai/components/workflow/components/properties/SwitcherNodeProperty.vue`

**改动内容**: 在模板末尾（保底情况之后）增加"执行过程输出"开关

**Template部分新增**:
```vue
<!-- 执行过程输出开关 -->
<div class="property-section">
  <div class="section-title">
    执行过程输出
    <el-tooltip content="关闭后，节点执行结果不会显示在对话中，但仍会传递给下游节点" placement="top">
      <i class="el-icon-question" style="color: #909399; font-size: 14px; margin-left: 4px;" />
    </el-tooltip>
  </div>
  <el-switch
    v-model="nodeConfig.show_process_output"
    active-text="显示"
    inactive-text="隐藏"
  />
</div>
```

**Computed部分修改** (在nodeConfig计算属性中增加初始化):
```javascript
nodeConfig () {
  // ... 现有初始化代码 ...

  // 执行过程输出开关，默认为true（显示）
  if (this.wfNode.nodeConfig.show_process_output === undefined) {
    this.$set(this.wfNode.nodeConfig, 'show_process_output', true)
  }

  return this.wfNode.nodeConfig
}
```

**Style部分新增**:
```scss
.property-section {
  margin-top: 24px;

  .section-title {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 8px;
    color: #303133;
    display: flex;
    align-items: center;
  }
}
```

### 不需要改动的文件

- **WorkflowEngine.java**: 已支持通用的 `show_process_output` 检查，无需修改
- **SwitcherNode.java**: 条件分支逻辑不变，数据仍传递给下游节点

### 数据库

无需改动。`show_process_output` 存储在 `ai_workflow_node.node_config` JSON字段中。

## 测试验证

1. 打开工作流编辑器
2. 选中Switcher节点（权限判断条件）
3. 确认右侧属性面板显示"执行过程输出"开关，默认为"显示"
4. 将开关切换为"隐藏"并保存工作流
5. 执行工作流，确认Switcher节点的输出不再显示在聊天界面
6. 确认下游节点仍能正常接收数据

## 向后兼容性

- 现有工作流的Switcher节点没有 `show_process_output` 字段
- 前端初始化时会设置默认值为 `true`（显示）
- WorkflowEngine检查逻辑：字段不存在时默认显示
- 完全向后兼容，不影响现有工作流

## 调用链路分析

```
用户点击开关 → SwitcherNodeProperty.vue (前端)
    ↓
nodeConfig.show_process_output = true/false
    ↓
保存工作流 → ai_workflow_node.node_config (JSON字段)
    ↓
执行工作流 → WorkflowEngine.java:executeNodeInternal()
    ↓
检查 nodeConfig.show_process_output
    ↓
如果 false → 跳过 NODE_OUTPUT SSE事件
如果 true  → 发送 NODE_OUTPUT SSE事件到前端
```

## KISS原则7问题评估

| # | 问题 | 回答 |
|---|------|------|
| 1 | 这是个真问题还是臆想出来的？ | ✅ 真问题。日志明确显示MCP工具静默模式被Switcher节点破坏 |
| 2 | 有更简单的方法吗？ | ✅ 已是最简。复用WorkflowEngine已有的通用检查逻辑，只需增加配置字段和UI |
| 3 | 会破坏什么吗？ | ✅ 无破坏。纯增量改动，默认值保持原行为 |
| 4 | 当前项目真的需要这个功能吗？ | ✅ 需要。用户已明确要求，且与MCP工具节点保持一致 |
| 5 | 过度设计了吗？有缺少必要信息吗？ | ✅ 无过度设计。只增加1个字段和1个开关控件 |
| 6 | 话题是否模糊，是否会产生幻觉？ | ✅ 明确。有日志证据，有参考实现(McpToolNodeConfig) |
| 7 | 是否已学习代码实施注意事项？ | ✅ 是。参考现有McpToolNodeConfig和McpNodeProperty.vue实现 |

## 风险分析

| 风险 | 级别 | 缓解措施 |
|------|------|----------|
| 前端样式冲突 | 低 | 复用现有.property-section样式 |
| JSON字段解析错误 | 低 | 使用@JsonProperty注解，与McpToolNodeConfig一致 |
| 向后兼容 | 无 | 默认值true，保持原有行为 |
