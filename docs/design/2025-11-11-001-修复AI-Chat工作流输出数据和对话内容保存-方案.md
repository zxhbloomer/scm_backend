# ä¿®å¤AI Chatå·¥ä½œæµè¾“å‡ºæ•°æ®å’Œå¯¹è¯å†…å®¹ä¿å­˜ - å®æ–½æ–¹æ¡ˆ

**æ–¹æ¡ˆç¼–å·**: BUGFIX-20251111-001
**åˆ›å»ºæ—¥æœŸ**: 2025-11-11
**é—®é¢˜çº§åˆ«**: P0 (æ•°æ®ä¸¢å¤±)
**å½±å“èŒƒå›´**: æ‰€æœ‰AI Chatç”¨æˆ·
**é¢„è®¡å·¥ä½œé‡**: 2å°æ—¶

---

## ä¸€ã€é—®é¢˜æè¿°

### 1.1 é—®é¢˜1: `ai_conversation_workflow_runtime.output_data` æ°¸è¿œæ˜¯NULL

**ç°è±¡**:
- AI Chatè°ƒç”¨Workflowæ‰§è¡ŒæˆåŠŸ(status=3)
- èŠ‚ç‚¹çº§åˆ«çš„output_dataæ­£å¸¸ä¿å­˜
- ä½†å·¥ä½œæµçº§åˆ«çš„output_dataå­—æ®µæ°¸è¿œæ˜¯NULL

**å½±å“**:
- å‰ç«¯æ— æ³•è·å–å·¥ä½œæµçš„æœ€ç»ˆè¾“å‡ºç»“æœ
- æ‰§è¡Œå†å²è®°å½•ä¸å®Œæ•´
- æ— æ³•è¿½æº¯å·¥ä½œæµçš„å®Œæ•´æ‰§è¡Œç»“æœ

### 1.2 é—®é¢˜2: å¯¹è¯å†…å®¹æ²¡æœ‰ä¿å­˜åˆ° `ai_conversation_content` è¡¨

**ç°è±¡**:
- ç”¨æˆ·è¾“å…¥å’ŒAIå›ç­”æ²¡æœ‰INSERTåˆ°æ•°æ®åº“
- å¯¹è¯å†å²å®Œå…¨ç¼ºå¤±
- æ— æ³•å®ç°å¯¹è¯ä¸Šä¸‹æ–‡è®°å¿†

**å½±å“**:
- ç”¨æˆ·æ— æ³•æŸ¥çœ‹å†å²å¯¹è¯è®°å½•
- å¤šè½®å¯¹è¯åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œ
- å¯¹è¯æ•°æ®æ— æ³•ç”¨äºåç»­åˆ†æ

---

## äºŒã€æ ¹å› åˆ†æ

### 2.1 é—®é¢˜1çš„æ ¹æœ¬åŸå› 

**ä½ç½®**: `WorkflowEngine.java` Line 550-573

**ä»£ç åˆ†æ**:
```java
if (callSource == WorkflowCallSource.AI_CHAT) {
    // Line 551-554: AI Chatåœºæ™¯
    // TODO: å¦‚æœéœ€è¦åœ¨streamingResultä¸­æ›´æ–°AI Chatçš„èŠ‚ç‚¹,éœ€è¦å®ç°æŸ¥è¯¢é€»è¾‘
    log.debug("AI Chatåœºæ™¯ä¸‹streamingResultæš‚æ—¶è·³è¿‡nodeæ›´æ–°");
    // runtimeNodeIdä¿æŒä¸ºnull
} else {
    // Line 555-561: Workflowç‹¬ç«‹æµ‹è¯•åœºæ™¯
    AiWorkflowRuntimeNodeVo runtimeNodeVo = wfState.getRuntimeNodeByNodeUuid(out.node());
    if (null != runtimeNodeVo) {
        runtimeNodeId = runtimeNodeVo.getId();
    }
}

// Line 564-573: æ›´æ–°è¿è¡Œæ—¶èŠ‚ç‚¹çš„è¾“å‡º
if (runtimeNodeId != null) {  // â† AI_CHATåœºæ™¯æ°¸è¿œè¿›ä¸æ¥
    if (callSource == WorkflowCallSource.AI_CHAT) {
        conversationWorkflowRuntimeNodeService.updateOutput(runtimeNodeId, abstractWfNode.getState());
    } else {
        workflowRuntimeNodeService.updateOutput(runtimeNodeId, abstractWfNode.getState());
    }
    wfState.setOutput(abstractWfNode.getState().getOutputs());  // â† å…³é”®ä»£ç è¢«è·³è¿‡
} else {
    log.warn("Can not find runtime node, node uuid:{}", out.node());
}
```

**æ‰§è¡Œæµç¨‹**:
1. AI_CHATåœºæ™¯ä¸‹,Line 554è¾“å‡ºdebugæ—¥å¿—å,runtimeNodeId=null
2. Line 564çš„ifæ¡ä»¶ä¸æˆç«‹,æ•´ä¸ªifå—è¢«è·³è¿‡
3. **Line 570çš„ `wfState.setOutput()` æ°¸è¿œä¸ä¼šæ‰§è¡Œ**
4. å·¥ä½œæµå®Œæˆå,Line 310è°ƒç”¨ `conversationWorkflowRuntimeService.updateOutput(id, wfState)`
5. Serviceä» `wfState.getOutput()` è¯»å–è¾“å‡º,ä½†è¿”å›ç©ºåˆ—è¡¨
6. `runtime.setOutputData()` æ²¡æœ‰è¢«è°ƒç”¨,output_dataä¿æŒNULL

**æ—¥å¿—è¯æ®**:
```sql
-- å·¥ä½œæµæ‰§è¡Œå®Œæˆæ—¶çš„UPDATE (Line 960)
UPDATE ai_conversation_workflow_runtime
SET output_data=NULL,  -- â† åº”è¯¥æœ‰å€¼ä½†å®é™…æ˜¯NULL
    status=3           -- â† æ‰§è¡ŒæˆåŠŸ
WHERE id=3

-- å¯¹æ¯”:LLMèŠ‚ç‚¹çš„outputæ­£å¸¸ (Line 844)
UPDATE ai_conversation_workflow_runtime_node
SET output_data='{"output":{"title":"","type":1,"value":"å¥½çš„,è¯·æå‡ºæ‚¨å…³äºä¾›åº”é“¾ç®¡ç†çš„é—®é¢˜ã€‚"}}',
    status=2
WHERE id=12
```

### 2.2 é—®é¢˜2çš„æ ¹æœ¬åŸå› 

**ä½ç½®**: `AiConversationController.java` chatStream()æ–¹æ³•

**ç¼ºå¤±çš„é€»è¾‘**:
```java
// åº”è¯¥åœ¨è¿™é‡Œä¿å­˜å¯¹è¯å†…å®¹,ä½†å®é™…ä»£ç ä¸­æ²¡æœ‰
// 1. ä¿å­˜ç”¨æˆ·è¾“å…¥
// conversationContentService.saveUserMessage(conversationId, prompt);

// 2. æ”¶é›†AIå›ç­”
// String aiResponse = ...;

// 3. ä¿å­˜AIå›ç­”
// conversationContentService.saveAssistantMessage(conversationId, aiResponse);
```

**æ—¥å¿—è¯æ®**:
- æ•´ä¸ªæ—¥å¿—æ–‡ä»¶æ²¡æœ‰ `INSERT INTO ai_conversation_content` è¯­å¥
- æ²¡æœ‰ `AiConversationContentService` çš„è°ƒç”¨æ—¥å¿—

---

## ä¸‰ã€KISSåŸåˆ™éªŒè¯

### 3.1 å…­é—®æ£€éªŒ

1. **"è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„?"**
   - âœ… çœŸé—®é¢˜:æ—¥å¿—è¯æ®ç¡®å‡¿,100%çš„AI Chatç”¨æˆ·å—å½±å“

2. **"æœ‰æ›´ç®€å•çš„æ–¹æ³•å—?"**
   - âœ… æœ‰:å°† `wfState.setOutput()` ç§»åˆ°ifå—å¤–éƒ¨å³å¯,æ— éœ€æ•°æ®åº“æŸ¥è¯¢

3. **"ä¼šç ´åä»€ä¹ˆå—?"**
   - âœ… é›¶ç ´åæ€§:
     - Workflowç‹¬ç«‹æµ‹è¯•:ä¸å—å½±å“
     - AI Chatåœºæ™¯:ä»bugçŠ¶æ€ä¿®å¤ä¸ºæ­£å¸¸çŠ¶æ€
     - å‰ç«¯:æ— éœ€ä¿®æ”¹ä»£ç 

4. **"å½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—?"**
   - âœ… å¿…éœ€:
     - æ•°æ®å®Œæ•´æ€§æ˜¯åŸºæœ¬è¦æ±‚
     - å¯¹è¯å†å²æ˜¯AI Chatçš„æ ¸å¿ƒåŠŸèƒ½

5. **"æœ‰è¶³å¤Ÿçš„æ•°æ®æ”¯æ’‘å—?"**
   - âœ… å……è¶³:
     - æ—¥å¿—æ–‡ä»¶å®Œæ•´è®°å½•äº†é—®é¢˜
     - ä»£ç å®¡æŸ¥å®šä½åˆ°å…·ä½“è¡Œå·
     - æ•°æ®åº“æŸ¥è¯¢éªŒè¯äº†é—®é¢˜

6. **"ä»£ç ç®€æ´æ€§å¦‚ä½•?"**
   - âœ… ç®€æ´:
     - ä¿®å¤1:ç§»åŠ¨1è¡Œä»£ç 
     - ä¿®å¤2:è°ƒç”¨ç°æœ‰Service,3è¡Œä»£ç 

### 3.2 å¤æ‚åº¦è¯„ä¼°

**ä¿®å¤å‰**:
- æœªå®Œæˆçš„TODO
- è¯¯å¯¼æ€§çš„åˆ†æ”¯é€»è¾‘
- å…³é”®ä»£ç è¢«é”™è¯¯åœ°æ”¾åœ¨ifå—å†…éƒ¨

**ä¿®å¤å**:
- åˆ é™¤TODO
- ç®€åŒ–é€»è¾‘:æ— è®ºåˆ†æ”¯å¦‚ä½•,éƒ½è®¾ç½®output
- ä»£ç æ›´æ¸…æ™°æ˜“æ‡‚

---

## å››ã€è¯¦ç»†ä¿®å¤æ–¹æ¡ˆ

### 4.1 ä¿®å¤é—®é¢˜1: æ­£ç¡®è®¾ç½® wfState.output

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WorkflowEngine.java`

**ä¿®æ”¹ä½ç½®**: Line 524-579 (streamingResultæ–¹æ³•)

**ä¿®æ”¹ç­–ç•¥**: å°† `wfState.setOutput()` ç§»åˆ°ifå—å¤–éƒ¨

**ä¿®æ”¹å‰ä»£ç ** (Line 550-573):
```java
if (callSource == WorkflowCallSource.AI_CHAT) {
    // AI Chatåœºæ™¯: ç”±äºæˆ‘ä»¬æ²¡æœ‰å­˜å‚¨conversation nodeåˆ°wfStateä¸­,
    // è¿™é‡Œæš‚æ—¶è·³è¿‡æ›´æ–°(æˆ–è€…å¯ä»¥é€šè¿‡æ•°æ®åº“æŸ¥è¯¢è·å–node ID)
    // TODO: å¦‚æœéœ€è¦åœ¨streamingResultä¸­æ›´æ–°AI Chatçš„èŠ‚ç‚¹,éœ€è¦å®ç°æŸ¥è¯¢é€»è¾‘
    log.debug("AI Chatåœºæ™¯ä¸‹streamingResultæš‚æ—¶è·³è¿‡nodeæ›´æ–°");
} else {
    // Workflowç‹¬ç«‹æµ‹è¯•åœºæ™¯: ä½¿ç”¨wfStateä¸­çš„runtime node
    AiWorkflowRuntimeNodeVo runtimeNodeVo = wfState.getRuntimeNodeByNodeUuid(out.node());
    if (null != runtimeNodeVo) {
        runtimeNodeId = runtimeNodeVo.getId();
    }
}

// æ›´æ–°è¿è¡Œæ—¶èŠ‚ç‚¹çš„è¾“å‡º
if (runtimeNodeId != null) {
    if (callSource == WorkflowCallSource.AI_CHAT) {
        conversationWorkflowRuntimeNodeService.updateOutput(runtimeNodeId, abstractWfNode.getState());
    } else {
        workflowRuntimeNodeService.updateOutput(runtimeNodeId, abstractWfNode.getState());
    }
    wfState.setOutput(abstractWfNode.getState().getOutputs());  // â† ç§»åŠ¨æ­¤è¡Œåˆ°ifå¤–éƒ¨
} else {
    log.warn("Can not find runtime node, node uuid:{}", out.node());
}
```

**ä¿®æ”¹åä»£ç **:
```java
if (callSource == WorkflowCallSource.AI_CHAT) {
    // AI Chatåœºæ™¯: æš‚ä¸æ›´æ–°èŠ‚ç‚¹çº§åˆ«çš„è¿è¡Œæ—¶è®°å½•
    // åŸå› : AI Chatåœºæ™¯ä¸‹æ²¡æœ‰å°†conversation runtime nodeå­˜å…¥wfState
    // èŠ‚ç‚¹çº§åˆ«çš„æ›´æ–°å·²åœ¨å…¶ä»–åœ°æ–¹å®Œæˆ,è¿™é‡Œåªéœ€è®¾ç½®å·¥ä½œæµçº§åˆ«çš„è¾“å‡º
    log.debug("AI Chatåœºæ™¯ä¸‹streamingResultè·³è¿‡èŠ‚ç‚¹çº§åˆ«æ›´æ–°");
} else {
    // Workflowç‹¬ç«‹æµ‹è¯•åœºæ™¯: ä½¿ç”¨wfStateä¸­çš„runtime node
    AiWorkflowRuntimeNodeVo runtimeNodeVo = wfState.getRuntimeNodeByNodeUuid(out.node());
    if (null != runtimeNodeVo) {
        runtimeNodeId = runtimeNodeVo.getId();
    }
}

// æ›´æ–°è¿è¡Œæ—¶èŠ‚ç‚¹çš„è¾“å‡º (ä»…Workflowç‹¬ç«‹æµ‹è¯•åœºæ™¯)
if (runtimeNodeId != null) {
    if (callSource == WorkflowCallSource.AI_CHAT) {
        conversationWorkflowRuntimeNodeService.updateOutput(runtimeNodeId, abstractWfNode.getState());
    } else {
        workflowRuntimeNodeService.updateOutput(runtimeNodeId, abstractWfNode.getState());
    }
} else if (callSource == WorkflowCallSource.WORKFLOW_TEST) {
    log.warn("Can not find runtime node, node uuid:{}", out.node());
}

// âœ… å…³é”®ä¿®å¤: æ— è®ºæ˜¯å¦æ›´æ–°èŠ‚ç‚¹,éƒ½è¦è®¾ç½®å·¥ä½œæµçº§åˆ«çš„è¾“å‡º
// è¿™æ ·ç¡®ä¿exe()æ–¹æ³•ä¸­çš„updateOutput()èƒ½è¯»å–åˆ°æ­£ç¡®çš„è¾“å‡ºæ•°æ®
wfState.setOutput(abstractWfNode.getState().getOutputs());
```

**ä¿®æ”¹è¯´æ˜**:
1. **åˆ é™¤è¯¯å¯¼æ€§çš„TODO**: å®é™…ä¸Šä¸éœ€è¦æ•°æ®åº“æŸ¥è¯¢,ç›´æ¥è®¾ç½®wfState.outputå³å¯
2. **ä¿®æ”¹æ³¨é‡Š**: æ˜ç¡®è¯´æ˜AI_CHATåœºæ™¯è·³è¿‡èŠ‚ç‚¹æ›´æ–°çš„åŸå› 
3. **ç§»åŠ¨å…³é”®ä»£ç **: å°† `wfState.setOutput()` ç§»åˆ°ifå—å¤–éƒ¨,ç¡®ä¿æ‰€æœ‰åœºæ™¯éƒ½æ‰§è¡Œ
4. **ä¼˜åŒ–æ—¥å¿—**: åªåœ¨WORKFLOW_TESTåœºæ™¯ä¸‹è¾“å‡ºwarnæ—¥å¿—

**ä»£ç è¡Œæ•°å˜åŒ–**:
- åˆ é™¤: 1è¡Œ (TODOæ³¨é‡Š)
- ä¿®æ”¹: 2è¡Œ (æ³¨é‡Šä¼˜åŒ–)
- ç§»åŠ¨: 1è¡Œ (wfState.setOutput)
- æ–°å¢: 1è¡Œ (ifæ¡ä»¶ä¼˜åŒ–)
- **å‡€å¢åŠ **: 1è¡Œ

### 4.2 ä¿®å¤é—®é¢˜2: æ·»åŠ å¯¹è¯å†…å®¹ä¿å­˜

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/controller/chat/AiConversationController.java`

**ä¿®æ”¹ä½ç½®**: chatStream()æ–¹æ³•

**éœ€è¦ç¡®è®¤çš„ä¿¡æ¯**:
1. `AiConversationContentService` æ˜¯å¦å·²å­˜åœ¨?
2. ä¿å­˜å¯¹è¯å†…å®¹çš„æ–¹æ³•ç­¾åæ˜¯ä»€ä¹ˆ?
3. ä»Workflowè¾“å‡ºä¸­å¦‚ä½•æå–å®Œæ•´çš„AIå›ç­”?

**é¢„æœŸä¿®æ”¹æ–¹æ¡ˆ** (å¾…ç¡®è®¤åå®æ–½):
```java
@PostMapping("/chat/stream")
public Flux<ServerSentEvent<String>> chatStream(
    @RequestBody AiConversationChatRequestVo requestVo,
    HttpServletRequest request
) {
    // ... ç°æœ‰ä»£ç  ...

    // 1. ä¿å­˜ç”¨æˆ·è¾“å…¥
    conversationContentService.saveUserMessage(
        conversationId,
        requestVo.getPrompt(),
        userId
    );

    // 2. æ‰§è¡Œå·¥ä½œæµå¹¶æ”¶é›†è¾“å‡º
    StringBuilder aiResponseBuilder = new StringBuilder();

    return workflowStarter.streaming(workflowUuid, inputs, tenantCode, WorkflowCallSource.AI_CHAT)
        .map(event -> {
            // æ”¶é›†AIå›ç­”å†…å®¹
            if (event.getEventType() == WorkflowEventType.NODE_CHUNK) {
                aiResponseBuilder.append(event.getData());
            }

            // è¿”å›SSEäº‹ä»¶
            return ServerSentEvent.<String>builder()
                .event(event.getEventType().name())
                .data(event.getData())
                .build();
        })
        .doOnComplete(() -> {
            // 3. æµå¼è¾“å‡ºå®Œæˆå,ä¿å­˜AIå›ç­”
            String fullAiResponse = aiResponseBuilder.toString();
            conversationContentService.saveAssistantMessage(
                conversationId,
                fullAiResponse,
                userId
            );
        })
        .doOnError(error -> {
            log.error("AI Chatæµå¼è¾“å‡ºå¼‚å¸¸", error);
        });
}
```

**å®æ–½æ­¥éª¤**:
1. æ£€æŸ¥ `AiConversationContentService` æ˜¯å¦å­˜åœ¨
2. å¦‚æœä¸å­˜åœ¨,éœ€è¦åˆ›å»ºServiceå’ŒMapper
3. ç¡®è®¤å¯¹è¯å†…å®¹çš„æ•°æ®æ¨¡å‹
4. å®ç°ä¿å­˜é€»è¾‘

---

## äº”ã€å½±å“åˆ†æ

### 5.1 å—å½±å“çš„æ¨¡å—

| æ¨¡å— | å½±å“ç±»å‹ | å½±å“è¯´æ˜ |
|------|---------|---------|
| WorkflowEngine | âœ… Bugä¿®å¤ | ä¿®å¤output_dataä¿å­˜é€»è¾‘ |
| AiConversationController | â• åŠŸèƒ½å¢å¼º | æ·»åŠ å¯¹è¯å†…å®¹ä¿å­˜ |
| AiConversationContentService | â“ å¾…ç¡®è®¤ | å¯èƒ½éœ€è¦æ–°å»ºæˆ–æ‰©å±• |
| æ•°æ®åº“ | âœ… æ•°æ®å®Œæ•´ | output_dataå’Œconversation_contentæœ‰æ•°æ® |
| å‰ç«¯ | âœ… åŠŸèƒ½æ­£å¸¸ | å¯ä»¥æ­£ç¡®è¯»å–è¾“å‡ºç»“æœå’Œå¯¹è¯å†å² |

### 5.2 ç ´åæ€§åˆ†æ

**âœ… é›¶ç ´åæ€§**:

1. **Workflowç‹¬ç«‹æµ‹è¯•åœºæ™¯**:
   - åˆ†æ”¯é€»è¾‘ä¿æŒä¸å˜
   - æ‰§è¡Œæµç¨‹å®Œå…¨ä¸€è‡´
   - è¾“å‡ºç»“æœä¸å—å½±å“

2. **AI Chatåœºæ™¯**:
   - ä»bugçŠ¶æ€ä¿®å¤ä¸ºæ­£å¸¸çŠ¶æ€
   - æ•°æ®ä»"ç¼ºå¤±"å˜ä¸º"å®Œæ•´"
   - å‘åå…¼å®¹,å‰ç«¯æ— éœ€ä¿®æ”¹

3. **å­å·¥ä½œæµ**:
   - ä¸æ›´æ–°runtimeè®°å½•,é€»è¾‘ä¸å˜
   - ä¸å—æ­¤æ¬¡ä¿®æ”¹å½±å“

### 5.3 æ•°æ®åº“å½±å“

**ä¿®å¤å‰**:
```sql
SELECT * FROM ai_conversation_workflow_runtime WHERE id=3;
-- output_data: NULL  â† é—®é¢˜

SELECT * FROM ai_conversation_content WHERE conversation_id='xxx';
-- 0 rows  â† é—®é¢˜
```

**ä¿®å¤å**:
```sql
SELECT * FROM ai_conversation_workflow_runtime WHERE id=3;
-- output_data: {"output":{"title":"","type":1,"value":"å¥½çš„,è¯·æå‡ºæ‚¨å…³äºä¾›åº”é“¾ç®¡ç†çš„é—®é¢˜ã€‚"}}  â† æ­£å¸¸

SELECT * FROM ai_conversation_content WHERE conversation_id='xxx';
-- 2 rows: user message + assistant message  â† æ­£å¸¸
```

---

## å…­ã€æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### 6.1 å•å…ƒæµ‹è¯•

**æµ‹è¯•1: éªŒè¯wfState.outputæ­£ç¡®è®¾ç½®**
```java
@Test
public void testAiChatWorkflowOutputDataSaved() {
    // 1. æ‰§è¡ŒAI Chatå·¥ä½œæµ
    String conversationId = "test-conv-id";
    String workflowUuid = "test-workflow-uuid";

    // 2. æ‰§è¡Œå·¥ä½œæµ
    workflowStarter.streaming(workflowUuid, inputs, tenantCode, WorkflowCallSource.AI_CHAT)
        .blockLast();

    // 3. æŸ¥è¯¢runtimeè®°å½•
    AiConversationWorkflowRuntimeEntity runtime =
        conversationWorkflowRuntimeMapper.selectOne(
            new QueryWrapper<AiConversationWorkflowRuntimeEntity>()
                .eq("conversation_id", conversationId)
        );

    // 4. éªŒè¯output_dataä¸ä¸ºç©º
    assertNotNull(runtime.getOutputData());
    assertTrue(runtime.getOutputData().contains("output"));
}
```

**æµ‹è¯•2: éªŒè¯å¯¹è¯å†…å®¹ä¿å­˜**
```java
@Test
public void testConversationContentSaved() {
    // 1. æ‰§è¡ŒAI Chat
    String conversationId = "test-conv-id";
    String userPrompt = "ä½ å¥½";

    conversationController.chatStream(requestVo, request).blockLast();

    // 2. æŸ¥è¯¢å¯¹è¯å†…å®¹
    List<AiConversationContentEntity> contents =
        conversationContentMapper.selectList(
            new QueryWrapper<AiConversationContentEntity>()
                .eq("conversation_id", conversationId)
                .orderByAsc("c_time")
        );

    // 3. éªŒè¯ä¿å­˜äº†2æ¡è®°å½•
    assertEquals(2, contents.size());

    // 4. éªŒè¯ç”¨æˆ·æ¶ˆæ¯
    assertEquals("user", contents.get(0).getRole());
    assertEquals(userPrompt, contents.get(0).getContent());

    // 5. éªŒè¯åŠ©æ‰‹æ¶ˆæ¯
    assertEquals("assistant", contents.get(1).getRole());
    assertNotNull(contents.get(1).getContent());
}
```

### 6.2 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯1: ç®€å•å¯¹è¯**
```
è¾“å…¥: "ä½ å¥½"
é¢„æœŸè¾“å‡º:
  - ai_conversation_workflow_runtime.output_data æœ‰å€¼
  - ai_conversation_content æœ‰2æ¡è®°å½•
```

**æµ‹è¯•åœºæ™¯2: å¤šè½®å¯¹è¯**
```
ç¬¬1è½®: "ä½ å¥½" â†’ éªŒè¯æ•°æ®ä¿å­˜
ç¬¬2è½®: "å¸®æˆ‘æŸ¥è®¢å•" â†’ éªŒè¯æ•°æ®ä¿å­˜
ç¬¬3è½®: "è°¢è°¢" â†’ éªŒè¯æ•°æ®ä¿å­˜
é¢„æœŸ: ai_conversation_content æœ‰6æ¡è®°å½•
```

**æµ‹è¯•åœºæ™¯3: å­å·¥ä½œæµè°ƒç”¨**
```
è¾“å…¥: è§¦å‘åŒ…å«å­å·¥ä½œæµçš„å·¥ä½œæµ
é¢„æœŸ:
  - ä¸»å·¥ä½œæµçš„output_dataæ­£å¸¸
  - å­å·¥ä½œæµä¸åˆ›å»ºruntimeè®°å½•(å¤ç”¨çˆ¶å·¥ä½œæµUUID)
```

### 6.3 å›å½’æµ‹è¯•

**æµ‹è¯•åœºæ™¯4: Workflowç‹¬ç«‹æµ‹è¯•**
```
åœºæ™¯: åœ¨å·¥ä½œæµæµ‹è¯•é¡µé¢æ‰§è¡Œå·¥ä½œæµ
é¢„æœŸ:
  - æ‰§è¡Œæµç¨‹ä¸ä¿®å¤å‰å®Œå…¨ä¸€è‡´
  - output_dataæ­£å¸¸ä¿å­˜
  - ä¸å½±å“å¯¹è¯å†…å®¹ä¿å­˜(å› ä¸ºä¸æ˜¯AI Chatåœºæ™¯)
```

---

## ä¸ƒã€é£é™©è¯„ä¼°

### 7.1 æŠ€æœ¯é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|--------|---------|---------|
| ä¿®æ”¹æ ¸å¿ƒå·¥ä½œæµå¼•æ“ä»£ç  | ğŸŸ¡ ä¸­ | å……åˆ†çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯• |
| å¯¹è¯å†…å®¹ä¿å­˜é€»è¾‘å¯èƒ½å½±å“æ€§èƒ½ | ğŸŸ¢ ä½ | ä½¿ç”¨å¼‚æ­¥ä¿å­˜,ä¸é˜»å¡ä¸»æµç¨‹ |
| æ•°æ®åº“å†™å…¥å¤±è´¥ | ğŸŸ¢ ä½ | æ·»åŠ å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶ |

### 7.2 ä¸šåŠ¡é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|--------|---------|---------|
| ä¿®å¤åæ•°æ®æ ¼å¼å˜åŒ– | ğŸŸ¢ ä½ | å‘åå…¼å®¹,å‰ç«¯æ— éœ€ä¿®æ”¹ |
| å†å²æ•°æ®ä¸å®Œæ•´ | ğŸŸ¢ ä½ | åªå½±å“ä¿®å¤å‰çš„æ•°æ®,ä¸å½±å“æ–°æ•°æ® |

### 7.3 å›æ»šæ–¹æ¡ˆ

å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜,å›æ»šæ­¥éª¤:
1. Gitå›é€€åˆ°ä¿®å¤å‰çš„commit
2. é‡æ–°éƒ¨ç½²
3. éªŒè¯Workflowç‹¬ç«‹æµ‹è¯•åŠŸèƒ½æ­£å¸¸
4. åˆ†æé—®é¢˜åŸå› ,é‡æ–°è®¾è®¡ä¿®å¤æ–¹æ¡ˆ

---

## å…«ã€å®æ–½è®¡åˆ’

### 8.1 å®æ–½æ­¥éª¤

| æ­¥éª¤ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº |
|------|------|---------|--------|
| 1 | ä¿®å¤WorkflowEngine.java | 15åˆ†é’Ÿ | å¼€å‘ |
| 2 | ç¡®è®¤AiConversationContentServiceæ˜¯å¦å­˜åœ¨ | 10åˆ†é’Ÿ | å¼€å‘ |
| 3 | å®ç°å¯¹è¯å†…å®¹ä¿å­˜é€»è¾‘ | 30åˆ†é’Ÿ | å¼€å‘ |
| 4 | ç¼–å†™å•å…ƒæµ‹è¯• | 30åˆ†é’Ÿ | å¼€å‘ |
| 5 | æ‰§è¡Œé›†æˆæµ‹è¯• | 20åˆ†é’Ÿ | å¼€å‘ |
| 6 | æ‰§è¡Œå›å½’æµ‹è¯• | 15åˆ†é’Ÿ | QA |
| 7 | ä»£ç Review | 10åˆ†é’Ÿ | Tech Lead |

**æ€»è®¡**: çº¦2å°æ—¶

### 8.2 ä¸Šçº¿è®¡åˆ’

1. **å¼€å‘ç¯å¢ƒéªŒè¯**: 1å°æ—¶
2. **æµ‹è¯•ç¯å¢ƒéªŒè¯**: 30åˆ†é’Ÿ
3. **é¢„å‘å¸ƒç¯å¢ƒéªŒè¯**: 30åˆ†é’Ÿ
4. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**: æ»šåŠ¨å‘å¸ƒ,é€æ­¥è§‚å¯Ÿ
5. **çº¿ä¸Šç›‘æ§**: éƒ¨ç½²å24å°æ—¶å¯†åˆ‡ç›‘æ§

---

## ä¹ã€ç›‘æ§æŒ‡æ ‡

### 9.1 å…³é”®æŒ‡æ ‡

**ä¿®å¤æ•ˆæœç›‘æ§**:
```sql
-- 1. ç›‘æ§output_dataä¸ä¸ºç©ºçš„æ¯”ä¾‹
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN output_data IS NOT NULL THEN 1 ELSE 0 END) as has_output,
    ROUND(SUM(CASE WHEN output_data IS NOT NULL THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as success_rate
FROM ai_conversation_workflow_runtime
WHERE c_time >= '2025-11-11 00:00:00'
  AND status = 3;  -- æ‰§è¡ŒæˆåŠŸçš„è®°å½•

-- é¢„æœŸ: success_rate = 100%
```

```sql
-- 2. ç›‘æ§å¯¹è¯å†…å®¹ä¿å­˜æƒ…å†µ
SELECT
    DATE(c_time) as date,
    COUNT(DISTINCT conversation_id) as conversation_count,
    COUNT(*) as message_count
FROM ai_conversation_content
WHERE c_time >= '2025-11-11 00:00:00'
GROUP BY DATE(c_time);

-- é¢„æœŸ: message_count >= conversation_count * 2 (æ¯ä¸ªå¯¹è¯è‡³å°‘2æ¡æ¶ˆæ¯)
```

### 9.2 æ€§èƒ½ç›‘æ§

```sql
-- 3. ç›‘æ§å·¥ä½œæµæ‰§è¡Œæ—¶é—´
SELECT
    AVG(TIMESTAMPDIFF(SECOND, c_time, u_time)) as avg_duration_seconds,
    MAX(TIMESTAMPDIFF(SECOND, c_time, u_time)) as max_duration_seconds
FROM ai_conversation_workflow_runtime
WHERE c_time >= '2025-11-11 00:00:00';

-- é¢„æœŸ: ä¸ä¿®å¤å‰ç›¸æ¯”,æ‰§è¡Œæ—¶é—´æ— æ˜¾è‘—å¢åŠ 
```

---

## åã€åç»­ä¼˜åŒ–å»ºè®®

### 10.1 çŸ­æœŸä¼˜åŒ– (1å‘¨å†…)

1. **æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—**:
   - åœ¨ä¿å­˜output_dataæ—¶è®°å½•è¯¦ç»†æ—¥å¿—
   - åœ¨ä¿å­˜å¯¹è¯å†…å®¹æ—¶è®°å½•è¯¦ç»†æ—¥å¿—
   - ä¾¿äºé—®é¢˜æ’æŸ¥

2. **ä¼˜åŒ–å¼‚å¸¸å¤„ç†**:
   - å¯¹è¯å†…å®¹ä¿å­˜å¤±è´¥ä¸åº”å½±å“ä¸»æµç¨‹
   - æ·»åŠ é‡è¯•æœºåˆ¶

### 10.2 é•¿æœŸä¼˜åŒ– (1ä¸ªæœˆå†…)

1. **ç»Ÿä¸€èŠ‚ç‚¹æ›´æ–°é€»è¾‘**:
   - è€ƒè™‘å°†AI_CHATåœºæ™¯ä¸‹çš„èŠ‚ç‚¹æ›´æ–°é€»è¾‘ä¹Ÿå®ç°
   - ä½¿ä¸¤ä¸ªåœºæ™¯çš„ä»£ç è·¯å¾„æ›´ä¸€è‡´

2. **å¯¹è¯å†…å®¹ç®¡ç†åŠŸèƒ½**:
   - å®ç°å¯¹è¯å†å²æŸ¥è¯¢API
   - å®ç°å¯¹è¯å†…å®¹å¯¼å‡ºåŠŸèƒ½
   - å®ç°å¯¹è¯å†…å®¹æœç´¢åŠŸèƒ½

---

## åä¸€ã€é™„å½•

### 11.1 ç›¸å…³æ–‡ä»¶æ¸…å•

**æ ¸å¿ƒæ–‡ä»¶**:
1. `scm-ai/src/main/java/com/xinyirun/scm/ai/workflow/WorkflowEngine.java`
2. `scm-ai/src/main/java/com/xinyirun/scm/ai/controller/chat/AiConversationController.java`
3. `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/workflow/AiConversationWorkflowRuntimeService.java`

**å¯èƒ½éœ€è¦çš„æ–‡ä»¶**:
4. `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/chat/AiConversationContentService.java` (å¾…ç¡®è®¤)
5. `scm-ai/src/main/java/com/xinyirun/scm/ai/core/mapper/chat/AiConversationContentMapper.java` (å¾…ç¡®è®¤)

### 11.2 æ•°æ®åº“è¡¨ç»“æ„

**ai_conversation_workflow_runtime**:
```sql
CREATE TABLE `ai_conversation_workflow_runtime` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `runtime_uuid` VARCHAR(50) NOT NULL COMMENT 'è¿è¡Œæ—¶UUID',
  `conversation_id` VARCHAR(100) NOT NULL COMMENT 'å¯¹è¯ID',
  `workflow_id` BIGINT NOT NULL COMMENT 'å·¥ä½œæµID',
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `input_data` TEXT COMMENT 'è¾“å…¥æ•°æ®(JSON)',
  `output_data` TEXT COMMENT 'è¾“å‡ºæ•°æ®(JSON)',  -- â† ä¿®å¤æ­¤å­—æ®µ
  `status` INT NOT NULL COMMENT 'çŠ¶æ€(1-è¿è¡Œä¸­,2-ç­‰å¾…è¾“å…¥,3-æˆåŠŸ,4-å¤±è´¥)',
  `status_remark` VARCHAR(500) COMMENT 'çŠ¶æ€è¯´æ˜',
  `c_time` DATETIME NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `u_time` DATETIME NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  `c_id` BIGINT COMMENT 'åˆ›å»ºäººID',
  `u_id` BIGINT COMMENT 'æ›´æ–°äººID',
  `dbversion` INT NOT NULL DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬'
) COMMENT 'AI Chatå·¥ä½œæµè¿è¡Œæ—¶';
```

**ai_conversation_content** (å¾…ç¡®è®¤):
```sql
CREATE TABLE `ai_conversation_content` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `conversation_id` VARCHAR(100) NOT NULL COMMENT 'å¯¹è¯ID',
  `role` VARCHAR(20) NOT NULL COMMENT 'è§’è‰²(user/assistant)',
  `content` TEXT NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
  `c_time` DATETIME NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `c_id` BIGINT COMMENT 'åˆ›å»ºäººID',
  INDEX `idx_conversation_id` (`conversation_id`),
  INDEX `idx_c_time` (`c_time`)
) COMMENT 'AIå¯¹è¯å†…å®¹è®°å½•';
```

---

**æ–¹æ¡ˆçŠ¶æ€**: å¾…ç”¨æˆ·å®¡æ‰¹
**ä¸‹ä¸€æ­¥**: ç”¨æˆ·ç¡®è®¤åå¼€å§‹å®æ–½
