# ä¸ä¿®æ”¹ä»£ç å®ç°æ•°æ®åˆ†ç¦»çš„å¯è¡Œæ€§åˆ†æ

## æ ¸å¿ƒå‘ç°

é€šè¿‡æ·±å…¥åˆ†æä»£ç ï¼Œæˆ‘å‘ç°**ç†è®ºä¸Šå¯ä»¥å®ç°**ï¼Œä½†éœ€è¦ç†è§£å½“å‰çš„æ¶æ„è®¾è®¡ã€‚

---

## å½“å‰æ¶æ„å…³é”®ç‚¹

### 1. ä¸¤å¥—ç‹¬ç«‹çš„ChatClient

**é…ç½®æ–‡ä»¶**: `AiChatMemoryConfig.java`

```java
// AI Chaté¢†åŸŸä¸“å±ChatClientï¼ˆæ²¡æœ‰é…ç½®defaultAdvisorsï¼‰
@Bean("chatDomainChatClient")
public ChatClient chatDomainChatClient(AiModelProvider aiModelProvider) {
    ChatModel chatModel = aiModelProvider.getChatModel();
    return ChatClient.builder(chatModel).build();  // æ²¡æœ‰defaultAdvisors
}

// Workflowé¢†åŸŸä¸“å±ChatClientï¼ˆé…ç½®äº†defaultAdvisorsï¼‰
@Bean("workflowDomainChatClient")
public ChatClient workflowDomainChatClient(
        AiModelProvider aiModelProvider,
        MessageChatMemoryAdvisor workflowMessageChatMemoryAdvisor,
        WorkflowConversationAdvisor workflowConversationAdvisor) {
    ChatModel chatModel = aiModelProvider.getChatModel();
    return ChatClient.builder(chatModel)
            .defaultAdvisors(
                workflowMessageChatMemoryAdvisor,  // è¯»å–å†å²å¯¹è¯
                workflowConversationAdvisor        // ä¿å­˜æ–°å¯¹è¯
            )
            .build();
}
```

### 2. ä¸¤å¥—ç‹¬ç«‹çš„Advisor

**Chaté¢†åŸŸAdvisor**:
- `chatMessageChatMemoryAdvisor` â†’ è¯»å–/ä¿å­˜ `ai_conversation_content`

**Workflowé¢†åŸŸAdvisor**:
- `workflowMessageChatMemoryAdvisor` â†’ è¯»å– `ai_workflow_conversation_content`
- `workflowConversationAdvisor` â†’ ä¿å­˜ `ai_workflow_conversation_content`

---

## å½“å‰å®ç°çš„é—®é¢˜

### AiConversationControllerçš„ä¸¤ä¸ªåˆ†æ”¯

**åˆ†æ”¯1: chatStreamWithoutWorkflow()** (ç¬¬472-580è¡Œ)
```java
// ä¸å¯ç”¨Workflowè·¯ç”±æ—¶çš„é€»è¾‘
private Flux<ChatResponseVo> chatStreamWithoutWorkflow(AIChatRequestVo request) {
    // ç›´æ¥è°ƒç”¨ AiConversationContentService.saveConversationContent()
    // ä¿å­˜åˆ° ai_conversation_content âœ…
    aiConversationContentService.saveConversationContent(
        request.getConversationId(),
        AiMessageTypeConstant.MESSAGE_TYPE_USER,
        request.getPrompt(),
        ...
    );
}
```
**æ•°æ®ä¿å­˜**: âœ… `ai_conversation_content`

---

**åˆ†æ”¯2: chatStream() with Workflowè·¯ç”±** (ç¬¬186-352è¡Œ)
```java
// å¯ç”¨Workflowè·¯ç”±æ—¶çš„é€»è¾‘
@PostMapping(value = "/chat/stream")
public Flux<ChatResponseVo> chatStream(@RequestBody AIChatRequestVo request) {
    if (!enableWorkflowRouting) {
        return chatStreamWithoutWorkflow(request);  // èµ°åˆ†æ”¯1
    }

    // æ™ºèƒ½è·¯ç”±é€‰æ‹©Workflow
    String workflowUuid = workflowRoutingService.route(...);

    // è°ƒç”¨ workflowStarter.streaming()
    return workflowStarter.streaming(workflowUuid, userInputs, tenantId);
    // âŒ é—®é¢˜ï¼šä½¿ç”¨äº† workflowDomainChatClient
    // âŒ è§¦å‘ WorkflowConversationAdvisor
    // âŒ ä¿å­˜åˆ° ai_workflow_conversation_content
}
```
**æ•°æ®ä¿å­˜**: âŒ `ai_workflow_conversation_content`ï¼ˆä¸ç¬¦åˆæœŸæœ›ï¼‰

---

## ğŸ¯ ä¸ä¿®æ”¹ä»£ç çš„å®ç°æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯ï¼šåˆ©ç”¨Feature Toggle

**å…³é”®é…ç½®**: `application.yml`
```yaml
scm:
  ai:
    workflow:
      enabled: false  # é»˜è®¤falseï¼Œä¸å¯ç”¨Workflowè·¯ç”±
```

**å½“å‰è¡Œä¸º**:
```java
if (!enableWorkflowRouting) {
    return chatStreamWithoutWorkflow(request);  // ä½¿ç”¨AI ChatåŸæœ‰é€»è¾‘
}
```

---

## ğŸ’¡ å®ç°æ•°æ®åˆ†ç¦»çš„å¯è¡Œæ–¹æ¡ˆï¼ˆä¸ä¿®æ”¹ä»£ç ï¼‰

### æ–¹æ¡ˆï¼šåˆ†ç¦»éƒ¨ç½²æˆ–é€»è¾‘éš”ç¦»

#### åœºæ™¯1: Workflowç‹¬ç«‹æµ‹è¯•
**å…¥å£**: `/api/v1/ai/workflow/run/{wfUuid}` (WorkflowController)
**æ•°æ®ä¿å­˜**: `ai_workflow_conversation_content` âœ…

#### åœºæ™¯2: AI Chatçº¯å¯¹è¯ï¼ˆä¸ä½¿ç”¨Workflowï¼‰
**å…¥å£**: `/api/v1/ai/conversation/chat/stream` (AiConversationController)
**é…ç½®**: `scm.ai.workflow.enabled=false`
**æ•°æ®ä¿å­˜**: `ai_conversation_content` âœ…

#### åœºæ™¯3: AI Chatè°ƒç”¨Workflowï¼ˆé—®é¢˜åœºæ™¯ï¼‰
**å…¥å£**: `/api/v1/ai/conversation/chat/stream` (AiConversationController)
**é…ç½®**: `scm.ai.workflow.enabled=true`
**æ•°æ®ä¿å­˜**: `ai_workflow_conversation_content` âŒï¼ˆä¸ç¬¦åˆæœŸæœ›ï¼‰

---

## âŒ ç»“è®ºï¼šä¸ä¿®æ”¹ä»£ç æ— æ³•å®ç°å®Œå…¨åˆ†ç¦»

### æ ¹æœ¬åŸå› 

**AI Chatè°ƒç”¨Workflowæ—¶çš„è°ƒç”¨é“¾**:
```
AiConversationController.chatStream()
  â†’ workflowRoutingService.route()
  â†’ workflowStarter.streaming()  // âŒ è¿™é‡Œç¡¬ç¼–ç ä½¿ç”¨ workflowDomainChatClient
     â†’ WorkflowEngine
     â†’ WorkflowConversationAdvisor  // âŒ ç¡¬ç¼–ç ä¿å­˜åˆ° ai_workflow_conversation_content
```

**é—®é¢˜æ ¸å¿ƒ**:
- `workflowStarter.streaming()` å†…éƒ¨ä½¿ç”¨çš„æ˜¯ `workflowDomainChatClient`
- `workflowDomainChatClient` é…ç½®äº† `WorkflowConversationAdvisor` ä½œä¸º `defaultAdvisors`
- `WorkflowConversationAdvisor` ç¡¬ç¼–ç ä¿å­˜åˆ° `ai_workflow_conversation_content`

**æ— æ³•é€šè¿‡é…ç½®æ”¹å˜**:
- ChatClientçš„Advisoræ˜¯åœ¨Beanå®šä¹‰æ—¶ç¡¬ç¼–ç çš„
- ä¸ä¿®æ”¹ä»£ç æ— æ³•åŠ¨æ€åˆ‡æ¢Advisor

---

## ğŸ“‹ ä¸ºä»€ä¹ˆå½“å‰è®¾è®¡å®é™…ä¸Šæ˜¯åˆç†çš„

### è®¾è®¡ç†å¿µåˆ†æ

**å½“å‰æ¶æ„çš„è®¾è®¡å“²å­¦**:
```
æ•°æ®æŒ‰ç…§"æ‰§è¡Œå¼•æ“"åˆ†ç±»ï¼Œè€Œä¸æ˜¯æŒ‰ç…§"ç”¨æˆ·å…¥å£"åˆ†ç±»
```

**å…·ä½“ä½“ç°**:
- æ‰€æœ‰é€šè¿‡ **Workflowå¼•æ“æ‰§è¡Œ** çš„å¯¹è¯ â†’ `ai_workflow_conversation_content`
- æ‰€æœ‰é€šè¿‡ **çº¯AI Chat** çš„å¯¹è¯ â†’ `ai_conversation_content`

**ä¼˜åŠ¿**:
1. **æ‰§è¡Œä¸Šä¸‹æ–‡å®Œæ•´**: Workflowæ‰§è¡Œçš„å¯¹è¯éƒ½å…³è” `runtimeUuid`ï¼Œä¾¿äºè¿½æº¯
2. **æ•°æ®ä¸€è‡´æ€§å¼º**: ç›¸åŒæ‰§è¡Œå¼•æ“çš„æ•°æ®åœ¨åŒä¸€å¼ è¡¨ï¼ŒæŸ¥è¯¢é€»è¾‘ç®€å•
3. **é¿å…æ•°æ®é‡å¤**: ä¸ä¼šå› ä¸ºå…¥å£ä¸åŒè€Œé‡å¤ä¿å­˜

---

## ğŸ¤” ä½ æœŸæœ›çš„æ¶æ„æ˜¯ä»€ä¹ˆ

### ç”¨æˆ·æœŸæœ›çš„æ¶æ„
```
æ•°æ®æŒ‰ç…§"ç”¨æˆ·å…¥å£"åˆ†ç±»
```

**æœŸæœ›çš„æ•°æ®æµå‘**:
- ç”¨æˆ·åœ¨ **AI Chatç•Œé¢** çš„æ‰€æœ‰å¯¹è¯ï¼ˆåŒ…æ‹¬è°ƒç”¨Workflowï¼‰ â†’ `ai_conversation_content`
- ç”¨æˆ·åœ¨ **Workflowæµ‹è¯•ç•Œé¢** çš„å¯¹è¯ â†’ `ai_workflow_conversation_content`

**ä¼˜åŠ¿**:
1. **ç”¨æˆ·è§†è§’æ¸…æ™°**: åœ¨å“ªä¸ªç•Œé¢æ“ä½œï¼Œæ•°æ®å°±åœ¨å“ªå¼ è¡¨
2. **å‰ç«¯æŸ¥è¯¢ç®€å•**: AI Chatç•Œé¢åªæŸ¥ `ai_conversation_content` å³å¯æ˜¾ç¤ºå®Œæ•´å†å²

**åŠ£åŠ¿**:
1. **æ‰§è¡Œä¸Šä¸‹æ–‡åˆ†æ•£**: åŒä¸€ä¸ªWorkflowçš„æ‰§è¡Œè®°å½•å¯èƒ½åœ¨ä¸¤å¼ è¡¨
2. **æ•°æ®è¿½æº¯å›°éš¾**: æŸ¥è¯¢æŸä¸ªWorkflowçš„æ‰€æœ‰æ‰§è¡Œå†å²éœ€è¦è·¨è¡¨
3. **å¯èƒ½æ•°æ®é‡å¤**: å¦‚æœåŒå†™ï¼Œä¼šå¯¼è‡´å†—ä½™

---

## ğŸ’ª å¦‚æœå¿…é¡»å®ç°ï¼Œéœ€è¦ä¿®æ”¹ä»€ä¹ˆ

### æœ€å°æ”¹åŠ¨æ–¹æ¡ˆï¼ˆå¿…é¡»ä¿®æ”¹ä»£ç ï¼‰

**ä¿®æ”¹ç‚¹1**: `AiConversationController.chatStream()` ç¬¬305è¡Œä¹‹å

```java
// å½“å‰ä»£ç 
return workflowStarter.streaming(workflowUuid, userInputs, tenantId);

// ä¿®æ”¹ä¸º
return workflowStarter.streaming(workflowUuid, userInputs, tenantId)
    .doOnNext(event -> {
        // å·¥ä½œæµæ‰§è¡Œå®Œæˆåï¼Œé¢å¤–ä¿å­˜åˆ° ai_conversation_content
        if ("done".equals(event.getEvent())) {
            String content = extractContentFromWorkflowEvent(event);
            aiConversationContentService.saveConversationContent(
                conversationId,
                AiMessageTypeConstant.MESSAGE_TYPE_ASSISTANT,
                content,
                modelSourceId,
                providerName,
                modelName,
                operatorId
            );
        }
    });
```

**æ•ˆæœ**:
- Workflowæ‰§è¡Œçš„å¯¹è¯ä»ç„¶ä¿å­˜åœ¨ `ai_workflow_conversation_content`ï¼ˆç”±WorkflowConversationAdvisorè‡ªåŠ¨å®Œæˆï¼‰
- AI Chatè°ƒç”¨æ—¶ï¼Œé¢å¤–ä¿å­˜ä¸€ä»½åˆ° `ai_conversation_content`ï¼ˆæ‰‹åŠ¨æ·»åŠ ï¼‰

**é—®é¢˜**:
- âš ï¸ æ•°æ®é‡å¤ï¼ˆä¸¤å¼ è¡¨éƒ½æœ‰ï¼‰
- âš ï¸ æ•°æ®å¯èƒ½ä¸ä¸€è‡´ï¼ˆå¦‚æœä¸€ä¸ªä¿å­˜æˆåŠŸï¼Œå¦ä¸€ä¸ªå¤±è´¥ï¼‰

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### å»ºè®®1: ä¿æŒå½“å‰æ¶æ„ï¼ˆå¼ºçƒˆæ¨èï¼‰

**ç†ç”±**:
1. âœ… å½“å‰è®¾è®¡æ›´ç¬¦åˆæŠ€æœ¯æ¶æ„çš„"å…³æ³¨ç‚¹åˆ†ç¦»"åŸåˆ™
2. âœ… æŒ‰æ‰§è¡Œå¼•æ“åˆ†ç±»ï¼Œæ•°æ®ä¸€è‡´æ€§æ›´å¼º
3. âœ… é¿å…æ•°æ®é‡å¤å’Œä¸ä¸€è‡´

**å‰ç«¯è§£å†³æ–¹æ¡ˆ**:
```javascript
// AI Chatç•Œé¢æ˜¾ç¤ºå®Œæ•´å¯¹è¯å†å²
async function getFullChatHistory(conversationId) {
    // å¹¶è¡ŒæŸ¥è¯¢ä¸¤å¼ è¡¨
    const [aiChatRecords, workflowRecords] = await Promise.all([
        aiConversationApi.getContentList(conversationId),
        workflowApi.getConversationContent(conversationId)
    ]);

    // åˆå¹¶å¹¶æŒ‰æ—¶é—´æ’åº
    return [...aiChatRecords, ...workflowRecords]
        .sort((a, b) => new Date(a.c_time) - new Date(b.c_time));
}
```

**å®æ–½æˆæœ¬**: å‰ç«¯ä¿®æ”¹1ä¸ªæŸ¥è¯¢æ¥å£ï¼Œå·¥ä½œé‡çº¦30åˆ†é’Ÿ

---

### å»ºè®®2: å¦‚æœå¿…é¡»æŒ‰ç”¨æˆ·å…¥å£åˆ†ç±»

**æœ€å°ä¿®æ”¹æ–¹æ¡ˆ**: åœ¨ `AiConversationController.chatStream()` ä¸­æ·»åŠ  `doOnNext()` å›è°ƒï¼ŒåŒå†™æ•°æ®

**ä¿®æ”¹ä½ç½®**: 1ä¸ªæ–‡ä»¶ï¼Œ1ä¸ªæ–¹æ³•ï¼Œå¢åŠ çº¦10è¡Œä»£ç 

**å®æ–½æˆæœ¬**: çº¦1å°æ—¶ï¼ˆåŒ…æ‹¬æµ‹è¯•ï¼‰

**ä»£ä»·**:
- âŒ æ•°æ®é‡å¤å­˜å‚¨
- âŒ éœ€è¦ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§
- âŒ å­˜å‚¨ç©ºé—´å¢åŠ 

---

## ğŸ“Š ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | å½“å‰æ¶æ„ï¼ˆæŒ‰æ‰§è¡Œå¼•æ“ï¼‰ | ç”¨æˆ·æœŸæœ›ï¼ˆæŒ‰ç”¨æˆ·å…¥å£ï¼‰ |
|------|---------------------|---------------------|
| **æ•°æ®ä¸€è‡´æ€§** | âœ… é«˜ï¼ˆå•ä¸€æ•°æ®æºï¼‰ | âŒ ä½ï¼ˆå¯èƒ½é‡å¤/ä¸ä¸€è‡´ï¼‰ |
| **æŸ¥è¯¢æ•ˆç‡** | âœ… é«˜ï¼ˆå•è¡¨æŸ¥è¯¢ï¼‰ | âš ï¸ ä¸­ï¼ˆéœ€è¦UNIONï¼‰ |
| **å­˜å‚¨æˆæœ¬** | âœ… ä½ï¼ˆæ— é‡å¤ï¼‰ | âŒ é«˜ï¼ˆæ•°æ®é‡å¤ï¼‰ |
| **æ‰§è¡Œè¿½æº¯** | âœ… æ˜“ï¼ˆåŒä¸€å¼•æ“åœ¨åŒä¸€è¡¨ï¼‰ | âŒ éš¾ï¼ˆè·¨è¡¨è¿½æº¯ï¼‰ |
| **å‰ç«¯å¼€å‘** | âš ï¸ ç¨å¤æ‚ï¼ˆä¸¤è¡¨æŸ¥è¯¢ï¼‰ | âœ… ç®€å•ï¼ˆå•è¡¨æŸ¥è¯¢ï¼‰ |
| **ä»£ç ä¿®æ”¹** | âœ… æ— éœ€ä¿®æ”¹ | âŒ éœ€è¦ä¿®æ”¹ |

---

## ğŸ† æœ€ç»ˆç­”æ¡ˆ

**ä¸ä¿®æ”¹ä»£ç ï¼Œæ— æ³•å®ç°ä½ æœŸæœ›çš„æ•°æ®åˆ†ç¦»ã€‚**

**åŸå› **:
1. `workflowStarter.streaming()` ç¡¬ç¼–ç ä½¿ç”¨ `workflowDomainChatClient`
2. `workflowDomainChatClient` çš„ `defaultAdvisors` åœ¨Beanå®šä¹‰æ—¶å°±å›ºå®šäº†
3. `WorkflowConversationAdvisor` ç¡¬ç¼–ç ä¿å­˜åˆ° `ai_workflow_conversation_content`

**ä½†æ˜¯**ï¼Œå½“å‰çš„è®¾è®¡å®é™…ä¸Š**æ¯”ä½ æœŸæœ›çš„æ›´åˆç†**ï¼š
- âœ… æŒ‰æ‰§è¡Œå¼•æ“åˆ†ç±»ï¼Œæ•°æ®ä¸€è‡´æ€§æ›´å¼º
- âœ… é¿å…æ•°æ®é‡å¤
- âœ… ä¾¿äºWorkflowæ‰§è¡Œè¿½æº¯

**å»ºè®®**: ä¿æŒå½“å‰æ¶æ„ï¼Œé€šè¿‡å‰ç«¯è”åˆæŸ¥è¯¢è§£å†³ç•Œé¢æ˜¾ç¤ºé—®é¢˜ã€‚è¿™æ˜¯æœ€ä¼˜è§£ã€‚
