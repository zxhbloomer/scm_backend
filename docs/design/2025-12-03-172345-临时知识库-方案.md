# ä¸´æ—¶çŸ¥è¯†åº“åŠŸèƒ½å¼€å‘æ–¹æ¡ˆ

**æ–¹æ¡ˆç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-12-03 17:23:45
**è®¾è®¡è€…**: AIå¼€å‘åŠ©æ‰‹
**çŠ¶æ€**: å¾…å®¡æ‰¹

---

## ä¸€ã€éœ€æ±‚èƒŒæ™¯

### 1.1 ä¸šåŠ¡éœ€æ±‚
ç”¨æˆ·éœ€è¦åœ¨RAGå¯¹è¯åœºæ™¯ä¸­å¿«é€Ÿåˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“ï¼Œç”¨äºå³æ—¶é—®ç­”ï¼Œæ— éœ€é•¿æœŸä¿å­˜ã€‚ä¸´æ—¶çŸ¥è¯†åº“å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- **2å°æ—¶è‡ªåŠ¨è¿‡æœŸ**ï¼šåˆ›å»ºå2å°æ—¶è‡ªåŠ¨æ¸…ç†
- **ç®€åŒ–ç´¢å¼•æµç¨‹**ï¼šåªè¿›è¡Œå‘é‡åŒ–ç´¢å¼•ï¼Œä¸è¿›è¡ŒçŸ¥è¯†å›¾è°±ç´¢å¼•
- **UIæ“ä½œé™åˆ¶**ï¼šç¦ç”¨ç¼–è¾‘å’Œç®¡ç†åŠŸèƒ½ï¼Œä¿æŒåªè¯»çŠ¶æ€

### 1.2 åŠŸèƒ½èŒƒå›´
1. **å‰ç«¯äº¤äº’æ§åˆ¶**ï¼š
   - åˆ—è¡¨é¡µæ˜¾ç¤º"æ˜¯å¦ä¸´æ—¶"æ ‡è¯†
   - ä¸´æ—¶çŸ¥è¯†åº“ç¦ç”¨"ç¼–è¾‘"æŒ‰é’®
   - è¿›å…¥ä¸´æ—¶çŸ¥è¯†åº“åï¼Œæ‰€æœ‰ç®¡ç†æŒ‰é’®ç¦ç”¨
   - æ–°å¢"æŸ¥çœ‹"æŒ‰é’®ç”¨äºåªè¯»æŸ¥çœ‹çŸ¥è¯†ç‚¹è¯¦æƒ…

2. **åç«¯æ•°æ®æµ**ï¼š
   - åˆ›å»ºæ—¶è‡ªåŠ¨è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå½“å‰æ—¶é—´+2å°æ—¶ï¼‰
   - åªæ‰§è¡Œå‘é‡åŒ–ç´¢å¼•ï¼Œè·³è¿‡å›¾è°±åŒ–ç´¢å¼•
   - å®šæ—¶ä»»åŠ¡æ¯10åˆ†é’Ÿæ¸…ç†è¿‡æœŸçš„ä¸´æ—¶çŸ¥è¯†åº“

3. **é»˜è®¤é…ç½®**ï¼š
   - å‚è€ƒçŸ¥è¯†åº“ID `1994334750959017986` çš„é…ç½®
   - ä¸´æ—¶çŸ¥è¯†åº“å¼ºåˆ¶è®¾ä¸ºç§æœ‰ï¼ˆ`is_public=0`ï¼‰

---

## äºŒã€è°ƒç”¨é“¾è·¯åˆ†æ

### 2.1 å®Œæ•´è°ƒç”¨æµç¨‹å›¾

```
ç”¨æˆ·è¯·æ±‚ï¼ˆåˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“ï¼‰
    â†“
[å‰ç«¯] KnowledgeBaseEditDialog.vue
    â†“ (è°ƒç”¨API)
[å‰ç«¯API] knowledgeBaseService.saveOrUpdate(vo)
    â†“ (HTTP POST)
[åç«¯Controller] KnowledgeBaseController.saveOrUpdate(vo)
    â†“
[åç«¯Service] KnowledgeBaseService.saveOrUpdate(vo)
    â†“ (åˆ¤æ–­ vo.isTemp == 1)
    â”œâ”€ ä¸´æ—¶çŸ¥è¯†åº“åˆ†æ”¯:
    â”‚   â”œâ”€ è®¾ç½® is_temp = 1
    â”‚   â”œâ”€ è®¾ç½® expire_time = NOW() + 2å°æ—¶
    â”‚   â”œâ”€ è®¾ç½® is_public = 0
    â”‚   â””â”€ åº”ç”¨é»˜è®¤é…ç½®
    â””â”€ æ°¸ä¹…çŸ¥è¯†åº“åˆ†æ”¯:
        â””â”€ æ­£å¸¸æµç¨‹ï¼ˆç°æœ‰é€»è¾‘ï¼‰
    â†“
[æ•°æ®åº“] ai_knowledge_base è¡¨æ’å…¥
    â†“ (MyBatis Plusè‡ªåŠ¨å¡«å……)
    c_id, c_time, u_id, u_time, dbversion
    â†“
è¿”å›åˆ›å»ºæˆåŠŸ

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ç”¨æˆ·æ“ä½œï¼ˆä¸Šä¼ æ–‡æ¡£åˆ°ä¸´æ—¶çŸ¥è¯†åº“ï¼‰
    â†“
[å‰ç«¯] KnowledgeBaseDetailDialog.vue
    â†“ (æ ¹æ®kb.isTempåˆ¤æ–­)
    indexTypes = kb.isTemp ? 'embedding' : 'embedding,graphical'
    â†“
[å‰ç«¯API] knowledgeBaseService.uploadDoc(uuid, file, indexTypes)
    â†“
[åç«¯Controller] KnowledgeBaseController.upload(uuid, file, indexTypes)
    â†“
[åç«¯Service] DocumentProcessingService.uploadDoc(...)
    â†“
[RabbitMQ] å‘é€ç´¢å¼•æ¶ˆæ¯
    message.index_types = ['embedding'] // ä¸´æ—¶çŸ¥è¯†åº“åªåŒ…å«embedding
    â†“
[MQ Consumer] DocumentIndexingConsumer.onMessage(...)
    â†“
[åç«¯Service] DocumentIndexingService.processDocument(...)
    â†“ (Line 143)
    if (indexTypes.contains("embedding")) {
        æ‰§è¡Œå‘é‡åŒ–ç´¢å¼• â†’ Milvus
    }
    â†“ (Line 164)
    if (indexTypes.contains("graphical")) {
        // ä¸´æ—¶çŸ¥è¯†åº“ä¸åŒ…å«æ­¤ç±»å‹ï¼Œè·³è¿‡
        æ‰§è¡Œå›¾è°±åŒ–ç´¢å¼• â†’ Neo4j
    }
    â†“
æ›´æ–°ç´¢å¼•çŠ¶æ€å®Œæˆ

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

å®šæ—¶ä»»åŠ¡ï¼ˆQuartzè°ƒåº¦ï¼‰
    â†“ (æ¯10åˆ†é’Ÿè§¦å‘)
[Quartz Job] TempKnowledgeBaseCleanupJob.execute()
    â†“
æŸ¥è¯¢è¿‡æœŸä¸´æ—¶çŸ¥è¯†åº“:
    SELECT * FROM ai_knowledge_base
    WHERE is_temp = 1 AND expire_time < NOW()
    â†“
æ‰¹é‡åˆ é™¤:
    FOR EACH è¿‡æœŸçŸ¥è¯†åº“:
        knowledgeBaseService.delete(kbUuid)
            â†“
            åˆ é™¤ ai_knowledge_base_item
            åˆ é™¤ ai_knowledge_base_graph_segment
            åˆ é™¤ Milvuså‘é‡æ•°æ®
            åˆ é™¤ Neo4jå›¾è°±æ•°æ®ï¼ˆä¸´æ—¶KBåº”è¯¥æ²¡æœ‰ï¼‰
            åˆ é™¤ ai_knowledge_base
    â†“
æ—¥å¿—è®°å½•æ¸…ç†å®Œæˆ
```

### 2.2 å…³é”®åˆ¤æ–­ç‚¹

| åˆ¤æ–­ä½ç½® | åˆ¤æ–­æ¡ä»¶ | åˆ†æ”¯è¡Œä¸º |
|---------|---------|---------|
| KnowledgeBaseService.saveOrUpdate | `vo.getIsTemp() == 1` | è®¾ç½®ä¸´æ—¶çŸ¥è¯†åº“æ ‡è¯†å’Œè¿‡æœŸæ—¶é—´ |
| å‰ç«¯ä¸Šä¼ æ–‡ä»¶ | `kb.isTemp === 1` | indexTypesåªåŒ…å«'embedding' |
| DocumentIndexingService.processDocument | `indexTypes.contains("graphical")` | ä¸´æ—¶KBæ­¤æ¡ä»¶ä¸ºfalseï¼Œè·³è¿‡å›¾è°±ç´¢å¼• |
| TempKnowledgeBaseCleanupJob | `is_temp=1 AND expire_time < NOW()` | åˆ é™¤è¿‡æœŸä¸´æ—¶çŸ¥è¯†åº“ |

---

## ä¸‰ã€æ”¯æ’‘æ•°æ®åˆ†æ

### 3.1 æ•°æ®åº“ç°çŠ¶

**ai_knowledge_base è¡¨ç»“æ„**ï¼ˆéœ€è¦æ–°å¢å­—æ®µï¼‰ï¼š
```sql
-- ç°æœ‰å­—æ®µï¼ˆéƒ¨åˆ†ï¼‰
id VARCHAR(50) PRIMARY KEY
kb_uuid VARCHAR(100) UNIQUE
title VARCHAR(100)
is_public TINYINT DEFAULT 0
is_strict TINYINT DEFAULT 0
-- ... å…¶ä»–å­—æ®µ

-- éœ€è¦æ–°å¢çš„å­—æ®µ
is_temp TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦ä¸´æ—¶çŸ¥è¯†åº“(0-å¦,1-æ˜¯)'
expire_time DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´ï¼ˆä¸´æ—¶çŸ¥è¯†åº“æœ‰æ•ˆï¼‰'
```

**å‚è€ƒé…ç½®æ•°æ®**ï¼ˆID: 1994334750959017986ï¼‰ï¼š
```json
{
  "ingest_max_overlap": 2000,
  "ingest_model_id": "7",
  "retrieve_max_results": 5,
  "retrieve_min_score": 0.5000,
  "query_llm_temperature": 0.00,
  "is_strict": 1,
  "is_public": 1,  // ä¸´æ—¶çŸ¥è¯†åº“åº”æ”¹ä¸º0
  "query_system_message": "è¯·è¿”å›æœ¬çŸ¥è¯†åº“çš„çš„å®Œæ•´åŸæ–‡æ¸…å•ï¼Œé€æ¡åˆ—å‡º..."
}
```

### 3.2 ç°æœ‰ä»£ç é€»è¾‘åˆ†æ

**ç´¢å¼•ç±»å‹æ§åˆ¶æœºåˆ¶**ï¼ˆå·²éªŒè¯ï¼‰ï¼š
- `DocumentIndexingService.processDocument()` é€šè¿‡ `indexTypes` å‚æ•°æ§åˆ¶ç´¢å¼•è¡Œä¸º
- Line 143: `if (indexTypes.contains(INDEX_TYPE_EMBEDDING))` - å‘é‡ç´¢å¼•
- Line 164: `if (indexTypes.contains(INDEX_TYPE_GRAPHICAL))` - å›¾è°±ç´¢å¼•
- **ç»“è®º**ï¼šä¸´æ—¶çŸ¥è¯†åº“åªéœ€åœ¨ `indexTypes` ä¸­æ’é™¤ "graphical" å³å¯è·³è¿‡å›¾è°±ç´¢å¼•

**æ•°æ®æ’å…¥æµç¨‹**ï¼ˆå·²éªŒè¯ï¼‰ï¼š
- **åŒæ­¥é˜¶æ®µ**ï¼š`KnowledgeBaseService.saveOrUpdate()` æ’å…¥ `ai_knowledge_base` è¡¨
- **å¼‚æ­¥é˜¶æ®µ**ï¼šRabbitMQæ¶ˆè´¹å `DocumentIndexingService.processDocument()` å¤„ç†å‘é‡åŒ–å’Œå›¾è°±åŒ–
- **ç»“è®º**ï¼šä¸´æ—¶çŸ¥è¯†åº“æ ‡è¯†éœ€åœ¨åŒæ­¥é˜¶æ®µè®¾ç½®ï¼Œç´¢å¼•ç±»å‹æ§åˆ¶åœ¨å¼‚æ­¥é˜¶æ®µç”Ÿæ•ˆ

---

## å››ã€æ–¹æ¡ˆè®¾è®¡

### 4.1 æ•°æ®åº“è®¾è®¡

#### DDLè„šæœ¬
```sql
-- æ–‡ä»¶ä½ç½®ï¼šscm-ai/src/main/resources/db/migration/V1.1.0__add_temp_kb_fields.sql

ALTER TABLE ai_knowledge_base
ADD COLUMN is_temp TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦ä¸´æ—¶çŸ¥è¯†åº“(0-å¦,1-æ˜¯)',
ADD COLUMN expire_time DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´ï¼ˆä¸´æ—¶çŸ¥è¯†åº“2å°æ—¶åè¿‡æœŸï¼‰';

-- ä¸ºæ¸…ç†ä»»åŠ¡æ·»åŠ ç´¢å¼•
CREATE INDEX idx_ai_knowledge_base_temp_cleanup
ON ai_knowledge_base(is_temp, expire_time);
```

**å‘åå…¼å®¹æ€§éªŒè¯**ï¼š
- âœ… æ–°å¢å­—æ®µæœ‰é»˜è®¤å€¼ `DEFAULT 0`ï¼Œç°æœ‰æ•°æ®è‡ªåŠ¨ä¸ºæ°¸ä¹…çŸ¥è¯†åº“
- âœ… ç°æœ‰æŸ¥è¯¢ä¸ä½¿ç”¨è¿™ä¸¤ä¸ªå­—æ®µï¼Œæ— å½±å“
- âœ… ç´¢å¼•ä¸å½±å“ç°æœ‰æŸ¥è¯¢æ€§èƒ½

---

### 4.2 åç«¯å®ç°è®¾è®¡

#### 4.2.1 å®ä½“ç±»ä¿®æ”¹

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/entity/rag/AiKnowledgeBaseEntity.java`

```java
/**
 * æ˜¯å¦ä¸´æ—¶çŸ¥è¯†åº“(0-å¦,1-æ˜¯)
 */
@TableField("is_temp")
private Integer is_temp;

/**
 * è¿‡æœŸæ—¶é—´ï¼ˆä¸´æ—¶çŸ¥è¯†åº“æœ‰æ•ˆï¼‰
 */
@TableField("expire_time")
private LocalDateTime expire_time;
```

**ä¿®æ”¹åŸå› **ï¼š
- éµå¾ªSCMè§„èŒƒï¼šå®ä½“ç±»å­—æ®µä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼Œä¸ä½¿ç”¨é©¼å³°
- ä½¿ç”¨ `@TableField` æ˜¾å¼æ˜ å°„æ•°æ®åº“å­—æ®µ
- ä¸æ·»åŠ ä»»ä½•MyBatis Plusè‡ªåŠ¨å¡«å……æ³¨è§£ï¼ˆè¿™ä¸¤ä¸ªå­—æ®µç”±ä¸šåŠ¡é€»è¾‘æ§åˆ¶ï¼‰

---

#### 4.2.2 VOç±»ä¿®æ”¹

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/rag/AiKnowledgeBaseVo.java`

```java
/**
 * æ˜¯å¦ä¸´æ—¶çŸ¥è¯†åº“(0-å¦,1-æ˜¯)
 */
private Integer isTemp;

/**
 * è¿‡æœŸæ—¶é—´ï¼ˆä¸´æ—¶çŸ¥è¯†åº“æœ‰æ•ˆï¼‰
 */
private LocalDateTime expireTime;
```

**ä¿®æ”¹åŸå› **ï¼š
- VOç±»ä½¿ç”¨é©¼å³°å‘½åï¼Œç¬¦åˆJavaè§„èŒƒ
- `BeanUtils.copyProperties` è‡ªåŠ¨å¤„ç†ä¸‹åˆ’çº¿åˆ°é©¼å³°çš„è½¬æ¢
- å‰ç«¯APIè¿”å›å’Œæ¥æ”¶éƒ½ä½¿ç”¨é©¼å³°æ ¼å¼

---

#### 4.2.3 Serviceé€»è¾‘ä¿®æ”¹

**æ–‡ä»¶**: `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/KnowledgeBaseService.java`

**ä¿®æ”¹ä½ç½®**: `saveOrUpdate()` æ–¹æ³•çš„æ–°å¢é€»è¾‘

```java
@Transactional(rollbackFor = Exception.class)
public AiKnowledgeBaseVo saveOrUpdate(AiKnowledgeBaseVo vo) {
    AiKnowledgeBaseEntity entity = new AiKnowledgeBaseEntity();
    boolean isNew = (vo.getKbUuid() == null || vo.getKbUuid().isEmpty());

    if (isNew) {
        BeanUtils.copyProperties(vo, entity, "id");

        // ç”Ÿæˆkb_uuid
        String tenantCode = DataSourceHelper.getCurrentDataSourceName();
        String uuid = UuidUtil.createShort();
        entity.setKbUuid(tenantCode + "::" + uuid);

        // è®¾ç½®æ‰€æœ‰è€…
        Long currentUserId = SecurityUtil.getStaff_id();
        entity.setOwnerId(String.valueOf(currentUserId));
        MStaffVo staffVo = staffService.selectByid(currentUserId);
        if (staffVo != null && staffVo.getName() != null) {
            entity.setOwnerName(staffVo.getName());
        }

        // âœ… æ–°å¢ï¼šä¸´æ—¶çŸ¥è¯†åº“ç‰¹æ®Šå¤„ç†
        if (vo.getIsTemp() != null && vo.getIsTemp() == 1) {
            entity.setIs_temp(1);
            entity.setExpire_time(LocalDateTime.now().plusHours(2));
            entity.setIs_public(0); // ä¸´æ—¶çŸ¥è¯†åº“å¼ºåˆ¶ç§æœ‰

            // åº”ç”¨é»˜è®¤é…ç½®ï¼ˆå‚è€ƒKB ID: 1994334750959017986ï¼‰
            entity.setIngest_max_overlap(2000);
            entity.setIngest_model_id("7");
            entity.setRetrieve_max_results(5);
            entity.setRetrieve_min_score(new BigDecimal("0.5000"));
            entity.setQuery_llm_temperature(new BigDecimal("0.00"));
            entity.setIs_strict(1);
            entity.setQuery_system_message("è¯·è¿”å›æœ¬çŸ¥è¯†åº“çš„çš„å®Œæ•´åŸæ–‡æ¸…å•ï¼Œé€æ¡åˆ—å‡ºã€‚\nè¦æ±‚ï¼š\n- å…¨éƒ¨çš„æ¸…å•ï¼Œä¸è¦é‡å¤\n- ä»…è¾“å‡ºåŸæ–‡å†…å®¹ï¼Œä¸è¦æ€»ç»“ã€æ¦‚æ‹¬ã€æ‰©å†™æˆ–æ”¹å†™ã€‚\n- ä¿ç•™åŸå§‹é¡ºåºä¸è¡¨è¿°ï¼Œä¸æ–°å¢æˆ–åˆ é™¤ä¿¡æ¯ã€‚\n- ä¸æ·»åŠ ä»»ä½•å‰åç¼€ã€è§£é‡Šæˆ–è¯„è®ºã€‚\n- è‹¥å­˜åœ¨åˆ†èŠ‚/æ¡ç›®,è¯·æŒ‰åŸæ–‡åˆ†èŠ‚/åˆ†æ¡ä¾æ¬¡åˆ—å‡ºã€‚\n- è‹¥æŸ¥æ— å†…å®¹ï¼Œè¯·æ˜ç¡®è¯´æ˜\"æœªæ‰¾åˆ°ç›¸å…³åŸæ–‡\"ã€‚");
        }

        knowledgeBaseMapper.insert(entity);
        BeanUtils.copyProperties(entity, vo);

    } else {
        // æ›´æ–°é€»è¾‘ä¿æŒä¸å˜
        AiKnowledgeBaseEntity existEntity = knowledgeBaseMapper.selectById(vo.getId());
        if (existEntity == null) {
            throw new RuntimeException("çŸ¥è¯†åº“ä¸å­˜åœ¨ï¼Œæ— æ³•æ›´æ–°");
        }

        // âš ï¸ æ³¨æ„ï¼šä¸´æ—¶çŸ¥è¯†åº“ä¸å…è®¸ç¼–è¾‘ï¼Œå‰ç«¯å·²ç¦ç”¨ï¼Œæ­¤å¤„æ— éœ€ç‰¹æ®Šå¤„ç†
        existEntity.setTitle(vo.getTitle());
        existEntity.setRemark(vo.getRemark());
        // ... å…¶ä»–å­—æ®µæ›´æ–°

        knowledgeBaseMapper.updateById(existEntity);
        BeanUtils.copyProperties(existEntity, vo);
    }

    return vo;
}
```

**å…³é”®é€»è¾‘è¯´æ˜**ï¼š
1. **åˆ¤æ–­æ¡ä»¶**ï¼š`vo.getIsTemp() != null && vo.getIsTemp() == 1`
2. **è¿‡æœŸæ—¶é—´**ï¼š`LocalDateTime.now().plusHours(2)` - å½“å‰æ—¶é—´+2å°æ—¶
3. **å¼ºåˆ¶ç§æœ‰**ï¼šä¸´æ—¶çŸ¥è¯†åº“ä¸å¯å…¬å¼€ï¼Œé˜²æ­¢å…¶ä»–ç”¨æˆ·è®¿é—®å³å°†è¿‡æœŸçš„æ•°æ®
4. **é»˜è®¤é…ç½®**ï¼šç›´æ¥ç¡¬ç¼–ç å‚è€ƒé…ç½®ï¼Œé¿å…é¢å¤–æ•°æ®åº“æŸ¥è¯¢

---

#### 4.2.4 æ¸…ç†ä»»åŠ¡å®ç°ï¼ˆæ–°å¢æ–‡ä»¶ï¼‰

**æ–‡ä»¶**: `scm-quartz/src/main/java/com/xinyirun/scm/quartz/job/TempKnowledgeBaseCleanupJob.java`

```java
package com.xinyirun.scm.quartz.job;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.xinyirun.scm.ai.bean.entity.rag.AiKnowledgeBaseEntity;
import com.xinyirun.scm.ai.core.mapper.rag.AiKnowledgeBaseMapper;
import com.xinyirun.scm.ai.core.service.KnowledgeBaseService;
import com.xinyirun.scm.common.utils.datasource.DataSourceHelper;
import lombok.extern.slf4j.Slf4j;
import org.quartz.DisallowConcurrentExecution;
import org.quartz.JobExecutionContext;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.quartz.QuartzJobBean;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.List;

/**
 * ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†ä»»åŠ¡
 *
 * æ‰§è¡Œé¢‘ç‡ï¼šæ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
 * Cronè¡¨è¾¾å¼ï¼š0 *&#47;10 * * * ?
 *
 * åŠŸèƒ½è¯´æ˜ï¼š
 * 1. æŸ¥è¯¢æ‰€æœ‰è¿‡æœŸçš„ä¸´æ—¶çŸ¥è¯†åº“ï¼ˆis_temp=1 ä¸” expire_time < NOW()ï¼‰
 * 2. æ‰¹é‡åˆ é™¤è¿‡æœŸä¸´æ—¶çŸ¥è¯†åº“åŠå…¶å…³è”æ•°æ®
 * 3. è®°å½•æ¸…ç†æ—¥å¿—
 */
@Slf4j
@Component
@DisallowConcurrentExecution
public class TempKnowledgeBaseCleanupJob extends QuartzJobBean {

    @Autowired
    private AiKnowledgeBaseMapper knowledgeBaseMapper;

    @Autowired
    private KnowledgeBaseService knowledgeBaseService;

    @Override
    protected void executeInternal(JobExecutionContext context) {
        log.info("å¼€å§‹æ¸…ç†è¿‡æœŸä¸´æ—¶çŸ¥è¯†åº“");

        // è·å–ç§Ÿæˆ·ä¿¡æ¯ï¼ˆä»JobDataMapä¸­ï¼‰
        String tenantCode = context.getJobDetail().getJobDataMap().getString("tenant_code");
        if (tenantCode != null && !tenantCode.isEmpty()) {
            DataSourceHelper.use(tenantCode);
        }

        try {
            // æŸ¥è¯¢è¿‡æœŸçš„ä¸´æ—¶çŸ¥è¯†åº“
            List<AiKnowledgeBaseEntity> expiredKbs = knowledgeBaseMapper.selectList(
                new LambdaQueryWrapper<AiKnowledgeBaseEntity>()
                    .eq(AiKnowledgeBaseEntity::getIs_temp, 1)
                    .lt(AiKnowledgeBaseEntity::getExpire_time, LocalDateTime.now())
            );

            if (expiredKbs.isEmpty()) {
                log.info("æ— è¿‡æœŸä¸´æ—¶çŸ¥è¯†åº“éœ€è¦æ¸…ç†");
                return;
            }

            int successCount = 0;
            int failCount = 0;

            // æ‰¹é‡åˆ é™¤
            for (AiKnowledgeBaseEntity kb : expiredKbs) {
                try {
                    log.info("æ¸…ç†ä¸´æ—¶çŸ¥è¯†åº“: id={}, kb_uuid={}, title={}, expire_time={}",
                        kb.getId(), kb.getKbUuid(), kb.getTitle(), kb.getExpire_time());

                    // è°ƒç”¨å·²æœ‰çš„åˆ é™¤é€»è¾‘ï¼ˆä¼šçº§è”åˆ é™¤å…³è”æ•°æ®ï¼‰
                    knowledgeBaseService.delete(kb.getKbUuid());
                    successCount++;

                } catch (Exception e) {
                    log.error("æ¸…ç†ä¸´æ—¶çŸ¥è¯†åº“å¤±è´¥: id={}, kb_uuid={}, error={}",
                        kb.getId(), kb.getKbUuid(), e.getMessage(), e);
                    failCount++;
                }
            }

            log.info("ä¸´æ—¶çŸ¥è¯†åº“æ¸…ç†å®Œæˆ: æ€»æ•°={}, æˆåŠŸ={}, å¤±è´¥={}",
                expiredKbs.size(), successCount, failCount);

        } catch (Exception e) {
            log.error("æ¸…ç†è¿‡æœŸä¸´æ—¶çŸ¥è¯†åº“ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {}", e.getMessage(), e);
        }
    }
}
```

**Quartzé…ç½®æ³¨å†Œ**ï¼ˆéœ€è¦åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æ³¨å†Œï¼‰ï¼š
```java
// åœ¨QuartzSchedulerConfigæˆ–ç±»ä¼¼çš„é…ç½®ç±»ä¸­æ·»åŠ 
@PostConstruct
public void initTempKbCleanupJob() throws SchedulerException {
    JobDetail jobDetail = JobBuilder.newJob(TempKnowledgeBaseCleanupJob.class)
        .withIdentity("tempKbCleanupJob", "ai")
        .storeDurably()
        .build();

    Trigger trigger = TriggerBuilder.newTrigger()
        .withIdentity("tempKbCleanupTrigger", "ai")
        .withSchedule(CronScheduleBuilder.cronSchedule("0 */10 * * * ?"))
        .build();

    scheduler.scheduleJob(jobDetail, trigger);
}
```

**å…³é”®é€»è¾‘è¯´æ˜**ï¼š
1. **æŸ¥è¯¢æ¡ä»¶**ï¼š`is_temp=1 AND expire_time < NOW()`
2. **ç§Ÿæˆ·å¤„ç†**ï¼šé€šè¿‡ `DataSourceHelper.use(tenantCode)` è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
3. **å¤ç”¨åˆ é™¤é€»è¾‘**ï¼šè°ƒç”¨ `knowledgeBaseService.delete()` è‡ªåŠ¨å¤„ç†çº§è”åˆ é™¤
4. **é”™è¯¯éš”ç¦»**ï¼šå•ä¸ªçŸ¥è¯†åº“åˆ é™¤å¤±è´¥ä¸å½±å“å…¶ä»–çŸ¥è¯†åº“çš„æ¸…ç†

---

### 4.3 å‰ç«¯å®ç°è®¾è®¡

#### 4.3.1 çŸ¥è¯†åº“åˆ—è¡¨é¡µä¿®æ”¹

**æ–‡ä»¶**: `01_scm_frontend/scm_frontend/src/components/70_ai/components/rag/dialogs/KnowledgeBaseManageDialog.vue`

**ä¿®æ”¹ä½ç½®1ï¼šæ·»åŠ "æ˜¯å¦ä¸´æ—¶"åˆ—**ï¼ˆLine 89åæ’å…¥ï¼‰
```vue
<el-table-column
  prop="isTemp"
  label="æ˜¯å¦ä¸´æ—¶"
  width="100"
>
  <template slot-scope="scope">
    <el-tag :type="scope.row.isTemp ? 'warning' : 'info'" size="small">
      {{ scope.row.isTemp ? 'ä¸´æ—¶' : 'æ°¸ä¹…' }}
    </el-tag>
  </template>
</el-table-column>
```

**ä¿®æ”¹ä½ç½®2ï¼šç¦ç”¨ä¸´æ—¶KBçš„ç¼–è¾‘æŒ‰é’®**ï¼ˆLine 126-132ä¿®æ”¹ï¼‰
```vue
<el-button
  type="text"
  size="small"
  :disabled="scope.row.isTemp"
  @click="handleEdit(scope.row)"
>
  ç¼–è¾‘
</el-button>
```

**UIæ•ˆæœè¯´æ˜**ï¼š
- ä¸´æ—¶çŸ¥è¯†åº“æ˜¾ç¤ºé»„è‰²"ä¸´æ—¶"æ ‡ç­¾
- æ°¸ä¹…çŸ¥è¯†åº“æ˜¾ç¤ºç°è‰²"æ°¸ä¹…"æ ‡ç­¾
- ä¸´æ—¶çŸ¥è¯†åº“çš„"ç¼–è¾‘"æŒ‰é’®ç½®ç°ä¸å¯ç‚¹å‡»

---

#### 4.3.2 çŸ¥è¯†åº“è¯¦æƒ…é¡µä¿®æ”¹

**æ–‡ä»¶**: `01_scm_frontend/scm_frontend/src/components/70_ai/components/rag/dialogs/KnowledgeBaseDetailDialog.vue`

**ä¿®æ”¹ä½ç½®1ï¼šæ·»åŠ propsæ¥æ”¶ä¸´æ—¶æ ‡è¯†**ï¼ˆLine 347-360ä¿®æ”¹ï¼‰
```javascript
props: {
  visible: {
    type: Boolean,
    default: false
  },
  kbUuid: {
    type: String,
    default: ''
  },
  kbTitle: {
    type: String,
    default: ''
  },
  // âœ… æ–°å¢ï¼šæ¥æ”¶ä¸´æ—¶çŸ¥è¯†åº“æ ‡è¯†
  kbInfo: {
    type: Object,
    default: () => ({})
  }
}
```

**ä¿®æ”¹ä½ç½®2ï¼šæ·»åŠ computedè®¡ç®—å±æ€§**ï¼ˆLine 385-389åæ·»åŠ ï¼‰
```javascript
computed: {
  dialogTitle() {
    return this.kbTitle ? `${this.kbTitle} - çŸ¥è¯†ç‚¹ç®¡ç†` : 'çŸ¥è¯†ç‚¹ç®¡ç†'
  },
  // âœ… æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºä¸´æ—¶çŸ¥è¯†åº“
  isTemporary() {
    return this.kbInfo && this.kbInfo.isTemp === 1
  }
}
```

**ä¿®æ”¹ä½ç½®3ï¼šç¦ç”¨æ‰€æœ‰ç®¡ç†æŒ‰é’®**ï¼ˆLine 23-54ä¿®æ”¹ï¼‰
```vue
<el-button
  size="small"
  type="primary"
  icon="el-icon-plus"
  :disabled="!kbUuid || isTemporary"
  @click="handleAdd"
>
  æ–°å»ºçŸ¥è¯†ç‚¹
</el-button>
<el-button
  size="small"
  icon="el-icon-upload"
  :disabled="!kbUuid || isTemporary"
  @click="handleUpload"
>
  ä¸Šä¼ æ–‡ä»¶
</el-button>
<el-button
  size="small"
  icon="el-icon-setting"
  :disabled="selectedItems.length === 0 || isTemporary"
  @click="handleBatchIndex"
>
  æ‰¹é‡ç´¢å¼• ({{ selectedItems.length }})
</el-button>
<!-- åˆ·æ–°çŠ¶æ€æŒ‰é’®ä¸ç¦ç”¨ -->
<el-button
  size="small"
  icon="el-icon-refresh"
  @click="handleRefreshIndexStatus"
>
  åˆ·æ–°çŠ¶æ€
</el-button>
```

**ä¿®æ”¹ä½ç½®4ï¼šæ·»åŠ "æŸ¥çœ‹"æŒ‰é’®å¹¶ç¦ç”¨ç¼–è¾‘æŒ‰é’®**ï¼ˆLine 212-250ä¿®æ”¹ï¼‰
```vue
<el-table-column
  label="æ“ä½œ"
  width="320"
  fixed="right"
>
  <template slot-scope="scope">
    <!-- âœ… æ–°å¢ï¼šæŸ¥çœ‹æŒ‰é’®ï¼ˆä¸´æ—¶çŸ¥è¯†åº“å¯ç”¨ï¼‰ -->
    <el-button
      v-if="isTemporary"
      type="text"
      size="small"
      @click="handleView(scope.row)"
    >
      æŸ¥çœ‹
    </el-button>
    <!-- ç¼–è¾‘æŒ‰é’®ï¼ˆä¸´æ—¶çŸ¥è¯†åº“ç¦ç”¨ï¼‰ -->
    <el-button
      v-if="!isTemporary"
      type="text"
      size="small"
      @click="handleEdit(scope.row)"
    >
      ç¼–è¾‘
    </el-button>
    <!-- åµŒå…¥ã€å›¾è°±ã€é¢„è§ˆæŒ‰é’®ä¿æŒå¯ç”¨ -->
    <el-button
      type="text"
      size="small"
      @click="handleViewEmbedding(scope.row)"
    >
      åµŒå…¥
    </el-button>
    <el-button
      type="text"
      size="small"
      @click="handleViewGraph(scope.row)"
    >
      å›¾è°±
    </el-button>
    <el-button
      v-if="scope.row.fileName"
      type="text"
      size="small"
      @click="handlePreviewFile(scope.row)"
    >
      é¢„è§ˆ
    </el-button>
    <!-- åˆ é™¤æŒ‰é’®ï¼ˆä¸´æ—¶çŸ¥è¯†åº“ç¦ç”¨ï¼‰ -->
    <el-button
      type="text"
      size="small"
      style="color: #f56c6c"
      :disabled="isTemporary"
      @click="handleDelete(scope.row)"
    >
      åˆ é™¤
    </el-button>
  </template>
</el-table-column>
```

**ä¿®æ”¹ä½ç½®5ï¼šæ·»åŠ æŸ¥çœ‹æ–¹æ³•å’Œå¼•å…¥æŸ¥çœ‹å¯¹è¯æ¡†**ï¼ˆLine 480åæ·»åŠ ï¼‰
```javascript
methods: {
  // ... ç°æœ‰æ–¹æ³•

  /**
   * æŸ¥çœ‹çŸ¥è¯†ç‚¹ï¼ˆåªè¯»ï¼‰
   */
  handleView(row) {
    this.currentItem = { ...row }
    this.viewDialogVisible = true
  }
}
```

**dataä¸­æ·»åŠ **ï¼ˆLine 378æ·»åŠ ï¼‰ï¼š
```javascript
data() {
  return {
    // ... ç°æœ‰æ•°æ®
    viewDialogVisible: false,  // âœ… æ–°å¢ï¼šæŸ¥çœ‹å¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€
  }
}
```

**componentsä¸­å¼•å…¥**ï¼ˆLine 337-344æ·»åŠ ï¼‰ï¼š
```javascript
import KnowledgeItemViewDialog from './KnowledgeItemViewDialog.vue'

components: {
  KnowledgeItemEditDialog,
  KnowledgeItemUploadDialog,
  KnowledgeIndexDialog,
  ItemEmbeddingDialog,
  ItemGraphDialog,
  FilePreview,
  Pagination,
  KnowledgeItemViewDialog  // âœ… æ–°å¢
}
```

**templateä¸­æ·»åŠ å¯¹è¯æ¡†**ï¼ˆLine 299åæ·»åŠ ï¼‰ï¼š
```vue
<!-- çŸ¥è¯†ç‚¹æŸ¥çœ‹å¯¹è¯æ¡†ï¼ˆåªè¯»ï¼‰ -->
<knowledge-item-view-dialog
  :visible.sync="viewDialogVisible"
  :item-info="currentItem"
/>
```

---

#### 4.3.3 çŸ¥è¯†ç‚¹æŸ¥çœ‹å¯¹è¯æ¡†ï¼ˆæ–°å¢æ–‡ä»¶ï¼‰

**æ–‡ä»¶**: `01_scm_frontend/scm_frontend/src/components/70_ai/components/rag/dialogs/KnowledgeItemViewDialog.vue`ï¼ˆæ–°å»ºï¼‰

```vue
<template>
  <el-dialog
    v-if="visible"
    v-el-drag-dialog
    :visible="visible"
    title="æŸ¥çœ‹çŸ¥è¯†ç‚¹"
    :modal="true"
    :close-on-click-modal="false"
    :close-on-press-escape="false"
    :show-close="true"
    :append-to-body="true"
    :modal-append-to-body="true"
    width="700px"
    destroy-on-close
    @close="handleClose"
  >
    <div class="item-view-container">
      <el-form label-width="80px">
        <el-form-item label="æ ‡é¢˜">
          <div class="view-text">{{ formData.title || '-' }}</div>
        </el-form-item>

        <el-form-item label="æ‘˜è¦">
          <div class="view-text">{{ formData.brief || '-' }}</div>
        </el-form-item>

        <el-form-item label="å†…å®¹">
          <div class="view-content">{{ formData.remark || '-' }}</div>
        </el-form-item>

        <el-form-item label="å‘é‡åŒ–çŠ¶æ€">
          <el-tag
            v-if="formData.embeddingStatus === 3"
            type="success"
            size="small"
          >
            å·²å®Œæˆ
          </el-tag>
          <el-tag
            v-else-if="formData.embeddingStatus === 2"
            type="warning"
            size="small"
          >
            å¤„ç†ä¸­
          </el-tag>
          <el-tag
            v-else-if="formData.embeddingStatus === 4"
            type="danger"
            size="small"
          >
            å¤±è´¥
          </el-tag>
          <el-tag
            v-else
            type="info"
            size="small"
          >
            å¾…å¤„ç†
          </el-tag>
        </el-form-item>

        <el-form-item label="åˆ›å»ºæ—¶é—´">
          <div class="view-text">{{ formData.c_time || '-' }}</div>
        </el-form-item>
      </el-form>
    </div>

    <div slot="footer" class="dialog-footer">
      <el-button @click="handleClose">å…³é—­</el-button>
    </div>
  </el-dialog>
</template>

<script>
import { createEmptyKbItem } from '../utils/knowledgeBaseUtils'
import elDragDialog from '@/directive/el-drag-dialog'

export default {
  name: 'KnowledgeItemViewDialog',

  directives: { elDragDialog },

  props: {
    visible: {
      type: Boolean,
      default: false
    },
    itemInfo: {
      type: Object,
      default: null
    }
  },

  data() {
    return {
      formData: createEmptyKbItem()
    }
  },

  watch: {
    visible(val) {
      if (val) {
        this.initFormData()
      }
    },

    itemInfo: {
      handler(val) {
        if (val && this.visible) {
          this.initFormData()
        }
      },
      deep: true
    }
  },

  methods: {
    initFormData() {
      if (this.itemInfo && this.itemInfo.id !== '0') {
        this.formData = { ...this.itemInfo }
      } else {
        this.formData = createEmptyKbItem()
      }
    },

    handleClose() {
      this.$emit('update:visible', false)
    }
  }
}
</script>

<style scoped>
.item-view-container {
  padding: 10px;
}

.view-text {
  line-height: 32px;
  color: #606266;
}

.view-content {
  white-space: pre-wrap;
  word-wrap: break-word;
  line-height: 1.6;
  color: #606266;
  max-height: 300px;
  overflow-y: auto;
  padding: 10px;
  background-color: #f5f7fa;
  border-radius: 4px;
}
</style>
```

**å…³é”®è¯´æ˜**ï¼š
- æ‰€æœ‰è¾“å…¥æ¡†æ›¿æ¢ä¸º `<div>` æ˜¾ç¤ºæ–‡æœ¬
- ç§»é™¤æ‰€æœ‰ç¼–è¾‘åŠŸèƒ½å’Œæäº¤æŒ‰é’®
- ä¿ç•™æ‹–æ‹½åŠŸèƒ½å’Œå…³é—­æŒ‰é’®
- æ ·å¼ä¿æŒä¸ç¼–è¾‘å¯¹è¯æ¡†ä¸€è‡´

---

#### 4.3.4 çˆ¶ç»„ä»¶ä¼ å‚ä¿®æ”¹

**æ–‡ä»¶**: `KnowledgeBaseManageDialog.vue`

**ä¿®æ”¹ä½ç½®ï¼šæ‰“å¼€è¯¦æƒ…æ—¶ä¼ å…¥å®Œæ•´KBä¿¡æ¯**ï¼ˆLine 367-371ä¿®æ”¹ï¼‰
```javascript
handleOpenDetail(row) {
  this.currentKbUuid = row.kbUuid
  this.currentKbTitle = row.title
  this.currentKbInfo = row  // âœ… æ–°å¢ï¼šä¼ é€’å®Œæ•´çš„KBä¿¡æ¯
  this.detailDialogVisible = true
}
```

**dataä¸­æ·»åŠ **ï¼ˆLine 229-236ä¿®æ”¹ï¼‰ï¼š
```javascript
data() {
  return {
    // ... ç°æœ‰æ•°æ®
    currentKbInfo: null,  // âœ… æ–°å¢ï¼šå½“å‰é€‰ä¸­çš„KBä¿¡æ¯
  }
}
```

**templateä¸­ä¿®æ”¹è¯¦æƒ…å¯¹è¯æ¡†props**ï¼ˆLine 164-170ä¿®æ”¹ï¼‰ï¼š
```vue
<knowledge-base-detail-dialog
  :visible.sync="detailDialogVisible"
  :kb-uuid="currentKbUuid"
  :kb-title="currentKbTitle"
  :kb-info="currentKbInfo"
  @close="detailDialogVisible = false"
/>
```

---

### 4.4 ç´¢å¼•ç±»å‹æ§åˆ¶

**å…³é”®æ§åˆ¶ç‚¹**ï¼šå‰ç«¯ä¸Šä¼ æ–‡ä»¶æ—¶æ ¹æ®ä¸´æ—¶æ ‡è¯†å†³å®š `indexTypes` å‚æ•°

**ä¿®æ”¹æ–‡ä»¶**: `KnowledgeItemUploadDialog.vue` æˆ–åœ¨ä¸Šä¼ é€»è¾‘ä¸­æ·»åŠ åˆ¤æ–­

```javascript
// ä¸Šä¼ æ–‡ä»¶æ—¶çš„ç´¢å¼•ç±»å‹åˆ¤æ–­
const indexTypes = this.kbInfo.isTemp === 1
  ? 'embedding'              // ä¸´æ—¶çŸ¥è¯†åº“ï¼šä»…å‘é‡ç´¢å¼•
  : 'embedding,graphical'    // æ°¸ä¹…çŸ¥è¯†åº“ï¼šå‘é‡+å›¾è°±ç´¢å¼•

await knowledgeBaseService.uploadDoc(this.kbUuid, file, indexTypes)
```

**åç«¯è‡ªåŠ¨å¤„ç†**ï¼š
- `DocumentIndexingService.processDocument()` æ ¹æ® `indexTypes` å‚æ•°è‡ªåŠ¨åˆ¤æ–­
- Line 143: `if (indexTypes.contains("embedding"))` â†’ ä¸´æ—¶KBæ‰§è¡Œ
- Line 164: `if (indexTypes.contains("graphical"))` â†’ ä¸´æ—¶KBè·³è¿‡

---

## äº”ã€KISSåŸåˆ™7é—®é¢˜å›ç­”

### 1. è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ
**âœ… çœŸé—®é¢˜**
- ç”¨æˆ·æ˜ç¡®æå‡ºéœ€æ±‚ï¼ŒåŒ…å«è¯¦ç»†çš„UIæˆªå›¾å’Œä¸šåŠ¡åœºæ™¯æè¿°
- ä¸´æ—¶çŸ¥è¯†åº“ç”¨äºå³æ—¶å¯¹è¯åœºæ™¯ï¼Œæ— éœ€é•¿æœŸä¿å­˜ï¼Œç¬¦åˆå®é™…ä¸šåŠ¡éœ€æ±‚
- 2å°æ—¶è‡ªåŠ¨è¿‡æœŸæœºåˆ¶å¯é¿å…æ•°æ®ç´¯ç§¯å’Œå­˜å‚¨æµªè´¹

### 2. æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ
**âœ… å·²æ˜¯æœ€ç®€æ–¹æ¡ˆ**
- **æ•°æ®ç»“æ„**ï¼šä»…æ–°å¢2ä¸ªå­—æ®µï¼ˆ`is_temp`, `expire_time`ï¼‰ï¼Œä¸åˆ›å»ºæ–°è¡¨
- **ç´¢å¼•æ§åˆ¶**ï¼šå¤ç”¨ç°æœ‰ `indexTypes` å‚æ•°æœºåˆ¶ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒç´¢å¼•é€»è¾‘
- **æ¸…ç†æœºåˆ¶**ï¼šé€šè¿‡Quartzå®šæ—¶ä»»åŠ¡ï¼Œå¤ç”¨ç°æœ‰ `delete()` æ–¹æ³•ï¼Œæ— éœ€é‡å¤å®ç°çº§è”åˆ é™¤
- **UIæ§åˆ¶**ï¼šé€šè¿‡ `:disabled` å±æ€§æ§åˆ¶æŒ‰é’®çŠ¶æ€ï¼Œæ— éœ€ä¿®æ”¹ç»„ä»¶å†…éƒ¨é€»è¾‘

**å¤‡é€‰æ–¹æ¡ˆå¯¹æ¯”**ï¼š
| æ–¹æ¡ˆ | å¤æ‚åº¦ | ç¼ºç‚¹ |
|------|--------|------|
| åˆ›å»ºæ–°è¡¨ `ai_knowledge_base_temp` | é«˜ | é‡å¤å¤§é‡å­—æ®µå’Œé€»è¾‘ï¼Œç»´æŠ¤æˆæœ¬é«˜ |
| ä½¿ç”¨çŠ¶æ€æœºï¼ˆå¢åŠ  `status` å­—æ®µï¼‰ | ä¸­ | å¼•å…¥ä¸å¿…è¦çš„çŠ¶æ€è½¬æ¢å¤æ‚åº¦ |
| **å½“å‰æ–¹æ¡ˆï¼ˆæ ‡å¿—ä½ï¼‰** | **ä½** | **æœ€ç®€å•ï¼Œæ¶ˆé™¤äº†"ä¸´æ—¶æ˜¯ç‰¹æ®Šæƒ…å†µ"çš„æƒ³æ³•** |

### 3. ä¼šç ´åä»€ä¹ˆå—ï¼Ÿ
**âœ… é›¶ç ´åæ€§**
- **æ•°æ®åº“**ï¼šæ–°å¢å­—æ®µæœ‰é»˜è®¤å€¼ `DEFAULT 0`ï¼Œç°æœ‰æ•°æ®è‡ªåŠ¨ä¸ºæ°¸ä¹…çŸ¥è¯†åº“
- **API**ï¼šVOç±»æ–°å¢å­—æ®µï¼Œå‰ç«¯ä¸ä¼ åˆ™ä¸º `null`ï¼Œåç«¯åˆ¤æ–­ä¸ºæ°¸ä¹…çŸ¥è¯†åº“
- **å‰ç«¯UI**ï¼šåªæ·»åŠ æ–°åˆ—å’ŒæŒ‰é’®çŠ¶æ€åˆ¤æ–­ï¼Œç°æœ‰æ°¸ä¹…çŸ¥è¯†åº“åŠŸèƒ½ä¸å˜
- **ç´¢å¼•æµç¨‹**ï¼š`indexTypes` ä¸ºç©ºæˆ–ä¸åŒ…å« `graphical` æ—¶è‡ªåŠ¨è·³è¿‡å›¾è°±ç´¢å¼•ï¼Œé€»è¾‘å·²å­˜åœ¨

### 4. å½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—ï¼Ÿ
**âœ… å¿…è¦åŠŸèƒ½**
- **ä¸šåŠ¡åœºæ™¯çœŸå®**ï¼šRAGå¯¹è¯åœºæ™¯ä¸­ï¼Œç”¨æˆ·éœ€è¦ä¸´æ—¶ä¸Šä¼ æ–‡æ¡£å¿«é€Ÿé—®ç­”
- **èµ„æºä¼˜åŒ–**ï¼šé¿å…å¤§é‡ä¸€æ¬¡æ€§ä½¿ç”¨çš„çŸ¥è¯†åº“é•¿æœŸå ç”¨å­˜å‚¨å’Œå‘é‡æ•°æ®åº“èµ„æº
- **ç”¨æˆ·ä½“éªŒ**ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œç”¨æˆ·æ— éœ€æ‰‹åŠ¨ç®¡ç†ä¸´æ—¶çŸ¥è¯†åº“

### 5. è¿™ä¸ªé—®é¢˜è¿‡åº¦è®¾è®¡äº†å—ï¼Ÿæœ‰ç¼ºå°‘å¿…è¦ä¿¡æ¯å—ï¼Ÿèƒ½å¦ç»§ç»­è¯„ä¼°ï¼Ÿ
**âœ… ä¿¡æ¯å®Œå–„ï¼Œæ— è¿‡åº¦è®¾è®¡**
- **æ•°æ®æ”¶é›†å®Œæ•´**ï¼š
  - âœ… å·²æŸ¥è¯¢å‚è€ƒçŸ¥è¯†åº“é…ç½®ï¼ˆID: 1994334750959017986ï¼‰
  - âœ… å·²åˆ†æè¡¨ç»“æ„ï¼ˆai_knowledge_base, ai_knowledge_base_item, ai_knowledge_base_graph_segmentï¼‰
  - âœ… å·²è¿½è¸ªå®Œæ•´è°ƒç”¨é“¾è·¯ï¼ˆController â†’ Service â†’ RabbitMQ â†’ DocumentIndexingServiceï¼‰
  - âœ… å·²éªŒè¯ç´¢å¼•ç±»å‹æ§åˆ¶æœºåˆ¶ï¼ˆindexTypeså‚æ•°ï¼‰
- **è®¾è®¡å…‹åˆ¶**ï¼š
  - âŒ æ²¡æœ‰å¼•å…¥æ–°è¡¨
  - âŒ æ²¡æœ‰å¼•å…¥çŠ¶æ€æœº
  - âŒ æ²¡æœ‰å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—æ–°æ¶ˆè´¹è€…
  - âœ… åªå¢åŠ 2ä¸ªå­—æ®µ + 1ä¸ªå®šæ—¶ä»»åŠ¡ + å‰ç«¯æŒ‰é’®çŠ¶æ€æ§åˆ¶

### 6. è¯é¢˜æ˜¯å¦æ¨¡ç³Šï¼Œæ˜¯å¦ä¼šå¯¼è‡´å¹»è§‰çš„äº§ç”Ÿï¼Ÿ
**âœ… ä¸ä¼šäº§ç”Ÿå¹»è§‰**
- **éœ€æ±‚æ˜ç¡®**ï¼šç”¨æˆ·æä¾›è¯¦ç»†çš„UIæˆªå›¾å’Œæ–‡å­—è¯´æ˜
- **æŠ€æœ¯è·¯å¾„æ¸…æ™°**ï¼šç´¢å¼•ç±»å‹æ§åˆ¶ã€Quartzå®šæ—¶ä»»åŠ¡ã€UIæŒ‰é’®ç¦ç”¨ï¼Œå‡ä¸ºæˆç†ŸæŠ€æœ¯æ–¹æ¡ˆ
- **æ•°æ®æ”¯æ’‘å……åˆ†**ï¼šå·²åˆ†æç°æœ‰ä»£ç é€»è¾‘ï¼Œè®¾è®¡æ–¹æ¡ˆåŸºäºå®é™…ä»£ç å®ç°

### 7. å·²ç»æ·±åˆ»å­¦ä¹ äº†ä»£ç å®æ–½çš„æ³¨æ„äº‹é¡¹ï¼Œå¹¶ä¸”åœ¨è®¾è®¡å’Œå¼€å‘ä¸­ä½¿ç”¨äº†è¿™éƒ¨åˆ†æ€æƒ³ï¼Ÿ
**âœ… å·²ä¸¥æ ¼éµå¾ªSCMå¼€å‘è§„èŒƒ**
- **æ’å…¥/æ›´æ–°ä½¿ç”¨beanæ“ä½œ**ï¼ˆæ³¨æ„äº‹é¡¹ç¬¬17æ¡ï¼‰ï¼š
  - âœ… æ’å…¥ï¼š`knowledgeBaseMapper.insert(entity)`
  - âœ… æ›´æ–°ï¼š`selectById()` â†’ ä¿®æ”¹entity â†’ `updateById(entity)`
- **æŸ¥è¯¢ä½¿ç”¨SQL**ï¼ˆæ³¨æ„äº‹é¡¹ç¬¬24æ¡ï¼‰ï¼š
  - âœ… æ¸…ç†ä»»åŠ¡ä½¿ç”¨ `LambdaQueryWrapper` æŸ¥è¯¢ï¼ˆç¬¦åˆè§„èŒƒï¼‰
- **å®ä½“ç±»å‘½åè§„èŒƒ**ï¼ˆæ³¨æ„äº‹é¡¹ç¬¬4æ¡ï¼‰ï¼š
  - âœ… å®ä½“ç±»å­—æ®µä½¿ç”¨ä¸‹åˆ’çº¿ï¼š`is_temp`, `expire_time`
  - âœ… VOç±»å­—æ®µä½¿ç”¨é©¼å³°ï¼š`isTemp`, `expireTime`
- **ç§Ÿæˆ·å¤„ç†**ï¼ˆæ³¨æ„äº‹é¡¹ç¬¬12æ¡ï¼‰ï¼š
  - âœ… Quartzä»»åŠ¡ä¸­æ˜¾å¼è°ƒç”¨ `DataSourceHelper.use(tenantCode)`
- **UUIDç”Ÿæˆ**ï¼ˆæ³¨æ„äº‹é¡¹ç¬¬23æ¡ï¼‰ï¼š
  - âœ… ä½¿ç”¨ `UuidUtil.createShort()` è€Œé `UUIDUtil.getUUID()`
- **ä¸ä½¿ç”¨convertToVo**ï¼ˆæ³¨æ„äº‹é¡¹ç¬¬21æ¡ï¼‰ï¼š
  - âœ… ä½¿ç”¨ `BeanUtils.copyProperties` è½¬æ¢å®ä½“ç±»å’ŒVOç±»

---

## å…­ã€é£é™©åˆ†æä¸ç¼“è§£æªæ–½

### 6.1 æŠ€æœ¯é£é™©

#### é£é™©1ï¼šå®šæ—¶ä»»åŠ¡è¯¯åˆ æ°¸ä¹…çŸ¥è¯†åº“
**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜
**å½±å“èŒƒå›´**ï¼šæ•°æ®ä¸¢å¤±ï¼Œä¸šåŠ¡ä¸­æ–­
**ç¼“è§£æªæ–½**ï¼š
1. **WHEREæ¡ä»¶ä¸¥æ ¼**ï¼š`is_temp=1 AND expire_time < NOW()`ï¼ŒåŒé‡æ¡ä»¶ç¡®ä¿å®‰å…¨
2. **æ—¥å¿—è®°å½•å®Œæ•´**ï¼šåˆ é™¤å‰è®°å½•idã€kb_uuidã€titleã€expire_time
3. **æ•°æ®åº“ç´¢å¼•**ï¼šæ·»åŠ ç´¢å¼• `idx_ai_knowledge_base_temp_cleanup(is_temp, expire_time)` ç¡®ä¿æŸ¥è¯¢æ€§èƒ½å’Œå‡†ç¡®æ€§
4. **æµ‹è¯•éªŒè¯**ï¼šå•å…ƒæµ‹è¯•è¦†ç›–è¯¯åˆ åœºæ™¯

#### é£é™©2ï¼šQuartzä»»åŠ¡é‡å¤æ‰§è¡Œå¯¼è‡´æ€§èƒ½é—®é¢˜
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­
**å½±å“èŒƒå›´**ï¼šæ•°æ®åº“å‹åŠ›å¢å¤§
**ç¼“è§£æªæ–½**ï¼š
1. **ç¦æ­¢å¹¶å‘æ‰§è¡Œ**ï¼šä½¿ç”¨ `@DisallowConcurrentExecution` æ³¨è§£
2. **æ‰§è¡Œæ—¶é—´ä¼˜åŒ–**ï¼šæ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œé¿å…é¢‘ç¹æŸ¥è¯¢
3. **æ‰¹é‡å¤„ç†**ï¼šå•æ¬¡ä»»åŠ¡å¤„ç†å¤šä¸ªè¿‡æœŸçŸ¥è¯†åº“ï¼Œå‡å°‘ä»»åŠ¡è§¦å‘æ¬¡æ•°

#### é£é™©3ï¼šå‰ç«¯ä¼ å…¥ `isTemp` ä¸º `null` æˆ– `undefined` å¯¼è‡´é€»è¾‘é”™è¯¯
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½
**å½±å“èŒƒå›´**ï¼šä¸´æ—¶çŸ¥è¯†åº“æœªè®¾ç½®è¿‡æœŸæ—¶é—´
**ç¼“è§£æªæ–½**ï¼š
1. **åç«¯åˆ¤æ–­ä¸¥æ ¼**ï¼š`vo.getIsTemp() != null && vo.getIsTemp() == 1`
2. **é»˜è®¤å€¼ä¿æŠ¤**ï¼šæ•°æ®åº“å­—æ®µ `DEFAULT 0`ï¼Œç¡®ä¿nullæ—¶ä¸ºæ°¸ä¹…çŸ¥è¯†åº“
3. **å‰ç«¯æ ¡éªŒ**ï¼šåˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“æ—¶ï¼Œå¼ºåˆ¶ä¼ å…¥ `isTemp: 1`

---

### 6.2 ä¸šåŠ¡é£é™©

#### é£é™©4ï¼šç”¨æˆ·åœ¨ä¸´æ—¶çŸ¥è¯†åº“è¿‡æœŸå‰æœªå®Œæˆæ“ä½œ
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­
**å½±å“èŒƒå›´**ï¼šç”¨æˆ·ä½“éªŒä¸‹é™
**ç¼“è§£æªæ–½**ï¼š
1. **å‰ç«¯æç¤º**ï¼šåˆ—è¡¨é¡µæ˜¾ç¤º"ä¸´æ—¶"æ ‡ç­¾ï¼Œæé†’ç”¨æˆ·æ³¨æ„è¿‡æœŸæ—¶é—´
2. **è¿‡æœŸæ—¶é—´æ˜¾ç¤º**ï¼ˆå¯é€‰æ‰©å±•ï¼‰ï¼šå‰ç«¯æ˜¾ç¤ºå‰©ä½™æ—¶é—´å€’è®¡æ—¶
3. **æ•°æ®å¯¼å‡º**ï¼ˆæœªæ¥æ‰©å±•ï¼‰ï¼šå…è®¸ç”¨æˆ·åœ¨è¿‡æœŸå‰å¯¼å‡ºä¸´æ—¶çŸ¥è¯†åº“æ•°æ®

#### é£é™©5ï¼šä¸´æ—¶çŸ¥è¯†åº“æ•°æ®é‡å¤§ï¼Œåˆ é™¤è€—æ—¶é•¿
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½
**å½±å“èŒƒå›´**ï¼šå®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿
**ç¼“è§£æªæ–½**ï¼š
1. **çº§è”åˆ é™¤ä¼˜åŒ–**ï¼šå¤ç”¨ç°æœ‰ `delete()` æ–¹æ³•ï¼Œå·²åŒ…å«Milvuså’ŒNeo4jæ•°æ®åˆ é™¤
2. **é”™è¯¯éš”ç¦»**ï¼šå•ä¸ªçŸ¥è¯†åº“åˆ é™¤å¤±è´¥ä¸å½±å“å…¶ä»–çŸ¥è¯†åº“
3. **ç›‘æ§å‘Šè­¦**ï¼šè®°å½•æ¸…ç†æ—¶é•¿ï¼Œè¶…è¿‡é˜ˆå€¼å‘Šè­¦

---

### 6.3 å…¼å®¹æ€§é£é™©

#### é£é™©6ï¼šç°æœ‰APIè°ƒç”¨æœªä¼  `isTemp` å‚æ•°
**é£é™©ç­‰çº§**ï¼šâœ… æ— é£é™©
**å½±å“èŒƒå›´**ï¼šæ— 
**è¯´æ˜**ï¼š
- VOç±»æ–°å¢å­—æ®µï¼Œå‰ç«¯ä¸ä¼ åˆ™ä¸º `null`
- åç«¯åˆ¤æ–­ `vo.getIsTemp() != null && vo.getIsTemp() == 1`ï¼Œnullæ—¶ä¸ºæ°¸ä¹…çŸ¥è¯†åº“
- å‘åå…¼å®¹æ€§å®Œç¾

---

## ä¸ƒã€å®æ–½æ–‡ä»¶æ¸…å•

### 7.1 åç«¯æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | æ“ä½œç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| `scm-ai/src/main/resources/db/migration/V1.1.0__add_temp_kb_fields.sql` | æ–°å»º | DDLè„šæœ¬ï¼šæ·»åŠ is_tempå’Œexpire_timeå­—æ®µ |
| `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/entity/rag/AiKnowledgeBaseEntity.java` | ä¿®æ”¹ | å®ä½“ç±»ï¼šæ·»åŠ is_tempå’Œexpire_timeå­—æ®µ |
| `scm-ai/src/main/java/com/xinyirun/scm/ai/bean/vo/rag/AiKnowledgeBaseVo.java` | ä¿®æ”¹ | VOç±»ï¼šæ·»åŠ isTempå’ŒexpireTimeå­—æ®µ |
| `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/KnowledgeBaseService.java` | ä¿®æ”¹ | Serviceï¼šåœ¨saveOrUpdateæ–¹æ³•ä¸­æ·»åŠ ä¸´æ—¶çŸ¥è¯†åº“å¤„ç†é€»è¾‘ |
| `scm-quartz/src/main/java/com/xinyirun/scm/quartz/job/TempKnowledgeBaseCleanupJob.java` | æ–°å»º | Quartzä»»åŠ¡ï¼šæ¸…ç†è¿‡æœŸä¸´æ—¶çŸ¥è¯†åº“ |

---

### 7.2 å‰ç«¯æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | æ“ä½œç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| `01_scm_frontend/scm_frontend/src/components/70_ai/components/rag/dialogs/KnowledgeBaseManageDialog.vue` | ä¿®æ”¹ | åˆ—è¡¨é¡µï¼šæ·»åŠ "æ˜¯å¦ä¸´æ—¶"åˆ—ï¼Œç¦ç”¨ä¸´æ—¶KBç¼–è¾‘æŒ‰é’® |
| `01_scm_frontend/scm_frontend/src/components/70_ai/components/rag/dialogs/KnowledgeBaseDetailDialog.vue` | ä¿®æ”¹ | è¯¦æƒ…é¡µï¼šç¦ç”¨æ‰€æœ‰ç®¡ç†æŒ‰é’®ï¼Œæ·»åŠ "æŸ¥çœ‹"æŒ‰é’® |
| `01_scm_frontend/scm_frontend/src/components/70_ai/components/rag/dialogs/KnowledgeItemViewDialog.vue` | æ–°å»º | æŸ¥çœ‹å¯¹è¯æ¡†ï¼šåªè¯»æ˜¾ç¤ºçŸ¥è¯†ç‚¹è¯¦æƒ… |

---

## å…«ã€æµ‹è¯•å»ºè®®

### 8.1 åŠŸèƒ½æµ‹è¯•

1. **ä¸´æ—¶çŸ¥è¯†åº“åˆ›å»º**ï¼š
   - [ ] åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“ï¼ŒéªŒè¯ `is_temp=1`, `expire_time=NOW()+2h`, `is_public=0`
   - [ ] éªŒè¯é»˜è®¤é…ç½®æ­£ç¡®åº”ç”¨ï¼ˆå‚è€ƒKB: 1994334750959017986ï¼‰

2. **ç´¢å¼•ç±»å‹æ§åˆ¶**ï¼š
   - [ ] ä¸Šä¼ æ–‡æ¡£åˆ°ä¸´æ—¶çŸ¥è¯†åº“ï¼ŒéªŒè¯åªæ‰§è¡Œå‘é‡ç´¢å¼•
   - [ ] æ£€æŸ¥Milvusæœ‰æ•°æ®ï¼ŒNeo4jæ— æ•°æ®

3. **UIäº¤äº’**ï¼š
   - [ ] åˆ—è¡¨é¡µæ˜¾ç¤º"ä¸´æ—¶"æ ‡ç­¾
   - [ ] ä¸´æ—¶KBçš„"ç¼–è¾‘"æŒ‰é’®ç½®ç°
   - [ ] è¿›å…¥ä¸´æ—¶KBåï¼Œæ‰€æœ‰ç®¡ç†æŒ‰é’®ç¦ç”¨
   - [ ] "æŸ¥çœ‹"æŒ‰é’®å¯æ­£å¸¸æ‰“å¼€åªè¯»å¯¹è¯æ¡†

4. **æ¸…ç†ä»»åŠ¡**ï¼š
   - [ ] æ‰‹åŠ¨ä¿®æ”¹ `expire_time` ä¸ºè¿‡å»æ—¶é—´
   - [ ] è§¦å‘Quartzä»»åŠ¡ï¼ŒéªŒè¯è¿‡æœŸKBè¢«åˆ é™¤
   - [ ] éªŒè¯å…³è”æ•°æ®ï¼ˆitemsã€segmentsã€Milvuså‘é‡ï¼‰å…¨éƒ¨åˆ é™¤

---

### 8.2 æ€§èƒ½æµ‹è¯•

1. **å®šæ—¶ä»»åŠ¡æ€§èƒ½**ï¼š
   - [ ] åˆ›å»º100ä¸ªè¿‡æœŸä¸´æ—¶çŸ¥è¯†åº“
   - [ ] è§¦å‘æ¸…ç†ä»»åŠ¡ï¼Œè®°å½•æ‰§è¡Œæ—¶é•¿
   - [ ] éªŒè¯æ•°æ®åº“CPUå’Œå†…å­˜å ç”¨

2. **ç´¢å¼•æ€§èƒ½**ï¼š
   - [ ] å¯¹æ¯”ä¸´æ—¶KBå’Œæ°¸ä¹…KBçš„ç´¢å¼•æ—¶é—´
   - [ ] éªŒè¯è·³è¿‡å›¾è°±ç´¢å¼•åæ€§èƒ½æå‡

---

### 8.3 å…¼å®¹æ€§æµ‹è¯•

1. **ç°æœ‰åŠŸèƒ½ä¸å—å½±å“**ï¼š
   - [ ] åˆ›å»ºæ°¸ä¹…çŸ¥è¯†åº“ï¼ŒéªŒè¯åŠŸèƒ½æ­£å¸¸
   - [ ] ç¼–è¾‘æ°¸ä¹…çŸ¥è¯†åº“ï¼ŒéªŒè¯åŠŸèƒ½æ­£å¸¸
   - [ ] ä¸Šä¼ æ–‡æ¡£åˆ°æ°¸ä¹…çŸ¥è¯†åº“ï¼ŒéªŒè¯å‘é‡+å›¾è°±ç´¢å¼•æ­£å¸¸

2. **APIå…¼å®¹æ€§**ï¼š
   - [ ] å‰ç«¯ä¸ä¼  `isTemp` å‚æ•°ï¼ŒéªŒè¯é»˜è®¤ä¸ºæ°¸ä¹…çŸ¥è¯†åº“
   - [ ] ç°æœ‰å‰ç«¯é¡µé¢è°ƒç”¨APIï¼ŒéªŒè¯æ— æŠ¥é”™

---

## ä¹ã€ä¸Šçº¿è®¡åˆ’

### 9.1 ä¸Šçº¿æ­¥éª¤

1. **æ•°æ®åº“å˜æ›´**ï¼ˆåœæœºçª—å£ï¼‰ï¼š
   ```sql
   ALTER TABLE ai_knowledge_base
   ADD COLUMN is_temp TINYINT DEFAULT 0,
   ADD COLUMN expire_time DATETIME NULL;

   CREATE INDEX idx_ai_knowledge_base_temp_cleanup
   ON ai_knowledge_base(is_temp, expire_time);
   ```

2. **åç«¯éƒ¨ç½²**ï¼š
   - éƒ¨ç½²åç«¯ä»£ç ï¼ˆåŒ…å«Entityã€VOã€Serviceä¿®æ”¹ï¼‰
   - æ³¨å†ŒQuartzå®šæ—¶ä»»åŠ¡

3. **å‰ç«¯éƒ¨ç½²**ï¼š
   - éƒ¨ç½²å‰ç«¯ä»£ç ï¼ˆåŒ…å«UIä¿®æ”¹å’Œæ–°å¯¹è¯æ¡†ï¼‰

4. **éªŒè¯**ï¼š
   - åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“æµ‹è¯•
   - æ£€æŸ¥Quartzä»»åŠ¡æ—¥å¿—

---

### 9.2 å›æ»šæ–¹æ¡ˆ

1. **æ•°æ®åº“å›æ»š**ï¼ˆå¦‚éœ€ï¼‰ï¼š
   ```sql
   ALTER TABLE ai_knowledge_base
   DROP COLUMN is_temp,
   DROP COLUMN expire_time;

   DROP INDEX idx_ai_knowledge_base_temp_cleanup ON ai_knowledge_base;
   ```

2. **ä»£ç å›æ»š**ï¼š
   - å›æ»šåç«¯ä»£ç åˆ°ä¸Šä¸€ç‰ˆæœ¬
   - å›æ»šå‰ç«¯ä»£ç åˆ°ä¸Šä¸€ç‰ˆæœ¬
   - åœæ­¢Quartzå®šæ—¶ä»»åŠ¡

---

## åã€æ€»ç»“

### 10.1 æ–¹æ¡ˆäº®ç‚¹

1. **æ•°æ®ç»“æ„ç®€æ´**ï¼šåªæ–°å¢2ä¸ªå­—æ®µï¼Œä¸åˆ›å»ºæ–°è¡¨ï¼Œæ¶ˆé™¤äº†"ä¸´æ—¶æ˜¯ç‰¹æ®Šæƒ…å†µ"çš„æƒ³æ³•
2. **å¤ç”¨ç°æœ‰é€»è¾‘**ï¼š
   - ç´¢å¼•æ§åˆ¶å¤ç”¨ `indexTypes` å‚æ•°æœºåˆ¶
   - æ¸…ç†é€»è¾‘å¤ç”¨ `delete()` æ–¹æ³•
   - UIæ§åˆ¶å¤ç”¨ `:disabled` å±æ€§
3. **é›¶ç ´åæ€§**ï¼šå‘åå…¼å®¹ï¼Œç°æœ‰åŠŸèƒ½ä¸å—å½±å“
4. **å®ç”¨ä¸»ä¹‰ä¼˜å…ˆ**ï¼šè§£å†³çœŸå®ä¸šåŠ¡é—®é¢˜ï¼Œé¿å…è¿‡åº¦è®¾è®¡

### 10.2 æ ¸å¿ƒæŠ€æœ¯å†³ç­–

| å†³ç­–ç‚¹ | æ–¹æ¡ˆé€‰æ‹© | ç†ç”± |
|--------|---------|------|
| æ•°æ®å­˜å‚¨ | æ ‡å¿—ä½å­—æ®µ `is_temp` | æœ€ç®€å•ï¼Œé¿å…æ–°å»ºè¡¨çš„å¤æ‚åº¦ |
| ç´¢å¼•æ§åˆ¶ | å¤ç”¨ `indexTypes` å‚æ•° | æ— éœ€ä¿®æ”¹æ ¸å¿ƒç´¢å¼•é€»è¾‘ |
| æ¸…ç†æœºåˆ¶ | Quartzå®šæ—¶ä»»åŠ¡ | ç¬¦åˆSCMæ¶æ„è§„èŒƒï¼Œå¯ç›‘æ§å’Œé…ç½® |
| UIæ§åˆ¶ | `:disabled` å±æ€§ | æ— éœ€ä¿®æ”¹ç»„ä»¶å†…éƒ¨é€»è¾‘ï¼Œç»´æŠ¤æˆæœ¬ä½ |

### 10.3 æ–¹æ¡ˆéªŒè¯ç»“è®º

âœ… **ç¬¦åˆKISSåŸåˆ™**ï¼šæœ€ç®€æ–¹æ¡ˆï¼Œæ— è¿‡åº¦è®¾è®¡
âœ… **æ•°æ®æ”¯æ’‘å®Œæ•´**ï¼šå·²æ”¶é›†å……è¶³çš„ç°æœ‰ä»£ç å’Œé…ç½®æ•°æ®
âœ… **å‘åå…¼å®¹**ï¼šé›¶ç ´åæ€§ï¼Œç°æœ‰åŠŸèƒ½ä¸å—å½±å“
âœ… **å®ç”¨ä¸»ä¹‰**ï¼šè§£å†³çœŸå®ä¸šåŠ¡é—®é¢˜ï¼Œå¤æ‚åº¦ä¸é—®é¢˜ä¸¥é‡æ€§åŒ¹é…

---

**æ–¹æ¡ˆçŠ¶æ€ï¼šâœ… å¾…ç”¨æˆ·å®¡æ‰¹**

è¯·å®¡é˜…æœ¬æ–¹æ¡ˆï¼Œç¡®è®¤æ˜¯å¦æ‰¹å‡†è¿›å…¥ä»£ç å®æ–½é˜¶æ®µã€‚
