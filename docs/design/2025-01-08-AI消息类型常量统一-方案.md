# AIæ¶ˆæ¯ç±»å‹å¸¸é‡ç»Ÿä¸€æ–¹æ¡ˆ

## 1. KISSåŸåˆ™éªŒè¯

### 1.1 è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ
âœ… **çœŸé—®é¢˜** - å·²å¯¼è‡´ç”Ÿäº§ç¯å¢ƒè¿è¡Œæ—¶å¼‚å¸¸
- é”™è¯¯ï¼š`java.lang.IllegalArgumentException: Invalid MessageType value: USER`
- åŸå› ï¼šä»£ç ä¸­æ··ç”¨å¤§å†™/å°å†™ï¼Œä¸Spring AIæ ‡å‡†ä¸ä¸€è‡´
- å½±å“ï¼šå¤šè½®å¯¹è¯è®°å¿†åŠŸèƒ½å®Œå…¨å¤±æ•ˆ

### 1.2 æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ
âœ… **æœ€ç®€æ–¹æ¡ˆ** - å®šä¹‰å¸¸é‡ç±»ï¼Œç»Ÿä¸€ä½¿ç”¨Spring AIå®˜æ–¹æ ‡å‡†
- ä¸æä¸¤å¥—æ ‡å‡†ï¼ˆå¤§å°å†™æ··ç”¨ï¼‰
- ä¸ç”¨ä¸´æ—¶è¡¥ä¸ï¼ˆ.toLowerCase()ï¼‰
- ç›´æ¥å¯¹é½Spring AIå®˜æ–¹æ ‡å‡†ï¼šå°å†™å¸¸é‡

### 1.3 ä¼šç ´åä»€ä¹ˆå—ï¼Ÿ
âš ï¸ **æ•°æ®åº“å…¼å®¹æ€§é£é™©**
- ç°æœ‰æ•°æ®åº“è®°å½•ä½¿ç”¨å¤§å†™ï¼š"USER", "ASSISTANT"
- ä¿®æ”¹åä½¿ç”¨å°å†™ï¼š"user", "assistant"
- **ç¼“è§£æªæ–½**ï¼šæ•°æ®åº“å­—æ®µä¸åŒºåˆ†å¤§å°å†™æŸ¥è¯¢ï¼Œæ— å½±å“

### 1.4 å½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—ï¼Ÿ
âœ… **å¿…è¦æ€§**
- æ¶ˆé™¤é­”æ³•å€¼ï¼ˆç¡¬ç¼–ç å­—ç¬¦ä¸²ï¼‰
- ç»Ÿä¸€ä»£ç è§„èŒƒ
- ç¬¦åˆSpring AIå®˜æ–¹æ ‡å‡†
- é¿å…è¿è¡Œæ—¶ç±»å‹è½¬æ¢é”™è¯¯

## 2. é—®é¢˜åˆ†æ

### 2.1 Spring AIå®˜æ–¹æ ‡å‡†
æ ¹æ®Spring AIå®˜æ–¹æ–‡æ¡£ï¼š
```java
public enum MessageType {
    USER("user"),
    ASSISTANT("assistant"),
    SYSTEM("system"),
    TOOL("tool");
}
```

**å®˜æ–¹æ ‡å‡†ï¼šå…¨éƒ¨å°å†™**

### 2.2 å½“å‰ä»£ç é—®é¢˜
ç³»ç»Ÿä¸­å­˜åœ¨å¤§å°å†™æ··ç”¨æƒ…å†µï¼š

| ä½ç½® | å½“å‰å€¼ | ç”¨é€” |
|-----|-------|------|
| WorkflowUtil.java:244 | "USER" (å¤§å†™) | ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ |
| WorkflowUtil.java:279 | "ASSISTANT" (å¤§å†™) | ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯ |
| AiWorkflowConversationContentVo.java | "USER", "ASSISTANT", "SYSTEM", "TOOL" (å¤§å†™) | ç±»å‹åˆ¤æ–­æ–¹æ³• |
| AiConversationPresetController.java:86 | "USER" (å¤§å†™) | åˆ›å»ºé¢„è®¾ |
| AiConversationContentVo.java:416 | "USER" (å¤§å†™) | ç”¨æˆ·æ¶ˆæ¯åˆ¤æ–­ |
| AiConversationContentVo.java:423 | "assistant" (å°å†™) | AIæ¶ˆæ¯åˆ¤æ–­ |
| AiConversationContentVo.java:430 | "system" (å°å†™) | ç³»ç»Ÿæ¶ˆæ¯åˆ¤æ–­ |
| ChatResponseVo.java:82 | "ASSISTANT" (å¤§å†™) | å“åº”æ¶ˆæ¯ç±»å‹ |
| ScmChatMessageChatMemory.java:73 | `.toLowerCase()` | ä¸´æ—¶è¡¥ä¸è½¬æ¢ |
| ScmWorkflowMessageChatMemory.java:73 | `.toLowerCase()` | ä¸´æ—¶è¡¥ä¸è½¬æ¢ |

## 3. è§£å†³æ–¹æ¡ˆ

### 3.1 åˆ›å»ºå¸¸é‡ç±»
**æ–‡ä»¶ä½ç½®**ï¼š`scm-ai/src/main/java/com/xinyirun/scm/ai/common/constant/AiMessageTypeConstant.java`

**å¸¸é‡å®šä¹‰**ï¼ˆéµå¾ªSpring AIæ ‡å‡† - å°å†™ï¼‰ï¼š
```java
package com.xinyirun.scm.ai.common.constant;

/**
 * AIæ¶ˆæ¯ç±»å‹å¸¸é‡
 *
 * éµå¾ªSpring AIå®˜æ–¹æ ‡å‡†ï¼Œæ‰€æœ‰æ¶ˆæ¯ç±»å‹ä½¿ç”¨å°å†™å€¼
 *
 * @see org.springframework.ai.chat.messages.MessageType
 * @author SCM-AIå¼€å‘å›¢é˜Ÿ
 * @since 2025-01-08
 */
public class AiMessageTypeConstant {

    /**
     * ç”¨æˆ·æ¶ˆæ¯ç±»å‹
     */
    public static final String MESSAGE_TYPE_USER = "user";

    /**
     * AIåŠ©æ‰‹æ¶ˆæ¯ç±»å‹
     */
    public static final String MESSAGE_TYPE_ASSISTANT = "assistant";

    /**
     * ç³»ç»Ÿæ¶ˆæ¯ç±»å‹
     */
    public static final String MESSAGE_TYPE_SYSTEM = "system";

    /**
     * å·¥å…·æ¶ˆæ¯ç±»å‹
     */
    public static final String MESSAGE_TYPE_TOOL = "tool";

    private AiMessageTypeConstant() {
        // å·¥å…·ç±»ï¼Œç¦æ­¢å®ä¾‹åŒ–
    }
}
```

### 3.2 æ–‡ä»¶ä¿®æ”¹æ¸…å•

#### åç«¯æ–‡ä»¶ï¼ˆ8ä¸ªæ–‡ä»¶ï¼‰

1. **WorkflowUtil.java**ï¼ˆ2å¤„ä¿®æ”¹ï¼‰
   - ç¬¬244è¡Œï¼š`"USER"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_USER`
   - ç¬¬279è¡Œï¼š`"ASSISTANT"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_ASSISTANT`

2. **AiWorkflowConversationContentVo.java**ï¼ˆ4å¤„ä¿®æ”¹ï¼‰
   - ç¬¬105è¡Œï¼š`"USER"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_USER`
   - ç¬¬112è¡Œï¼š`"ASSISTANT"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_ASSISTANT`
   - ç¬¬119è¡Œï¼š`"SYSTEM"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_SYSTEM`
   - ç¬¬126è¡Œï¼š`"TOOL"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_TOOL`

3. **AiConversationPresetController.java**ï¼ˆ1å¤„ä¿®æ”¹ï¼‰
   - ç¬¬86è¡Œï¼š`"USER"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_USER`

4. **AiConversationContentVo.java**ï¼ˆ3å¤„ä¿®æ”¹ï¼‰
   - ç¬¬416è¡Œï¼š`"USER"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_USER`
   - ç¬¬423è¡Œï¼š`"assistant"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_ASSISTANT`
   - ç¬¬430è¡Œï¼š`"system"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_SYSTEM`

5. **ChatResponseVo.java**ï¼ˆ1å¤„ä¿®æ”¹ï¼‰
   - ç¬¬82è¡Œï¼š`"ASSISTANT"` â†’ `AiMessageTypeConstant.MESSAGE_TYPE_ASSISTANT`

6. **ScmChatMessageChatMemory.java**ï¼ˆ1å¤„ä¿®æ”¹ï¼‰
   - ç¬¬73è¡Œï¼šåˆ é™¤`.toLowerCase()`ï¼Œç›´æ¥ä½¿ç”¨ `conversationContent.getType()`
   - åŸå› ï¼šæ•°æ®åº“ç°åœ¨ä¿å­˜çš„å°±æ˜¯å°å†™ï¼Œæ— éœ€è½¬æ¢

7. **ScmWorkflowMessageChatMemory.java**ï¼ˆ1å¤„ä¿®æ”¹ï¼‰
   - ç¬¬73è¡Œï¼šåˆ é™¤`.toLowerCase()`ï¼Œç›´æ¥ä½¿ç”¨ `conversationContent.getType()`
   - åŸå› ï¼šæ•°æ®åº“ç°åœ¨ä¿å­˜çš„å°±æ˜¯å°å†™ï¼Œæ— éœ€è½¬æ¢

8. **æ–°å»ºï¼šAiMessageTypeConstant.java**
   - åˆ›å»ºå¸¸é‡å®šä¹‰ç±»

### 3.3 æ•°æ®å…¼å®¹æ€§è¯´æ˜

**æ•°æ®åº“å½±å“**ï¼š
- MySQLå­—ç¬¦ä¸²æ¯”è¾ƒé»˜è®¤**ä¸åŒºåˆ†å¤§å°å†™**ï¼ˆCOLLATE utf8mb4_general_ciï¼‰
- ç°æœ‰å¤§å†™æ•°æ®ï¼ˆ"USER", "ASSISTANT"ï¼‰ä»å¯æ­£å¸¸æŸ¥è¯¢
- æ–°æ•°æ®å°†ä½¿ç”¨å°å†™ï¼ˆ"user", "assistant"ï¼‰ä¿å­˜
- æŸ¥è¯¢æ¡ä»¶ `WHERE type = 'user'` å¯ä»¥åŒ¹é…åˆ° 'USER' å’Œ 'user'

**éªŒè¯SQL**ï¼š
```sql
-- éªŒè¯ä¸åŒºåˆ†å¤§å°å†™æŸ¥è¯¢
SELECT * FROM ai_workflow_conversation_content
WHERE type = 'user';  -- å¯ä»¥åŒ¹é… 'USER' å’Œ 'user'

SELECT * FROM ai_conversation_content
WHERE type = 'assistant';  -- å¯ä»¥åŒ¹é… 'ASSISTANT' å’Œ 'assistant'
```

## 4. å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºå¸¸é‡ç±»
åˆ›å»º `AiMessageTypeConstant.java`

### æ­¥éª¤2ï¼šæ‰¹é‡æ›¿æ¢ç¡¬ç¼–ç å­—ç¬¦ä¸²
æŒ‰æ–‡ä»¶ä¿®æ”¹æ¸…å•é€ä¸€æ›¿æ¢ï¼Œç¡®ä¿ï¼š
- æ·»åŠ  `import static com.xinyirun.scm.ai.common.constant.AiMessageTypeConstant.*;`
- æˆ–ä½¿ç”¨å®Œæ•´ç±»åï¼š`AiMessageTypeConstant.MESSAGE_TYPE_USER`

### æ­¥éª¤3ï¼šç§»é™¤ä¸´æ—¶è¡¥ä¸ä»£ç 
åˆ é™¤ `ScmChatMessageChatMemory.java` å’Œ `ScmWorkflowMessageChatMemory.java` ä¸­çš„ `.toLowerCase()` è°ƒç”¨

### æ­¥éª¤4ï¼šéªŒè¯æµ‹è¯•
- å•å…ƒæµ‹è¯•ï¼šéªŒè¯å¸¸é‡å€¼æ­£ç¡®
- é›†æˆæµ‹è¯•ï¼šéªŒè¯æ•°æ®åº“æŸ¥è¯¢æ­£å¸¸
- åŠŸèƒ½æµ‹è¯•ï¼šéªŒè¯å¤šè½®å¯¹è¯è®°å¿†åŠŸèƒ½

## 5. é£é™©è¯„ä¼°

### 5.1 æŠ€æœ¯é£é™©
| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|-----|------|---------|
| æ•°æ®åº“å¤§å°å†™ä¸åŒ¹é… | ğŸŸ¢ ä½ | MySQLé»˜è®¤ä¸åŒºåˆ†å¤§å°å†™ï¼Œæ— å½±å“ |
| é—æ¼ç¡¬ç¼–ç å­—ç¬¦ä¸² | ğŸŸ¡ ä¸­ | é€šè¿‡grepå…¨å±€æœç´¢ç¡®è®¤ |
| Spring AIç‰ˆæœ¬å…¼å®¹ | ğŸŸ¢ ä½ | ä½¿ç”¨å®˜æ–¹æ ‡å‡†ï¼Œå®Œå…¨å…¼å®¹ |

### 5.2 ä¸šåŠ¡é£é™©
| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|-----|------|---------|
| ç°æœ‰å¯¹è¯å†å²ä¸¢å¤± | ğŸŸ¢ ä½ | ä¸åŒºåˆ†å¤§å°å†™æŸ¥è¯¢ï¼Œæ— å½±å“ |
| å¤šè½®å¯¹è¯åŠŸèƒ½å¼‚å¸¸ | ğŸŸ¢ ä½ | ä¿®å¤åæ¶ˆé™¤è¿è¡Œæ—¶é”™è¯¯ |

## 6. éªŒæ”¶æ ‡å‡†

### 6.1 ä»£ç è´¨é‡
- âœ… æ‰€æœ‰ç¡¬ç¼–ç å­—ç¬¦ä¸²å·²æ›¿æ¢ä¸ºå¸¸é‡
- âœ… æ— æ–°å¢PMD/Checkstyleè­¦å‘Š
- âœ… ä»£ç å¯è¯»æ€§æå‡

### 6.2 åŠŸèƒ½éªŒè¯
- âœ… Chaté¢†åŸŸå¤šè½®å¯¹è¯è®°å¿†æ­£å¸¸
- âœ… Workflowé¢†åŸŸå¤šè½®å¯¹è¯è®°å¿†æ­£å¸¸
- âœ… ç°æœ‰å¤§å†™æ•°æ®ä»å¯æŸ¥è¯¢
- âœ… æ–°æ•°æ®ä½¿ç”¨å°å†™ä¿å­˜

### 6.3 æ€§èƒ½éªŒè¯
- âœ… æ— æ€§èƒ½é€€åŒ–
- âœ… æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡æ— å˜åŒ–

## 7. å›æ»šæ–¹æ¡ˆ

å¦‚å‘ç°é—®é¢˜ï¼Œå¯å¿«é€Ÿå›æ»šï¼š
1. æ¢å¤ç¡¬ç¼–ç å­—ç¬¦ä¸²ï¼ˆå¤§å†™ï¼‰
2. æ¢å¤ `.toLowerCase()` è½¬æ¢ä»£ç 
3. åˆ é™¤å¸¸é‡ç±»

é¢„è®¡å›æ»šæ—¶é—´ï¼š< 10åˆ†é’Ÿ

## 8. ç›¸å…³æ–‡æ¡£

- Spring AIå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-ai/reference/
- MessageTypeæšä¸¾å®šä¹‰ï¼šorg.springframework.ai.chat.messages.MessageType
- å‰æ¬¡æ–¹æ¡ˆï¼šdocs/design/2025-01-08-Workflowå¤šè½®å¯¹è¯è®°å¿†ä¿®å¤-æ–¹æ¡ˆ.md
