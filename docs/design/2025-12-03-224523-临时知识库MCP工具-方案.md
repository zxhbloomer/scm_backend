# ä¸´æ—¶çŸ¥è¯†åº“MCPå·¥å…· - è®¾è®¡æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-12-03 22:45:23
**è®¾è®¡è€…**: Claude Code (zzxxhhè§’è‰²)
**å®æ–½æ–¹å¼**: å®Œå…¨åŒæ­¥ï¼ˆæ–¹æ¡ˆ1ï¼‰

---

## 1. éœ€æ±‚èƒŒæ™¯

### 1.1 ä¸šåŠ¡åœºæ™¯
åœ¨åˆåŒå®¡æ‰¹workflowä¸­ï¼Œéœ€è¦åœ¨æµç¨‹å¼€å§‹æ—¶åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“ï¼š
- ç”¨æˆ·ä¸Šä¼ åˆåŒPDFå’Œç›¸å…³é™„ä»¶
- ç³»ç»Ÿåˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“å¹¶ç«‹å³ç´¢å¼•ï¼ˆä»…å‘é‡ï¼‰
- åç»­workflowèŠ‚ç‚¹ä½¿ç”¨è¯¥çŸ¥è¯†åº“è¿›è¡ŒAIè¾…åŠ©å®¡æ‰¹
- 2å°æ—¶åè‡ªåŠ¨æ¸…ç†

### 1.2 æŠ€æœ¯éœ€æ±‚
- **MCPå·¥å…·å°è£…**ï¼šæä¾›ç»Ÿä¸€çš„æ¥å£ä¾›workflowè°ƒç”¨
- **åŒæ­¥æ‰§è¡Œ**ï¼šå¿…é¡»ç­‰å¾…ç´¢å¼•å®Œæˆå†è¿”å›ï¼ˆåç»­èŠ‚ç‚¹éœ€ç«‹å³ä½¿ç”¨ï¼‰
- **ä»…å‘é‡ç´¢å¼•**ï¼šä¸´æ—¶çŸ¥è¯†åº“ä¸åšå›¾è°±ç´¢å¼•ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- **è‡ªåŠ¨æ¸…ç†**ï¼šå¤ç”¨ç°æœ‰çš„Quartzæ¸…ç†æœºåˆ¶

---

## 2. å®Œæ•´è°ƒç”¨é“¾è·¯åˆ†æ

### 2.1 è¯·æ±‚æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WorkflowèŠ‚ç‚¹                                                    â”‚
â”‚  è°ƒç”¨MCPå·¥å…·: createTempKnowledgeBase(...)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCPå·¥å…·å±‚: TempKnowledgeBaseMcpTools                           â”‚
â”‚  - ç§Ÿæˆ·æ•°æ®æºåˆ‡æ¢                                                â”‚
â”‚  - å‚æ•°éªŒè¯                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Serviceå±‚: KnowledgeBaseService.saveOrUpdate()                 â”‚
â”‚  - åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“è®°å½•ï¼ˆis_temp=1, expire_time=now+2hï¼‰          â”‚
â”‚  - åˆ›å»ºQuartzæ¸…ç†ä»»åŠ¡ï¼ˆSimpleTrigger, 2å°æ—¶åæ‰§è¡Œï¼‰             â”‚
â”‚  - è¿”å›kbUuid                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Serviceå±‚: DocumentProcessingService                           â”‚
â”‚  - å¦‚æœæœ‰textï¼šåˆ›å»ºæ–‡æœ¬ç±»å‹item                                  â”‚
â”‚  - å¦‚æœæœ‰fileUrlsï¼šä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºitem                            â”‚
â”‚  - ä¿å­˜åˆ°MySQL: ai_knowledge_base_item                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Serviceå±‚: DocumentIndexingService (åŒæ­¥è°ƒç”¨)                  â”‚
â”‚  - éå†æ‰€æœ‰itemUuid                                              â”‚
â”‚  - å¯¹æ¯ä¸ªitemï¼š                                                  â”‚
â”‚    1. è§£ææ–‡æ¡£å†…å®¹ï¼ˆDocumentParsingServiceï¼‰                     â”‚
â”‚    2. å‘é‡ç´¢å¼•ï¼ˆMilvusVectorIndexingServiceï¼‰                    â”‚
â”‚    3. æ›´æ–°embedding_status=3ï¼ˆå·²å®Œæˆï¼‰                           â”‚
â”‚  - indexTypesåªåŒ…å«"embedding"ï¼ˆè·³è¿‡graphicalï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“ (æ‰€æœ‰ç´¢å¼•å®Œæˆ)
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›MCPå·¥å…·                                                     â”‚
â”‚  - è¿”å›JSON: {"success": true, "kbUuid": "...", ...}           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å…³é”®æ—¶åºè¯´æ˜

**åŒæ­¥æ‰§è¡Œæµç¨‹**ï¼š
1. Workflowè°ƒç”¨MCPå·¥å…·ï¼ˆ**é˜»å¡ç­‰å¾…**ï¼‰
2. MCPå·¥å…·å†…éƒ¨é¡ºåºæ‰§è¡Œæ‰€æœ‰æ­¥éª¤
3. **ç­‰å¾…æ‰€æœ‰æ–‡æ¡£ç´¢å¼•å®Œæˆ**
4. è¿”å›kbUuidç»™Workflow
5. Workflowä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç«‹å³å¯ç”¨è¯¥çŸ¥è¯†åº“

**é¢„ä¼°è€—æ—¶**ï¼š
- 1ä¸ªåˆåŒPDFï¼ˆ5MBï¼‰ï¼šçº¦5-8ç§’
- 1ä¸ªåˆåŒ + 3ä¸ªé™„ä»¶ï¼ˆå…±10MBï¼‰ï¼šçº¦10-15ç§’
- çº¯æ–‡æœ¬ï¼ˆæ— æ–‡ä»¶ï¼‰ï¼šçº¦2-3ç§’

---

## 3. æ–‡ä»¶çº§åˆ«è®¾è®¡

### 3.1 åç«¯æ–‡ä»¶æ¸…å•

#### âœ… æ— éœ€ä¿®æ”¹çš„ç°æœ‰æ–‡ä»¶ï¼ˆå¤ç”¨ï¼‰
| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `scm-ai/.../KnowledgeBaseService.java` | âœ… å·²æ”¯æŒ`is_temp=1`åˆ›å»ºä¸´æ—¶KB |
| `scm-ai/.../DocumentProcessingService.java` | âœ… å·²æ”¯æŒæ–‡æœ¬/æ–‡ä»¶itemåˆ›å»º |
| `scm-ai/.../DocumentIndexingService.java` | âœ… å·²æ”¯æŒåŒæ­¥ç´¢å¼• |
| `scm-ai/.../MilvusVectorIndexingService.java` | âœ… å‘é‡ç´¢å¼•å®ç° |
| `scm-ai/.../TempKnowledgeBaseCleanupService.java` | âœ… è‡ªåŠ¨æ¸…ç†é€»è¾‘ |
| `scm-ai/.../entity/AiKnowledgeBaseEntity.java` | âœ… å·²æœ‰`is_temp`å’Œ`expire_time`å­—æ®µ |

#### ğŸ†• éœ€è¦æ–°å»ºçš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | è¯´æ˜ |
|---------|------|------|
| `scm-ai/src/main/java/com/xinyirun/scm/ai/mcp/utils/temp/knowledge/TempKnowledgeBaseMcpTools.java` | MCPå·¥å…·ç±» | æ ¸å¿ƒå®ç°æ–‡ä»¶ |
| `scm-bean/src/main/java/com/xinyirun/scm/bean/system/vo/business/ai/TempKbCreateParamVo.java` | VOç±» | MCPå·¥å…·å…¥å‚VOï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ç›´æ¥ç”¨åŸºæœ¬ç±»å‹ï¼‰ |

---

## 4. æ•°æ®ç»“æ„åˆ†æ

### 4.1 æ ¸å¿ƒæ•°æ®æµ

```java
// è¾“å…¥æ•°æ®
{
  "tenantCode": "scm_tenant_20250519_001",
  "userId": 123,
  "text": "åˆåŒå†…å®¹...",  // å¯é€‰
  "fileUrls": [         // å¯é€‰
    "http://file.server.com/contract.pdf",
    "http://file.server.com/attachment1.pdf"
  ]
}

// åˆ›å»ºçš„æ•°æ®åº“è®°å½•
ai_knowledge_base {
  kb_uuid: "scm_tenant_20250519_001::abc123def456",
  title: "ä¸´æ—¶çŸ¥è¯†åº“-åˆåŒå®¡æ‰¹-20251203224523",
  is_temp: 1,
  expire_time: "2025-12-04 00:45:23",  // å½“å‰æ—¶é—´+2å°æ—¶
  is_public: 0,
  owner_id: "123",
  ...
}

ai_knowledge_base_item {
  item_uuid: "scm_tenant_20250519_001::item001",
  kb_uuid: "scm_tenant_20250519_001::abc123def456",
  title: "åˆåŒæ–‡æœ¬" æˆ– "contract.pdf",
  embedding_status: 3,  // 3=å·²å®Œæˆ
  ...
}

// è¾“å‡ºæ•°æ®
{
  "success": true,
  "kbUuid": "scm_tenant_20250519_001::abc123def456",
  "message": "ä¸´æ—¶çŸ¥è¯†åº“åˆ›å»ºæˆåŠŸï¼Œå·²å®Œæˆå‘é‡ç´¢å¼•",
  "itemCount": 3,
  "indexedCount": 3,
  "tenantCode": "scm_tenant_20250519_001"
}
```

---

## 5. æ ¸å¿ƒä»£ç è®¾è®¡

### 5.1 MCPå·¥å…·ç±»å®ç°

```java
package com.xinyirun.scm.ai.mcp.utils.temp.knowledge;

import com.alibaba.fastjson2.JSON;
import com.alibaba.fastjson2.JSONWriter;
import com.xinyirun.scm.ai.bean.vo.rag.AiKnowledgeBaseVo;
import com.xinyirun.scm.ai.core.service.DocumentIndexingService;
import com.xinyirun.scm.ai.core.service.DocumentProcessingService;
import com.xinyirun.scm.ai.core.service.KnowledgeBaseService;
import com.xinyirun.scm.bean.system.vo.sys.file.SFileInfoVo;
import com.xinyirun.scm.common.utils.UuidUtil;
import com.xinyirun.scm.common.utils.datasource.DataSourceHelper;
import lombok.extern.slf4j.Slf4j;
import org.springaicommunity.mcp.annotation.McpTool;
import org.springaicommunity.mcp.annotation.McpToolParam;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;

/**
 * ä¸´æ—¶çŸ¥è¯†åº“åˆ›å»ºMCPå·¥å…·
 *
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - ä¸ºworkflowæä¾›åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“çš„èƒ½åŠ›
 * - æ”¯æŒæ–‡æœ¬å’Œæ–‡ä»¶ï¼ˆæ•°ç»„ï¼‰è¾“å…¥
 * - åŒæ­¥æ‰§è¡Œï¼Œç­‰å¾…ç´¢å¼•å®Œæˆåè¿”å›
 * - ä»…åšå‘é‡ç´¢å¼•ï¼Œä¸åšå›¾è°±ç´¢å¼•
 * - 2å°æ—¶åè‡ªåŠ¨æ¸…ç†ï¼ˆå¤ç”¨ç°æœ‰Quartzæœºåˆ¶ï¼‰
 *
 * ä½¿ç”¨åœºæ™¯ï¼š
 * - åˆåŒå®¡æ‰¹workflowï¼šåœ¨æµç¨‹å¼€å§‹æ—¶åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“
 * - åç»­workflowèŠ‚ç‚¹å¯ç«‹å³ä½¿ç”¨è¯¥çŸ¥è¯†åº“è¿›è¡ŒRAGæ£€ç´¢
 *
 * @author zzxxhh
 * @since 2025-12-03
 */
@Slf4j
@Component
public class TempKnowledgeBaseMcpTools {

    @Autowired
    private KnowledgeBaseService knowledgeBaseService;

    @Autowired
    private DocumentProcessingService documentProcessingService;

    @Autowired
    private DocumentIndexingService documentIndexingService;

    /**
     * åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“å¹¶åŒæ­¥æ‰§è¡Œå‘é‡ç´¢å¼•
     *
     * æ‰§è¡Œæµç¨‹ï¼š
     * 1. åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“è®°å½•ï¼ˆis_temp=1, expire_time=now+2hï¼‰
     * 2. å¦‚æœæœ‰textï¼šåˆ›å»ºæ–‡æœ¬ç±»å‹item
     * 3. å¦‚æœæœ‰fileUrlsï¼šä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºitem
     * 4. åŒæ­¥æ‰§è¡Œå‘é‡ç´¢å¼•ï¼ˆç­‰å¾…å®Œæˆï¼‰
     * 5. è¿”å›kbUuidä¾›workflowä½¿ç”¨
     *
     * @param tenantCode ç§Ÿæˆ·ç¼–ç ï¼ˆå¿…å¡«ï¼‰
     * @param userId ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
     * @param text æ–‡æœ¬å†…å®¹ï¼ˆå¯é€‰ï¼‰
     * @param fileUrls æ–‡ä»¶URLæ•°ç»„ï¼ˆå¯é€‰ï¼‰
     * @return JSONæ ¼å¼çš„åˆ›å»ºç»“æœ
     */
    @McpTool(description = """
        åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“å¹¶åŒæ­¥å®Œæˆå‘é‡ç´¢å¼•ï¼Œä¾›workflowåç»­èŠ‚ç‚¹ç«‹å³ä½¿ç”¨ã€‚
        ä¸´æ—¶çŸ¥è¯†åº“2å°æ—¶åè‡ªåŠ¨æ¸…ç†ã€‚ä»…åšå‘é‡ç´¢å¼•ï¼Œä¸åšå›¾è°±ç´¢å¼•ã€‚
        """)
    public String createTempKnowledgeBase(
            @McpToolParam(description = "ç§Ÿæˆ·ç¼–ç ") String tenantCode,
            @McpToolParam(description = "ç”¨æˆ·ID") Long userId,
            @McpToolParam(description = "æ–‡æœ¬å†…å®¹ï¼ˆå¯é€‰ï¼‰") String text,
            @McpToolParam(description = "æ–‡ä»¶URLæ•°ç»„ï¼ˆå¯é€‰ï¼‰") List<String> fileUrls) {

        log.info("MCPå·¥å…·è°ƒç”¨ - åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“: ç§Ÿæˆ·={}, ç”¨æˆ·ID={}, æ–‡æœ¬é•¿åº¦={}, æ–‡ä»¶æ•°é‡={}",
                tenantCode, userId, (text != null ? text.length() : 0),
                (fileUrls != null ? fileUrls.size() : 0));

        try {
            // 1. åˆ‡æ¢ç§Ÿæˆ·æ•°æ®æº
            DataSourceHelper.use(tenantCode);

            // 2. å‚æ•°éªŒè¯
            if ((text == null || text.trim().isEmpty()) &&
                (fileUrls == null || fileUrls.isEmpty())) {
                return JSON.toJSONString(Map.of(
                        "success", false,
                        "message", "æ–‡æœ¬å’Œæ–‡ä»¶ä¸èƒ½åŒæ—¶ä¸ºç©ºï¼Œè‡³å°‘æä¾›ä¸€é¡¹",
                        "tenantCode", tenantCode
                ), JSONWriter.Feature.PrettyFormat);
            }

            // 3. åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“
            AiKnowledgeBaseVo kbVo = new AiKnowledgeBaseVo();
            String timestamp = LocalDateTime.now().format(
                    DateTimeFormatter.ofPattern("yyyyMMddHHmmss"));
            kbVo.setTitle("ä¸´æ—¶çŸ¥è¯†åº“-" + timestamp);
            kbVo.setRemark("ç”±MCPå·¥å…·è‡ªåŠ¨åˆ›å»ºçš„ä¸´æ—¶çŸ¥è¯†åº“ï¼Œç”¨äºworkflow");
            kbVo.setIs_temp(1);  // æ ‡è®°ä¸ºä¸´æ—¶
            kbVo.setExpire_time(LocalDateTime.now().plusHours(2));
            kbVo.setIsPublic(0);  // ç§æœ‰
            kbVo.setIsStrict(0);  // éä¸¥æ ¼æ¨¡å¼

            // è®¾ç½®é»˜è®¤é…ç½®ï¼ˆä¸´æ—¶çŸ¥è¯†åº“ä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
            kbVo.setIngestMaxOverlap(2000);
            kbVo.setIngestTokenEstimator("cl100k_base");
            kbVo.setIngestEmbeddingModel("BAAI/bge-m3");
            kbVo.setRetrieveMaxResults(5);
            kbVo.setRetrieveMinScore(new java.math.BigDecimal("0.3"));
            kbVo.setQueryLlmTemperature(new java.math.BigDecimal("0.7"));

            // ä¿å­˜çŸ¥è¯†åº“ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºQuartzæ¸…ç†ä»»åŠ¡ï¼‰
            AiKnowledgeBaseVo savedKb = knowledgeBaseService.saveOrUpdate(kbVo);
            String kbUuid = savedKb.getKbUuid();

            log.info("ä¸´æ—¶çŸ¥è¯†åº“åˆ›å»ºæˆåŠŸ: kbUuid={}, è¿‡æœŸæ—¶é—´={}",
                    kbUuid, savedKb.getExpire_time());

            // 4. åˆ›å»ºæ–‡æ¡£é¡¹
            List<String> itemUuids = new ArrayList<>();

            // 4.1 å¦‚æœæœ‰æ–‡æœ¬å†…å®¹ï¼Œåˆ›å»ºæ–‡æœ¬ç±»å‹item
            if (text != null && !text.trim().isEmpty()) {
                String textItemUuid = createTextItem(kbUuid, savedKb.getId(), text);
                itemUuids.add(textItemUuid);
                log.info("æ–‡æœ¬itemåˆ›å»ºæˆåŠŸ: itemUuid={}", textItemUuid);
            }

            // 4.2 å¦‚æœæœ‰æ–‡ä»¶URLï¼Œåˆ›å»ºæ–‡ä»¶ç±»å‹item
            if (fileUrls != null && !fileUrls.isEmpty()) {
                List<SFileInfoVo> fileInfoList = new ArrayList<>();
                for (String fileUrl : fileUrls) {
                    // ä»URLæå–æ–‡ä»¶å
                    String fileName = extractFileNameFromUrl(fileUrl);

                    SFileInfoVo fileInfo = new SFileInfoVo();
                    fileInfo.setUrl(fileUrl);
                    fileInfo.setFileName(fileName);
                    fileInfo.setFileSize(0L);  // æ–‡ä»¶å¤§å°æœªçŸ¥
                    fileInfoList.add(fileInfo);
                }

                List<String> fileItemUuids = documentProcessingService
                        .batchCreateItems(kbUuid, fileInfoList, false)
                        .stream()
                        .map(vo -> vo.getItemUuid())
                        .toList();

                itemUuids.addAll(fileItemUuids);
                log.info("æ–‡ä»¶itemsåˆ›å»ºæˆåŠŸï¼Œæ•°é‡: {}", fileItemUuids.size());
            }

            // 5. åŒæ­¥æ‰§è¡Œå‘é‡ç´¢å¼•ï¼ˆå…³é”®ï¼šç­‰å¾…å®Œæˆï¼‰
            log.info("å¼€å§‹åŒæ­¥ç´¢å¼•ï¼ŒitemCount: {}", itemUuids.size());
            int indexedCount = syncIndexItems(tenantCode, kbUuid, itemUuids);
            log.info("ç´¢å¼•å®Œæˆï¼ŒæˆåŠŸ: {}/{}", indexedCount, itemUuids.size());

            // 6. è¿”å›æˆåŠŸç»“æœ
            Map<String, Object> result = Map.of(
                    "success", true,
                    "kbUuid", kbUuid,
                    "message", "ä¸´æ—¶çŸ¥è¯†åº“åˆ›å»ºæˆåŠŸï¼Œå·²å®Œæˆå‘é‡ç´¢å¼•",
                    "itemCount", itemUuids.size(),
                    "indexedCount", indexedCount,
                    "expireTime", savedKb.getExpire_time().toString(),
                    "tenantCode", tenantCode
            );

            return JSON.toJSONString(result, JSONWriter.Feature.PrettyFormat);

        } catch (Exception e) {
            log.error("MCPå·¥å…·å¼‚å¸¸ - åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“å¤±è´¥: ç§Ÿæˆ·={}, é”™è¯¯={}",
                    tenantCode, e.getMessage(), e);
            return JSON.toJSONString(Map.of(
                    "success", false,
                    "message", "åˆ›å»ºä¸´æ—¶çŸ¥è¯†åº“å¤±è´¥: " + e.getMessage(),
                    "tenantCode", tenantCode,
                    "error", e.getClass().getSimpleName()
            ), JSONWriter.Feature.PrettyFormat);
        } finally {
            // æ¸…ç†æ•°æ®æºä¸Šä¸‹æ–‡
            DataSourceHelper.close();
        }
    }

    /**
     * åˆ›å»ºæ–‡æœ¬ç±»å‹çš„çŸ¥è¯†é¡¹
     */
    private String createTextItem(String kbUuid, String kbId, String text) {
        // ç›´æ¥åˆ›å»ºitemå®ä½“å¹¶ä¿å­˜
        com.xinyirun.scm.ai.bean.entity.rag.AiKnowledgeBaseItemEntity item =
                new com.xinyirun.scm.ai.bean.entity.rag.AiKnowledgeBaseItemEntity();

        String tenantCode = DataSourceHelper.getCurrentDataSourceName();
        String uuid = UuidUtil.createShort();
        String itemUuid = tenantCode + "::" + uuid;

        item.setItemUuid(itemUuid);
        item.setKbId(kbId);
        item.setKbUuid(kbUuid);
        item.setTitle("æ–‡æœ¬å†…å®¹");
        item.setRemark(text);  // æ–‡æœ¬å†…å®¹ä¿å­˜åœ¨remarkå­—æ®µ
        item.setBrief(text.length() > 200 ? text.substring(0, 200) : text);
        item.setEmbeddingStatus(0);  // å¾…ç´¢å¼•

        // ä¿å­˜ï¼ˆc_time, c_idç­‰ç”±MyBatis Plusè‡ªåŠ¨å¡«å……ï¼‰
        documentProcessingService.getItemMapper().insert(item);

        return itemUuid;
    }

    /**
     * ä»URLæå–æ–‡ä»¶å
     */
    private String extractFileNameFromUrl(String url) {
        if (url == null || url.isEmpty()) {
            return "æœªçŸ¥æ–‡ä»¶";
        }

        int lastSlash = url.lastIndexOf('/');
        if (lastSlash >= 0 && lastSlash < url.length() - 1) {
            return url.substring(lastSlash + 1);
        }

        return "æœªçŸ¥æ–‡ä»¶";
    }

    /**
     * åŒæ­¥æ‰§è¡Œç´¢å¼•ï¼ˆå…³é”®æ–¹æ³•ï¼‰
     *
     * ä¸ç°æœ‰çš„indexItems()ä¸åŒï¼š
     * - ä¸ä½¿ç”¨MQå¼‚æ­¥ï¼Œç›´æ¥è°ƒç”¨DocumentIndexingService
     * - åŒæ­¥ç­‰å¾…æ‰€æœ‰itemç´¢å¼•å®Œæˆ
     * - åªåšå‘é‡ç´¢å¼•ï¼ˆindexTypesåªåŒ…å«"embedding"ï¼‰
     *
     * @return æˆåŠŸç´¢å¼•çš„itemæ•°é‡
     */
    private int syncIndexItems(String tenantCode, String kbUuid, List<String> itemUuids) {
        int successCount = 0;
        List<String> indexTypes = Arrays.asList("embedding");  // ä»…å‘é‡ç´¢å¼•

        for (String itemUuid : itemUuids) {
            try {
                // æŸ¥è¯¢itemä¿¡æ¯
                com.xinyirun.scm.ai.bean.entity.rag.AiKnowledgeBaseItemEntity item =
                        documentProcessingService.getItemMapper().selectOne(
                                new com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper<
                                        com.xinyirun.scm.ai.bean.entity.rag.AiKnowledgeBaseItemEntity>()
                                        .eq(com.xinyirun.scm.ai.bean.entity.rag.AiKnowledgeBaseItemEntity::getItemUuid, itemUuid)
                        );

                if (item == null) {
                    log.warn("Itemä¸å­˜åœ¨ï¼Œè·³è¿‡ç´¢å¼•: itemUuid={}", itemUuid);
                    continue;
                }

                // æŸ¥è¯¢æ–‡ä»¶URLï¼ˆå¦‚æœæ˜¯æ–‡ä»¶ç±»å‹ï¼‰
                String fileUrl = "";
                String fileName = item.getTitle();

                if (item.getRemark() == null || item.getRemark().isEmpty()) {
                    // æ²¡æœ‰remarkè¯´æ˜æ˜¯æ–‡ä»¶ç±»å‹ï¼Œéœ€è¦æŸ¥è¯¢URL
                    List<SFileInfoVo> files = documentProcessingService
                            .getSFileService()
                            .selectFileInfoBySerialTypeAndId("ai_knowledge_base_item",
                                    Integer.parseInt(item.getId()));

                    if (files != null && !files.isEmpty()) {
                        fileUrl = files.get(0).getUrl();
                        fileName = files.get(0).getFileName();
                    }
                }

                // åŒæ­¥è°ƒç”¨ç´¢å¼•æœåŠ¡ï¼ˆå…³é”®ï¼šè¿™é‡Œæ˜¯åŒæ­¥çš„ï¼‰
                documentIndexingService.processDocument(
                        tenantCode,
                        itemUuid,
                        kbUuid,
                        fileUrl,
                        fileName,
                        indexTypes  // åªåŒ…å«"embedding"
                );

                successCount++;
                log.info("Itemç´¢å¼•å®Œæˆ: itemUuid={}", itemUuid);

            } catch (Exception e) {
                log.error("Itemç´¢å¼•å¤±è´¥: itemUuid={}, é”™è¯¯={}", itemUuid, e.getMessage(), e);
            }
        }

        return successCount;
    }
}
```

### 5.2 éœ€è¦çš„ä¾èµ–æ³¨å…¥ä¿®æ”¹

DocumentProcessingServiceéœ€è¦æš´éœ²itemMapperå’ŒsFileServiceï¼š

```java
// åœ¨DocumentProcessingServiceä¸­æ·»åŠ getteræ–¹æ³•
public AiKnowledgeBaseItemMapper getItemMapper() {
    return itemMapper;
}

public ISFileService getSFileService() {
    return sFileService;
}
```

---

## 6. KISSåŸåˆ™7é—®é¢˜å›ç­”

### é—®é¢˜1ï¼š"è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ"
**âœ… çœŸé—®é¢˜**
- Workflowéœ€è¦ä¸´æ—¶çŸ¥è¯†åº“åšAIè¾…åŠ©å®¡æ‰¹
- ç°æœ‰çš„æ¥å£éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸æ»¡è¶³"ç«‹å³å¯ç”¨"éœ€æ±‚
- ç”¨æˆ·å·²æ˜ç¡®è¡¨ç¤ºéœ€è¦è¿™ä¸ªåŠŸèƒ½

### é—®é¢˜2ï¼š"æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ"
**âœ… å·²æ˜¯æœ€ç®€æ–¹æ¡ˆ**
- å®Œå…¨å¤ç”¨ç°æœ‰Serviceï¼Œé›¶æ–°å¢ä¸šåŠ¡é€»è¾‘
- åªæ˜¯æ¢äº†ä¸ªè°ƒç”¨æ–¹å¼ï¼šç›´æ¥è°ƒç”¨ vs MQå¼‚æ­¥
- ä»£ç é‡æœ€å°ï¼ˆçº¦200è¡Œï¼Œä¸»è¦æ˜¯å‚æ•°å¤„ç†å’Œæ—¥å¿—ï¼‰

### é—®é¢˜3ï¼š"ä¼šç ´åä»€ä¹ˆå—ï¼Ÿ"
**âœ… é›¶ç ´å**
- åªæ–°å¢MCPå·¥å…·ç±»ï¼Œä¸ä¿®æ”¹ä»»ä½•ç°æœ‰ä»£ç 
- DocumentProcessingServiceåªæ˜¯æ–°å¢2ä¸ªgetterï¼ˆéç ´åæ€§ï¼‰
- å®Œå…¨ä¸å½±å“ç°æœ‰çš„å¼‚æ­¥ç´¢å¼•é€»è¾‘

### é—®é¢˜4:"å½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—ï¼Ÿ"
**âœ… å¿…è¦åŠŸèƒ½**
- åˆåŒå®¡æ‰¹workflowçš„æ ¸å¿ƒéœ€æ±‚
- ç¬¦åˆSCM AIè¾…åŠ©å®¡æ‰¹çš„ä¸šåŠ¡åœºæ™¯

### é—®é¢˜5ï¼š"æœ‰ç¼ºå°‘å¿…è¦ä¿¡æ¯å—ï¼Ÿèƒ½å¦ç»§ç»­è¯„ä¼°ï¼Ÿ"
**âœ… ä¿¡æ¯å®Œæ•´**
- å·²ç¡®è®¤ä½¿ç”¨å®Œå…¨åŒæ­¥æ–¹æ¡ˆ
- å·²ç†è§£ä¸´æ—¶KBåªåšå‘é‡ç´¢å¼•çš„é€»è¾‘
- å·²åˆ†æå®Œæ•´è°ƒç”¨é“¾è·¯

### é—®é¢˜6ï¼š"è¯é¢˜æ˜¯å¦æ¨¡ç³Šï¼Œæ˜¯å¦ä¼šäº§ç”Ÿå¹»è§‰ï¼Ÿ"
**âœ… è¯é¢˜æ¸…æ™°**
- éœ€æ±‚æ˜ç¡®ï¼šMCPå·¥å…· + åŒæ­¥ç´¢å¼•
- æŠ€æœ¯è·¯å¾„æ¸…æ™°ï¼šå¤ç”¨ç°æœ‰Service
- å®ç°ç»†èŠ‚æ¸…æ™°ï¼šå·²æœ‰å®Œæ•´ä»£ç è®¾è®¡

### é—®é¢˜7ï¼š"å·²ç»å­¦ä¹ äº†ä»£ç å®æ–½çš„æ³¨æ„äº‹é¡¹ï¼Ÿ"
**âœ… å·²æ·±åˆ»å­¦ä¹ å¹¶åº”ç”¨**
- âœ… ç¬¬17æ¡ï¼šæ’å…¥ç”¨beanï¼ˆ`itemMapper.insert(item)`ï¼‰
- âœ… ç¬¬10æ¡ï¼šæ£€æŸ¥äº†ç°æœ‰ä»£ç ï¼Œå®Œå…¨å¤ç”¨
- âœ… ç¬¬6æ¡ï¼šç†è§£äº†Milvuså‘é‡ç´¢å¼•é€»è¾‘
- âœ… ç¬¬22æ¡ï¼šä½¿ç”¨importï¼Œä¸ç”¨åŒ…å.ç±»å
- âœ… ç¬¬23æ¡ï¼šä½¿ç”¨`UuidUtil.createShort()`

---

## 7. é£é™©åˆ†æä¸ç¼“è§£æªæ–½

### 7.1 æ€§èƒ½é£é™©

**é£é™©**ï¼šåŒæ­¥ç´¢å¼•å¯èƒ½é˜»å¡workflowè¾ƒé•¿æ—¶é—´

**ç¼“è§£æªæ–½**ï¼š
1. ä¸´æ—¶KBä½¿ç”¨åœºæ™¯ï¼šæ–‡ä»¶æ•°é‡å°‘ï¼ˆ1-3ä¸ªï¼‰ï¼Œå¯æ§
2. å¦‚è¶…æ—¶å¯è®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆå¦‚60ç§’ï¼‰
3. è®°å½•è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºå®šä½æ…¢æŸ¥è¯¢

**é¢„ä¼°æ—¶é—´**ï¼š
- 1ä¸ª5MB PDFï¼š5-8ç§’
- 3ä¸ªæ–‡ä»¶å…±10MBï¼š10-15ç§’
- çº¯æ–‡æœ¬ï¼š2-3ç§’

### 7.2 æ•°æ®ä¸€è‡´æ€§é£é™©

**é£é™©**ï¼šç´¢å¼•å¤±è´¥å¯¼è‡´KBå¯ç”¨ä½†æ— å†…å®¹

**ç¼“è§£æªæ–½**ï¼š
1. æ¯ä¸ªitemç‹¬ç«‹try-catchï¼Œä¸€ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–
2. è¿”å›`indexedCount`ï¼Œè°ƒç”¨æ–¹å¯åˆ¤æ–­æˆåŠŸç‡
3. è¯¦ç»†é”™è¯¯æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥

### 7.3 ç§Ÿæˆ·éš”ç¦»é£é™©

**é£é™©**ï¼šå¤šç§Ÿæˆ·ç¯å¢ƒä¸‹æ•°æ®æºåˆ‡æ¢ä¸å½“

**ç¼“è§£æªæ–½**ï¼š
1. æ˜¾å¼è°ƒç”¨`DataSourceHelper.use(tenantCode)`
2. finallyå—ç¡®ä¿`DataSourceHelper.close()`
3. æ‰€æœ‰Serviceéƒ½å·²æ”¯æŒç§Ÿæˆ·éš”ç¦»

---

## 8. æµ‹è¯•éªŒè¯è®¡åˆ’

### 8.1 å•å…ƒæµ‹è¯•åœºæ™¯

1. **çº¯æ–‡æœ¬åœºæ™¯**
   - è¾“å…¥ï¼štext="åˆåŒå†…å®¹..."
   - éªŒè¯ï¼šKBåˆ›å»ºæˆåŠŸï¼Œ1ä¸ªitemï¼Œå‘é‡ç´¢å¼•å®Œæˆ

2. **å•æ–‡ä»¶åœºæ™¯**
   - è¾“å…¥ï¼šfileUrls=["http://.../contract.pdf"]
   - éªŒè¯ï¼šKBåˆ›å»ºæˆåŠŸï¼Œ1ä¸ªitemï¼Œå‘é‡ç´¢å¼•å®Œæˆ

3. **æ··åˆåœºæ™¯**
   - è¾“å…¥ï¼štext + fileUrlsï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰
   - éªŒè¯ï¼šKBåˆ›å»ºæˆåŠŸï¼Œ4ä¸ªitemsï¼Œå…¨éƒ¨ç´¢å¼•å®Œæˆ

4. **å¼‚å¸¸åœºæ™¯**
   - è¾“å…¥ï¼štextå’ŒfileUrlséƒ½ä¸ºç©º
   - éªŒè¯ï¼šè¿”å›å¤±è´¥ï¼Œæç¤ºé”™è¯¯

### 8.2 é›†æˆæµ‹è¯•åœºæ™¯

1. **Workflowé›†æˆæµ‹è¯•**
   - è°ƒç”¨MCPå·¥å…·åˆ›å»ºä¸´æ—¶KB
   - ä¸‹ä¸€èŠ‚ç‚¹ä½¿ç”¨kbUuidåšRAGæ£€ç´¢
   - éªŒè¯ï¼šèƒ½æ­£å¸¸æ£€ç´¢åˆ°å‘é‡

2. **è‡ªåŠ¨æ¸…ç†æµ‹è¯•**
   - åˆ›å»ºä¸´æ—¶KB
   - ç­‰å¾…2å°æ—¶
   - éªŒè¯ï¼šQuartzä»»åŠ¡æ‰§è¡Œï¼Œæ•°æ®æ¸…ç†

---

## 9. éƒ¨ç½²è¯´æ˜

### 9.1 æ–‡ä»¶å˜æ›´æ¸…å•

**æ–°å¢æ–‡ä»¶**ï¼š
- `scm-ai/src/main/java/com/xinyirun/scm/ai/mcp/utils/temp/knowledge/TempKnowledgeBaseMcpTools.java`

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `scm-ai/src/main/java/com/xinyirun/scm/ai/core/service/DocumentProcessingService.java`
  - æ–°å¢2ä¸ªgetteræ–¹æ³•

**ä¾èµ–**ï¼šæ— æ–°å¢ä¾èµ–

### 9.2 é…ç½®å˜æ›´

æ— éœ€é…ç½®å˜æ›´ï¼Œå¤ç”¨ç°æœ‰é…ç½®ã€‚

### 9.3 æ•°æ®åº“å˜æ›´

æ— éœ€æ•°æ®åº“å˜æ›´ï¼Œå¤ç”¨ç°æœ‰è¡¨ç»“æ„ã€‚

---

## 10. æ–¹æ¡ˆæ€»ç»“

### 10.1 è®¾è®¡ä¼˜åŠ¿

1. **é›¶ç ´åæ€§**ï¼šåªæ–°å¢æ–‡ä»¶ï¼Œä¸ä¿®æ”¹ç°æœ‰é€»è¾‘
2. **æœ€å¤§å¤ç”¨**ï¼š100%å¤ç”¨ç°æœ‰Service
3. **åŒæ­¥å¯é **ï¼šworkflowæ‹¿åˆ°çš„kbUuidç«‹å³å¯ç”¨
4. **æ€§èƒ½å¯æ§**ï¼šæ–‡ä»¶æ•°é‡å°‘ï¼Œç´¢å¼•æ—¶é—´åœ¨å¯æ¥å—èŒƒå›´
5. **è‡ªåŠ¨æ¸…ç†**ï¼šå¤ç”¨ç°æœ‰Quartzæœºåˆ¶ï¼Œæ— éœ€é¢å¤–ç»´æŠ¤

### 10.2 å…³é”®åˆ›æ–°ç‚¹

1. **åŒæ­¥ç´¢å¼•**ï¼šä¸ä½¿ç”¨MQï¼Œç›´æ¥è°ƒç”¨DocumentIndexingService
2. **å•ä¸€èŒè´£**ï¼šMCPå·¥å…·åªè´Ÿè´£åˆ›å»º+ç´¢å¼•ï¼Œæ¸…ç†ç”±Quartzè´Ÿè´£
3. **é”™è¯¯éš”ç¦»**ï¼šå•ä¸ªitemå¤±è´¥ä¸å½±å“å…¶ä»–item

### 10.3 åç»­ä¼˜åŒ–æ–¹å‘

1. å¦‚æœæ–‡ä»¶æ•°é‡å¢å¤šï¼Œå¯è€ƒè™‘ï¼š
   - å¢åŠ è¶…æ—¶æ§åˆ¶
   - æ”¯æŒéƒ¨åˆ†æˆåŠŸè¿”å›
   - æä¾›è¿›åº¦å›è°ƒæ¥å£

2. ç›‘æ§æŒ‡æ ‡ï¼š
   - ç´¢å¼•å¹³å‡è€—æ—¶
   - æˆåŠŸç‡ç»Ÿè®¡
   - ä¸´æ—¶KBä½¿ç”¨é‡

---

**æ–¹æ¡ˆè®¾è®¡å®Œæˆ**
**å¾…å®¡æ‰¹é€šè¿‡åè¿›å…¥ä»£ç å®æ–½é˜¶æ®µ**
