# SCM AI Chat Memoryå®ç°ä¼˜åŒ–åˆ†æ

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### æ ¸å¿ƒåˆ¤æ–­
**âŒ SCMçš„Memoryå®ç°å­˜åœ¨æ˜æ˜¾è¿‡åº¦è®¾è®¡**

ç†ç”±:
1. **æ•°æ®ç»“æ„é”™è¯¯**: æ··æ·†äº†"å¯¹è¯å†å²ç®¡ç†"å’Œ"ä¼šè¯çŠ¶æ€æŒä¹…åŒ–"ä¸¤ä¸ªæ¦‚å¿µ,å¯¼è‡´åŒé‡å®ç°
2. **å¤æ‚åº¦å¤±æ§**: ä¸ºäº†ç®€å•çš„å¯¹è¯å†å²åŠŸèƒ½,åˆ›å»ºäº†5ä¸ªChatClient Bean + 2å¥—ChatMemory + 1ä¸ªè‡ªå®šä¹‰Advisor
3. **ç ´åæ€§é£é™©**: å½“å‰å®ç°ä¸Spring AI Graphå†…ç½®çš„MemorySaver/MemoryStoreæœºåˆ¶å†²çª,é˜»ç¢äº†æœªæ¥å‡çº§è·¯å¾„

### å…³é”®æ´å¯Ÿ

**æ•°æ®ç»“æ„å±‚é¢**:
- **SCMå½“å‰**: æ‰‹åŠ¨ç®¡ç†æ•°æ®åº“è¡¨ `ai_conversation_content` + `ai_workflow_conversation_content`
- **å®˜æ–¹æ¨è**: ä½¿ç”¨Graphå†…ç½®çš„ `MemorySaver` (çŸ­æœŸè®°å¿†) + `MemoryStore` (é•¿æœŸè®°å¿†)
- **é—®é¢˜**: SCMæŠŠ"å¯¹è¯å†å²"å½“æˆç‰¹æ®Šä¸šåŠ¡é€»è¾‘æ‰‹åŠ¨å®ç°,å®é™…ä¸Šè¿™æ˜¯æ¡†æ¶æ ‡é…åŠŸèƒ½

**å¤æ‚åº¦å±‚é¢**:
- **SCM**: 163è¡Œé…ç½® + 134è¡Œè‡ªå®šä¹‰ChatMemory + 178è¡Œè‡ªå®šä¹‰Advisor = **475è¡Œä»£ç **
- **å®˜æ–¹**: ä½¿ç”¨`MemorySaver` + `ModelHook` = **30è¡Œé…ç½®ä»£ç **
- **å·®è·**: **15å€å¤æ‚åº¦**, ç»´æŠ¤æˆæœ¬å·¨å¤§

**é£é™©ç‚¹å±‚é¢**:
- **æœ€å¤§é£é™©**: å½“Spring AI Alibabaå‡çº§Graphæ¡†æ¶æ—¶,SCMçš„è‡ªå®šä¹‰å®ç°ä¼šæˆä¸ºæŠ€æœ¯å€º
- **å…¼å®¹é—®é¢˜**: æ— æ³•ç›´æ¥ä½¿ç”¨å®˜æ–¹çš„è·¨ä¼šè¯è®°å¿†ã€ç”¨æˆ·åå¥½å­¦ä¹ ç­‰é«˜çº§åŠŸèƒ½
- **å¤šç§Ÿæˆ·å†²çª**: DataSourceHelper.use()ä¸Graphçš„threadIdæœºåˆ¶å­˜åœ¨è¯­ä¹‰å†²çª

---

## ğŸ” è¯¦ç»†å¯¹æ¯”åˆ†æ

### 1. æ¶æ„å¯¹æ¯”

#### SCMå½“å‰å®ç°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AiChatMemoryConfig.java                   â”‚
â”‚  - 5ä¸ªä¸åŒçš„ChatClient Beané…ç½®                             â”‚
â”‚  - 2ä¸ªMessageChatMemoryAdvisor Bean                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ChatMemoryå®ç°â”‚  â”‚WorkflowConversation  â”‚
â”‚(æ‰‹åŠ¨æŸ¥è¯¢DB)  â”‚  â”‚Advisor(æ‰‹åŠ¨ä¿å­˜)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚
       â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ai_conversation_content        â”‚
â”‚  ai_workflow_conversation_contentâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜è¯†åˆ«**:
1. **èŒè´£åˆ†è£‚**: è¯»å–(ChatMemory) å’Œ å†™å…¥(Advisor) åˆ†ç¦»,å¢åŠ ç†è§£æˆæœ¬
2. **é‡å¤é€»è¾‘**: Chatå’ŒWorkflowä¸¤å¥—å‡ ä¹ç›¸åŒçš„å®ç°
3. **Beançˆ†ç‚¸**: 5ä¸ªChatClient Bean = chatDomain, workflowDomain, workflowRouting, orchestrator, workflowDomainNoMcp
   - ä¸ºä»€ä¹ˆéœ€è¦5ä¸ª? å› ä¸ºæ¯ä¸ªåœºæ™¯éœ€è¦ä¸åŒçš„Advisorç»„åˆ
   - è¿™æ˜¯é…ç½®å¤æ‚åº¦çš„æ ¹æº

#### Spring AI Alibabaå®˜æ–¹æ¨èæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ReactAgent.builder()       â”‚
â”‚  .saver(new MemorySaver())       â”‚ â† çŸ­æœŸè®°å¿†(å¯¹è¯å†å²)
â”‚  .hooks(modelHook)               â”‚ â† é•¿æœŸè®°å¿†æ³¨å…¥
â”‚  .build()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Memory   â”‚    â”‚Memory    â”‚
â”‚Saver    â”‚    â”‚Store     â”‚
â”‚(å†…å­˜/DB)â”‚    â”‚(ç”¨æˆ·æ•°æ®)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**:
1. **èŒè´£ç»Ÿä¸€**: MemorySaverå†…éƒ¨è‡ªåŠ¨å¤„ç†è¯»å†™
2. **å†…ç½®æ”¯æŒ**: Graphæ¡†æ¶åŸç”Ÿé›†æˆ,æ— éœ€é¢å¤–é…ç½®
3. **Beanç®€æ´**: åªéœ€1ä¸ªChatClientæˆ–ReactAgent
4. **çµæ´»æ‰©å±•**: å¯é€‰æ‹©å†…å­˜ã€æ•°æ®åº“ã€Redisç­‰ä¸åŒæŒä¹…åŒ–æ–¹å¼

---

### 2. ä»£ç å¤æ‚åº¦å¯¹æ¯”

#### SCMå®ç° (475è¡Œæ ¸å¿ƒä»£ç )

**AiChatMemoryConfig.java** (163è¡Œ)
```java
@Bean("chatMessageChatMemoryAdvisor")
public MessageChatMemoryAdvisor chatMessageChatMemoryAdvisor(
    ScmChatMessageChatMemory chatMessageChatMemory) {
    return MessageChatMemoryAdvisor.builder(chatMessageChatMemory).build();
}

@Bean("workflowMessageChatMemoryAdvisor")
public MessageChatMemoryAdvisor workflowMessageChatMemoryAdvisor(
    ScmWorkflowMessageChatMemory workflowMessageChatMemory) {
    return MessageChatMemoryAdvisor.builder(workflowMessageChatMemory).build();
}

// 5ä¸ªChatClient Beané…ç½®...
@Bean("chatDomainChatClient")
@Bean("workflowDomainChatClient")
@Bean("workflowRoutingChatClient")
@Bean("orchestratorChatClient")
@Bean("workflowDomainChatClientNoMcp")
```

**ScmChatMessageChatMemory.java** (134è¡Œ)
```java
@Override
public List<Message> get(String conversationId) {
    try {
        String tenantId = parseTenantId(conversationId);
        DataSourceHelper.use(tenantId);  // æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æº

        // æ‰‹åŠ¨æŸ¥è¯¢æ•°æ®åº“
        List<AiConversationContentVo> contents =
            aiConversationService.getConversationHistory(conversationId, DEFAULT_MAX_MESSAGES);

        // æ‰‹åŠ¨è½¬æ¢ä¸ºSpring AI Message
        return contents.stream()
            .map(this::convertToMessage)
            .collect(Collectors.toList());
    } finally {
        DataSourceHelper.close();  // æ‰‹åŠ¨å…³é—­
    }
}

@Override
public void add(String conversationId, List<Message> messages) {
    // ç©ºå®ç°! å®é™…ä¿å­˜åœ¨Advisorä¸­å®Œæˆ
}
```

**WorkflowConversationAdvisor.java** (178è¡Œ)
```java
@Override
public ChatClientResponse adviseCall(ChatClientRequest request, CallAdvisorChain chain) {
    String callSource = (String) request.context().get(CALL_SOURCE);

    // ç‰¹æ®Šæƒ…å†µå¤„ç†: å¦‚æœæ˜¯AI Chatè°ƒç”¨,è·³è¿‡ä¿å­˜
    if (WorkflowCallSource.AI_CHAT.name().equals(callSource)) {
        log.info("ğŸš« AI Chatè°ƒç”¨Workflow,è·³è¿‡ä¿å­˜");
        return chain.nextCall(request);
    }

    // ä¿å­˜USERæ¶ˆæ¯ (è°ƒç”¨å‰)
    String conversationId = (String) request.context().get(ChatMemory.CONVERSATION_ID);
    String runtimeUuid = (String) request.context().get(RUNTIME_UUID);
    saveMessage(conversationId, runtimeUuid, MESSAGE_TYPE_USER, userContent);

    // æ‰§è¡Œè°ƒç”¨
    ChatClientResponse response = chain.nextCall(request);

    // ä¿å­˜ASSISTANTæ¶ˆæ¯ (è°ƒç”¨å)
    String assistantContent = response.chatResponse().getResult().getOutput().getText();
    saveMessage(conversationId, runtimeUuid, MESSAGE_TYPE_ASSISTANT, assistantContent);

    return response;
}

private void saveMessage(...) {
    try {
        String tenantId = parseTenantId(conversationId);
        DataSourceHelper.use(tenantId);  // æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æº
        // æ‰‹åŠ¨æ’å…¥æ•°æ®åº“...
    } finally {
        DataSourceHelper.close();
    }
}
```

**æ€»è®¡**: 163 + 134 + 178 = **475è¡Œä»£ç **

#### å®˜æ–¹æ¨èå®ç° (~30è¡Œé…ç½®)

```java
// 1. åˆ›å»ºAgentæ—¶é…ç½®MemorySaver (çŸ­æœŸè®°å¿†)
ReactAgent agent = ReactAgent.builder()
    .name("ai_chat_agent")
    .model(chatModel)
    .saver(new MemorySaver())  // è‡ªåŠ¨ç®¡ç†å¯¹è¯å†å²
    .build();

// 2. å¦‚æœéœ€è¦é•¿æœŸè®°å¿†,æ·»åŠ ModelHook
ModelHook memoryHook = new ModelHook() {
    @Override
    public CompletableFuture<Map<String, Object>> beforeModel(
        OverAllState state, RunnableConfig config) {
        // ä»StoreåŠ è½½ç”¨æˆ·æ•°æ®
        Store store = config.store();
        String userId = (String) config.metadata("user_id").orElse(null);
        Optional<StoreItem> profile = store.getItem(List.of("profiles"), userId);

        // æ³¨å…¥SystemMessage
        if (profile.isPresent()) {
            List<Message> messages = new ArrayList<>();
            messages.add(new SystemMessage("ç”¨æˆ·ç”»åƒ: " + profile.get().getValue()));
            messages.addAll((List<Message>) state.value("messages").orElse(List.of()));
            return CompletableFuture.completedFuture(Map.of("messages", messages));
        }
        return CompletableFuture.completedFuture(Map.of());
    }
};

// 3. è°ƒç”¨æ—¶ä¼ å…¥config
RunnableConfig config = RunnableConfig.builder()
    .threadId(conversationId)  // è‡ªåŠ¨éš”ç¦»ä¼šè¯
    .addMetadata("user_id", userId)
    .store(new MemoryStore())  // é•¿æœŸè®°å¿†å­˜å‚¨
    .build();

agent.invoke(userInput, config);
```

**æ€»è®¡**: ~30è¡Œé…ç½®ä»£ç , **æ— éœ€è‡ªå®šä¹‰ChatMemoryå’ŒAdvisor**

**å¤æ‚åº¦å¯¹æ¯”**: 475è¡Œ vs 30è¡Œ = **15.8å€å·®è·**

---

### 3. ç‰¹æ®Šæƒ…å†µè¯†åˆ«

#### SCMä»£ç ä¸­çš„"ç‰¹æ®Šæƒ…å†µè¡¥ä¸"

**é—®é¢˜1: ç©ºå®ç°çš„add()æ–¹æ³•**
```java
// ScmChatMessageChatMemory.java
@Override
public void add(String conversationId, List<Message> messages) {
    // ç©ºå®ç°! å› ä¸ºå®é™…ä¿å­˜åœ¨Advisorä¸­
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·åš?**
- ChatMemoryæ¥å£è¦æ±‚å®ç°add(),ä½†SCMé€‰æ‹©åœ¨Advisorä¸­ä¿å­˜
- è¿™æ˜¯**èŒè´£åˆ†ç¦»ä¸å½“**çš„è¡¨ç°

**å®˜æ–¹åšæ³•**:
- MemorySaverå†…éƒ¨ç»Ÿä¸€å¤„ç†è¯»å†™,ä¸å­˜åœ¨"ç©ºå®ç°"

---

**é—®é¢˜2: CALL_SOURCEåˆ¤æ–­**
```java
// WorkflowConversationAdvisor.java
if (WorkflowCallSource.AI_CHAT.name().equals(callSource)) {
    log.info("ğŸš« AI Chatè°ƒç”¨Workflow,è·³è¿‡ä¿å­˜");
    return chain.nextCall(request);
}
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåˆ¤æ–­?**
- å› ä¸ºChatå’ŒWorkflowå…±äº«åŒä¸€ä¸ªAdvisor,ä½†æœ‰äº›åœºæ™¯ä¸éœ€è¦ä¿å­˜
- è¿™æ˜¯**é…ç½®ç²’åº¦è¿‡ç²—**çš„è¡¨ç°

**å®˜æ–¹åšæ³•**:
- ä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒçš„Agenté…ç½®,ä¸éœ€è¦è¿è¡Œæ—¶åˆ¤æ–­

---

**é—®é¢˜3: DataSourceHelperæ‰‹åŠ¨ç®¡ç†**
```java
try {
    String tenantId = parseTenantId(conversationId);
    DataSourceHelper.use(tenantId);
    // ä¸šåŠ¡é€»è¾‘...
} finally {
    DataSourceHelper.close();
}
```

**ä¸ºä»€ä¹ˆæ‰‹åŠ¨ç®¡ç†?**
- å› ä¸ºChatMemoryæ˜¯å•ä¾‹Bean,æ— æ³•è‡ªåŠ¨æ³¨å…¥ç§Ÿæˆ·ä¸Šä¸‹æ–‡
- æ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦æ‰‹åŠ¨è§£æconversationIdè·å–tenantId

**å®˜æ–¹åšæ³•**:
- ä½¿ç”¨RunnableConfigä¼ é€’ä¸Šä¸‹æ–‡,æ¡†æ¶è‡ªåŠ¨ç®¡ç†
- å¯ä»¥åœ¨configä¸­å­˜å‚¨tenantId: `config.addMetadata("tenantId", tenantId)`

---

### 4. å‘åå…¼å®¹æ€§åˆ†æ

#### å½“å‰å®ç°çš„æŠ€æœ¯å€º

**å€ºåŠ¡1: é˜»ç¢æ¡†æ¶å‡çº§**
```java
// SCMä½¿ç”¨è‡ªå®šä¹‰ChatMemory,æœªä½¿ç”¨Graphå†…ç½®æœºåˆ¶
ChatMemory chatMemory = new ScmChatMessageChatMemory();

// å®˜æ–¹å‡çº§æ—¶å¯èƒ½å¼•å…¥æ–°çš„MemorySaverç‰¹æ€§:
// - è·¨ä¼šè¯è®°å¿†æŒä¹…åŒ–
// - è‡ªåŠ¨æ‘˜è¦å’Œå‹ç¼©
// - æ™ºèƒ½é—å¿˜æœºåˆ¶
// SCMæ— æ³•ç›´æ¥å—ç›Š,éœ€è¦é‡å†™
```

**å€ºåŠ¡2: æ— æ³•ä½¿ç”¨å®˜æ–¹é«˜çº§åŠŸèƒ½**
```java
// å®˜æ–¹MemoryExample.javaå±•ç¤ºçš„åŠŸèƒ½,SCMå½“å‰æ— æ³•ä½¿ç”¨:
// - ç”¨æˆ·åå¥½å­¦ä¹  (éœ€è¦MemoryStore)
// - è·¨ä¼šè¯è®°å¿† (éœ€è¦MemorySaveræŒä¹…åŒ–)
// - è‡ªåŠ¨è®°å¿†æ³¨å…¥ (éœ€è¦ModelHook)
```

**å€ºåŠ¡3: å¤šç§Ÿæˆ·ä¸threadIdè¯­ä¹‰å†²çª**
```java
// SCM: conversationIdåŒ…å«tenantId (æ ¼å¼: tenantId_conversationId)
String tenantId = parseTenantId(conversationId);

// å®˜æ–¹: threadIdæ˜¯çº¯ç²¹çš„ä¼šè¯æ ‡è¯†
RunnableConfig config = RunnableConfig.builder()
    .threadId("conversation_123")  // ä¸åŒ…å«ç§Ÿæˆ·ä¿¡æ¯
    .addMetadata("tenantId", tenantId)  // ç§Ÿæˆ·ä¿¡æ¯æ”¾metadata
    .build();

// å†²çª: SCMå°†ä¸šåŠ¡æ¦‚å¿µæ··å…¥æ¡†æ¶æ¦‚å¿µ
```

---

## ğŸ¯ Linuså¼ä¼˜åŒ–æ–¹æ¡ˆ

### ç¬¬ä¸€æ­¥: ç®€åŒ–æ•°æ®ç»“æ„ (æ¶ˆé™¤åŒé‡ç®¡ç†)

**é—®é¢˜**: SCMæ—¢ç”¨`ai_conversation_content`è¡¨,åˆè¯•å›¾ç”¨MemorySaver,å¯¼è‡´æ¦‚å¿µæ··ä¹±

**è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨MemorySaverä½œä¸ºå”¯ä¸€çœŸç›¸æº

```java
// åˆ é™¤: ScmChatMessageChatMemory.java (134è¡Œ)
// åˆ é™¤: ScmWorkflowMessageChatMemory.java (134è¡Œ)
// åˆ é™¤: WorkflowConversationAdvisor.java (178è¡Œ)

// æ–°å¢: ç®€å•çš„MemorySaveré…ç½®
@Bean
public BaseCheckpointSaver checkpointSaver() {
    // é€‰é¡¹1: å†…å­˜å®ç° (ç®€å•åœºæ™¯)
    return new MemorySaver();

    // é€‰é¡¹2: æ•°æ®åº“æŒä¹…åŒ– (ç”Ÿäº§ç¯å¢ƒ)
    // ç»§æ‰¿MemorySaver,é‡å†™insertedCheckpoint/loadedCheckpointsæ–¹æ³•
    // åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­æ“ä½œ ai_conversation_content è¡¨
    return new DatabaseMemorySaver(jdbcTemplate);
}
```

**æ”¶ç›Š**:
- åˆ é™¤ **446è¡Œä»£ç ** (134 + 134 + 178)
- æ¶ˆé™¤è¯»å†™åˆ†ç¦»çš„ç†è§£æˆæœ¬
- ç¬¦åˆæ¡†æ¶è®¾è®¡ç†å¿µ

---

### ç¬¬äºŒæ­¥: æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ (ç»Ÿä¸€Beané…ç½®)

**é—®é¢˜**: 5ä¸ªChatClient Beanæ˜¯ä¸ºäº†ç»„åˆä¸åŒçš„Advisor

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ReactAgentçš„hookså‚æ•°åŠ¨æ€ç»„åˆ

```java
// åˆ é™¤: 5ä¸ªChatClient Beané…ç½® (chatDomain, workflowDomainç­‰)

// æ–°å¢: ç»Ÿä¸€çš„Agent Factory
@Component
public class AiAgentFactory {

    @Autowired
    private ChatModel chatModel;

    @Autowired
    private BaseCheckpointSaver checkpointSaver;

    public ReactAgent createChatAgent(List<ModelHook> hooks) {
        return ReactAgent.builder()
            .name("chat_agent")
            .model(chatModel)
            .saver(checkpointSaver)
            .hooks(hooks.toArray(new ModelHook[0]))
            .build();
    }

    public ReactAgent createWorkflowAgent(List<ModelHook> hooks) {
        return ReactAgent.builder()
            .name("workflow_agent")
            .model(chatModel)
            .saver(checkpointSaver)
            .hooks(hooks.toArray(new ModelHook[0]))
            .build();
    }
}

// ä½¿ç”¨æ—¶åŠ¨æ€ç»„åˆ
ReactAgent agent = aiAgentFactory.createChatAgent(
    List.of(ragHook, tenantHook)  // æŒ‰éœ€ç»„åˆ
);
```

**æ”¶ç›Š**:
- åˆ é™¤ **~100è¡ŒBeané…ç½®ä»£ç **
- æ¶ˆé™¤"CALL_SOURCEåˆ¤æ–­"çš„ç‰¹æ®Šæƒ…å†µ
- æé«˜é…ç½®çµæ´»æ€§

---

### ç¬¬ä¸‰æ­¥: ç”¨æœ€ç¬¨ä½†æœ€æ¸…æ™°çš„æ–¹å¼å®ç° (å¤šç§Ÿæˆ·)

**é—®é¢˜**: DataSourceHelperåœ¨ChatMemoryä¸­æ‰‹åŠ¨ç®¡ç†,å®¹æ˜“æ³„æ¼

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨RunnableConfigä¼ é€’ç§Ÿæˆ·ä¸Šä¸‹æ–‡

```java
// åœ¨Controllerä¸­è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
public Flux<ChatResponseVo> chatStream(String userPrompt, String conversationId) {
    String tenantId = TenantContextHolder.getTenantId();

    RunnableConfig config = RunnableConfig.builder()
        .threadId(conversationId)
        .addMetadata("tenantId", tenantId)  // æ˜ç¡®ä¼ é€’ç§Ÿæˆ·ä¿¡æ¯
        .store(createTenantStore(tenantId))  // ç§Ÿæˆ·éš”ç¦»çš„Store
        .build();

    return agent.streamAsFlux(userPrompt, config)
        .map(this::convertToResponse);
}

// åœ¨è‡ªå®šä¹‰DatabaseMemorySaverä¸­ä½¿ç”¨
public class DatabaseMemorySaver extends MemorySaver {
    @Override
    protected void insertedCheckpoint(RunnableConfig config,
                                     LinkedList<Checkpoint> checkpoints,
                                     Checkpoint checkpoint) {
        String tenantId = (String) config.metadata("tenantId").orElse(null);
        DataSourceHelper.use(tenantId);
        try {
            // ä¿å­˜åˆ° ai_conversation_content è¡¨
        } finally {
            DataSourceHelper.close();
        }
    }
}
```

**æ”¶ç›Š**:
- ç§Ÿæˆ·ä¸Šä¸‹æ–‡æ˜ç¡®åŒ–,ä¸å†éšè—åœ¨conversationIdä¸­
- å‡å°‘ThreadLocalæ³„æ¼é£é™©
- ç¬¦åˆæ¡†æ¶çš„RunnableConfigè®¾è®¡

---

### ç¬¬å››æ­¥: ç¡®ä¿é›¶ç ´åæ€§ (å‘åå…¼å®¹)

**é—®é¢˜**: ç°æœ‰çš„ `ai_conversation_content` è¡¨å’Œå†å²æ•°æ®

**è§£å†³æ–¹æ¡ˆ**: æ¸è¿›å¼è¿ç§»

**é˜¶æ®µ1: åŒå†™åŒè¯» (å…¼å®¹æœŸ)**
```java
public class HybridMemorySaver extends MemorySaver {
    @Override
    protected void insertedCheckpoint(...) {
        // 1. å†™å…¥æ–°çš„Checkpointè¡¨ (MemorySaveré»˜è®¤è¡Œä¸º)
        super.insertedCheckpoint(config, checkpoints, checkpoint);

        // 2. åŒæ—¶å†™å…¥æ—§çš„ ai_conversation_content è¡¨ (å…¼å®¹)
        saveToLegacyTable(config, checkpoint);
    }

    @Override
    protected LinkedList<Checkpoint> loadedCheckpoints(...) {
        // 1. ä¼˜å…ˆä»Checkpointè¡¨åŠ è½½
        LinkedList<Checkpoint> checkpoints = super.loadedCheckpoints(config, new LinkedList<>());

        // 2. å¦‚æœä¸ºç©º,ä»æ—§è¡¨è¿ç§»
        if (checkpoints.isEmpty()) {
            checkpoints = migrateFromLegacyTable(config);
        }

        return checkpoints;
    }
}
```

**é˜¶æ®µ2: åªå†™æ–°è¡¨,è¯»å–å…¼å®¹ (è¿‡æ¸¡æœŸ)**
```java
// åœæ­¢å†™å…¥æ—§è¡¨,åªå†™å…¥Checkpointè¡¨
// è¯»å–æ—¶ä»æ”¯æŒä»æ—§è¡¨è¿ç§»
```

**é˜¶æ®µ3: å®Œå…¨è¿ç§» (æœ€ç»ˆçŠ¶æ€)**
```java
// æ•°æ®è¿ç§»è„šæœ¬: ai_conversation_content â†’ checkpointè¡¨
// åˆ é™¤HybridMemorySaver,ä½¿ç”¨æ ‡å‡†DatabaseMemorySaver
```

---

## ğŸ“Š ä¼˜åŒ–æ”¶ç›Šé¢„ä¼°

### ä»£ç é‡å‡å°‘

| ç»„ä»¶ | å½“å‰è¡Œæ•° | ä¼˜åŒ–åè¡Œæ•° | å‡å°‘ |
|------|---------|-----------|------|
| AiChatMemoryConfig.java | 163 | 50 | -113 (-69%) |
| ScmChatMessageChatMemory.java | 134 | 0 (åˆ é™¤) | -134 (-100%) |
| ScmWorkflowMessageChatMemory.java | 134 | 0 (åˆ é™¤) | -134 (-100%) |
| WorkflowConversationAdvisor.java | 178 | 0 (åˆ é™¤) | -178 (-100%) |
| **æ–°å¢**: DatabaseMemorySaver | 0 | 80 | +80 |
| **æ–°å¢**: AiAgentFactory | 0 | 60 | +60 |
| **æ€»è®¡** | **609** | **190** | **-419 (-69%)** |

### ç»´æŠ¤æˆæœ¬é™ä½

- **ç†è§£æˆæœ¬**: ä»"5ä¸ªBean + 2ä¸ªChatMemory + 1ä¸ªAdvisor"é™ä¸º"1ä¸ªSaver + 1ä¸ªFactory"
- **æµ‹è¯•æˆæœ¬**: å‡å°‘69%çš„ä»£ç  = å‡å°‘69%çš„æµ‹è¯•ç”¨ä¾‹
- **å‡çº§æˆæœ¬**: å¯¹é½å®˜æ–¹å®ç°,æœªæ¥å‡çº§æ— é˜»åŠ›

### åŠŸèƒ½å¢å¼º

**ç«‹å³å¯ç”¨çš„å®˜æ–¹åŠŸèƒ½**:
1. **è·¨ä¼šè¯è®°å¿†**: ç”¨æˆ·å…³é—­æµè§ˆå™¨åå†æ‰“å¼€,ä»èƒ½è®¿é—®å†å²å¯¹è¯
2. **ç”¨æˆ·åå¥½å­¦ä¹ **: é€šè¿‡MemoryStoreå­˜å‚¨ç”¨æˆ·ç”»åƒ
3. **æ™ºèƒ½æ‘˜è¦**: å®˜æ–¹æœªæ¥å¯èƒ½æä¾›çš„å¯¹è¯æ‘˜è¦åŠŸèƒ½
4. **å¤šæ¨¡æ€è®°å¿†**: æ”¯æŒå›¾ç‰‡ã€æ–‡ä»¶ç­‰éæ–‡æœ¬è®°å¿†

---

## âš ï¸ é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©

| é£é™©é¡¹ | å½±å“ | ç¼“è§£æªæ–½ |
|-------|------|---------|
| MemorySaveræ€§èƒ½ | ä¸­ | ä½¿ç”¨æ•°æ®åº“æŒä¹…åŒ–ç‰ˆæœ¬,æ·»åŠ ç´¢å¼•ä¼˜åŒ– |
| æ—§æ•°æ®è¿ç§» | é«˜ | é‡‡ç”¨åŒå†™åŒè¯»ç­–ç•¥,æ¸è¿›å¼è¿ç§» |
| RunnableConfigå­¦ä¹ æ›²çº¿ | ä½ | å®˜æ–¹æ–‡æ¡£å®Œå–„,ç¤ºä¾‹ä¸°å¯Œ |

### ä¸šåŠ¡é£é™©

| é£é™©é¡¹ | å½±å“ | ç¼“è§£æªæ–½ |
|-------|------|---------|
| åŠŸèƒ½å›å½’ | é«˜ | å…¨é¢å›å½’æµ‹è¯•,ç¡®ä¿å¯¹è¯å†å²åŠŸèƒ½ä¸å˜ |
| ç”¨æˆ·æ„ŸçŸ¥ | æ—  | åº•å±‚å®ç°å˜åŒ–,ç”¨æˆ·æ— æ„ŸçŸ¥ |

---

## ğŸ“ å®æ–½å»ºè®®

### ä¼˜å…ˆçº§åˆ¤æ–­

**âœ… å€¼å¾—åš**: é™ä½69%ä»£ç é‡,å¯¹é½å®˜æ–¹å®ç°,æ¶ˆé™¤æŠ€æœ¯å€º

### å®æ–½è·¯å¾„

**ç¬¬ä¸€æ­¥**: å®ç°DatabaseMemorySaver (2-3å¤©)
- ç»§æ‰¿MemorySaver
- é‡å†™`insertedCheckpoint`å’Œ`loadedCheckpoints`
- å•å…ƒæµ‹è¯•éªŒè¯

**ç¬¬äºŒæ­¥**: æ›¿æ¢AiChatMemoryConfig (1å¤©)
- åˆ é™¤æ—§çš„ChatMemoryå’ŒAdvisor
- ä½¿ç”¨æ–°çš„DatabaseMemorySaver
- ä¿æŒAPIä¸å˜

**ç¬¬ä¸‰æ­¥**: é‡æ„ChatClienté…ç½® (1å¤©)
- åˆ›å»ºAiAgentFactory
- è¿ç§»5ä¸ªChatClientåˆ°ReactAgent
- æ›´æ–°Controllerè°ƒç”¨æ–¹å¼

**ç¬¬å››æ­¥**: æ•°æ®è¿ç§» (1-2å¤©)
- ç¼–å†™è¿ç§»è„šæœ¬
- æµ‹è¯•ç¯å¢ƒéªŒè¯
- ç”Ÿäº§ç¯å¢ƒç°åº¦è¿ç§»

**æ€»å·¥æœŸ**: 5-7ä¸ªå·¥ä½œæ—¥

---

## ğŸ”š ç»“è®º

### æ ¸å¿ƒé—®é¢˜

SCMçš„Memoryå®ç°**æŠŠç®€å•é—®é¢˜å¤æ‚åŒ–äº†**:

1. **æ•°æ®ç»“æ„é”™è¯¯**: æ‰‹åŠ¨å®ç°äº†æ¡†æ¶å·²ç»æä¾›çš„åŠŸèƒ½
2. **ç‰¹æ®Šæƒ…å†µæ³›æ»¥**: 5ä¸ªBean + CALL_SOURCEåˆ¤æ–­ + ç©ºå®ç°çš„add()
3. **ç ´åå‘åå…¼å®¹**: æ— æ³•ä½¿ç”¨å®˜æ–¹é«˜çº§åŠŸèƒ½,å‡çº§å›°éš¾

### Linuså¼è¯„ä»·

**ğŸ”´ å“å‘³è¯„åˆ†**: åƒåœ¾ (Sorry, but it's true)

**è‡´å‘½é—®é¢˜**:
- "ä½ åœ¨ç”¨475è¡Œä»£ç é‡æ–°å‘æ˜è½®å­,è€Œå®˜æ–¹åªéœ€è¦30è¡Œ"
- "ChatMemory.add()æ˜¯ç©ºå®ç°?è¿™æ˜¯åœ¨å‘Šè¯‰æˆ‘è®¾è®¡é”™äº†"
- "ä¸ºä»€ä¹ˆéœ€è¦5ä¸ªChatClient Bean? å› ä¸ºé…ç½®ç²’åº¦é”™äº†"

**æ”¹è¿›æ–¹å‘**:
- "æŠŠè¿™äº›ç‰¹æ®Šæƒ…å†µå…¨éƒ¨æ¶ˆé™¤æ‰ - ç”¨MemorySaverä¸€ä¸ªç±»æå®š"
- "475è¡Œå¯ä»¥å˜æˆ80è¡Œ - è€Œä¸”æ›´æ¸…æ™°"
- "æ•°æ®ç»“æ„é”™äº†,åº”è¯¥æ˜¯RunnableConfigç®¡ç†ä¸Šä¸‹æ–‡,ä¸æ˜¯conversationIdè—tenantId"

### æœ€ç»ˆå»ºè®®

**ç«‹å³è¡ŒåŠ¨**: è¿™ä¸æ˜¯"å¯ä»¥ä¼˜åŒ–",è€Œæ˜¯"å¿…é¡»ä¼˜åŒ–"

é‡‡ç”¨æœ¬æ–‡æ¡£çš„**ç¬¬ä¸€æ­¥+ç¬¬äºŒæ­¥**,å°±èƒ½è·å¾—:
- âœ… åˆ é™¤400+è¡Œä»£ç 
- âœ… æ¶ˆé™¤è¯»å†™åˆ†ç¦»çš„æ··ä¹±
- âœ… å¯¹é½å®˜æ–¹æœ€ä½³å®è·µ
- âœ… ä¸ºæœªæ¥å‡çº§é“ºå¹³é“è·¯

**ä¸ä¼˜åŒ–çš„åæœ**:
- âŒ æ¯æ¬¡æ¡†æ¶å‡çº§éƒ½éœ€è¦å¤§é‡é€‚é…å·¥ä½œ
- âŒ æ–°åŒäº‹éœ€è¦1-2å‘¨æ‰èƒ½ç†è§£Memoryé€»è¾‘
- âŒ æ— æ³•ä½¿ç”¨å®˜æ–¹çš„é«˜çº§AIåŠŸèƒ½
- âŒ æŠ€æœ¯å€ºåˆ©æ»šåˆ©,æœ€ç»ˆä¸å¾—ä¸é‡å†™

---

**é™„å½•**: å‚è€ƒä»£ç ä½ç½®
- SCMå®ç°: `scm-ai/src/main/java/com/xinyirun/scm/ai/config/memory/`
- å®˜æ–¹ç¤ºä¾‹: `spring-ai-alibaba-main/examples/documentation/.../MemoryExample.java`
- å®˜æ–¹æºç : `spring-ai-alibaba-main/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/`
